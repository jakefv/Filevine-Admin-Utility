/*! Filevine 2019-01-16 */
!function(){"use strict";var a=$.fn.datepicker.noConflict();$.fn.bootstrapDP=a;var b=Crops.ViewPath,c=Crops.AdminPath,d=Crops.AdvancedPath,e=["ngAnimate","ngSanitize","ui.utils","ui.sortable","ui.router","ui.bootstrap","Signup","ngTable","ngTableExport","rzTable","cfp.hotkeys"],f=angular.module("Crops",e).config(["$urlRouterProvider","$stateProvider","$httpProvider","$compileProvider",function(a,e,f,g){g.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|data|tel|ms-word|ms-powerpoint|ms-excel|ms-visio|ms-access|ms-project|ms-publisher):/),Crops.currentUserID&&(a.when("","/feed"),a.when("/project/:projectID/docs","/project/:projectID/docs/"),a.when("/setup","/setup/profile"),a.when("/tasks/:due","/tasks?:due"),a.when("/mailroom","/mailroom/0"),a.otherwise("/feed")),e.state("setupLayout",{"abstract":!0,url:"",templateUrl:b+"setup/setup.layout.html",controller:"SetupController"}).state("setupLayout.setup",{"abstract":!0,title:"Setup",url:"/setup",views:{"setup-page-header":{templateUrl:b+"setup/setup.page.header.html"},"setup-sidenav":{templateUrl:b+"setup/setup.sidenav.html",controller:"SetupSidenavController"},"setup-section-wrapper":{template:'<div ui-view="setup-section"></div>'}}}).state("setupLayout.setup.profile",{title:"Setup - Profile",url:"/profile",views:{"setup-section":{templateUrl:b+"setup/currentuser/profile/profile.view.html",controller:"UserProfileController"}}}).state("setupLayout.setup.account",{title:"Setup - Account Settings",url:"/account",views:{"setup-section":{templateUrl:b+"setup/currentuser/account/account.view.html",controller:"UserAccountController"}}}).state("setupLayout.setup.notifications",{title:"Setup - Notifications",url:"/notifications",views:{"setup-section":{templateUrl:b+"setup/currentuser/notifications/notifications.view.html",controller:"UserSetupNotificationsController"}}}).state("setupLayout.setup.orgs",{title:"Setup - Orgs",url:"/orgs",views:{"setup-section":{templateUrl:b+"setup/orgs/org.view.html",controller:"OrgController"}}}).state("setupLayout.setup.plugins",{title:"Setup - Plugins",url:"/plugins",views:{"setup-section":{templateUrl:b+"setup/plugins/plugins.html"}}}).state("feedLayout",{"abstract":!0,url:"",templateUrl:b+"feed/feed.layout.html"}).state("feedLayout.feed",{title:"Feed",url:"/feed",views:{"feed-page-header":{templateUrl:b+"feed/feed.page.header.html",controller:"FeedPageHeaderController"},"feed-page-content":{templateUrl:b+"feed/feed.html",controller:"FeedController"}}}).state("feedLayout.recent",{title:"My Recent Activity",url:"/recent",views:{"feed-page-header":{templateUrl:b+"feed/feed.page.header.html",controller:"FeedPageHeaderController"},"feed-page-content":{templateUrl:b+"feed/feed.html",controller:"FeedController"}}}).state("calendarLayout",{"abstract":!0,url:"",templateUrl:b+"calendar/calendar.layout.html",controller:"CalendarLayoutController"}).state("calendarLayout.calendar",{title:"Calendar",url:"/calendar",views:{"calendar-page-header":{templateUrl:b+"calendar/calendar.page.header.html"},"calendar-sidenav":{templateUrl:b+"calendar/calendar.sidenav.html",controller:"CalendarSidenavController"},"calendar-main":{templateUrl:b+"calendar/calendar.html",controller:"GlobalCalendarController"}}}).state("tasksLayout",{"abstract":!0,title:"Tasks",url:"",templateUrl:b+"tasks/tasks.layout.html"}).state("tasksLayout.tasks",{title:"Tasks",url:"/tasks",views:{"tasks-page-header":{templateUrl:b+"tasks/tasks.page.header.html",controller:"TasksPageHeaderController"},"tasks-page-content":{templateUrl:b+"tasks/tasks.view.html",controller:"TasksController"}}}).state("searchLayout",{"abstract":!0,title:"Search",url:"",templateUrl:b+"search/search.layout.html"}).state("searchLayout.search",{title:"Search",url:"/search",views:{"search-page-header":{templateUrl:b+"search/search.page.header.html"},"search-page-content":{templateUrl:b+"search/search.view.html",controller:"SearchController"}}}).state("mailroomLayout",{"abstract":!0,url:"",templateUrl:b+"mailroom/mailroom.layout.html",controller:"MailroomLayoutController"}).state("mailroomLayout.mailroom",{title:"Mailroom",url:"/mailroom/:orgID",views:{"mailroom-page-header":{templateUrl:b+"mailroom/mailroom.page.header.html"},"mailroom-sidenav":{templateUrl:b+"mailroom/mailroom.sidenav.html",controller:"MailroomSidenavController"},"mailroom-org":{templateUrl:b+"mailroom/mailroom.html",controller:"MailroomController"}}}).state("createProjectLayout",{"abstract":!0,url:"",templateUrl:b+"projects/create/create.project.layout.html"}).state("createProjectLayout.createProject",{title:"Create Project",url:"/project/create",views:{"create-project-page-header":{templateUrl:b+"projects/create/create.project.page.header.html"},"create-project-page-content":{templateUrl:b+"projects/create/create.project.html",controller:"CreateProjectController"}}}).state("projectLayout",{"abstract":!0,url:"",templateUrl:b+"projects/project.layout.view.html",controller:"ProjectController"}).state("projectLayout.project",{"abstract":!0,url:"/project/:projectID",views:{"project-page-header":{templateUrl:b+"projects/project.page.header.html",controller:"ProjectPageHeaderController"},"project-sidenav":{templateUrl:b+"projects/project.sidenav.html",controller:"ProjectSidenavController"},"project-section-wrapper":{template:'<div ui-view="project-section"></div>'}}}).state("projectLayout.project.activity",{url:"/activity",views:{"project-section":{templateUrl:b+"notes/project.activity.html",controller:"ProjectActivityController"}}}).state("projectLayout.project.calendar",{url:"/calendar",views:{"project-section":{templateUrl:b+"calendar/calendar.html",controller:"ProjectCalendarController"}}}).state("projectLayout.project.contacts",{url:"/contacts",views:{"project-section":{templateUrl:b+"contacts/contacts.html",controller:"ContactController"}}}).state("projectLayout.project.chain",{url:"/chain",views:{"project-section":{templateUrl:b+"chain/chain.html",controller:"ChainController"}}}).state("projectLayout.project.deadlines",{url:"/deadlines",views:{"project-section":{templateUrl:b+"deadlines/deadlines.html",controller:"DeadlineController"}}}).state("projectLayout.project.incident",{url:"/incident",views:{"project-section":{templateUrl:b+"incident/incident.html",controller:"IncidentController"}}}).state("projectLayout.project.related",{url:"/related",views:{"project-section":{templateUrl:b+"related/related.html",controller:"RelatedProjectsController"}}}).state("projectLayout.project.team",{url:"/team",views:{"project-section":{templateUrl:b+"team/team.view.html",controller:"TeamController"}}}).state("projectLayout.project.yield",{url:"/yield",views:{"project-section":{templateUrl:b+"yield/yield.html",controller:"YieldController"}}}).state("projectLayout.project.conflictcheck",{url:"/conflictcheck",views:{"project-section":{templateUrl:b+"conflictchecks/conflict.check.html",controller:"ConflictCheckController"}}}).state("projectLayout.project.docs",{url:"/docs/:folderID",views:{"project-section":{templateUrl:b+"docs/docs.html",controller:"DocumentsController"}}}).state("projectLayout.project.custom",{url:"/custom/:sectionName",views:{"project-section":{templateUrl:function(a){return"/api/customsection/"+a.sectionName},controller:"CustomController"}}}).state("reportBuilderLayout",{"abstract":!0,url:"",templateUrl:b+"reports/builder/report.builder.layout.html"}).state("reportBuilderLayout.reportBuilder",{title:"Report Builder",url:"/reportbuilder",views:{"report-builder-page-header":{templateUrl:b+"reports/builder/report.builder.page.header.html"},"report-builder-page-content":{templateUrl:b+"reports/builder/report.builder.view.html",controller:"ReportBuilderController"}}}).state("reportLayout",{"abstract":!0,url:"",templateUrl:b+"reports/viewer/report.viewer.layout.html",controller:"ReportViewerLayoutController"}).state("reportLayout.reports",{title:"Reports",url:"/reports/:reportID",views:{"report-viewer-page-header":{templateUrl:b+"reports/viewer/report.viewer.page.header.html",controller:"ReportViewerPageHeaderController"},"report-viewer-sidenav":{templateUrl:b+"reports/viewer/report.viewer.sidenav.html",controller:"ReportViewerSidenavController"},"report-viewer-page-content":{templateUrl:b+"reports/viewer/report.viewer.html",controller:"ReportViewerController"}}}),d&&(a.when("/advanced","/advanced/autohashtags"),e.state("advancedLayout",{"abstract":!0,url:"",templateUrl:d+"advanced.layout.html",controller:"AdvancedController"}).state("advancedLayout.advanced",{"abstract":!0,url:"/advanced",views:{"advanced-page-header":{templateUrl:d+"advanced.page.header.html"},"advanced-sidenav":{templateUrl:d+"advanced.sidenav.html",controller:"AdvancedSidenavController"},"advanced-section-wrapper":{template:'<div ui-view="advanced-section"></div>'}}}).state("advancedLayout.advanced.chains",{url:"/chains",views:{"advanced-section":{templateUrl:d+"chain/chain.admin.html",controller:"ChainAdminController"}}}).state("advancedLayout.advanced.customs",{url:"/customs",views:{"advanced-section":{templateUrl:d+"projecttypes/projecttypes.view.html",controller:"AdvancedProjectTypesController"}}}).state("advancedLayout.advanced.docgen",{url:"/docgen",views:{"advanced-section":{templateUrl:d+"docgen/docgen.html",controller:"advancedDocGenController"}}}).state("advancedLayout.advanced.judicialcalendar",{url:"/judicialcalendar",views:{"advanced-section":{templateUrl:d+"workingcalendar/working.calendar.view.html",controller:"advWorkingCalendarController"}}}).state("advancedLayout.advanced.mergecontacts",{url:"/mergecontacts",views:{"advanced-section":{templateUrl:d+"mergecontacts/merge.contacts.html",controller:"mergeContactsController"}}}).state("advancedLayout.advanced.quickbooks",{url:"/quickbooks",views:{"advanced-section":{templateUrl:d+"quickbooks/quickbooks.html",controller:"QuickbooksController"}}}).state("advancedLayout.advanced.taskutils",{url:"/taskutils",views:{"advanced-section":{templateUrl:d+"/taskutils/task.utils.html",controller:"advTaskUtilsController"}}}).state("advancedLayout.advanced.massupdatepermissions",{url:"/massupdatepermissions",views:{"advanced-section":{templateUrl:d+"/massupdatepermissions/massupdatepermissions.html",controller:"advMassUpdatePermissionsController"}}}).state("advancedLayout.advanced.reportutils",{url:"/reportutils",views:{"advanced-section":{templateUrl:d+"/reportutils/report.utils.html",controller:"advReportUtilsController"}}}).state("advancedLayout.advanced.clearfeed",{url:"/feed",views:{"advanced-section":{templateUrl:d+"/feed/clear.feed.html",controller:"advClearFeedController"}}}).state("advancedLayout.advanced.undelete",{url:"/undelete",views:{"advanced-section":{templateUrl:d+"undelete/undelete.html",controller:"UndeleteController"}}}).state("advancedLayout.advanced.massupdate",{url:"/massupdate",views:{"advanced-section":{templateUrl:d+"massupdate/massupdate.html",controller:"MassUpdateController"}}}).state("advancedLayout.advanced.massdocgen",{url:"/massdocgen",views:{"advanced-section":{templateUrl:d+"massdocgen/massdocgen.html",controller:"MassDocGenController"}}}).state("advancedLayout.advanced.taskflow",{title:"advanced - Taskflow",url:"/taskflow",views:{"advanced-section":{templateUrl:d+"taskflow/taskflow.view.html",controller:"TaskflowController",controllerAs:"vm"}}}).state("advancedLayout.advanced.reminderSchedules",{title:"advanced - Reminder Schedules",url:"/reminderschedules",views:{"advanced-section":{templateUrl:d+"reminderschedules/reminder.schedules.view.html",controller:"advReminderSchedulesController"}}}).state("advancedLayout.advanced.docIntegration",{title:"advanced - Doc Integration",url:"/docintegration",views:{"advanced-section":{templateUrl:d+"docintegration/doc.integration.html",controller:"advDocIntegrationController"}}}).state("advancedLayout.advanced.autohashtags",{title:"advanced - AutoHashtags",url:"/autohashtags",views:{"advanced-section":{templateUrl:d+"autohashtags/autohashtags.view.html",controller:"AutoHashtagsController",controllerAs:"vm"}}})),c&&(a.when("/admin","/admin/utils"),e.state("adminLayout",{"abstract":!0,url:"",templateUrl:c+"admin.layout.html",controller:"AdminController"}).state("adminLayout.admin",{"abstract":!0,url:"/admin",views:{"admin-page-header":{templateUrl:c+"admin.page.header.html"},"admin-sidenav":{templateUrl:c+"admin.sidenav.html",controller:"AdminSidenavController"},"admin-section-wrapper":{template:'<div ui-view="admin-section"></div>'}}}).state("adminLayout.admin.projecttypesorgs",{url:"/projecttypes/orgs",views:{"admin-section":{templateUrl:c+"projecttypes/projecttypes.view.html"}}}).state("adminLayout.admin.dashboard",{url:"/dashboard",views:{"admin-section":{templateUrl:c+"dashboard/dashboard.view.html"}}}).state("adminLayout.admin.utils",{url:"/utils",views:{"admin-section":{templateUrl:c+"utils/admin.utils.view.html"}}}).state("adminLayout.admin.migrations",{url:"/migrations",views:{"admin-section":{templateUrl:c+"migrations/migration.list.html",controller:"MigrationController"}}}).state("adminLayout.admin.imports",{url:"/imports",views:{"admin-section":{templateUrl:c+"imports/import.batches.html",controller:"ImportBatchController"}}}).state("adminLayout.admin.orgs",{url:"/orgs",views:{"admin-section":{templateUrl:c+"orgs/orgs.view.html"}}}).state("adminLayout.admin.manageadvanced",{url:"/manage/advanced",views:{"admin-section":{templateUrl:c+"manage/advanced.view.html"}}}).state("adminLayout.admin.manageadmins",{url:"/manage/admin",views:{"admin-section":{templateUrl:c+"manage/admin.view.html"}}}).state("adminLayout.admin.apikey",{url:"/apikey",views:{"admin-section":{templateUrl:c+"apikey/apikey.view.html"}}})),f.interceptors.push(["$q",function(a){return{response:function(b){return/doctype/gi.test(b.data)?(/loginForm/g.test(b.data)&&(window.location="/account/login"),a.reject(b)):b},responseError:function(b){return a.reject(b)}}}])}]);f.run(["$rootScope","config","$window","$state","$stateParams","hotkeys",function(a,b,c,d,e,f){a.$state=d,a.$stateParams=e,a.$on("$stateChangeStart",function(d,e,g,h){e.title?document.title="Filevine - "+e.title:document.title="Filevine";var i=e.name.split("."),j=h.name.split(".");i[0]!==j[0]&&c.scrollTo(0,0),f.bindTo(a).add({combo:"mod+s",description:"save button",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(c,d){c.preventDefault(),a.$broadcast(b.globalSaveHotkeyPressed,d,c)}})})}]),window.console=function(a){function b(a){a.length>=20&&a.shift()}window.console&&a||(a={});var c=Crops.DEBUG,d={logs:[],debug:[],errors:[],warns:[],infos:[],time:[],timeEnd:[]};return{log:function(){return b(d.logs),d.logs.push(arguments),c&&a.log&&a.log.apply(a,arguments)},warn:function(){return b(d.warns),d.warns.push(arguments),c&&a.warn&&a.warn.apply(a,arguments)},error:function(){return b(d.errors),d.errors.push(arguments),c&&a.error&&a.error.apply(a,arguments)},info:function(){return b(d.infos),d.infos.push(arguments),c&&a.info&&a.info.apply(a,arguments)},time:function(){return b(d.time),d.time.push(arguments),c&&a.time&&a.time.apply(a,arguments)},timeEnd:function(){return b(d.timeEnd),d.timeEnd.push(arguments),c&&a.timeEnd&&a.timeEnd.apply(a,arguments)},debug:function(){return b(d.debug),d.debug.push(arguments),c&&a.debug&&a.debug.apply(a,arguments)},enableDebug:function(){return c=!0,"Console Logging Enabled."},disableDebug:function(){return c=!1,"Console Logging Disabled."},logArray:function(){return d}}}(window.console),angular.extend(Crops,f)}(),function(){"use strict";function a(a,b,c){return{scope:{},restrict:"E",replace:!0,templateUrl:"{0}/alerts/fvAlerts.html".format(b.viewRoot),link:function(b){b.alerts=a.alerts(),b.$on(a.onAlertsChanged,function(){b.alerts=a.alerts()}),b.closeAlert=function(b){a.closeAlert(b)}}}}angular.module("Crops").directive("fvAlerts",a),a.$inject=["fvAlertsService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){function d(){return k}function e(a,b,c){i("success",a,b,c)}function f(a,b,c){i("danger",a,b,c)}function g(a,b,c){i("warning",a,b,c)}function h(a,b,c){i("info",a,b,c)}function i(b,d,e,f){var g={id:++l,type:b,icon:m[b].icon,msg:d||m[b].msg,timeout:!e||isNaN(e)||e<0?m[b].timeout:e},h=null;f&&(h=_(k).findWhere({type:g.type,msg:g.msg})),g.msg&&(h?(c.cancel(o[h.id]),o[h.id]=c(function(){j(h)},g.timeout)):(k.unshift(g),a.$broadcast(n),o[g.id]=c(function(){j(g)},g.timeout)))}function j(b){k.length&&(k=_(k).reject(function(a){return a.id===b.id}),a.$broadcast(n))}var k=[],l=0,m={success:{icon:"fa-check",msg:"Success!",timeout:4e3},danger:{icon:"fa-times-circle",msg:"Oops! Something went wrong. Please refresh the page and try again.",timeout:12e3},warning:{icon:"fa-exclamation-triangle",timeout:12e3},info:{icon:"fa-lightbulb-o",timeout:12e3}},n="alertService.onAlertsChanged",o={},p={alerts:d,alertSuccess:e,alertFail:f,alertWarning:g,alertInfo:h,onAlertsChanged:n,closeAlert:j};return p}angular.module("Crops").service("fvAlertsService",a),a.$inject=["$rootScope","fvUtils","$timeout"]}(),function(){"use strict";function a(a,b,c,d){return service}angular.module("Crops").service("billableItemService",a),a.$inject=["fvApi","fvUtils","$stateParams","$rootScope"]}(),function(){"use strict";function a(a){}angular.module("Crops").controller("BillingSectionController",a),a.$inject=["$scope"]}(),function(){"use strict";function a(a,b,c,d){function e(){return c.projectID===t?void d.$broadcast(u):(q=!0,r=[],t=c.projectID,d.$broadcast(u),void a.get(p.getInvoiceList,[t]).then(function(a){r=a,q=!1,d.$broadcast(u)}))}function f(){return r}function g(){return q}function h(){return s}function i(a){s=a,d.$broadcast(onCurrentChanged)}function j(b){var e=c.projectID;a.post(p.createInvoice,[c.projectID],b).then(function(a){e===c.projectID&&(r.push(a),d.$broadcast(u))})}function k(b){a.post(p.updateInvoice,[b.id],b)}function l(c){a.post(p.removeInvoice,[c.id],c).then(function(a){b.removeFromList(r,a.id)})}function m(b,c){var e=s;a.post(p.createDetail,[e],c).then(function(a){e===s&&(s.details.push(a),d.$broadcast(v))})}function n(b){a.post(p.updateDetail,[b.id],b)}function o(b){var c=s;a.post(p.removeDetail,[b.id],b).then(function(a){for(var d=c.details.length-1;d>=0;d++)if(c.details[d].userID===b.userID){c.details.splice(d,1);break}})}var p={getInvoiceList:"/api/projects/{0}/invoices",createInvoice:"/api/projects/{0}/invoices/create",updateInvoice:"/api/invoices/{0}/update",removeInvoice:"/api/invoices/{0}/remove",createDetail:"/api/invoices/{0}/details/create",updateDetail:"/api/invoicedetails/{0}/update",removeDetail:"/api/invoicedetails/{0}/remove"},q=!1,r=null,s=null,t=0,u="invoiceService.onInvoiceListChanged",v="invoiceService.onCurrentInvoiceChanged",w={loadInvoiceList:e,invoiceList:f,currentInvoice:h,isLoading:g,onInvoiceListChanged:u,onCurrentInvoiceChanged:v,selectCurrent:i,createInvoice:j,updateInvoice:k,removeInvoice:l,createDetail:m,updateDetail:n,removeDetail:o};return w}angular.module("Crops").service("invoiceService",a),a.$inject=["fvApi","fvUtils","$stateParams","$rootScope"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{detail:"="},templateUrl:"{0}/billing/orgRates/rate.detail.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("rateDetail",a),a.$inject=["rateService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{line:"=",table:"@"},templateUrl:"{0}/billing/orgRates/rate.tables.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("rateTables",a),a.$inject=["rateTableService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/billing/projectInvoices/billable.items.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("billableItem",a),a.$inject=["invoiceService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/billing/projectInvoices/billable.items.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("billingItems",a),a.$inject=["invoiceService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{detail:"="},templateUrl:"{0}/billing/projectInvoices/invoice.detail.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("invoiceDetail",a),a.$inject=["invoiceService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{invoice:"="},templateUrl:"{0}/billing/projectInvoices/invoice.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("invoice",a),a.$inject=["invoiceService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/billing/projectInvoices/invoice.history.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("invoiceHistory",a),a.$inject=["invoiceService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/billing/projectRates/rate.overrides.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("rateOverrides",a),a.$inject=["rateTableService","config"]}(),function(){"use strict";function a(a,b,c){function d(){return $stateParams.orgID===y?void c.$broadcast(z):(t=!0,u=[],y=$stateParams.orgID,c.$broadcast(z),void a.get(s.getTableList,[y]).then(function(a){u=a,t=!1,c.$broadcast(z)}))}function e(){return u}function f(){return t}function g(){return v}function h(a){v=a,c.$broadcast(onCurrentChanged)}function i(a){a.id?r(a):q(a)}function j(c){a.post(s.removeTable,[c.id],c).then(function(a){b.removeFromList(u,a.id)})}function k(b,c){a.post(s.saveDetail,[b],c)}function l(b,c){var d=v;a.post(s.removeDetail,[b],c).then(function(a){for(var b=d.details.length-1;b>=0;b++)if(d.details[b].userID===c.userID){d.details.splice(b,1);break}})}function m(){return $stateParams.projectID===x?void c.$broadcast(B):(t=!0,w=[],x=$stateParams.projectID,c.$broadcast(B),void a.get(s.getProjectTable,[x]).then(function(a){w=a,t=!1,c.$broadcast(B)}))}function n(){return w}function o(b){a.post(s.saveOverride,[$stateParams.projectID],b)}function p(b){var c=w;a.post(s.removeOverride,[$stateParams.projectID],b).then(function(a){for(var d=0;d<c.details.length;d++)if(c.details[d].userID===b.userID){c.details[d].overrideAmount=0,c.details[d].isOverridden=!1;break}})}function q(b){var d=$stateParams.orgID;a.post(s.createTable,[$stateParams.orgID],b).then(function(a){d===$stateParams.orgID&&(u.push(a),c.$broadcast(z))})}function r(b){a.post(s.updateTable,[b.id],b)}var s={getTableList:"/api/orgs/{0}/ratetables",createTable:"/api/orgs/{0}/ratetables/create",updateTable:"/api/ratetables/{0}/update",removeTable:"/api/ratetables/{0}/remove",saveDetail:"/api/ratetables/{0}/details/save",removeDetail:"/api/ratetables/{0}/details/remove",getProjectTable:"/api/projects/{0}/ratetable",saveOverride:"/api/projects/{0}/rateoverrides/save",removeOverride:"/api/projects/{0}/rateoverrides/remove"},t=!1,u=null,v=null,w=null,x=0,y=0,z="rateTableService.onRateTableListChanged",A="rateTableService.onCurrentRateTableChanged",B="rateTableService.onProjectRateTableChanged",C={loadRateTableList:d,rateTableList:e,currentRateTable:g,isLoading:f,selectCurrent:h,saveTable:i,removeTable:j,saveDetail:k,removeDetail:l,onRateTableListChanged:z,onCurrentRateTableChanged:A,loadProjectRateTable:m,projectRateTable:n,saveOverride:o,removeOverride:p,onProjectRateTableChanged:B};return C}angular.module("Crops").service("rateTableService",a),a.$inject=["fvApi","fvUtils","$rootScope"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/billing/timers/billing.timer.html".format(b.viewRoot),link:function(a){}}}angular.module("Crops").directive("billingTimer",a),a.$inject=["billableItemService","config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(a,b){if(a&&b)return a.userID&&b.userID&&a.userID===b.userID||a.personID&&b.personID&&a.personID===b.personID}function l(b){d.getAvailableAttendeesList(b.projectID).then(function(b){return a.data.allAvailableAttendees=b||[],m(b)})}function m(a){if(!a||a.length<=1)return a;var b=_(a).find(function(a){return a&&a.userID&&a.userID===i.currentUser.id})||[];return a=_.chain(a).reject(function(a){return a.userID&&a.userID===i.currentUser.id}).sortBy(function(a){return a.attendeeInfo?a.attendeeInfo.fullname:void 0}).value(),b.concat(a)}function n(a){if(!a||a.length<=1)return a;var b=[],c=[],d=[],e=[];return a=_(a).sortBy(function(a){return a.attendeeInfo?a.attendeeInfo.fullname:void 0}),_(a).each(function(a){a.attendeeInfo&&(a.userID&&a.userID===i.currentUser().id?b.push(a):a.hasProjectPermission?c.push(a):!a.hasProjectPermission&&a.attendeeInfo&&"User"===a.attendeeInfo.type?d.push(a):a.attendeeInfo&&"Contact"===a.attendeeInfo.type&&e.push(a))}),b.concat(c,d,e)}a.data={allAvailableAttendees:[],projectAttendees:[],contactAttendees:[],nonProjectAttendees:[]},a.settings={isSaving:!1},a.tab={projectAttendeesIsOpen:!0,nonProjectAttendeesIsOpen:!1,contactAttendeesIsOpen:!1},a.isValid={calendarEventStartDate:!1,calendarEventEndDate:!1},f&&(a.settings.canEdit=f.editable,a.settings.isEditing=f._new,a.calendarEvent=angular.copy(f),a.calendarEvent.attendees=n(a.calendarEvent.attendees),a.calendarEvent.end=a.calendarEvent.allDay?moment(a.calendarEvent.end).subtract(23,"h").format():a.calendarEvent.end,a.settings.startsEndsSameDay=moment(a.calendarEvent.start).isSame(a.calendarEvent.end,"day"),g(function(){f.id||a.$broadcast("onBeginEditingNewCalendarEvent",{selectAll:!0})})),a.getUserDataForUserSelector=function(a){return a?a.attendeeInfo:{}},a.onAttendeeAdded=function(b){n(a.calendarEvent.attendees)},a.removeAttendee=function(b){a.calendarEvent.attendees=_(a.calendarEvent.attendees).reject(function(a){return k(a,b)}),g(function(){!a.tab.nonProjectAttendeesIsOpen||a.data.nonProjectAttendees&&a.data.nonProjectAttendees.length||(a.tab.notProjectAttendeesIsOpen=!1,a.tab.projectAttendeesIsOpen=!0)})},a.addAttendee=function(b){b&&a.calendarEvent.attendees.push(b)},a.$on(d.onViewedListChanged,function(){a.viewedCalendars=d.viewedList()}),a.openStart=function(){a.isStartOpen=!0},a.showProjectSelector=function(){return a.calendarEvent&&!a.calendarEvent.projectID},a.close=function(){e.dismiss("close"),a.calendarEvent=null},a.beginEditing=function(){a.originalEvent=angular.copy(a.calendarEvent),a.settings.isEditing=!0},a.cancelEditing=function(){a.calendarEvent&&a.calendarEvent.id?(a.calendarEvent=angular.copy(a.originalEvent),delete a.originalEvent,a.settings.isEditing=!1):(e.dismiss("cancel"),a.calendarEvent=null)},a.canSave=function(){return a.calendarEvent&&a.calendarEvent.title&&a.calendarEvent.projectID&&a.calendarEvent.attendees&&a.calendarEvent.attendees.length&&a.isValid.calendarEventStartDate&&a.calendarEvent.start&&moment(a.calendarEvent.start).isValid()&&a.endDateValid()&&!angular.equals(a.calendarEvent,a.originalEvent)&&!a.settings.isSaving},a.endDateValid=function(){return a.calendarEvent&&a.calendarEvent.end&&a.isValid.calendarEventStartDate&&moment(a.calendarEvent.end).isValid()&&moment(a.calendarEvent.end)>moment(a.calendarEvent.start)},a.changeAllDay=function(){a.endDateValid()||(a.calendarEvent.end=moment(a.calendarEvent.start).add(1,"hours").toDate())},a.save=function(){a.canSave()&&(a.settings.isSaving=!0,c.saveEvent(a.calendarEvent).then(function(b){a.calendarEvent=b,a.close(),a.settings.isEditing=!1,a.settings.isSaving=!1},function(){h.alertFail(),a.settings.isSaving=!1}))},a.$on(b.globalSaveHotkeyPressed,function(b,c,d){a.save()}),a.remove=function(){c.removeEvent(a.calendarEvent),e.dismiss("removed"),a.calendarEvent=null},a.selectProject=function(b){a.data.availableAttendees=[],a.data.allAvailableAttendees=[],a.calendarEvent.projectID=b.id,a.calendarEvent.project=b,a.calendarEvent.detailsUrl="/#/project/"+b.id+"/activity"},a.$watch("calendarEvent.projectID",function(b){b?l(a.calendarEvent):(a.data.availableAttendees=[],a.data.allAvailableAttendees=[])}),a.removeProject=function(){a.calendarEvent.projectID=null,a.calendarEvent.project=null,a.calendarEvent.detailsUrl=""},a.getProjectLink=function(a){return a.detailsUrl?a.detailsUrl:j.projectID&&j.projectID===a.project.id?null:"#/project/"+f.project.id+"/activity"}}angular.module("Crops").controller("calendarEventDetailController",a),a.$inject=["$scope","config","calendarService","calendarSharingService","$uibModalInstance","calendarEvent","$timeout","fvAlertsService","currentUserService","$stateParams"]}(),function(){"use strict";function a(a,b){b.toggleSidenav("close"),a.$on(b.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){b.toggleSidenav()}}angular.module("Crops").controller("CalendarLayoutController",a),a.$inject=["$scope","sidenavService"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){return(new Date).getTimezoneOffset()}function h(){F={type:null,start:null,end:null,timezone:0}}function i(b,d){if(c.projectID){var e=g();if(y("project:"+c.projectID,b,d,e))return void x();F={type:"project:"+c.projectID,start:b,end:d,timezone:e},I=!0,G=[],H=[],x(),a.get(B.getProjectEvents,[c.projectID,moment(b).format("YYYY-MM-DD"),moment(d).format("YYYY-MM-DD")]).then(function(a){G=[],H=a,H.forEach(function(a){u(a)}),I=!1,x()})}}function j(b,c){var d=g();return y("global",b,c,d)?(z(),void x()):(F={type:"global",start:b,end:c,timezone:d},I=!0,G=[],H=[],x(),void a.get(B.getDisplayedEventSet,[moment(b).format("YYYY-MM-DD"),moment(c).format("YYYY-MM-DD"),d]).then(function(a){G=a,w(a),z(),I=!1,x()}))}function k(){return H}function l(){return I}function m(a){for(var b=0;b<G.length;b++)if(G[b].ownerID===a)return G[b].isDisplayed=!1,z(),void x()}function n(b){for(var c=null,d=0;d<G.length;d++)if(c=G[d],c.ownerID===b){c.isDisplayed=!0;break}if(c&&c.events)return z(),void x();var e=g();I=!0,x(),a.get(B.getSingleEventSet,[b,moment(F.start).format("YYYY-MM-DD"),moment(F.end).format("YYYY-MM-DD"),e]).then(function(a){c?(c.isDisplayed=!0,c.events=a.events):(a.isDisplayed=!0,G.push(a)),w(G),z(),I=!1,x()})}function o(){return{header:{left:"prev next title",right:"month agendaWeek agendaDay"},titleFormat:{month:"MMMM YYYY",week:"[Week of] MMMM Do, YYYY",day:"MMMM Do, YYYY"},fixedWeekCount:!1,eventClick:p,dayClick:r,timezone:"local"}}function p(c){c.calendarEventType&&"appointment"===c.calendarEventType.toLowerCase()?a.get(B.getEvent,[c.calendarEventID]).then(function(a){b.$broadcast(E,a)},function(){f.alertFail()}):b.$broadcast(E,c)}function q(c){a.get(B.getEvent,[c]).then(function(a){b.$broadcast(E,a)},function(){f.alertFail()})}function r(a){b.$broadcast(E,A(a))}function s(b){var c=angular.copy(b);return c.start=moment(c.start).utc().format(),c.end=c.allDay?moment(c.end).add(1,"d").hour(0).minute(0).utc().format():moment(c.end).utc().format(),a.post(B.saveEvent,[],c).then(function(a){if(v(b),"global"===F.type){for(var c=0,d=G.length;c<d;c++)a.applyToOwnerIDs.indexOf(G[c].ownerID)!==-1&&G[c].events&&G[c].events.push(a);z()}else u(a),H.push(a);return x(),a})}function t(b){a.post(B.removeEvent,[b.calendarEventID]).then(function(){v(b),x()})}function u(a){a.allDay&&(a.start=moment.utc(a.start).add(g(),"minutes").format("MM/DD/YYYY"),a.end=moment.utc(a.end).add(g(),"minutes").format("MM/DD/YYYY"))}function v(a){var b=function(b){return b.id===a.id};if(H=_(H).reject(b),"global"===F.type)for(var c=0,d=G.length;c<d;c++)G[c].events&&(G[c].events=_(G[c].events).reject(b))}function w(a){for(var b=["#005776","#860A0E","#DB5822","#50A3A5","#008000","#9400D3","#C71585","#D2691E","#1E90FF","#008B8B"],c=0;c<a.length;c++)a[c].color=b[c%b.length]}function x(){c.projectID?b.$broadcast(C):b.$broadcast(D)}function y(a,b,c,d){return F&&F.type===a&&moment(F.start).isSame(moment(b),"day")&&moment(F.end).isSame(moment(c),"day")&&F.timezone===(d||g())}function z(){H=[];for(var a=0;a<G.length;a++)if(G[a].isDisplayed){if(!G[a].events)continue;for(var b=0;b<G[a].events.length;b++){var c=G[a].events[b];
u(c);var d;d=c.id?_(H).findWhere({id:c.id}):_(H).findWhere({title:c.title,start:c.start,end:c.end,allDay:c.allDay,notes:c.notes}),d?(d.color="#666666",d.multiUser=!0,d.startEditable=!1):(c.color=G[a].color,c.startEditable=!1,H.push(c))}}}function A(a){var b=null;return c.projectID&&(b=d.project(),b={id:c.projectID,projectOrClientName:b.projectName||b.client.fullname,clientPictureUrl:b.client.pictureUrl}),{_new:!0,id:0,projectIDLocked:!!c.projectID,projectID:c.projectID?c.projectID:0,project:b,calendarEventID:null,calendarEventType:"Appointment",editable:!0,start:moment(a.toISOString()).format(),end:moment(a.toISOString()).add(1,"hours").format(),allDay:!1,location:"",notes:"",title:"New Calendar Event",attendees:[]}}var B={getProjectEvents:"/api/calendar/projects/{0}/?start={1}&end={2}",getSingleEventSet:"/api/calendar/events/{0}/{1}/{2}/?timezoneOffset={3}",getDisplayedEventSet:"/api/calendar/displayableevents/{0}/{1}/?timezoneOffset={2}",saveEvent:"/api/calendar/event/save",removeEvent:"/api/calendar/event/{0}/remove",getEvent:"/api/calendar/events/{0}"},C="calendarService.onProjectEventsChanged",D="calendarService.onGlobalEventsChanged",E="calendarService.onDetailRequested",F={type:null,start:null,end:null,timezone:0},G=[],H=[],I=!1,J={loadGlobalEvents:j,loadProjectEvents:i,isLoading:l,hideSingleCalendar:m,showSingleCalendar:n,renderEventSet:k,calendarOptions:o,onDetailRequested:E,onProjectEventsChanged:C,onGlobalEventsChanged:D,openNewEvent:r,openEvent:p,openEventByID:q,saveEvent:s,removeEvent:t,assignColors:w,forceNextToRefresh:h};return J}angular.module("Crops").service("calendarService",a),a.$inject=["fvApi","$rootScope","$stateParams","projectService","fvUtils","fvAlertsService"]}(),function(){"use strict";function a(a,b,c){function d(){return a.get(u.getSettings)}function e(b){return a.post(u.setSettings,[],b)}function f(){q=[],s=!0,b.$broadcast(v),a.get(u.loadViewerList).then(function(a){q=a,s=!1,b.$broadcast(v)})}function g(){return q}function h(){return s}function i(c){a.post(u.inviteViewer,[c]).then(function(a){q.push(a),b.$broadcast(v)})}function j(c){a.post(u.removeViewer,[c.viewerID]).then(function(a){for(var d=0;d<q.length;d++)q[d].viewerID===c.viewerID&&q.splice(d,1);b.$broadcast(v)})}function k(){r=[],t=!0,b.$broadcast(w),a.get(u.loadViewedList,[]).then(function(a){c.assignColors(a),r=a,t=!1,b.$broadcast(w)})}function l(){return r}function m(){return t}function n(c){a.post(u.removeViewed,[c.ownerID]).then(function(a){for(var d=0;d<r.length;d++)if(r[d].ownerID===c.ownerID){r.splice(d,1);break}b.$broadcast(w)})}function o(b){for(var d=0;d<r.length;d++)if(r[d].ownerID===b.ownerID){r[d].isDisplayed=b.isDisplayed;break}b.isDisplayed?c.showSingleCalendar(b.ownerID):c.hideSingleCalendar(b.ownerID),a.post(u.displayViewed,[b.ownerID,b.isDisplayed])}function p(b){return a.get(u.getAvailableAttendeesList,[b])}var q,r,s,t,u={loadViewerList:"/api/calendar/viewerlist",inviteViewer:"/api/calendar/viewer/invite?newInvite={0}",removeViewer:"/api/calendar/viewer/remove/{0}",loadViewedList:"/api/calendar/viewedlist",removeViewed:"/api/calendar/viewed/remove/{0}",displayViewed:"/api/calendar/viewed/display/{0}/{1}",getAvailableAttendeesList:"/api/calendar/availableAttendeesList/{0}",getSettings:"/api/calendar/settings",setSettings:"/api/calendar/settings"},v="calendarSharingService.onViewerListChanged",w="calendarSharingService.onViewedListChanged",x={loadViewerList:f,isLoadingViewerList:h,viewerList:g,inviteViewer:i,removeViewer:j,loadViewedList:k,isLoadingViewedList:m,viewedList:l,removeViewed:n,displayViewed:o,getAvailableAttendeesList:p,getSettings:d,setSettings:e,onViewerListChanged:v,onViewedListChanged:w};return x}angular.module("Crops").service("calendarSharingService",a),a.$inject=["fvApi","$rootScope","calendarService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(b,d){if(b!==d){console.log("SET globalCalendarSettings",a.settings);var e=500;j&&(f.cancel(j),e=1e3),c.setSettings(a.settings).then(function(){j&&f.cancel(j),j=f(i,e)})}}function i(){console.log("RefreshingCalendar"),b.forceNextToRefresh(),$("#full-calendar").fullCalendar("refetchEvents")}a.viewedCalendars=[],a.isLoading=!0,a.currentUserName=d.currentUser().fullname,a.viewedNames={},a.$on(c.onViewedListChanged,function(){a.viewedCalendars=c.viewedList(),a.isLoading=c.isLoadingViewedList()}),a.$on(d.onCurrentUserChanged,function(){a.currentUserName=d.currentUser().fullname}),c.getSettings().then(function(b){console.log("GET globalCalendarSettings",b),a.settings=b,a.$watch("settings",h,!0)});var j=null;c.loadViewedList(),a.toggleViewed=function(a){a.isDisplayed=!a.isDisplayed,c.displayViewed(a)},a.calendarColor=function(a){return a.isDisplayed?{"background-color":a.color}:{}},a.isSidenavOpen=!1,a.$on(e.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){e.toggleSidenav()}}angular.module("Crops").controller("CalendarSidenavController",a),a.$inject=["$scope","calendarService","calendarSharingService","currentUserService","sidenavService","$timeout","config"]}(),function(){"use strict";function a(a,b,c,d,e){function f(a,c,d,e){g=e,b.loadGlobalEvents(a,c)}var g=null,h=$("#full-calendar");a.isLoading=!0,a.$on(b.onGlobalEventsChanged,function(){null===g?h.fullCalendar("refetchEvents"):(g(b.renderEventSet()),g=null),a.isLoading=b.isLoading()}),b.forceNextToRefresh();var i=b.calendarOptions();i.events=f,h.fullCalendar(i),a.eventDetailSettings={templateUrl:"{0}/calendar/calendar.event.detail.html".format(d.viewRoot),instanceController:"calendarEventDetailController",calendarEvent:null},a.$on(b.onDetailRequested,function(b,c){if(c){if(c.start){var d=c.allDay?e.getDateOnlyMoment(c.start).format("YYYY-MM-DD")+" "+moment("2000-01-01 00:00:00.000").format("HH:mm"):c.start;c.start=moment(d).toDate()}if(c.end){var f=c.allDay?e.getDateOnlyMoment(c.end).format("YYYY-MM-DD")+" "+moment("2000-01-01 00:00:00.000").format("HH:mm"):c.end;c.end=moment(f).toDate()}var g=angular.copy(a.eventDetailSettings);g.calendarEvent=c,a.openModal(g)}}),a.openModal=function(a){c.open({animation:!0,templateUrl:a.templateUrl,controller:a.instanceController,size:"md",backdrop:"static",windowClass:"calendar-event-modal global-calendar-event-modal",keyboard:!1,resolve:{calendarEvent:function(){return a.calendarEvent}}})}}angular.module("Crops").controller("GlobalCalendarController",a),a.$inject=["$scope","calendarService","$uibModal","config","fvUtils"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(a,c,d,e){j=e,b.loadProjectEvents(a,c)}function i(){if(g.path().match(/calendar$/gi)&&g.search().year&&g.search().month){var a=g.search().year,c=g.search().month,d=g.search().day||1,e=moment([a,c-1,d]),f=moment([a,c-1]).startOf("week"),h=moment([a,c-1]).endOf("month").endOf("week");k.fullCalendar("gotoDate",e),b.loadProjectEvents(f,h),b.forceNextToRefresh(),g.search().event&&b.openEventByID(+g.search().event),g.search({})}}var j=null,k=$("#full-calendar");a.isLoading=!0,a.eventDetailModalIsOpen=!1,a.$on(b.onProjectEventsChanged,function(){null===j?k.fullCalendar("refetchEvents"):(j(b.renderEventSet()),j=null),a.isLoading=b.isLoading()}),b.forceNextToRefresh();var l=b.calendarOptions();l.events=h,k.fullCalendar(l),i(),a.$on("$locationChangeSuccess",function(){i()},!0),a.eventDetailSettings={templateUrl:"{0}/calendar/calendar.event.detail.html".format(e.viewRoot),instanceController:"calendarEventDetailController",calendarEvent:null},a.$on(b.onDetailRequested,function(b,c){if(c){if(c.start){var d=c.allDay?f.getDateOnlyMoment(c.start).format("YYYY-MM-DD")+" "+moment("2000-01-01 00:00:00.000").format("HH:mm"):c.start;c.start=moment(d).toDate()}if(c.end){var e=c.allDay?f.getDateOnlyMoment(c.end).format("YYYY-MM-DD")+" "+moment("2000-01-01 00:00:00.000").format("HH:mm"):c.end;c.end=moment(e).toDate()}var g=angular.copy(a.eventDetailSettings);g.calendarEvent=c,a.openModal(g)}}),a.openModal=function(b){if(!a.eventDetailModalIsOpen){var c=d.open({animation:!0,templateUrl:b.templateUrl,controller:b.instanceController,size:"md",backdrop:"static",windowClass:"calendar-event-modal project-calendar-event-modal",resolve:{calendarEvent:function(){return b.calendarEvent}}});a.eventDetailModalIsOpen=!0,c.result.then()["finally"](function(){a.eventDetailModalIsOpen=!1})}}}angular.module("Crops").controller("ProjectCalendarController",a),a.$inject=["$scope","calendarService","calendarSharingService","$uibModal","config","fvUtils","$location"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){a.status.isLockedForNonProjectAdmin=!e.currentUserIsAdmin()&&e.currentSection()&&e.currentSection().isLockedForNonProjectAdmin}function k(){a.status.isEditingChainName=!1,a.status.isSavingName=!1,a.status.isEditingChainDateNotes=!1,a.status.currentChainDate=null,a.status.isSavingChainDateNotes=!1,a.status.isRemovingChain=!1,a.status.isSavingChainDate=!1}var l=!1;a.status={isEditingChainName:!1,isSavingName:!1,isEditingChainDateNotes:!1,currentChainDate:null,isSavingChainDateNotes:!1,isRemovingChain:!1,isSavingChainDate:!1,isLockedForNonProjectAdmin:!0},a.canDelete=e.canDeleteItems(),a.$on("$locationChangeSuccess",function(a){var c=i.search(),d=b.currentChain();c.chainID&&d&&d.id!==c.chainID&&b.loadChainListAndSelectCurrent(c.chainID)}),a.$on(e.onStateChange,function(){a.canDelete=e.canDeleteItems(),j()}),j(),a.$on(b.onCurrentChanged,function(){a.isLoading=b.isLoading(),l=!0,a.currentChain=b.currentChain(),a.currentChain&&a.currentChain.visibleDates&&(_(a.currentChain.visibleDates).each(function(a){a.dueDateTag=g.getDueDateTag(a.dueDate,a.doneDate)}),i.search().chainID&&+i.search().chainID===a.currentChain.id||i.search("chainID",a.currentChain.id)),d(function(){l=!1}),k()}),a.$on(b.onChainTypeListChanged,function(){a.chainTypeList=_(b.chainTypeList()).sortBy(function(a){return a.name.toLowerCase()})}),a.$on(b.onChainListChanged,function(){a.isLoading=b.isLoading(),a.chainList=b.chainList()}),b.loadChainTypeList(),b.loadChainListAndSelectCurrent(i.search().chainID),a.save=function(a){b.saveChainDate(a).then(function(){},function(){h.alertFail("There was a problem saving the deadline chain. Please refresh and try again.")})},a.removeChain=function(){if(a.canDelete&&!a.status.isRemovingChain&&a.currentChain){var c="Are you sure you wish to remove the '"+a.currentChain.name+"' deadline chain and its deadline dates from the project?";f.confirm({text:c,confirmButtonText:"Remove Chain",isLoadingButtonText:"Removing Chain"},function(){return a.status.isRemovingChain=!0,b.removeChain(a.currentChain)})}},a.selectCurrentChain=function(a){b.loadChainListAndSelectCurrent(a.id)},a.openAddChainModal=function(){$("#addChainModal").modal({backdrop:"static",keyboard:!1,show:!0})},$("#addChainModal").on("hidden.bs.modal",function(){a.$apply(function(){a.newChain=null})}),a.addChain=function(c){a.isAddingChain||(a.isAddingChain=!0,b.addChain(c).then(function(){},function(){h.alertFail("There was a problem adding the deadline chain. Please refresh and try again.")})["finally"](function(){a.isAddingChain=!1,$("#addChainModal").modal("hide")}))},a.beginEditingChainName=function(){a.currentChain.newName=angular.copy(a.currentChain.name),a.status.isEditingChainName=!0,d(function(){a.$broadcast("onEditingChainName")})},a.canSaveChainName=function(){return!a.status.isSavingName&&a.currentChain.newName&&a.currentChain.newName!==a.currentChain.name},a.saveChainName=function(){a.canSaveChainName()&&(a.status.isSavingName=!0,b.updateChain(a.currentChain.id,a.currentChain.newName).then(function(){a.status.isSavingName=!1,a.cancelRenaming()},function(){a.status.isSavingName=!1,h.alertFail("There was a problem renaming the deadline chain. Please refresh and try again.")}))},a.cancelRenaming=function(){a.status.isEditingChainName=!1,a.currentChain.newName=""},a.beginEditingChainDateNotes=function(b){a.status.isEditingChainDateNotes||(a.status.currentChainDate=angular.copy(b),a.status.isEditingChainDateNotes=!0,d(function(){a.$broadcast("onEditingNotes")}))},a.saveChainDateNotes=function(c){!a.status.isSavingChainDateNotes&&a.status.currentChainDate&&a.status.currentChainDate.id===c.id&&(a.status.currentChainDate.notes!==c.notes?(a.status.isSavingChainDateNotes=!0,b.saveChainDate(a.status.currentChainDate).then(function(){a.cancelEditingNotes()},function(){h.alertFail("There was a problem saving the notes. Please refresh and try again.")})["finally"](function(){a.status.isSavingChainDateNotes=!1})):a.cancelEditingNotes())},a.cancelEditingNotes=function(){a.status.isEditingChainDateNotes=!1,a.status.currentChainDate=null},a.setCompleteDate=function(b){b.doneDate||(b.doneDate=moment().format("MM/DD/YYYY"),a.handleDoneDateChange(b))},a.handleDueDateChange=function(d){l||a.status.isSavingChainDate||!d||""!==d.dueDate&&!c.dateRegex.test(d.dueDate)||(a.status.isSavingChainDate=!0,b.saveChainDate(d).then(null,function(){a.status.isSavingChainDate=!1}))},a.handleDoneDateChange=function(d){l||a.status.isSavingChainDate||!d||""!==d.doneDate&&!c.dateRegex.test(d.doneDate)||(a.status.isSavingChainDate=!0,b.saveChainDate(d).then(null,function(){a.status.isSavingChainDate=!1}))}}angular.module("Crops").controller("ChainController",a),a.$inject=["$scope","chainService","config","$timeout","projectService","confirmService","fvUtils","fvAlertsService","$location"]}(),function(){"use strict";function a(a,b){var c=0;return{restrict:"E",replace:!0,scope:{chain:"=?",chainList:"=",placeholder:"@",disabled:"=?",formControlName:"@?",onSelect:"&?"},templateUrl:"{0}/chain/chain.selector.html".format(b.viewRoot),link:function(a,b,d){a.selectorID=c,a.chainInputID=a.formControlName?a.formControlName:"chainSelector"+c,c++,a.placeholder=a.placeholder||"Enter deadline chain name",a.noChainResults=!1,a.onChainSelected=function(b,c,d){!a.disabled&&b&&(a.onSelect&&angular.isFunction(a.onSelect)&&a.onSelect({chain:b}),a.chain=null)},a.clearInput=function(){a.chain=a.disabled?a.chain:null},a.$watch("chain",function(){a.chain||(a.noChainResults=!1)})}}}angular.module("Crops").directive("chainSelector",a),a.$inject=["fvApi","config"]}(),function(){"use strict";function a(a,b,c,d){function e(){return s=[],w=d.projectID,a.get(o.getChainTypeList,[w]).then(function(a){s=a,b.$broadcast(q)})}function f(c){return v=!0,t=[],w=d.projectID,a.get(o.getChainList,[w]).then(function(a){if(t=a,v=!1,a.length&&a.length>0){var b;c&&(b=_.findWhere(a,{id:parseInt(c)})),u=b||a[0]}else u=null})["finally"](function(){b.$broadcast(r),b.$broadcast(p)})}function g(){return s}function h(){return t}function i(){return v}function j(){return u}function k(c){return a.post(o.addChain,[w],{chainTypeID:c.id,name:c.name}).then(function(a){return t.push(a),u=a,b.$broadcast(r),b.$broadcast(p),a})}function l(c,e){return a.post(o.updateChain,[d.projectID,c],{name:e}).then(function(a){return t=_(t).map(function(b){return b.id===c?a:b}),u=a,b.$broadcast(r),b.$broadcast(p),a})}function m(e){return a.post(o.removeChain,[d.projectID,e.id]).then(function(a){c.removeFromList(t,e.id),t.length>0?(u=t[0],b.$broadcast(r),b.$broadcast(p)):(u=null,b.$broadcast(r),b.$broadcast(p))})}function n(c){var d={chainDateTypeID:c.chainDateTypeID,dueDate:c.dueDate,doneDate:c.doneDate,notes:c.notes};return a.post(o.updateChainDate,[w,c.id],d).then(function(a){return u=a,b.$broadcast(p),a})}var o={getChainList:"/api/projects/{0}/chains",getChainTypeList:"/api/projects/{0}/chaintypelist",addChain:"/api/projects/{0}/chains/create",updateChain:"/api/projects/{0}/chains/{1}/update",removeChain:"/api/projects/{0}/chains/{1}/remove",updateChainDate:"/api/projects/{0}/chaindates/{1}/update"},p="chainService.onCurrentChanged",q="chainService.onChainTypeListChanged",r="chainService.onChainListChanged",s=[],t=[],u=null,v=!1,w=-1,x={loadChainTypeList:e,loadChainListAndSelectCurrent:f,chainTypeList:g,chainList:h,currentChain:j,isLoading:i,addChain:k,updateChain:l,removeChain:m,saveChainDate:n,onChainTypeListChanged:q,onChainListChanged:r,onCurrentChanged:p};return x}angular.module("Crops").service("chainService",a),a.$inject=["fvApi","$rootScope","fvUtils","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e){c&&(a.options=c),a.isLoading=!1,a.confirm=function(){a.isLoading||(d?(a.isLoading=!0,d().then()["finally"](function(){a.isLoading=!1,b.close()})):b.close())},a.deny=function(){e?(e(),b.dismiss("denied")):b.dismiss("denied")},a.cancel=function(){b.dismiss("canceled")}}angular.module("Crops").controller("confirmModalController",a),a.$inject=["$scope","$uibModalInstance","options","onConfirm","onDeny"]}(),function(){"use strict";function a(a,b,c){function d(d,e,i){return d.type=d.type&&h.indexOf(d.type.toLowerCase())>-1?d.type.toLowerCase():g.type,d.text=d.text||g.text,d.showConfirmButton="undefined"!=typeof d.showConfirmButton?d.showConfirmButton:g.showConfirmButton,d.showCancelButton="undefined"!=typeof d.showCancelButton?d.showCancelButton:g.showCancelButton,d.cancelButtonText=d.cancelButtonText||g.cancelButtonText,d.confirmButtonText=d.confirmButtonText||g.confirmButtonText,e=e&&angular.isFunction(e)?e:null,i=i&&angular.isFunction(i)?i:null,d.showDenyButton="undefined"!=typeof d.showDenyButton?d.showDenyButton&&i:g.showDenyButton,d.denyButtonText=d.denyButtonText||g.denyButtonText,d.isLoadingButtonText=e&&d.isLoadingButtonText?d.isLoadingButtonText:d.confirmButtonText,f=a.open({animation:!0,templateUrl:"{0}/confirm/confirm.modal.html".format(b.viewRoot),controller:"confirmModalController",backdrop:"static",keyboard:!1,size:"md",windowClass:"fv-confirm-modal "+d.type,resolve:{options:function(){return d},onConfirm:function(){return e},onDeny:function(){return i}}}),f.result.then(function(){return c.resolve(!0)},function(a){return c.reject(a)})}function e(){f&&f.dismiss()}var f,g={type:"danger",text:"Are you sure?",showConfirmButton:!0,confirmButtonText:"Yes",showCancelButton:!0,cancelButtonText:"Cancel",showDenyButton:!1,denyButtonText:"No"},h=["danger","warning","success","info"],i={confirm:d,close:e};return i}angular.module("Crops").service("confirmService",a),a.$inject=["$uibModal","config","$q"]}(),function(){"use strict";function a(a,b){a.checkList=[],a.isLoading=!0,a.$on(b.onCheckListChanged,function(){a.checkList=b.checkList(),a.isLoading=b.isLoading()}),b.loadCheckList(),a.startNewCheck=function(){b.startNewCheck()},a.formatDate=function(a){if(a)return moment(a).format("M/D/YYYY [at] h:mm:ss a")}}angular.module("Crops").controller("ConflictCheckController",a),a.$inject=["$scope","conflictCheckService"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{},templateUrl:"{0}/conflictchecks/conflict.check.editor.html".format(b.viewRoot),link:function(b){function c(){b.nameChecked="",b.showResults=!1,b.nameCheckForm.$setPristine()}b.conflictList=[],b.nameChecked="";var d=$("#conflictCheckModal");b.$on(a.onStartNewCheck,function(){d.modal("show")}),b.$on(a.onConflictListChanged,function(c,d){b.nameChecked===d&&(b.showResults=!0,b.conflictList=a.conflictList())}),b.hideConflict=function(a){a.hide=!0},b.showAll=function(){for(var a=0;a<b.conflictList.length;a++)b.conflictList[a].hide=!1},b.isHiddenConflicts=function(){for(var a=0;a<b.conflictList.length;a++)if(b.conflictList[a].hide)return!0;return!1},b.isHiddenAllConflicts=function(){for(var a=0;a<b.conflictList.length;a++)if(!b.conflictList[a].hide)return!1;return!0},b.searchForConflicts=function(){b.nameChecked&&a.loadConflictList(b.nameChecked)},b.noConflict=function(){a.saveNewCheck({nameChecked:b.nameChecked,isSuccess:!0}),d.modal("hide")},b.conflict=function(){a.saveNewCheck({nameChecked:b.nameChecked,isSuccess:!1}),d.modal("hide")},d.on("shown.bs.modal",function(){b.$broadcast("onConflictCheckModalOpen")}).on("hidden.bs.modal",function(){c()})}}}angular.module("Crops").directive("conflictCheckEditor",a),a.$inject=["conflictCheckService","config"]}(),function(){"use strict";function a(a,b,c,d){function e(){s=!0,q=[],t=d.projectID,a.get(m.getList,[t]).then(function(a){q=a,s=!1,b.$broadcast(n)})}function f(c){s=!0,r=[],t=d.projectID,a.post(m.check,[t],{nameChecked:c}).then(function(a){r=a,s=!1,b.$broadcast(o,c)})}function g(){return q}function h(){return r}function i(){return s}function j(){b.$broadcast(p)}function k(c){a.post(m.create,[t],c).then(function(a){q.push(a),b.$broadcast(n)})}function l(d){a.post(m.remove,[t,d.id]).then(function(a){c.removeFromList(q,d.id),b.$broadcast(n)})}var m={getList:"/api/projects/{0}/conflictchecks",create:"/api/projects/{0}/conflictchecks/create",check:"/api/projects/{0}/conflictchecks/check",remove:"/api/projects/{0}/conflictchecks/{1}/remove"},n="conflictCheckService.onCheckListChanged",o="conflictCheckService.onConflictListChanged",p="conflictCheckService.onStartnewCheck",q=[],r=[],s=!1,t=-1,u={loadCheckList:e,loadConflictList:f,checkList:g,conflictList:h,isLoading:i,startNewCheck:j,saveNewCheck:k,removeCheck:l,onCheckListChanged:n,onConflictListChanged:o,onStartNewCheck:p};return u}angular.module("Crops").service("conflictCheckService",a),a.$inject=["fvApi","$rootScope","fvUtils","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{contact:"=",isAdding:"="},replace:!0,templateUrl:"{0}/contacts/contact.card.html".format(a.viewRoot),link:function(f){f.canDelete=e.canDeleteItems(),f.projectEmailAddress=e.project()?e.project().emailAddress:null,f.$on(e.onStateChange,function(){f.projectEmailAddress=e.project()?e.project().emailAddress:null,f.canDelete=e.canDeleteItems()}),f.options={isEditing:!1,isSaving:!1,isAdding:f.isAdding||!1},f.onContactCardClicked=function(){f.options.isAdding||f.options.isEditing||f.showContactDetail()},f.showContactDetail=function(a){a&&a.stopPropagation(),null!==f.contact&&null!==f.contact.person&&b.show(f.contact.person,null,null)},f.beginEditing=function(a){a.stopPropagation(),f.contact.oldRole=angular.copy(f.contact.role),f.options.isEditing=!0},f.cancelEditing=function(a){a.stopPropagation(),f.contact.role=f.contact.oldRole,delete f.contact.oldRole,f.options.isEditing=!1},f.canSave=function(){return!f.options.isSaving&&!f.options.isAdding&&!angular.equals(f.contact.role,f.contact.oldRole)&&f.options.isEditing&&!f.contact.readonly},f.save=function(a,b){a.stopPropagation(),f.canSave()&&(f.options.isSaving=!0,c.save(d.projectID,b).then(function(){delete f.contact.oldRole,f.options.isEditing=!1},function(a){console.log("Contact save failed:"+a)})["finally"](function(){f.options.isSaving=!1}))},f.$on(a.globalSaveHotkeyPressed,function(a,b,c){f.canSave()&&f.save(c,f.contact)}),f.canRemove=function(){return f.contact&&f.contact.id&&!f.contact.readonly&&f.canDelete},f.remove=function(a){if(a.stopPropagation(),f.canRemove()){var b="Are you sure you wish to remove ";b+=f.contact&&f.contact.person&&f.contact.person.fullname?f.contact.person.fullname:"this contact",b+=" from the project's contacts?",g.confirm({text:b,confirmButtonText:"Remove Contact",isLoadingButtonText:"Removing Contact"},function(){return c.remove(f.contact)})}}}}}angular.module("Crops").directive("contactCard",a),a.$inject=["config","personPanelService","contactService","$stateParams","projectService","nameService","confirmService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){e.search().contactID&&a.singleContactID!==+e.search().contactID&&+e.search().contactID>0?a.singleContactID=+e.search().contactID:a.singleContactID=""}c.loadContacts(!0),a.singleContactID="",a.projectID=h.projectID,d.enabled(!1),a.isAdding=!1,a.$on(c.onContactListChanged,function(){a.isLoading=c.isLoading(),a.contactList=c.contactList()}),a.newOne=function(){return angular.copy({id:0,role:"",personID:0,person:{id:0,fullname:""},readonly:!1})},a.newContact=a.newOne(),a.add=function(){a.newContact=a.newOne(),a.isAdding=!0},a.$on("$locationChangeSuccess",function(){i()}),i(),a.clearSingleContactIDFilter=function(){e.search({})},a.$on("$stateChangeStart",function(){var a=angular.element('[name="contactEditForm"]');a.scope()&&angular.isFunction(a.scope().resetModel)&&a.scope().resetModel()}),a.$on("formReset",function(b,c){if(c){var d;a.contactList.forEach(function(a,b){a.id===c.id&&(d=b)}),c.current=!1,a.contactList[d]=c,a.currentContact=null,a.isAdding=a.isEditing=!1}}),a.$on("contactRemoved",function(b,c){for(var d=0,e=a.contactList.length;d<e;d++)if(a.contactList[d].id===c.id){a.contactList.splice(d,1);break}a.isEditing=!1,a.currentContact=null}),a.$on("contactAdded",function(b,c){c.isNew=!1,a.contactList.unshift(c),a.isAdding=!1,a.contactFilter="",e.hash("first"),f(),g(function(){e.hash(c.id),f()})})}angular.module("Crops").controller("ContactController",a),a.$inject=["$scope","$rootScope","contactService","$animate","$location","$anchorScroll","$timeout","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",scope:{contact:"="},templateUrl:"{0}/contacts/contact.editor.html".format(e.viewRoot),link:function(a){function g(b){a.creatingContact||(a.creatingContact=!0,c.save(d.projectID,b).then(function(b){b.isNew&&a.$emit("contactAdded",b)},function(a){console.log("Contact save failed:"+a)})["finally"](function(){a.$emit("resetCurrent"),a.creatingContact=!1}))}a.creatingContact=!1,a.selectPerson=function(b){a.contact.person=b},a.canDelete=b.canDeleteItems(),a.$on(b.onStateChange,function(){a.canDelete=b.canDeleteItems()}),a.save=function(a){if(a.person&&a.person.fullname&&a.person.fullname.trim()){if(!a.person.id)return void f.alertFail("Select a Person, or create a new person");a.personID=a.person.id,g(a)}},a.$on(e.globalSaveHotkeyPressed,function(b,c,d){d.currentTarget.contactEditForm&&a.save(a.contact)})}}}angular.module("Crops").directive("contactEditor",a),a.$inject=["$rootScope","projectService","contactService","$stateParams","config","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(c){b.projectID&&(b.projectID!==r||c)&&(q=!0,p=[],d.$broadcast(n),r=b.projectID,a.get(m.getContacts,[b.projectID]).then(function(a){p=a,q=!1,d.$broadcast(n)}))}function g(){return p}function h(){return q}function i(b,d){var e=c.defer();return a.post(m.addContact,[b],d).then(function(a){d.id=a.id,d.isNew=!0,e.resolve(d)},function(a){e.reject(a)}),e.promise}function j(c){return a.post(m.updateContact,[b.projectID,c.id],c)}function k(a,b){return b.id?j(b):i(a,b)}function l(c){return a.del(m.removeContact,[b.projectID,c.id]).then(function(){q=!0,d.$broadcast(n),p=_(p).reject(function(a){return a.id===c.id}),q=!1,d.$broadcast(n);var a=c.person&&c.person.fullname?c.person.fullname+" has been removed":"This contact has been removed";e.alertSuccess(a)},function(){var a="We were unable to remove ";a+=c.person&&c.person.fullname?c.person.fullname:"this contact",a+=". Please refresh and try again.",e.alertFail(a)})}var m={getContacts:"/api/projects/{0}/contacts",addContact:"/api/projects/{0}/contacts/create",updateContact:"/api/projects/{0}/contacts/{1}/update",addContactPerson:"/api/people",removeContact:"api/projects/{0}/contacts/{1}/remove"},n="contactService.onContactListChanged",o={loadContacts:f,contactList:g,isLoading:h,add:i,update:j,save:k,remove:l,onContactListChanged:n},p=[],q=!1,r=-1;return o}angular.module("Crops").service("contactService",a),a.$inject=["fvApi","$stateParams","$q","$rootScope","fvAlertsService"]}(),function(){"use strict";function a(a,b){a.oldPassword=a.newPassword=a.newPasswordConfirm="",a._enabled=!0,a.enabled=function(){return a._enabled},a.changePassword=function(){a._enabled=!1,b.put("/api/users/{1}/password",[Crops.currentUserID],{oldPassword:a.oldPassword,newPassword:a.newPassword}).then(function(){a.oldPassword=a.newPassword=a.newPasswordConfirm="",a._enabled=!0,$("#changePasswordModal").modal("hide")})}}angular.module("Crops").controller("ChangePasswordController",a),a.$inject=["$scope","fvApi"]}(),angular.module("Signup",[]).controller("SignupController",["$scope","$http","$q","$sce","fvAlertsService",function(a,b,c,d,e){function f(){var d=c.defer();return l.indexOf(a.signup.email)>-1||/\'/gi.test(a.signup.email)?d.reject():(a.isLoading=!0,b.get(i.format(null,encodeURIComponent(a.signup.email))).then(function(b){b.data.success||(l.push(a.signup.email),d.reject()),d.resolve()},function(){l.push(a.signup.email),d.reject()})),d.promise}function g(){var d=c.defer();return a.isLoading=!0,b.post(j,JSON.stringify({response:$("#g-recaptcha-response").val()})).then(function(a){d.resolve(a)},function(){d.reject()}),d.promise}var h="",i="{0}/signup/checkemail?email={1}".format(h),j="{0}/signup/checkcaptcha".format(h),k="{0}/signup/create".format(h),l=[];a.isLoading=!1,a.emailChecked=!1,a.emailValid=!0,a.passwordsChecked=!1,a.passwordsMatch=!0,a.passwordsPass=!0,a.showCaptchaError=!1,a.addressInUse=d.trustAsHtml('Email Address in use - <a href="/account/forgotpassword">Forgot Password</a>'),a.signup={firstname:"",lastname:"",email:"",password:"",passwordConfirm:"",username:""},a.viewTOS=function(){a.noClickTOS=!1},a.viewPrivacy=function(){a.noClickPrivacy=!1},a.sendSignup=function(){f().then(function(){return a.emailValid=!0,a.signup.password!==a.signup.passwordConfirm?(a.passwordsChecked=!0,void(a.passwordsMatch=a.isLoading=!1)):/^(?=.{8})(?=.*[^a-zA-Z])/.test(a.signup.password)?(a.passwordsChecked=a.passwordsMatch=a.passwordsPass=!0,a.noClickTOS=!1,a.noClickPrivacy=!1,angular.isUndefined(a.signup.confirmTOS)||a.signup.confirmTOS===!1?(a.noClickTOS=!0,void(a.isLoading=!1)):angular.isUndefined(a.signup.confirmPrivacy)||a.signup.confirmPrivacy===!1?(a.noClickPrivacy=!0,void(a.isLoading=!1)):void g().then(function(c){var d=JSON.parse(c.data);return d.success===!1?(a.isLoading=!1,void(a.showCaptchaError=!0)):(a.signup.firstname=a.signup.firstname.replace('"',"").replace("'",""),a.signup.lastname=a.signup.lastname.replace('"',"").replace("'",""),void b.post(k,JSON.stringify(a.signup)).then(function(b){b.data.success?location.href="/":(a.isLoading=!1,e.alertFail("Unable to signup at this time. Please try again later."))},function(b){console.log(b),a.isLoading=!1,e.alertFail("Unable to signup at this time. Please try again later.")}))},function(b){console.log(b),a.isLoading=!1,e.alertFail("Unable to signup at this time. Please try again later.")})):(a.passwordsChecked=a.passwordsMatch=!0,void(a.passwordsPass=a.isLoading=!1))},function(){a.emailValid=!1,a.isLoading=!1,angular.element('[name="signupEmail"]').focus().select()})["finally"](function(){a.emailChecked=!0})},a.$watch("signup.email",function(b){a.emailValid=l.indexOf(b)<0})}]).directive("fvFormAutofillFix",function(){return function(a,b,c){b.prop("method","POST"),c.ngSubmit&&setTimeout(function(){b.unbind("submit").submit(function(d){d.preventDefault(),b.find("input, textarea, select").trigger("input").trigger("change").trigger("keydown"),a.$apply(c.ngSubmit)})},0)}}),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(){a.isSortingList={},a.isEditingUrlField={},a.isAddingPersonListItem={}}function x(){i.search().item&&a.singleItemID!==i.search().item?a.singleItemID=i.search().item:a.singleItemID=""}function y(){a.sectionUiSettings=v.getCustomSectionUiSettings(e.sectionName),a.isCollection&&(a.sectionUiSettings.tabularViewColSettings=a.sectionUiSettings.tabularViewColSettings||{},a.collection.isTabularView=a.sectionUiSettings.isTabularView,a.collection.isExpanded=a.sectionUiSettings.isExpanded)}function z(){a.projectID=e.projectID,a.canDelete=l.canDeleteItems(),a.isAdmin=a.canDelete,a.isReadonly=G(),null!==l.project()&&(a.primafactLink=p.replaceParams("http://cloud.primafact.com/action/opencase?fvClientId={0}&fvProjectId={1}&fvProjectName={2}",[l.project().orgID,e.projectID,l.project().projectName||l.project().client.fullname])),F(),X=o.subscribeToSection(e.projectID,e.sectionName),a.createActionButtonLink=function(a){return D(a)}}function A(a,b){for(var c=0;c<b.length;c+=1)if(b[c]._id===a)return c;return-1}function B(){!a.collection||a.isAdding||a.isEditing||!a.collection.filteredItems||!a.collection.filteredItems.length||a.collection.isTabularView||a.collection.isExpanded||k(function(){
a.collection.showExpandedItemBtn=_(a.collection.filteredItems).any(function(a){var b=angular.element("#"+a._id+" .project-item-body .custom-item-scroll-container");return b&&b[0]&&b[0].scrollHeight>b[0].clientHeight})})}function C(b){if(b){var c=A(b._id,a.sectionData.collection),d=A(b._id,a.collection.filteredItems);c>-1&&(Object.keys(a.updatedPersonFields).length&&_(a.updatedPersonFields).each(function(a,c){b[c]=a}),Object.keys(a.updatedPersonLists).length&&_(a.updatedPersonLists).each(function(a,c){b[c]=angular.copy(a)}),a.sectionData.collection[c]=b,d&&(a.collection.filteredItems[d]=b)),a.item=null,a.updatedPersonFields={},a.updatedPersonLists={},a.hasChangedPerson=!1,a.uploads=[],L(),a.hasRemovedDocs=!1,w(),a.customListItemsChanged=!1}}function D(a){if(a=a.toLowerCase(),l.project()){var b=l.project();a=a.replace("{{projectname}}",encodeURIComponent(b.projectName||b.client.fullname)),a=a.replace("{{projectid}}",encodeURIComponent(b.id)),a=a.replace("{{orgid}}",encodeURIComponent(b.orgID)),a=a.replace("{{projectemail}}",encodeURIComponent(b.emailAddress)),a=a.replace("{{projectsmsnumber}}",encodeURIComponent(b.smsNumber)),b.client&&(a=a.replace("{{clientname}}",encodeURIComponent(b.client.fullname)),a=a.replace("{{clientfirstname}}",encodeURIComponent(b.client.firstName)),a=a.replace("{{clientlastname}}",encodeURIComponent(b.client.lastName)),b.client.emails&&b.client.emails.length&&(a=a.replace("{{clientemail}}",encodeURIComponent(b.client.emails[0].address))))}if(q.vitalsList())for(var c=q.vitalsList(),d=0;d<c.length;d++)a=a.replace("{{"+c[d].fieldName+"}}",encodeURIComponent(c[d].value)),a=a.replace("{{"+c[d].friendlyName+"}}",encodeURIComponent(c[d].value));return a}function E(){F(),c.setIsEditingItem(!1)}function F(){X&&(o.unsubscribeToSection(X,e.sectionName),X=null)}function G(){var a=l.project()&&e.sectionName?_(l.project().sections).findWhere({internalName:e.sectionName}):null;return!a||a.isReadonly}function H(b){var c=!1;if(a.hasCompletedUploads())for(var d=0,e=a.uploads.length;d<e;d++){var f=a.uploads[d];b[f.fieldName]={id:f.id},c=!0}for(var g in a.completedMultiDocUploads)if(a.completedMultiDocUploads.hasOwnProperty(g)){b[g]=b[g]||[];var h=b[g].length;J(g,b);var i=b[g].length;c=c||h!==i}return c}function I(){var a=angular.element('[name="itemEditForm"]');a.scope()&&angular.isFunction(a.scope().resetModelToHere)&&a.scope().resetModelToHere()}function J(b,c){c[b]=c[b]||[],a.completedMultiDocUploads[b].forEach(function(a){a.hideInUploader(),_(c[b]).any(function(b){return b.id===a.id})||c[b].push({id:a.id})})}function K(){for(var b in a.completedMultiDocUploads)if(a.completedMultiDocUploads.hasOwnProperty(b)&&a.completedMultiDocUploads[b].length>0)return!0;return!1}function L(){a.completedMultiDocUploads=_(a.completedMultiDocUploads).each(function(a,b,c){c[b]=[]}),a.hasPendingMultiDocUploads=_(a.hasPendingMultiDocUploads).each(function(a,b,c){c[b]=!1})}function M(b){return b&&a.sectionData&&a.sectionData.collection&&_(a.sectionData.collection).any(function(a){return a[b]||a[b]===!1})}function N(b){var c=angular.element(b).attr("id");c&&(a.collection.tabularView.colSettings[c]=a.collection.tabularView.colSettings[c]||{},a.$apply(function(){a.collection.tabularView.colSettings[c].isResizing=!0}))}function O(b){var c=angular.element(b).attr("id");if(c){a.collection.tabularView.colSettings[c].isResizing=!1;var d=angular.element(b).outerWidth();d&&(a.collection.tabularView.colSettings[c].width=d+"px",a.collection.tabularView.isEditing||(a.sectionUiSettings.tabularViewColSettings[c]=a.sectionUiSettings.tabularViewColSettings[c]||{},a.sectionUiSettings.tabularViewColSettings[c].width=d+"px",a.saveSectionUiSettings()))}}function P(){a.taskflowActionButton={isLoading:{},isResetting:{},isTriggering:{},history:{}}}function Q(b,d){return a.taskflowActionButton.isTriggering[d]||(a.taskflowActionButton.isTriggering[d]={}),a.taskflowActionButton.isTriggering[d][b]=!0,c.triggerTaskflowActionButton(e.projectID,e.sectionName,d,b).then(function(c){a.taskflowActionButton.history[d]||(a.taskflowActionButton.history[d]={}),a.taskflowActionButton.history[d][b]=c})["finally"](function(){a.taskflowActionButton.isTriggering[d][b]=!1})}function R(a,b){return c.prepareSendEmailLink(e.projectID,e.sectionName,b,a).then(function(a){window.location.href=a},function(a){console.log(a)})}function S(){if(a.functionsToRunOnRefresh&&a.functionsToRunOnRefresh.length)for(var b=0;b<a.functionsToRunOnRefresh.length;b++)a.functionsToRunOnRefresh[b]()}function T(b){a.item&&b&&(a.item[b]=a.item[b]||{})}function U(b,c){a.item&&b&&(a.isEditingUrlField[b]=c?!a.item[b]||!a.item[b].length:!a.item[b])}function V(b){a.item&&b&&a.getTaskflowActionButtonHistory(a.item._id,b)}a.isSaving=!1;var W=!1,X=null;a.$on("$destroy",E),a.isLoading=!0,a.singleItemID="",a.editingLink={},a.isPrintingSingleItem=!1,a.isPrintingSingleItemId={},a.customListItemsChanged=!1,a.isSortingList={},a.isEditingUrlField={},a.isAddingPersonListItem={},a.overrideCollectionListItemLimit=!1,a.sectionUiSettings={},a.primafactLink="",a.$on(l.onStateChange,z),a.currentSection=l.currentSection(),a.$on(l.onCurrentSectionChanged,function(){a.currentSection=l.currentSection()}),a.newOne=function(a){return{_entered:moment.utc(Date.now()),_isNew:a}},a.sectionData={customObject:a.newOne(!0)},f.enabled(!1),a.$on("$locationChangeSuccess",function(){x()}),x(),a.clearSingleItemIDFilter=function(){i.search({})},a.$on("$stateChangeStart",function(){if("undefined"==typeof b.ignoreStateChangeStart||!angular.isFunction(b.ignoreStateChangeStart)||!b.ignoreStateChangeStart()){var a=angular.element('[name="itemEditForm"]');a.scope()&&angular.isFunction(a.scope().resetModel)&&a.scope().resetModel()}}),a.$watch("isEditing",function(b,d){b!==!0&&b!==!1||b===d||c.setIsEditingItem(a.isEditing)}),a.saveSectionUiSettings=function(){v.setCustomSectionUiSettings(e.sectionName,a.sectionUiSettings)},a.initSingle=function(){P(),a.collection=void 0,a.settings=void 0,a.functionsToRunOnRefresh=[],c.getSectionData(e.projectID,e.sectionName).then(function(c){a.sectionData=c,a.isCollection=!1,a.updatedPersonFields={},a.updatedPersonLists={},a.sectionData.customObject=a.sectionData.customObject||a.newOne(!1),a.item=a.sectionData.customObject,a.isEditing=!0,a.isLoading=!1,b.$broadcast("projectSectionViewLoaded")},function(a){console.log(a)}),y(),a.$on(v.onUiSettingsChanged,function(){y()}),z(),a.saveItem=function(b){a.isSaving=!0;H(b);return c.updateObject(e.projectID,e.sectionName,b).then(function(b){return a.item=null,a.sectionData.customObject=b||a.newOne(!1),a.item=a.sectionData.customObject,a.updatedPersonFields={},a.updatedPersonLists={},a.uploads=[],L(),a.hasRemovedDocs=!1,a.hasChangedPerson=!1,a.hasChangedProjectLink=!1,w(),I(),S(),a.isSaving=!1,a.customListItemsChanged=!1,a.nonCollectionItemID},function(b){return a.isSaving=!1,u.alertFail("There was a problem saving this item. "+b,null,!0),console.error(b),s.reject(b)})},a.$on("formReset",function(b,c){c&&(Object.keys(a.updatedPersonFields).length&&_(a.updatedPersonFields).each(function(a,b){c[b]=a}),Object.keys(a.updatedPersonLists).length&&_(a.updatedPersonLists).each(function(a,b){c[b]=angular.copy(a)}),a.sectionData.customObject=c,a.item=a.sectionData.customObject,a.updatedPersonFields={},a.updatedPersonLists={},a.hasChangedPerson=!1,a.hasChangedProjectLink=!1,a.uploads=[],L(),a.hasRemovedDocs=!1,a.customListItemsChanged=!1,S())})},a.initCollection=function(){P(),a.isCollection=!0,a.functionsToRunOnRefresh=[],a.settings={isMobile:n.innerWidth<480},a.collection={filteredItems:[],showExpandedItemBtn:!0,isTabularView:!1,isExpanded:!1,tabularView:{resizer:{table:{},mode:"OverflowResizer",options:{onResizeEnded:O,onResizeStarted:N,colWidthContainerClass:"col-width-container"}},isEditing:!1,colSettings:{},colSettingsEditingCopy:null,colStyle:function(b){return b&&a.collection.tabularView.colSettings[b]&&a.collection.tabularView.colSettings[b].width?{}:{width:a.collection.tabularView.colSettings[b].width}}}},c.getSectionData(e.projectID,e.sectionName).then(function(c){a.sectionData=c,a.sectionData.collection||(a.sectionData.collection=[]),a.isLoading=!1,b.$broadcast("projectSectionViewLoaded")}),y(),a.$on(v.onUiSettingsChanged,function(){y()}),z(),a.isListExpanded={},a.item=null,a.updatedPersonFields={},a.updatedPersonLists={},a.isAdding=a.isEditing=!1,a.sectionTotal=function(b){return _(a.sectionData.collection).pluck(b).reduce(function(a,b){return b?a+b:a},0)},a.isCurrent=function(b){return b&&a.item&&b._id===a.item._id},a.addItem=function(){a.isAdding=!0;var b=a.newOne(!0);a.editItem(b)},a.editItem=function(b){a.item=angular.copy(b),a.isEditing=!0,k(function(){i.hash("first"),j(),i.hash(null)})},a.$on("formReset",function(b,c){c&&(C(c),a.isAdding=a.isEditing=!1,a.functionsToRunOnRefresh=[],k(function(){i.hash(c._id),j(),i.hash(null)}),a.item=null,a.updatedPersonFields={},a.updatedPersonLists={},a.hasChangedPerson=!1,a.hasChangedProjectLink=!1,a.uploads=[],L(),a.hasRemovedDocs=!1,w(),a.customListItemsChanged=!1,a.isAdding=a.isEditing=!1)}),a.saveItem=function(b,d){a.isSaving=!0;H(b);return c.saveItem(e.projectID,e.sectionName,b).then(function(c){if(b._isNew)a.sectionData.collection.unshift(c),a.collection.filteredItems.unshift(c);else{for(var e=0;e<a.sectionData.collection.length;e++)if(a.sectionData.collection[e]._id===c._id){a.sectionData.collection[e]=c;break}for(var f=0;f<a.collection.filteredItems.length;f++)if(a.collection.filteredItems[f]._id===c._id){a.collection.filteredItems[f]=c;break}}return a.item=null,a.updatedPersonFields={},a.updatedPersonLists={},a.uploads=[],L(),a.hasChangedPerson=!1,a.hasChangedProjectLink=!1,a.hasRemovedDocs=!1,a.isAdding=!1,w(),a.customListItemsChanged=!1,d?(a.isEditing=!0,a.item=c,I(),S()):a.isEditing=!1,k(function(){i.hash(c._id),j(),i.hash(null)}),a.isSaving=!1,c._id},function(b){return console.error(b),u.alertFail("There was a problem saving this item. "+b,null,!0),a.isSaving=!1,s.reject(b)})},a.removeItem=function(b){a.isRemovingItem=!0,r.confirm({text:"Are you sure you wish to permanently remove this item?",confirmButtonText:"Remove Item",isLoadingButtonText:"Removing Item"},function(){return c.removeItem(e.projectID,e.sectionName,b._id).then(function(){for(var c=0,d=a.sectionData.collection.length;c<d;c++)if(a.sectionData.collection[c]._id===b._id){a.sectionData.collection.splice(c,1);break}a.isEditing=!1,a.currentConfig=null,i.hash("first"),j(),i.hash(null)},function(a){console.error(a)})["finally"](function(){a.isRemovingItem=!1})})},a.isFirstItem=function(b){return b&&a.collection.filteredItems&&a.collection.filteredItems.length&&b===a.collection.filteredItems[0]._id},a.isLastItem=function(b){return b&&a.collection.filteredItems&&a.collection.filteredItems.length&&b===a.collection.filteredItems[a.collection.filteredItems.length-1]._id},a.gotoFirstItem=function(b,c){a.collection.filteredItems&&a.collection.filteredItems.length&&a.$broadcast("onExitingSavableView",function(){C(b),c.$setPristine(),c.$setUntouched(),a.editItem(a.collection.filteredItems[0]),S()})},a.gotoLastItem=function(b,c){a.collection.filteredItems&&a.collection.filteredItems.length&&a.$broadcast("onExitingSavableView",function(){C(b),c.$setPristine(),c.$setUntouched(),a.editItem(a.collection.filteredItems[a.collection.filteredItems.length-1]),S()})},a.gotoPreviousItem=function(b,c){if(b&&b._id&&a.collection.filteredItems&&a.collection.filteredItems.length){var d=A(b._id,a.collection.filteredItems);d>0&&a.$broadcast("onExitingSavableView",function(){C(b,c),c.$setPristine(),c.$setUntouched(),a.editItem(a.collection.filteredItems[d-1]),S()})}},a.gotoNextItem=function(b,c){if(b&&b._id&&a.collection.filteredItems&&a.collection.filteredItems.length){var d=A(b._id,a.collection.filteredItems);d<a.collection.filteredItems.length-1&&d>-1&&a.$broadcast("onExitingSavableView",function(){C(b),c.$setPristine(),c.$setUntouched(),a.editItem(a.collection.filteredItems[d+1]),S()})}};var d=_.debounce(function(){a.$apply(function(){a.settings.isMobile=n.innerWidth<480,a.collection.isTabularView||B()})},250);angular.element(n).bind("resize",d),a.$on("$destroy",function(){angular.element(n).unbind("resize",d)}),a.$watch("collection.itemFilter",function(){a.collection.isTabularView||k(B)}),a.$watch("collection.isTabularView",function(a,b){b&&!a&&k(B)}),a.$watch("isEditing",function(a,b){b&&!a&&k(B)});var f=a.$watch("collection.filteredItems",function(){a.collection.filteredItems&&(k(B),f())})},a.getDateOnlyView=function(a){var b=p.getDateOnlyMoment(a);return p.replaceParams("{0}/{1}/{2}",[b.month()+1,b.date(),b.year()])},a.uploads=[],a.completedMultiDocUploads={},a.hasPendingMultiDocUploads={},a.showUpload=function(b){return!(a.isReadonly||a.item&&(a.item[b]||_.any(a.uploads,function(a){return a.fieldName===b})))},a.hasCompletedUploads=function(){return 0!==a.uploads.length&&!_.any(a.uploads,function(a){return a.id===-1})||K()},a.$on("uploadStart",function(){W=!0}),a.$on("uploadComplete",function(){W=!1,a.$apply()}),a.uploadDoc=function(b,c){!a.isReadonly&&c.length>0&&a.$apply(function(){a.item[b]=null,a.uploads.push({file:c[0],percent:0,id:-1,projectID:e.projectID,fieldName:b})})},a.hasRemovedDocs=!1,a.removeDoc=function(b,c){return a.isReadonly?s.reject("Section is readonly"):(a.hasRemovedDocs=!0,a.item[b]=null,s.resolve("Doc removed from custom item"))},a.removeDocListDoc=function(b,c){return a.isReadonly?s.reject("Section is readonly"):(a.hasRemovedDocs=!0,a.item[b]=_(a.item[b]).reject(function(a){return a.id===c.id}),s.resolve("Doc removed from custom item doclist"))},a.removeUpload=function(b){if(!a.isReadonly){var c=a.uploads.indexOf(b);c>=0&&a.uploads.splice(c,1)}},a.savePerson=function(b,c){a.updatedPersonFields[c]||null===a.updatedPersonFields[c]||(a.updatedPersonFields[c]=angular.copy(a.item[c])||null);var d=null===b&&null===a.updatedPersonFields[c]||b&&b.id&&a.updatedPersonFields[c]&&a.updatedPersonFields[c].id===b.id;d&&(a.updatedPersonFields[c]=b),a.item[c]=b,a.hasChangedPerson=!d},a.setProjectLink=function(b,c){a.item[c]=b,a.hasChangedProjectLink=!0},a.generateDoc=function(b,d,f){if(f.stopPropagation(),b[d]={isPending:!0},a.isCollection)for(var g=0,h=a.sectionData.collection.length;g<h;g++)if(a.sectionData.collection[g]._id===b._id){a.sectionData.collection[g][d]={isPending:!0};break}var i=a.isCollection?b._id:null;c.generateDoc(e.projectID,e.sectionName,i,d).then(function(){b[d]={isPending:!0}},function(a){console.log("generateDoc error: ",a),b[d]={isPending:!0,error:a}})},a.needsSave=function(b){return a.customListItemsChanged||a.hasChangedPerson||a.hasChangedProjectLink||a.hasCompletedUploads()||a.hasRemovedDocs||b},a.canSave=function(b){return!a.isSaving&&!a.isRemovingItem&&b&&!W&&!a.isReadonly},a.showUrlErrorMessage=function(a){return a&&!d.emailRegex.test(a)&&!d.urlRegex.test(a)},a.deadlineDone=function(b){if(!a.isReadonly){a.item[b]||(a.item[b]={});var c=moment(Date()).format("MM/DD/YYYY");a.item[b].doneDate?a.item[b].doneDate="":a.item[b].doneDate=c,this.itemEditForm.$setDirty()}},a.isEmail=function(a){return!(!a||!a.match(d.emailRegex)&&!a.match(/^mailto:/))},a.printPage=function(){a.overrideCollectionListItemLimit=!0,k(function(){n.print(),a.overrideCollectionListItemLimit=!1},500)},a.printItem=function(b){a.isPrintingSingleItem=!0,a.isPrintingSingleItemId[b]=!0,k(function(){n.print(),a.isPrintingSingleItem=!1,a.isPrintingSingleItemId[b]=!1})},t.bindTo(a).add({combo:"mod+p",description:"print",callback:function(b,c){b.preventDefault(),a.isCollection?a.item?a.printItem(a.item._id):a.printPage():a.printItem(a.item._id)}}),a.$on("docresponse-ready",function(b,c){console.log("docresponse-ready received: ",c),a.$applyAsync(function(){if(e.projectID===c.projectID.toString()){if(a.isCollection)for(var b=0,d=a.sectionData.collection.length;b<d;b++)if(a.sectionData.collection[b]._id===c.itemGuid){a.sectionData.collection[b][c.fieldName]=c.docResponse,a.sectionData.collection[b][c.fieldName].isPending=!1;break}a.isCollection&&a.item._id!==c.itemGuid||(a.item[c.fieldName]=c.docResponse,a.item[c.fieldName].isPending=!1),I()}})});var Y={"default":"200px",Date:"120px",Deadline:"120px",Boolean:"90px",PersonLink:"280px",Text:"360px",TextLarge:"360px",DocList:"360px",PersonList:"360px"};a.toggleCollectionView=function(b){b&&(a.collection.isTabularView="tabular"===b,a.collection.isExpanded="cardsExpanded"===b,a.sectionUiSettings=a.sectionUiSettings||{},a.sectionUiSettings.isTabularView=a.collection.isTabularView,a.sectionUiSettings.isExpanded=a.collection.isExpanded,a.collection.tabularView.isEditing&&a.cancelTabularViewConfig(),a.saveSectionUiSettings())},a.calculateVisibleColCount=function(){a.collection.tabularView.visibleColCount=_(a.collection.tabularView.colSettings).filter(function(a){return a.isNotObsoleteOrHasDataInCollection&&a.isVisible}).length},a.initCols=function(){if(arguments&&arguments.length){for(var b=[],c=0;c<arguments.length;c+=3)b.push({fieldInternalName:arguments[c],customFieldType:arguments[c+1],isObsolete:"True"===arguments[c+2]});b.length&&(_(b).each(function(b){a.collection.tabularView.colSettings[b.fieldInternalName]=a.collection.tabularView.colSettings[b.fieldInternalName]||{},a.sectionUiSettings&&a.sectionUiSettings.tabularViewColSettings&&a.sectionUiSettings.tabularViewColSettings[b.fieldInternalName]?(a.collection.tabularView.colSettings[b.fieldInternalName].width=a.sectionUiSettings.tabularViewColSettings[b.fieldInternalName].width||Y[b.customFieldType]||Y["default"],a.collection.tabularView.colSettings[b.fieldInternalName].isVisible=!a.sectionUiSettings.tabularViewColSettings[b.fieldInternalName].isHidden,a.collection.tabularView.colSettings[b.fieldInternalName].isNotObsoleteOrHasDataInCollection=!b.isObsolete||M(b.fieldInternalName)):a.collection.tabularView.colSettings[b.fieldInternalName]={width:Y[b.customFieldType]||Y["default"],isVisible:!0,isNotObsoleteOrHasDataInCollection:!b.isObsolete||M(b.fieldInternalName)}}),a.calculateVisibleColCount())}},a.toggleColVisibility=function(b){b&&(a.collection.tabularView.colSettings[b]=a.collection.tabularView.colSettings[b]||{},a.collection.tabularView.colSettings[b].isVisible=!a.collection.tabularView.colSettings[b].isVisible,a.calculateVisibleColCount())},a.beginEditingTabularView=function(){a.collection.tabularView.colSettingsEditingCopy=angular.copy(a.collection.tabularView.colSettings),a.collection.tabularView.isEditing=!0},a.resetTabularViewCols=function(){a.collection.tabularView.resizer.table&&a.collection.tabularView.resizer.table.reset(),_(a.collection.tabularView.colSettings).each(function(a,b,c){c[b].width=void 0,c[b].isVisible=!0}),a.calculateVisibleColCount()},a.canSaveTabularViewConfig=function(){return!angular.equals(a.collection.tabularView.colSettings,a.collection.tabularView.colSettingsEditingCopy)},a.saveTabularViewConfig=function(){a.canSaveTabularViewConfig()&&(a.sectionUiSettings.tabularViewColSettings=a.sectionUiSettings.tabularViewColSettings||{},_(a.collection.tabularView.colSettings).each(function(b,c,d){a.sectionUiSettings.tabularViewColSettings[c]={},a.collection.tabularView.colSettings[c].isVisible||(a.sectionUiSettings.tabularViewColSettings[c].isHidden=!0),a.collection.tabularView.colSettings[c].width&&(a.sectionUiSettings.tabularViewColSettings[c].width=a.collection.tabularView.colSettings[c].width)}),a.saveSectionUiSettings(),a.collection.tabularView.colSettingsEditingCopy=null,a.collection.tabularView.isEditing=!1)},a.cancelTabularViewConfig=function(){a.collection.tabularView.resizer.table&&a.collection.tabularView.resizer.table.reset(a.collection.tabularView.colSettingsEditingCopy),a.collection.tabularView.colSettings=angular.copy(a.collection.tabularView.colSettingsEditingCopy),a.calculateVisibleColCount(),a.collection.tabularView.colSettingsEditingCopy=null,a.collection.tabularView.isEditing=!1},a.stringListSortableOptions={axis:"y",handle:".dnd-handle",stop:function(b,c){a.customListItemsChanged=!0}},a.addStringListItem=function(b,c){var d="";a.item[b]?a.item[b].push(d):a.item[b]=[d],a.customListItemsChanged=!0,k(function(){var d=angular.element("#edit-"+b+" li:last-child input")[0];d&&a.$broadcast("onListItemAdded-"+b+"-"+(a.item[b].length-1),{selectAll:!c})})},a.removeListItem=function(b,c){a.item[b]&&a.item[b].length&&(a.item[b].splice(c,1),a.customListItemsChanged=!0)},a.onListItemEnterKey=function(b,c,d){b===a.item[c].length-1&&a.addStringListItem(c,d)},a.cleanUpListItems=function(b){for(var c=0;c<a.item[b].length;c++)a.item[b][c]=a.item[b][c].trim(),""!==a.item[b][c]&&null!==a.item[b][c]||(a.item[b].splice(c,1),c--,a.customListItemsChanged=!0)},a.alphasortStringListItems=function(b){a.item[b]&&a.item[b].length>1&&(a.item[b]=_(a.item[b]).sortBy(function(a){return a.toLowerCase()}),a.customListItemsChanged=!0)},a.multiselectClicked=function(b,c){if(a.item[b]){var d=a.item[b].indexOf(c);d>-1?a.item[b].splice(d,1):a.item[b].push(c)}else a.item[b]=[c];a.customListItemsChanged=!0},a.selectedToList=function(b,c){var d=[];if(a.isCollection){var e=a.sectionData.collection.find(function(a){return a._id===c});e&&(d=e[b]||[])}else d=a.item[b]||[];return d.length?1===d.length?d[0]:[d.slice(0,-1).join(", "),d.slice(-1)[0]].join(d.length>2?", and ":" and "):""},a.isSelected=function(b,c,d){var e=-1;if(a.isCollection){var f=a.sectionData.collection.find(function(a){return a._id===d});f&&f[b]&&(e=f[b].indexOf(c))}else a.item&&a.item[b]&&(e=a.item[b].indexOf(c));return e>-1},a.isInListField=function(a,b,c){return a&&b&&c&&b[a]&&b[a].length&&_.any(b[a],function(a){return a.toString().toLowerCase()===(c||"").toString().toLowerCase()})},a.beginAddPersonToList=function(b){a.item.newPersonListItem={},a.isAddingPersonListItem[b]=!0,k(function(){a.$broadcast("onPersonSelectorInputNeedsFocus-"+b+"PersonInput")})},a.cancelAddingPersonToList=function(b){a.isAddingPersonListItem[b]=!1,a.item.newPersonListItem={}},a.savePersonToList=function(b,c,d){a.item[c]=_(a.item[c]).reject(function(a){return _.isEmpty(a)}),a.updatedPersonLists[c]||null===a.updatedPersonLists[c]||(a.updatedPersonLists[c]=angular.copy(a.item[c])||null),null===b&&d<a.item[c].length?a.item[c].splice(d,1):null===b||a.item[c].find(function(a){return a.id===b.id})||a.item[c].push(b),a.customListItemsChanged=!0,a.cancelAddingPersonToList(c)},a.removePersonFromList=function(b,c){a.item[b].splice(c,1),a.customListItemsChanged=!0},a.showPersonDetails=function(a,b){if(a&&a.id){var c=a;h.show(c,{readonly:b},function(b){b&&b.id>0&&(a=b)})}},a.alphasortPersonListItems=function(b){a.item[b]&&a.item[b].length>1&&(a.item[b]=_(a.item[b]).sortBy(function(a){return a.fullname.toLowerCase()}),a.customListItemsChanged=!0)},a.onProjectLinkListChanged=function(){a.customListItemsChanged=!0},a.taskflowActionButton={isLoading:{},isResetting:{},isTriggering:{},history:{}},a.nonCollectionItemID=c.nonCollectionItemID(),a.getTaskflowActionButtonHistory=function(b,d){b=a.isCollection?b:a.nonCollectionItemID,!b||a.taskflowActionButton.isLoading[b]&&a.taskflowActionButton.isLoading[b][d]||a.taskflowActionButton.history[b]&&a.taskflowActionButton.history[b][d]||(a.taskflowActionButton.isLoading[b]=a.taskflowActionButton.isLoading[b]||{},a.taskflowActionButton.isLoading[b][d]=!0,c.getTaskflowActionButtonHistory(e.projectID,e.sectionName,b,d).then(function(c){a.taskflowActionButton.history[b]||(a.taskflowActionButton.history[b]={}),a.taskflowActionButton.history[b][d]=c},function(a){console.log(a)})["finally"](function(){a.taskflowActionButton.isLoading[b][d]=!1}))},a.isTaskflowActionButtonTriggered=function(b,c){return b=a.isCollection?b:a.nonCollectionItemID,b&&a.taskflowActionButton.history[b]&&a.taskflowActionButton.history[b][c]&&a.taskflowActionButton.history[b][c].triggeredDateTime},a.canTriggerActionButton=function(b,c,d){return b=a.isCollection?b:a.nonCollectionItemID,!b&&a.needsSave(c)&&a.canSave(d)||b&&(!a.needsSave(c)||a.canSave(d))},a.canTriggerTaskflowActionButton=function(b,c,d,e){return b=a.isCollection?b:a.nonCollectionItemID,a.canTriggerActionButton(b,d,e)&&!a.isTaskflowActionButtonTriggered(b,c)&&(!b||(!a.taskflowActionButton.isTriggering[b]||!a.taskflowActionButton.isTriggering[b][c])&&(!a.taskflowActionButton.isResetting[b]||!a.taskflowActionButton.isResetting[b][c])&&(!a.taskflowActionButton.isLoading[b]||!a.taskflowActionButton.isLoading[b][c]))},a.triggerTaskflowActionButton=function(b,c,d,e,f){var g=a.isCollection?b._id:a.nonCollectionItemID;if(a.canTriggerTaskflowActionButton(g,c,e,f)){var h=b._isNew||a.needsSave(e);r.confirm({text:"Are you sure you would like to "+(h?"save changes and ":"")+"start the '"+d+"' Taskflow?",confirmButtonText:"Start Taskflow",isLoadingButtonText:"Starting Taskflow"},function(){return h?a.saveItem(b,!0).then(function(a){return Q(c,a)}):Q(c,g)})}},a.canShowTaskflowResetButton=function(b,c){return b=a.isCollection?b:a.nonCollectionItemID,b&&a.isAdmin&&a.isTaskflowActionButtonTriggered(b,c)},a.canResetTaskflowActionButton=function(b,c){return b=a.isCollection?b:a.nonCollectionItemID,a.canShowTaskflowResetButton(b,c)&&(!a.taskflowActionButton.isTriggering[b]||!a.taskflowActionButton.isTriggering[b][c])&&(!a.taskflowActionButton.isResetting[b]||!a.taskflowActionButton.isResetting[b][c])&&(!a.taskflowActionButton.isLoading[b]||!a.taskflowActionButton.isLoading[b][c])},a.resetTaskflowActionButton=function(b,d,f){b=a.isCollection?b:a.nonCollectionItemID,a.canResetTaskflowActionButton(b,d)&&r.confirm({text:"Are you sure you would like to reset the "+f+" Taskflow? Resetting does not remove any tasks from the project, but allows for the taskflow to be restarted.",confirmButtonText:"Reset Taskflow",isLoadingButtonText:"Resetting Taskflow"},function(){return a.taskflowActionButton.isResetting[b]||(a.taskflowActionButton.isResetting[b]={}),a.taskflowActionButton.isResetting[b][d]=!0,c.resetTaskflowActionButton(e.projectID,e.sectionName,b,d).then(function(){a.taskflowActionButton.history[b]||(a.taskflowActionButton.history[b]={}),a.taskflowActionButton.history[b][d]=""})["finally"](function(){a.taskflowActionButton.isResetting[b][d]=!1})})},a.createLinkAndSendEmail=function(b,c,d,e,f,g){b.stopPropagation();var h=a.isCollection?c._id:a.nonCollectionItemID;if(a.canTriggerActionButton(h,f,g)){var i=c._isNew||a.needsSave(f);i?r.confirm({text:"Are you sure you would like to save changes and send the '"+e+"' Email?",confirmButtonText:"Send Email",isLoadingButtonText:"Sending Email"},function(){return a.saveItem(c,!0).then(function(a){return R(d,a)})}):R(d,h)}},a.functionsToRunOnRefresh=[],a.initAndRegisterField=function(b,c){var d;switch(c){case"personLink":d=function(){T(b)};break;case"Url":d=function(){U(b,!1)};break;case"UrlList":d=function(){U(b,!0)};break;case"TaskflowActionButton":d=function(){V(b)}}d&&angular.isFunction(d)&&(d(),a.functionsToRunOnRefresh.push(d))}}angular.module("Crops").controller("CustomController",a),a.$inject=["$scope","$rootScope","customService","config","$stateParams","$animate","docService","personPanelService","$location","$anchorScroll","$timeout","projectService","nameService","$window","pushService","fvUtils","projectVitalsService","confirmService","$q","hotkeys","fvAlertsService","uiSettingsService"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{field:"=",fieldName:"@",colWidth:"=",limitToProjectTypeId:"@",limitToProjectTypeName:"@",isReadonly:"=",isLinkBackField:"=",onListChanged:"&"},templateUrl:"{0}/customData/custom.project.link.list.edit.html".format(a.viewRoot),link:function(a){function d(){a.settings.isAddingListItem=!0,c(function(){a.$broadcast("focusOnProjectSelector")})}function e(){a.settings.isAddingListItem=!1,a.selected.project=null}function f(c){c&&(a.field.find(function(a){return a.id===c.id})?b.alertWarning("'"+c.title+"' is already in the list.",5e3):(a.onListChanged(),a.field.push(c))),a.cancelAddingToList()}function g(b){a.field&&a.field.length&&(a.onListChanged(),a.field.splice(b,1))}function h(){a.field&&a.field.length>1&&(a.onListChanged(),a.field=_(a.field).sortBy(function(a){return a.title.toLowerCase()}))}a.permittedLinksList=[],a.$watch("field",function(){a.field||(a.field=[]),a.permittedLinksList=_(a.field).filter(function(a){return a.title})},!0),a.selected={project:null},a.settings={isAddingListItem:!1,isSortingList:!1,projectFilter:""},a.updatedList={},a.beginAddToList=d,a.cancelAddingToList=e,a.saveItemToList=f,a.removeItemFromList=g,a.alphasortListItems=h,a.projectListSortableOptions={axis:"y",handle:".dnd-handle",stop:function(b,c){a.onListChanged()}}}}}angular.module("Crops").directive("customProjectLinkListEdit",a),a.$inject=["config","fvAlertsService","$timeout"]}(),function(){"use strict";function a(a){return{restrict:"E",replace:!0,scope:{field:"=",fieldName:"@",itemId:"@",overrideCollectionListItemLimit:"="},templateUrl:"{0}/customData/custom.project.link.list.view.html".format(a.viewRoot),link:function(a){a.permittedLinksList=[],a.settings={isListExpanded:!1},a.$watch("field",function(){a.field||(a.field=[]),a.permittedLinksList=_(a.field).filter(function(a){return a.title})},!0)}}}angular.module("Crops").directive("customProjectLinkListView",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",replace:!0,scope:{project:"=",limitToProjectTypeId:"@",limitToProjectTypeName:"@",projectsToExclude:"=?",isReadonly:"=",onSelect:"&"},templateUrl:"{0}/customdata/custom.project.link.selector.html".format(a.viewRoot),link:function(b){function d(a){b.isReadonly||(a&&b.onSelect({project:a}),b.project=a)}function e(){var a=b.project;b.project&&b.project.id&&0!==b.project.id||(a=f(b.project)),g(a)}function f(c){if(!b.isReadonly){var d=c&&c.title&&""!==c.title.trim()?c.title:"",e={id:0,title:d,pictureUrl:a.defaultPicture,details:""};return e}}function g(d){var e=c.open({animation:!0,templateUrl:"{0}/projects/create/create.project.modal.html".format(a.viewRoot),controller:"createProjectModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"create-project create-project-modal",resolve:{projectTypeId:function(){return+b.limitToProjectTypeId},projectName:function(){return d.title||null}}});e.result.then(function(a){a&&(b.project=a,b.onSelect({project:a}))},function(a){console.log("Modal closing error: "+a)})}function h(){b.project=null,b.onSelect({project:null})}b.setProjectLink=d,b.showCreateProjectDetails=e,b.removeProject=h}}}angular.module("Crops").directive("projectLinkSelector",a),a.$inject=["config","fvUtils","$uibModal","orgService"]}(),function(){"use strict";function a(a){function b(){return r}function c(a){s=a}function d(){return s}function e(b,c,d,e){var f=new Date,g={projectID:b,sectionKey:c,itemGuid:d,fieldName:e,timezoneOffset:f.getTimezoneOffset()};return a.post(q.generateDoc,b,g)}function f(b,c){return a.get(q.getSectionData,[b,c])}function g(a,b){if("_id"!==a&&"_isNew"!==a&&"_entered"!==a&&"_date_binder"!==a)return b}function h(b,c,d){return a.post(q.updateObject,[b,c],JSON.stringify(d,g))}function i(b,c,d){return a.post(q.addCollectionItem,[b,c],JSON.stringify(d,g))}function j(b,c,d){return a.post(q.updateCollectionItem,[b,c,d._id],JSON.stringify(d,g))}function k(a,b,c){return c._id?j(a,b,c):i(a,b,c)}function l(b,c,d){return a.del(q.removeCollectionItem,[b,c,d])}function m(b,c,d,e){return a.post(q.triggerTaskflowActionButton,[b,c,d,e])}function n(b,c,d,e){return a.get(q.getTaskflowActionButtonHistory,[b,c,d,e])}function o(b,c,d,e){return a.post(q.resetTaskflowActionButton,[b,c,d,e])}function p(b,c,d,e){return a.get(q.prepareSendEmailLink,[b,c,d,e])}var q={getSectionData:"/api/projects/{0}/custom/{1}",updateObject:"/api/projects/{0}/custom/{1}/updateobject",addCollectionItem:"/api/projects/{0}/custom/{1}/additem",updateCollectionItem:"/api/projects/{0}/custom/{1}/updateitem/{2}",removeCollectionItem:"/api/projects/{0}/custom/{1}/removeitem/{2}",generateDoc:"/api/projects/{0}/docgen/",triggerTaskflowActionButton:"/api/projects/{0}/custom/{1}/triggerTaskflowActionButton/{2}/{3}",getTaskflowActionButtonHistory:"/api/projects/{0}/custom/{1}/getTaskflowActionButtonHistory/{2}/{3}",
resetTaskflowActionButton:"/api/projects/{0}/custom/{1}/resetTaskflowActionButton/{2}/{3}",prepareSendEmailLink:"/api/projects/{0}/custom/{1}/prepareSendEmailLink/{2}/{3}"},r="00000000-0000-0000-0000-000000000000",s=!1,t={nonCollectionItemID:b,getSectionData:f,updateObject:h,addItem:i,updateItem:j,saveItem:k,removeItem:l,generateDoc:e,setIsEditingItem:c,getIsEditingItem:d,triggerTaskflowActionButton:m,getTaskflowActionButtonHistory:n,resetTaskflowActionButton:o,prepareSendEmailLink:p};return t}angular.module("Crops").service("customService",a),a.$inject=["fvApi"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a){return f.getDueDateTag(a.dueDate,a.doneDate)}a.isLoading=!0,c.loadDeadlines().then(function(b){a.deadlineList=_.chain(b).each(function(a){a.dueDateTag=g(a)}).sortBy(function(a){return a.dueDate}).value()})["finally"](function(){a.isLoading=!1}),a.currentDeadline=null,a.isAdding=a.isEditing=!1,a.isCurrent=function(b){return b&&b==a.currentDeadline},a.newOne=function(){return angular.copy({name:"",notes:"",dueDate:null,doneDate:null})},a.add=function(){a.newDeadline=a.newOne(),a.isAdding=!0},a.edit=function(b){a.isEditing||(a.currentDeadline=b,a.isEditing=!0)},a.save=function(b){c.save(e.projectID,b).then(function(b){b.dueDateTag=g(b),f.replaceInList(a.deadlineList,b)})},a.handleCompleteDateChange=function(b){console.log("handleCompleteDateChange"),b&&(a.isAdding||a.isEditing||(""===b.doneDate||d.dateRegex.test(b.doneDate))&&a.save(b))},a.$on("formReset",function(b,c){c&&(c.dueDateTag=g(c),f.replaceInList(a.deadlineList,c),a.currentDeadline=null,a.isAdding=a.isEditing=!1)}),a.$on("deadlineEditorDirective.onResetCurrent",function(){a.currentDeadline=null,a.isAdding=a.isEditing=!1}),a.$on("deadlineEditorDirective.onDeadlineRemoved",function(b,c){a.deadlineList=_(a.deadlineList).reject(function(a){return a.id===c.id}),a.isEditing=!1,a.currentDeadline=null}),a.$on("deadlineEditorDirective.onDeadlineAdded",function(b,c){c.isNew=!1,c.dueDateTag=g(c),a.deadlineList.unshift(c),a.deadlineList=_(a.deadlineList).sortBy(function(a){return a.dueDate})}),a.$on("deadlineEditorDirective.onDeadlineUpdated",function(b,c){c.dueDateTag=g(c),f.replaceInList(a.deadlineList,c),a.deadlineList=_(a.deadlineList).sortBy(function(a){return a.dueDate})}),a.$on("deadlineEditorDirective.onDateChanged",function(a,b){b.dueDateTag=g(b)})}angular.module("Crops").controller("DeadlineController",a),a.$inject=["$scope","$rootScope","deadlineService","config","$stateParams","fvUtils"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{deadline:"="},templateUrl:"{0}/deadlines/deadline.editor.html".format(e.viewRoot),link:function(a){a.settings={isSaving:!1,isRemoving:!1},a.canDelete=b.canDeleteItems(),a.$on(b.onStateChange,function(){a.canDelete=b.canDeleteItems()}),a.remove=function(b){a.settings.isSaving||a.settings.isRemoving||(a.settings.isRemoving=!0,c.remove(b.id).then(function(){a.$emit("deadlineEditorDirective.onDeadlineRemoved",b)},function(a){console.warn(a)})["finally"](function(){a.settings.isRemoving=!1}))},a.save=function(b){return a.settings.isSaving||a.settings.isRemoving?g.reject("Doesn't pass canSave"):(a.settings.isSaving=!0,c.save(d.projectID,b).then(function(c){b.isNew?a.$emit("deadlineEditorDirective.onDeadlineAdded",c):(b=c,a.$emit("deadlineEditorDirective.onDeadlineUpdated",c))},function(a){console.warn(a)})["finally"](function(){a.$emit("deadlineEditorDirective.onResetCurrent")}))},a.onDateChanged=function(){a.$emit("deadlineEditorDirective.onDateChanged",a.deadline)}}}}angular.module("Crops").directive("deadlineEditor",a),a.$inject=["$rootScope","projectService","deadlineService","$stateParams","config","fvUtils","$q"]}(),function(){"use strict";function a(a,b){function c(){return a.get(h.getDeadlines,[b.projectID])}function d(b,c){var d=a.post(h.addDeadline,[b],c);return d.then(function(a){c.id=a.id,c.isNew=!0}),d}function e(b){return a.post(h.updateDeadline,[b.id],b)}function f(a,b){return b.id?e(b):d(a,b)}function g(b){return a.del(h.removeDeadline,[b])}var h={getDeadlines:"/api/projects/{0}/deadlines",addDeadline:"/api/projects/{0}/deadlines/create",updateDeadline:"/api/deadlines/{0}/update",removeDeadline:"/api/deadlines/{0}/remove"},i={loadDeadlines:c,add:d,update:e,save:f,remove:g};return i}angular.module("Crops").service("deadlineService",a),a.$inject=["fvApi","$stateParams"]}(),function(){"use strict";function a(a){return{restrict:"A",require:"?ngModel",link:function(b,c,d,e){function f(){var a=c.html();d.stripBr&&"<br>"==a&&(a=""),e.$setViewValue(a)}if(d.maxlength){var g=Number(d.maxlength);g>0&&c.on("keypress paste",function(a){if(c.text().length>=g&&(a.which>=48||"paste"===a.type))return a.preventDefault(),!1})}e&&(e.$render=function(){c.html(a.getTrustedHtml(e.$viewValue||""))},c.on("blur keyup change",function(){b.$evalAsync(f)}),f())}}}angular.module("Crops").directive("contenteditable",a),a.$inject=["$sce"]}(),function(){"use strict";function a(a){return{restrict:"E",template:'<input class="form-control" />',scope:{date:"=",onChanged:"&"},link:function(b,c){b.input=$(c).find("input"),b.getDateString=function(){return b.input.val()},b.setDateString=function(a){b.input.val(a)},b.hasGoodChanges=function(){var a=moment(b.date).format("M/D/YYYY"),c=moment(b.getDateString()).hour(12).utc();return c.isValid()&&b.getDateString()!=a},b.$watch("date",function(){var a=moment(b.date).hour(12).utc().format("M/D/YYYY");a!=b.getDateString()&&b.setDateString(a)}),b.onBlur=function(){a(function(){b.hasGoodChanges()&&(b.date=""===b.getDateString()?null:moment(b.getDateString()).hour(12).utc().toDate(),a(function(){null!==b.onChanged&&b.onChanged()}))},200)},b.input.datepicker({dateFormat:"m/d/yy"}),b.input.on("blur",function(){b.onBlur()})}}}angular.module("Crops").directive("dateSelector",a),a.$inject=["$timeout"]}(),function(){"use strict";function a(){return{restrict:"E",replace:!0,scope:{onDateChange:"&"},template:"<div></div>",link:function(a,b){b.datepicker({onSelect:function(c){a.$apply(function(){a.onDateChange({newDate:c}),b.datepicker("hide")})}}),b.on("click",function(){})}}}angular.module("Crops").directive("fixedDateSelector",a)}(),function(){"use strict";function a(){return{restrict:"A",require:"ngModel",scope:{ignoreDirty:"="},link:function(a,b,c,d){a.ignoreDirty&&(d.$setPristine=function(){},d.$pristine=!1)}}}angular.module("Crops").directive("ignoreDirty",a)}(),function(){"use strict";function a(){return{restrict:"A",link:function(a,b){function c(a){return 8===a||9===a||37===a||39===a||46===a}function d(a){return a>=48&&a<=57}var e=b.find('input[type="text"].month'),f=b.find('input[type="text"].date'),g=b.find('input[type="text"].year');e.bind("keypress",function(a){var b=e.val(),f=a.which;return!!c(a.keyCode)||!!d(f)&&(!(0===b.length&&f>49)&&(!(1===b.length&&"0"!==b&&f>50)&&(1!==b.length||"0"!==b||48!==f)))}),f.bind("keypress",function(a){var b=f.val(),e=a.which;return!!c(a.keyCode)||!!d(e)&&(!(0===b.length&&e>51)&&(1!==b.length||"0"!==b||48!==e))}),g.bind("keypress",function(a){var b=g.val(),e=a.which;return!!c(a.keyCode)||!!d(e)&&((0!==b.length||49===e||50===e)&&((1!==b.length||"1"!==b||57===e)&&(1!==b.length||"2"!==b||48===e)))})}}}angular.module("Crops").directive("fvBirthdate",a)}(),function(){"use strict";function a(a){return{restrict:"A",link:function(b,c,d){function e(a){var b,c;if(window.getSelection){if(b=window.getSelection(),b.getRangeAt&&b.rangeCount){c=b.getRangeAt(0),c.deleteContents();var d=document.createElement("div");d.innerHTML=a;for(var e,f,g=document.createDocumentFragment();e=d.firstChild;)f=g.appendChild(e);c.insertNode(g),f&&(c=c.cloneRange(),c.setStartAfter(f),c.collapse(!0),b.removeAllRanges(),b.addRange(c))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(a)}c.on("paste",function(b){var d;if(a.clipboardData)d=a.clipboardData.getData("Text");else if(b.originalEvent.clipboardData)try{d=b.originalEvent.clipboardData.getData("text/plain")}catch(f){d=void 0}d&&(b.preventDefault?b.preventDefault():b.returnValue=!1,e(d),c.blur(),c.focus())})}}}angular.module("Crops").directive("fvContentEditableSanitizePaste",a),a.$inject=["$window"]}(),function(){"use strict";function a(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){if(void 0!==a)return null===a?null:parseInt(a,10)}),d.$formatters.push(function(a){if(void 0!==a)return null===a?null:""+a})}}}angular.module("Crops").directive("fvConvertToNumber",a),a.$inject=[]}(),function(){"use strict";function a(a){return{scope:{},require:"ngModel",link:function(b,c,d,e){function f(b){if(!b)return"";var c=a.getDateOnlyMoment(b);return a.replaceParams("{0}/{1}/{2}",[c.month()+1,c.date(),c.year()])}function g(b){if(!b)return"";var c=a.getDateOnlyMoment(b);return a.replaceParams("{0}/{1}/{2}",[c.month()+1,c.date(),c.year()])}e.$formatters.push(f),e.$parsers.push(g)}}}angular.module("Crops").directive("fvDateOnlyDisplayer",a),a.$inject=["fvUtils"]}(),function(){"use strict";function a(a){return{scope:{ngModel:"=",onDateChanged:"&"},require:"ngModel",link:function(b,c,d,e){function f(){var a;a="function"==typeof b.ngModel?b.ngModel():b.ngModel,c.bootstrapDP("update",g(a))}function g(b){if(!b)return"";var c=a.getDateOnlyMoment(b);return c.format("MM/DD/YYYY")}function h(b){if(!b)return"";var c=a.getDateOnlyMoment(b);return c.format("MM/DD/YYYY")}b.datePickerIsInitialized=!1,b.ignoreDateChanges=!1,c&&c.length&&c[0].parentElement&&$(c[0].parentElement).css("position","relative"),c.bootstrapDP({todayHighlight:!0,autoclose:!0,forceParse:!1,shortYearCutoff:50,container:c[0].parentElement}),c.is("input")&&c.attr("autocomplete","off"),e.$formatters.push(g),e.$parsers.push(h),c.closest(".dropdown-menu").on("click",function(a){if(!$(a.target).is(".day")&&!$(a.target).is(".dropdown-menu > li > a"))return!1}),c.bootstrapDP().on("changeDate",function(a){if(b.ignoreDateChanges=!0,!c.is("input")){var d=g(a.format());b.ngModel=d,b.onDateChanged({date:d})}}),b.$watch("ngModel",function(d,e){return d||e?(b.datePickerIsInitialized&&(b.ignoreDateChanges||d&&e&&a.getDateOnlyMoment(d).isSame(a.getDateOnlyMoment(e)))||(f(),""!==d&&"undefined"!=typeof d&&c.bootstrapDP("hide")),b.datePickerIsInitialized=!0,void(b.ignoreDateChanges=!1)):void(b.datePickerIsInitialized=!0)})}}}angular.module("Crops").directive("fvDateOnlyEditor",a),a.$inject=["fvUtils"]}(),function(){"use strict";function a(a){return{restrict:"E",templateUrl:"{0}/directives/fvDateOnlyEditorInput.html".format(a.viewRoot),replace:!0,link:function(b,c,d,e){b.dateRegex=a.dateRegex}}}angular.module("Crops").directive("fvDateOnlyEditorInput",a),a.$inject=["config"]}(),function(){"use strict";function a(){return{scope:{},require:"ngModel",link:function(a,b,c,d){function e(a){return a?moment(a).format(g):""}function f(a){return a?h?moment(a).utc():moment(a):""}var g=c.fvDatepickerSimple||"MM/DD/YYYY",h=!c.convertToUtc||"false"!==c.convertToUtc;b.bootstrapDP({todayHighlight:!0,autoclose:!0,forceParse:!1,shortYearCutoff:50}),d.$formatters.push(e),d.$parsers.push(f),b.closest(".dropdown-menu").on("click",function(a){if(!$(a.target).is(".day")&&!$(a.target).is(".dropdown-menu > li > a"))return!1})}}}angular.module("Crops").directive("fvDatepickerSimple",a),a.$inject=[]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,templateUrl:"{0}/directives/fvDateTimePicker.html".format(a.viewRoot),scope:{dateValue:"=",showTime:"=",fieldId:"=",isValid:"="},link:function(a,b){a.dateValue&&moment(a.dateValue).isValid()?(a.datePart=moment(moment(a.dateValue).format("YYYY-MM-DD")).toDate(),a.isValid=!0,a.timePart=moment(moment(a.dateValue)).toDate()):(a.datePart=null,a.isValid=!1,a.timePart=new Date("2000-01-01 12:00:00")),a.isPopupOpen=!1,a.openPopup=function(){a.isPopupOpen=!0},a.$watch("dateValue",function(b,c){if(b&&moment(b).isValid()){if(c&&b.valueOf()===c.valueOf())return;a.datePart=moment(moment(b).format("YYYY-MM-DD")).toDate(),a.isValid=!0,a.timePart=moment(moment(b)).toDate()}else a.datePart=null,a.isValid=!1,a.timePart=new Date("2000-01-01 12:00:00")}),a.$watch("datePart",function(b,c){if(b&&moment(b).isValid()){if(c&&b.valueOf()===c.valueOf())return;a.dateValue=moment(moment(b).format("YYYY-MM-DD")+" "+moment(a.timePart).format("HH:mm")).toDate(),a.isValid=!0}else a.isValid=!1}),a.$watch("timePart",_.debounce(function(b,c){if(b&&moment(b).isValid()){if(c&&b.valueOf()===c.valueOf())return;a.dateValue=moment(moment(a.datePart).format("YYYY-MM-DD")+" "+moment(b).format("HH:mm")).toDate(),a.$evalAsync()}},800))}}}angular.module("Crops").directive("fvDateTimePicker",a),a.$inject=["config","$timeout"]}(),function(){"use strict";function a(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.fvEnterKey,{event:b})}),b.preventDefault())})}}angular.module("Crops").directive("fvEnterKey",a)}(),function(){"use strict";function a(){return function(a,b,c){b.bind("keydown keypress",function(b){27===b.which&&(a.$apply(function(){a.$eval(c.fvEscKey,{event:b})}),b.preventDefault())})}}angular.module("Crops").directive("fvEscKey",a)}(),function(){"use strict";function a(a,b,c){return function(d,e,f){d.$on(f.fvFocusOn,function(d,g){b.isNumber(f.fvFocusOnDelay)?a(function(){g&&g.selectAll&&!c.getSelection().toString()?(e[0].focus(),e[0].setSelectionRange(0,e[0].value.length)):e[0].focus()},f.fvFocusOnDelay):g&&g.selectAll&&!c.getSelection().toString()?(e[0].focus(),e[0].setSelectionRange(0,e[0].value.length)):e[0].focus()})}}angular.module("Crops").directive("fvFocusOn",a),a.$inject=["$timeout","config","$window"]}(),function(){"use strict";function a(a){return function(b,c,d){var e=a(d.fvFormReset),f=angular.copy(e(b)),g=b[c.attr("name")];if(!e.assign)throw new Error("Expression is required to be a model: "+d.fvFormReset);c.bind("reset",function(a){return b.$apply(b.resetModel),a.preventDefault()}),b.resetModel=function(){g.$invalid&&g.$rollbackViewValue();var a=angular.copy(f);e.assign(b,a),g.$setPristine(),b.$emit("formReset",a)},b.resetModelToHere=function(){f=angular.copy(e(b)),g.$setPristine(),g.$setUntouched()},b.$watch(d.fvFormReset,function(a,c){!e(b)||c&&Object.keys(c).length||(f=angular.copy(e(b))),JSON.stringify(angular.copy(a))===JSON.stringify(f)&&(g.$setPristine(),g.$setUntouched())},!0)}}angular.module("Crops").directive("fvFormReset",a),a.$inject=["$parse"]}(),function(){"use strict";function a(a){return{transclude:!0,template:'<div ng-transclude></div><label for="imageupload" role="button" tabindex="0" ng-keypress="keyHandler($event)"><span class="btn-image-upload" title="Upload an image"><i class="fa fa-upload"></i></button><input tabindex="0" type="file" id="imageupload" name="imageupload"/></label>',scope:{fvImageUploadUrl:"&",fvImageTargetEntity:"=",fvImageTargetKey:"=",fvImageChanged:"=",fvFileName:"="},link:function(b,c,d){d.fvImageUploadUrl&&(b.keyHandler=function(a){console.log(a),13!==a.which&&32!==a.which||$(a.target).find("input").click()},c.find("input").on("change",function(){var c=this.files[0];c&&c.name?(b.fvFileName=c.name,a({method:"PUT",url:b.fvImageUploadUrl(),headers:{"Content-type":"multipart/form-data","X-File-Name":c.name,"X-File-Type":c.type,"X-File-Size":c.size},data:c}).then(function(a){b.fvImageTargetEntity=a.data.ImageUrl?a.data.ImageUrl.replace(/\"/g,""):a.data.replace(/\"/g,""),b.fvImageChanged=!0,b.fvImageTargetKey=a.data.ImageKey},function(a){console.log("Unable to upload photo with error: "+a)})):console.log("Unable to upload photo with error: input has no files")}),b.$on("resetFvImageUpload",function(a,b){if(c&&c.length&&b&&c[0].id===b){var d=c.find("input");d.val(null)}}))}}}angular.module("Crops").directive("fvImageUpload",a),a.$inject=["$http"]}(),function(){"use strict";function a(){return{restrict:"E",replace:!0,scope:{isLoading:"&",loading:"="},template:'<div class="fv-loading" ng-if="(isLoading && isLoading()) || (loading)">Loading...<i class="fa fa-spinner fa-spin fa-lg"></i></div>'}}angular.module("Crops").directive("fvLoader",a)}(),function(){"use strict";angular.module("Crops").directive("fvMarkdown",["$compile","$location","$state","projectService",function(a,b,c,d){function e(a,b,c,d){var e='<a class="fv-tag fv-tag-inline" ng-click="filterOrSearch($event, \''+d+"')\" ng-dblclick=\"search('"+d+'\', $event)"><span class="tag-icon"><i class="fa fa-hashtag"></i></span><span class="tag-body">'+d+"</span></a>";return b+e}function f(a,b,c,d){return b+'<mark class="usertag"><i class="fa fa-at"></i>'+d+"</mark>"}function g(a,b){var c=new RegExp(b+"=[^&]*","i"),d=a.match(c);return d?d[0].replace(b+"=",""):""}return{scope:{fvMarkdown:"=",fvMarkdownOptions:"=?"},link:function(h,i,j,k){function l(){var b="";h.fvMarkdown&&(b=$.trim(marked(h.fvMarkdown)).replace(/\r\n/g,"<br />").replace(/[\r\n]/g,"<br />")),h.fvMarkdownOptions.highlightTags&&(b=b.replace(/([\s>])([#])([A-Za-z0-9-]+)/gi,e),b=b.replace(/([\s>\.\+])([@])([A-Za-z0-9-]+)/gi,f)),h.fvMarkdownOptions.addProjectCCToEmails&&(n&&(b=b.replace(/mailto:([^"]+)/gi,m)),b=b.replace(/target="_blank" href="mailto:/gi,'target="_top" ng-click="$event.stopPropagation()" href="mailto:')),b=b.replace(/\}\}/gi,"}<span>}</span>"),b=b.replace(/target="_blank" href="http/gi,'target="_top" ng-click="$event.stopPropagation()" href="http'),i.html(a(b)(h))}function m(a){a=a.replace(/'/gi,"%27").replace(/\+/g,"%2B").replace(/^mailto:/i,"");var b=a.match(/^[^?]*/i)?a.match(/^[^?]*/i)[0]:"";if(!b)return"";var c=b===n;if(b===a)return"mailto:"+b+(n&&!c?"?cc="+n:"");var d=navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)?",%20":";%20",e=g(a,"to");b=_([b,e]).compact().join(d),c=n&&b.indexOf(n)>-1;var f=g(a,"bcc");f=f?"bcc="+f:"";var h=g(a,"cc");h=_([h,c?"":n]).compact().join(d),h=h?"cc="+h:"";var i=g(a,"subject");i=i?"subject="+encodeURI(decodeURI(i)):"";var j=g(a,"body");j=j?"body="+encodeURI(decodeURI(j)):"";var k=_([h,f,i,j]).compact().join("&");return"mailto:"+b+(k?"?"+k:"")}h.fvMarkdownOptions=h.fvMarkdownOptions||{highlightTags:!1,addProjectCCToEmails:!1};var n=d.project()?d.project().emailAddress:"";h.$watch("fvMarkdown",l),h.filterOrSearch=function(a,d){a.stopPropagation(),"Mailroom"!==c.current.title?b.search({hashtag:"#"+d}):h.search(d)},h.search=function(a,c){c&&c.stopPropagation(),b.url("/search?q=%23"+a)}}}}])}(),function(){"use strict";function a(){return function(a,b,c){b.bind("click",function(a){a.stopImmediatePropagation()})}}angular.module("Crops").directive("fvNoBubble",a)}(),function(){"use strict";function a(){return{require:"ngModel",link:function(a,b,c,d){var e="#"+c.fvPasswordMatch;b.add(e).on("keyup",function(){a.$apply(function(){var a=b.val()===$(e).val();d.$setValidity("passwordmatch",a)})})}}}angular.module("Crops").directive("fvPasswordMatch",a)}(),function(){"use strict";function a(a,b){return{scope:{value:"=",type:"=",relatedValue:"="},replace:!1,restrict:"EA",templateUrl:"{0}/directives/fvValue.view.html".format(a.viewRoot),link:function(c){c.isEmail=function(b){return!(!b||!b.match(a.emailRegex)&&!b.match(/^mailto:/))},c.getRawNumber=function(a){return!!a&&a.replace(/[^0-9]/g,"")},c.calcAge=function(a){var b=moment().diff(moment(a),"years");return isNaN(b)?"":b},c.unescapeJson=function(a){return JSON.parse(a)},c.getCommaList=function(a){return a instanceof Array?b.arrayToCommaListNoAnd(a):""}}}}angular.module("Crops").directive("fvValue",a),a.$inject=["config","fvUtils"]}(),function(){"use strict";function a(a,b,c){return{link:function(d,e,f){function g(){l=c.innerWidth<768&&m?angular.element(c):$(e).closest(".fv-vscrollbox")}var h,i,j,k,l,m=f.infiniteScrollWindowOnMobile&&d.$eval(f.infiniteScrollWindowOnMobile);if(g(),m){var n=c.innerWidth,o=_.debounce(function(){var a=c.innerWidth;(n<768&&a>=768||n>=768&&a<768)&&(n=a,l.off("scroll",i),g(),l.on("scroll",i))},250);angular.element(c).bind("resize",o)}return j=0,null!==f.infiniteScrollDistance&&d.$watch(f.infiniteScrollDistance,function(a){return j===parseInt(a,10)}),k=!0,h=!1,null!==f.infiniteScrollDisabled&&d.$watch(f.infiniteScrollDisabled,function(a){if(k=!a,k&&h)return h=!1,i()}),i=function(){var b,c,g,i;return i=l.height()+l.scrollTop(),b=e.offset().top+e.height(),c=b-i,g=c<=l.height()*j,g&&k?a.$$phase?d.$eval(f.infiniteScroll):d.$apply(f.infiniteScroll):g?h===!0:void 0},l.on("scroll",i),d.$on("$destroy",function(){m&&angular.element(c).unbind("resize",o),l.off("scroll",i)}),b(function(){return f.infiniteScrollImmediateCheck?d.$eval(f.infiniteScrollImmediateCheck)?i():void 0:i()},0)}}}angular.module("Crops").directive("infiniteScroll",a),a.$inject=["$rootScope","$timeout","$window"]}(),function(){"use strict";function a(){return{restrict:"A",require:"?form",link:function(a,b,c,d){if(b.addClass("isolate-form"),d){var e=b.parent().controller("form");if(e){e.$removeControl(d);var f={};angular.copy(d,f);var g={$setValidity:function(a,b,c){f.$setValidity(a,b,c),e.$setValidity(a,!0,d)},$setDirty:function(){b.removeClass("ng-pristine").addClass("ng-dirty"),d.$dirty=!0,d.$pristine=!1},$setPristine:function(){b.addClass("ng-pristine").removeClass("ng-dirty"),d.$dirty=!1,d.$pristine=!0}};angular.extend(d,g)}}}}}angular.module("Crops").directive("isolateForm",a),a.$inject=[]}(),function(){"use strict";function a(a,b){var c=0;return{restrict:"A",priority:1,compile:function(d,e){var f="$$clickOnNoSelect"+c++,g=e.ngClick;return e.ngClick=f+"($event)",function(c){var d,e,h;c[f]=function(f){var i=a.getSelection(),j=i.anchorOffset,k=i.focusOffset;return k-j===0||d===j&&e===k?(d=null,e=null,void(h=b(function(){c.$eval(g,{$event:f}),h=null},250))):(d=j,e=k,void(h&&(b.cancel(h),h=null)))}}}}}angular.module("Crops").directive("selectableText",a),a.$inject=["$window","$timeout"]}(),function(){"use strict";function a(){return{require:"ngModel",restrict:"A",scope:{typeaheadAllResultsOn:"@"},link:function(a,b,c,d){var e=["click","focus"],f=e.indexOf(a.typeaheadAllResultsOn)>-1?a.typeaheadAllResultsOn:null;f&&(b.bind(f,function(){var a=d.$viewValue;" "===d.$viewValue&&d.$setViewValue(null),d.$setViewValue(" "),d.$setViewValue(a||" ")}),a.emptyOrMatch=function(a,b){return" "===b||a.indexOf(b)>-1})}}}angular.module("Crops").directive("typeaheadAllResultsOn",a)}(),function(){"use strict";function a(a,b){return{restrict:"EA",scope:{doc:"="},templateUrl:"{0}/docs/doc.block.html".format(a.viewRoot),link:function(a,c,d){$(c).addClass("doc-block"),a.docIcon=b.getIconForFileType(a.doc.filename)}}}angular.module("Crops").directive("docBlock",a),a.$inject=["config","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){a.isloadingProjectExternalIDs||(a.isloadingProjectExternalIDs=!0,b.getExternalIDsForProject())}function k(){a.createFolderSettings.isAdding=!1,a.createFolderSettings.isCreating=!1,a.createFolderSettings.newFolder={parentID:a.currentFolder?a.currentFolder.id:void 0,name:""},a.createFolderSettings.newFolderForm&&(a.createFolderSettings.newFolderForm.$setPristine(),a.createFolderSettings.newFolderForm.$setUntouched())}function l(){var c=!1;f.search().hashtag&&a.filter.q!==f.search().hashtag?(a.filter.q=f.search().hashtag,f.search("hashtag",null),c=!0):(f.search().docID&&a.filter.singleDocId!==+f.search().docID||!f.search().docID&&a.filter.singleDocId)&&(a.filter.singleDocId=isNaN(+f.search().docID)?0:+f.search().docID,c=!0,o=!0),!c&&n||(n=!0,b.loadFolder())}function m(b){return b&&a.currentFolder&&a.currentFolder.children&&a.currentFolder.children.length&&_(a.currentFolder.children).any(function(a){return a.name.toLowerCase()===b.toLowerCase()})}var n=!1,o=!1,p=null;a.docList=[],a.currentFolder=null,a.isLoading=b.isLoading(),a.isloadingProjectExternalIDs=!1,a.projectExternalIDs=null,a.projectExternalIDType=null,a.integrationTypes=b.integrationTypes(),a.showFileUpload=!0,a.projectFolders=null,a.uploadFolderTreeSettings={selectedFolder:null,selectedFolderId:null,currentFolder:null,canSelectCurrent:!0,autoSelectCurrent:!0,canSelectParent:!0,showDescendants:!0,openToCurrent:!0,disabled:!1},a.showIntegrationOptionsReadonly=!1,a.showIntegrationOptions=!1,a.hasLegacyIntegration=!1,a.isCanada=i.isCanada,a.canShowBrowserPath=function(){return a.project&&a.project.currentUserAccessLevel>=2&&a.currentFolder&&a.currentFolder.integrationType&&a.currentFolder.browserPath},a.$on(b.onProjectExternalIDsChanged,function(){a.isloadingProjectExternalIDs=!1,a.projectExternalIDs=b.projectExternalIDs(),a.projectExternalIDType=b.projectExternalIDType(),a.hasLegacyIntegration=a.projectExternalIDs&&a.projectExternalIDs.length&&a.projectExternalIDs[0].integrationTypeID<11,a.showIntegrationTab=!a.isCanada&&a.hasLegacyIntegration&&(a.showIntegrationOptionsReadonly||a.showIntegrationOptions)}),a.$on(c.onStateChange,function(){a.project=c.project(),a.project&&(a.showIntegrationOptionsReadonly=2===a.project.currentUserAccessLevel,a.showIntegrationOptions=3===a.project.currentUserAccessLevel,j())}),a.createFolderSettings={isAdding:!1,isCreating:!1,newFolder:{parentID:a.currentFolder?a.currentFolder.id:void 0,name:""},invalidChars:i.folderNameInvalidCharacters},a.$on(b.onCurrentFolderChanged,function(){a.isLoading=b.isLoading(),a.currentFolder=b.currentFolder(),a.uploadFolderTreeSettings.currentFolder=angular.copy(a.currentFolder),k(),!o&&p&&p===e.folderID||(o=!1,p=e.folderID,b.loadDocs(!0,a.filter.q,a.sort,a.filter.singleDocId))}),a.$on(b.onDocListChanged,function(){a.docList=b.docList(),a.docList&&a.docList.length&&(a.currentFolder.canRemove=!1),a.isLoading=b.isLoading()}),a.$on(b.onLoadingChanged,function(){a.isLoading=b.isLoading()}),c.loadProject(),a.sortProperties=["id","filename"],a.sort=h.getDocSort()&&a.sortProperties.indexOf(h.getDocSort())>-1?h.getDocSort():"id",a.filter={q:"",singleDocId:0},a.$on(h.onUiSettingsChanged,function(){a.sort=h.getDocSort()&&a.sortProperties.indexOf(h.getDocSort())>-1?h.getDocSort():"id"}),a.folderSort=function(b){return"id"===a.sort?-b.id:"filename"===a.sort?b.name:""},a.$on("$locationChangeSuccess",function(){l()},!0),l(),a.showUploadIntegrationWarning=function(){return a.projectExternalIDs&&a.projectExternalIDs.length&&a.projectExternalIDs[0].integrationTypeID<=11&&a.uploadFolderTreeSettings&&a.uploadFolderTreeSettings.selectedFolderId&&a.project&&a.uploadFolderTreeSettings.selectedFolderId!==a.project.rootDocFolderID};var q=_.debounce(function(b){a.applyFilter(b)},1200);a.filterChanged=function(b){a.isLoading.docs=!0,q(b)},a.applyFilter=function(c){a.filter.q!==c&&(a.filter.q=c),a.offset=0,b.loadDocs(!1,a.filter.q,a.sort)},a.clearSingleDocIdFilter=function(){f.search("docID",null)},a.getMoreDocs=function(){b.loadMore()},a.newUploads=[],a.setSort=function(c){a.sortProperties.indexOf(c)>-1&&(a.sort=c,h.setDocSort(c),b.loadDocs(!1,a.filter.q,c))},a.$on("docAdded",function(a,c){c.length&&b.onDocsAdded(c)}),a.$on("uploadComplete",function(c,d){var e=a.newUploads.indexOf(d);e>=0&&(a.newUploads.splice(e,1),b.claimDocForProject(d.docID,a.project.id).then(function(a){b.onDocAdded(a)}))}),a.setProjectExternalID=function(a){b.setProjectExternalID(a).then(function(c){a.externalID=c.externalID,a.savedExternalID=a.externalID,b.loadFolder()})},a.refreshProjectFolders=function(){a.projectFolders=null,b.getProjectFolders().then(function(b){a.projectFolders=b})},a.allowCreateFolder=function(){return a.project&&a.project.currentUserAccessLevel>=2},a.canCreateFolder=function(){return a.createFolderSettings&&!a.createFolderSettings.isCreating&&a.allowCreateFolder()&&a.createFolderSettings.newFolder.parentID&&a.createFolderSettings.newFolderForm&&a.createFolderSettings.newFolderForm.newFolderName&&a.createFolderSettings.newFolderForm.$valid},a.validateNewFolderName=function(){if(a.createFolderSettings.newFolder&&a.createFolderSettings.newFolderForm){var b=a.createFolderSettings.newFolder.name,c=a.createFolderSettings.newFolderForm.newFolderName;c.$setValidity("invalidChars",!i.folderNameInvalidCharactersRegex.test(b)),c.$setValidity("duplicate",!m(b))}},a.$watch("createFolderSettings.isAdding",function(){a.createFolderSettings&&a.createFolderSettings.isAdding&&g(function(){a.$broadcast("onAddingFolder")})}),a.createFolder=function(){a.canCreateFolder()&&(a.createFolderSettings.isCreating=!0,a.createFolderSettings.newFolder.name=a.createFolderSettings.newFolder.name.trim(),b.createFolder(a.createFolderSettings.newFolder))},a.cancelCreateFolder=function(){a.createFolderSettings.isCreating||k()},a.$on(b.onCreateFolderFail,function(){a.createFolderSettings.isCreating=!1}),a.gotoFolder=function(b){a.isLoading.docs||d.go("projectLayout.project.docs",{folderID:b})},a.$on(b.onDocRemoved,function(c,d){d.curLength||d.hasMore?d.curLength<30&&d.hasMore?a.getMoreDocs():a.docList=b.docList():(b.loadFolder(),a.docList=b.docList())})}angular.module("Crops").controller("DocumentsController",a),a.$inject=["$scope","docService","projectService","$state","$stateParams","$location","$timeout","uiSettingsService","config"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{currentFolder:"=",project:"=",isLoadingDocs:"=",isAdding:"=",docList:"=",hasLegacyIntegration:"="},templateUrl:"{0}/docs/doc.current.folder.html".format(b.viewRoot),link:function(g,h){function i(){g.settings={showEditIcon:!1,isEditingName:!1,isRenaming:!1,isCreatingFolder:!1,isRemoving:!1,newName:""}}i(),g.invalidFolderNameChars=b.folderNameInvalidCharacters,g.$on(a.onCurrentFolderChanged,i),g.projectExternalIDs=a.projectExternalIDs(),g.projectExternalIDType=a.projectExternalIDType(),g.integrationTypes=a.integrationTypes(),g.$on(a.onProjectExternalIDsChanged,function(){g.projectExternalIDs=a.projectExternalIDs(),g.projectExternalIDType=a.projectExternalIDType()}),g.showIntegrationWarning=function(){return g.projectExternalIDs&&g.projectExternalIDs.length&&g.projectExternalIDs[0].integrationTypeID<=11&&g.currentFolder&&g.currentFolder.isProjectRootFolder},g.isGuest=function(){return g.project&&g.project.currentUserAccessLevel<2},g.canJumpToFolder=function(){if(g.isLoadingDocs||g.settings.isJumping||!g.currentFolder)return!1;var a=g.currentFolder.parents?_(g.currentFolder.parents).reject(function(a){return!a.projectID}):null;return g.currentFolder.children&&g.currentFolder.children.length||a&&a.length},g.canCreateFolder=function(){return g.project&&g.project.currentUserAccessLevel>=2},g.allowRenameFolder=function(){return g.project&&g.project.currentUserAccessLevel>=2&&g.currentFolder&&(!g.currentFolder.isProjectRootFolder||!g.hasLegacyIntegration)},g.canMoveFolder=function(){return g.currentFolder&&g.project&&(!g.currentFolder.isProjectRootFolder&&g.project.currentUserAccessLevel>=2||g.currentFolder.isProjectRootFolder&&3===g.project.currentUserAccessLevel)},g.canRemoveFolder=function(){return g.currentFolder&&!g.currentFolder.isProjectRootFolder&&g.currentFolder.canRemove&&(!g.currentFolder.children||!g.currentFolder.children.length)&&!g.docList.length&&g.project&&g.project.currentUserAccessLevel>=3},g.createFolder=function(a){g.isAdding=!0},g.gotoFolder=function(a){if(!g.isLoadingDocs){var b=a.isProjectRootFolder?null:a.id;c.go("projectLayout.project.docs",{folderID:b})}},g.beginEditingName=function(){g.allowRenameFolder()&&(g.settings.newName=angular.copy(g.currentFolder.name),g.settings.isEditingName=!0,e(function(){g.$broadcast("onEditingName",{selectAll:!0})}))},g.cancelEditingName=function(){g.settings.isRenaming||(g.settings.isEditingName=!1,g.settings.newName="")},g.canRenameFolder=function(){return g.allowRenameFolder()&&!g.settings.isRenaming&&g.settings.folderRenameForm.$valid},g.validateNewFolderName=function(){if(g.settings&&g.settings.folderRenameForm){var a=g.settings.newName,c=g.settings.folderRenameForm.renameFolderInput;c.$setValidity("invalidChars",!b.folderNameInvalidCharactersRegex.test(a))}},g.renameFolder=function(){g.canRenameFolder()&&(g.settings.isRenaming=!0,a.renameFolder(g.currentFolder.id,g.settings.newName.trim()))},g.$on(a.onCurrentFolderRenameFail,function(a,b){b===g.currentFolder.id&&(g.settings.isRenaming=!1)}),g.removeFolder=function(){
g.canRemoveFolder()&&f.confirm({text:"Are you sure you wish to remove this folder?",confirmButtonText:"Remove Folder",isLoadingButtonText:"Removing Folder"},function(){return g.settings.isRemoving=!0,a.removeFolder(g.currentFolder.id)})},g.$on(a.onFolderRemoved,function(a,b){b===g.currentFolder.id&&c.go("projectLayout.project.docs",{folderID:g.currentFolder.parentID})}),g.showFolderMoveModal=function(a){d.open({animation:!0,templateUrl:"{0}/docs/doc.folder.move.modal.html".format(b.viewRoot),controller:"docFolderMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal folder-move-modal doc-folder-move-modal",resolve:{folderID:function(){return g.currentFolder.id},mode:function(){return a}}})},g.showRootFolderMoveModal=function(){d.open({animation:!0,templateUrl:"{0}/setup/orgs/folders/org.folder.move.modal.html".format(b.viewRoot),controller:"orgFolderMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"folder-move-modal org-folder-move-modal",resolve:{currentOrgID:function(){return g.project.orgID},folderID:function(){return g.currentFolder.id},mode:function(){return"move"}}})},g.jumpToFolder=function(){g.canJumpToFolder()&&g.showFolderMoveModal("jump")},g.moveFolder=function(){g.canMoveFolder()&&(g.currentFolder.isProjectRootFolder?g.showRootFolderMoveModal():g.showFolderMoveModal("move"))}}}}angular.module("Crops").directive("docCurrentFolder",a),a.$inject=["docService","config","$state","$uibModal","$timeout","confirmService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l){function m(c){c&&(a.doc=c,a.docIcon=f.getIconForFileType(a.doc.filename),a.docExtension=f.getExtension(a.doc.filename),a.projectID=b.projectID||a.doc.projectID,n())}function n(){if(a.doc){var c=b.projectID||a.doc.projectID;a.doc.folderID?f.getFolder(a.doc.folderID,c).then(o):f.getProjectRootFolder(c).then(o)}}function o(b){b&&(a.folder=b)}function p(a){return a.replace(/\.[^\/.]+$/,"")}function q(){a.updateTab.settings.isLoadingRevisionList||(a.updateTab.settings.isLoadingRevisionList=!0,a.updateTab.settings.revisionList=null,a.updateTab.settings.revisionListLoadError=!1,f.getRevisionList(a.doc.id).then(function(b){a.updateTab.settings.revisionList=b,a.updateTab.settings.hasInitiallyLoadedRevisionList=!0},function(b){a.updateTab.settings.revisionListLoadError=!0})["finally"](function(){a.updateTab.settings.isLoadingRevisionList=!1,a.updateTab.settings.isEditingDoc&&(v=j(q,15e3))}))}function r(a){a.wrap("<form>").closest("form").get(0).reset(),a.unwrap()}function s(b){b&&b.id&&a.doc&&a.doc.id&&f.updateDoc(a.doc.id,b.id).then(function(b){l.alertSuccess("Doc updated!"),m(b),a.updateTab.settings.uploads=[],q()},function(a){l.alertFail(a)})["finally"](function(){a.status.isUpdating=!1})}function t(){a.docLinksTab.settings.isLoadingDocLinks||(a.docLinksTab.settings.isLoadingDocLinks=!0,a.docLinksTab.settings.docLinks=null,f.getDocLinksForDoc(a.doc.id).then(function(b){a.docLinksTab.settings.docLinks=b})["finally"](function(){a.doc.hasActiveDocLinks=!!a.docLinksTab.settings.docLinks.length,a.docLinksTab.settings.isLoadingDocLinks=!1}))}a.resetGlobalSettings=function(){a.doc=null,a.docIcon=null,a.docExtension=null,a.folder=null,a.projectID=b.projectID||null},a.resetGlobalSettings();var u=["allowMove","allowRename","allowHashtags","allowUpdate","allowLink","allowEdit"];a.permissions={},i&&_(u).each(function(b){a.permissions[b]="undefined"!=typeof i[b]&&i[b]}),a.status={isRenaming:!1,isAddingHashtags:!1,isUpdating:!1,isReverting:!1};var v;a.isPerformingDocAction=function(){return!Object.keys(a.status).every(function(b){return!a.status[b]})},a.propertiesTab={name:"Properties",icon:"fa-info-circle",title:"Doc Properties",isOpen:!h||"properties"===h,settings:{showEditIcon:!1,isEditingName:!1,isRenaming:!1,newFilename:""}},a.updateTab={name:"Update",icon:"fa-upload",title:"Update Doc",isOpen:"update"===h,settings:{uploads:[],revisionList:null,isLoadingRevisionList:!1,hasInitiallyLoadedRevisionList:!1,revisionListLoadError:!1}},a.docLinksTab={name:"Share Link",icon:"fa-link fa-rotate-90",title:"Manage Doc Share Links",isOpen:"docLinks"===h,settings:{isLoadingDocLinks:!1,isEditingDocLink:!1,docLinks:null,challengeTypes:{"public":0,users:1,password:2}}},m(g),a.downloadDoc=function(){f.getDownloadUrl(a.doc.id).then(function(a){a.url&&(window.location=a.url)})},a.editDoc=function(){f.getEditDocUrl(a.doc.id).then(function(b){b&&(a.updateTab.settings.isEditingDoc=!0,v=j(q,3e4),window.location=b)})},a.previewDoc=function(){f.previewDoc(a.doc,a.permissions.allowEdit)},a.isCurrentUser=function(a){return a.id===k.currentUser().id},a.initPropertiesTab=function(){a.currentTabTitle=a.propertiesTab.title},a.beginEditingName=function(){a.permissions.allowRename&&(a.propertiesTab.settings.newFilename=p(angular.copy(a.doc.filename)),a.propertiesTab.settings.isEditingName=!0,j(function(){a.$broadcast("onEditingName")}))},a.cancelEditingName=function(){a.status.isRenaming||(a.propertiesTab.settings.isEditingName=!1,a.propertiesTab.settings.newFilename="")},a.canRename=function(){return a.permissions.allowRename&&!a.isPerformingDocAction()&&a.propertiesTab.settings.newFilename&&a.propertiesTab.settings.newFilename.trim()&&!angular.equals(p(a.doc.filename),a.propertiesTab.settings.newFilename.trim())},a.rename=function(){a.canRename()&&(a.status.isRenaming=!0,f.renameDoc(a.doc.id,a.propertiesTab.settings.newFilename.trim()).then(function(b){a.doc.filename=b,a.status.isRenaming=!1,a.cancelEditingName()},function(){a.status.isRenaming=!1}))},a.canBeMoved=function(){return a.permissions.allowMove&&a.doc&&a.folder&&(a.doc.folderID&&!a.folder.isProjectRootFolder||a.folder.isProjectRootFolder&&a.folder.children&&a.folder.children.length)},a.showDocMoveModal=function(){if(a.canBeMoved()){var b=d.open({animation:!0,templateUrl:"{0}/docs/doc.move.modal.html".format(c.viewRoot),controller:"docMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-move-modal",resolve:{docID:function(){return a.doc.id},allowMove:function(){return a.permissions.allowMove}}});b.result.then(function(b){b&&b.id===a.doc.id&&m(b)})}},a.initUpdateTab=function(){a.currentTabTitle=a.updateTab.title,q()},a.destroyUpdateTab=function(){a.updateTab.settings.isEditingDoc=!1,j.cancel(v)},a.uploadDoc=function(b,c,d){a.$apply(function(){d.status.isUpdating=!0,d.updateTab.settings.uploads=[{file:b[0],percent:0,projectID:a.projectID,id:-1,complete:function(){return s(this)}}],r($(c))}),r($(c))},a.downloadRevision=function(b){f.getRevisionDownloadUrl(a.doc.id,b.rev).then(function(a){a.url&&(window.location=a.url)})},a.previewRevision=function(b){f.previewRevision(a.doc,b.rev)},a.revertToRevision=function(b){a.status.isReverting=!0,f.revertToRevision(a.doc.id,b.rev).then(function(a){l.alertSuccess(),m(a),q()},function(a){l.alertFail(a)})["finally"](function(){a.status.isReverting=!1})},a.initDocLinksTab=function(){a.currentTabTitle=a.docLinksTab.title,t()},a.showDocLinkEditorModal=function(b){var e=d.open({animation:!0,templateUrl:"{0}/docs/doc.link.editor.modal.html".format(c.viewRoot),controller:"docLinkEditorModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-link-editor-modal",resolve:{docLink:function(){return b},doc:function(){return a.doc}}});e.result.then(function(){},function(a){t()})},a.editDocLink=function(b){a.showDocLinkEditorModal(b)},a.createDocLink=function(){a.showDocLinkEditorModal(null)},a.challengeTypeDisplay=function(b){return b.challengeType===a.docLinksTab.settings.challengeTypes["public"]?"Public link":b.challengeType===a.docLinksTab.settings.challengeTypes.password?"Password protected":b.challengeType===a.docLinksTab.settings.challengeTypes.users?"Shared with specific users":""},a.docLinkExpirationDateTagText=function(a){return a&&a.expirationDate?moment().diff(moment(moment.utc(a.expirationDate).format()),"hours")>0?"":moment(moment.utc(a.expirationDate).format()).calendar(null,{sameDay:"[Today]",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[]",lastWeek:"[]",sameElse:"[]"}).split(" at")[0]:""},a.close=function(){e.close(a.doc)},a.$on("$destroy",function(){j.cancel(v)})}angular.module("Crops").controller("docDetailsModalController",a),a.$inject=["$scope","$stateParams","config","$uibModal","$uibModalInstance","docService","document","activeTab","permissions","$timeout","currentUserService","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{doc:"=",allowDelete:"=",noDropdown:"=",allowRename:"=",allowLink:"=",allowMove:"=?",allowHashtags:"=",allowUpdate:"=?",allowEdit:"=?",allowFax:"=?",removeFunction:"&?",isCustomSection:"=?"},templateUrl:"{0}/docs/doc.download.html".format(b.viewRoot),link:function(h,i){function j(){h.canFax=("undefined"!=typeof h.allowFax?h.allowFax:h.allowRename)&&h.doc&&h.doc.filename&&h.project&&h.project.smsNumber&&h.project.faxEnabled&&_(l).any(function(a){return h.doc.filename.endsWith(a)})}function k(a){return a.replace(/\.[^\/.]+$/,"")}h.settings={isDocOptionsOpen:!1,isEditingName:!1,isRenaming:!1,newFilename:"",isRemoving:!1},h.allowMove="undefined"!=typeof h.allowMove?h.allowMove:h.allowRename,h.allowUpdate="undefined"!=typeof h.allowUpdate?h.allowUpdate:h.allowRename,h.allowEdit=("undefined"!=typeof h.allowEdit?h.allowEdit:h.allowRename)&&h.doc&&h.doc.canEditInPlace;var l=[".pdf",".docx",".doc",".xls",".xlsx"];h.project=g.project(),j(),h.$on(g.onStateChange,function(){h.project=g.project(),j()}),h.download=function(b){b.stopPropagation(),h.settings.isDocOptionsOpen=!1,a.getDownloadUrl(h.doc.id).then(function(a){a.url&&(window.location=a.url)})},h.docIcon=function(){return h.doc&&h.doc.filename?a.getIconForFileType(h.doc.filename):"fa-file-o"},h.remove=function(a){if(a.stopPropagation(),h.settings.isDocOptionsOpen=!1,h.removeFunction&&angular.isFunction(h.removeFunction)){var b="Are you sure you wish to remove this document?"+(h.isCustomSection?" (Don't forget to save the section.)":"");e.confirm({text:b,confirmButtonText:"Remove Doc",isLoadingButtonText:"Removing Doc"},function(){return h.settings.isRemoving=!0,h.removeFunction({doc:h.doc}).then()["finally"](function(){h.settings.isRemoving=!1})})}},h.preview=function(b){b.stopPropagation(),h.settings.isDocOptionsOpen=!1,a.previewDoc(h.doc,h.allowEdit)},h.openFaxModal=function(a){h.canFax&&f.showProjectFaxModal(h.project,a)},h.beginEditingName=function(a){a.stopPropagation(),h.settings.isDocOptionsOpen=!1,h.allowRename&&(h.settings.newFilename=k(angular.copy(h.doc.filename)),h.settings.isDocOptionsOpen=!1,h.settings.isEditingName=!0,d(function(){h.$broadcast("onEditingName")}))},h.cancelEditingName=function(a){a&&a.stopPropagation(),h.settings.isRenaming||(h.settings.isEditingName=!1,h.newFilename=null)},h.rename=function(b){b.stopPropagation(),h.allowRename&&!h.settings.isRenaming&&h.settings.newFilename.trim()&&(h.settings.isRenaming=!0,a.renameDoc(h.doc.id,h.settings.newFilename.trim()).then(function(a){h.doc.filename=a,h.settings.isRenaming=!1,h.cancelEditingName()},function(){h.settings.isRenaming=!1}))},h.editDoc=function(b){b.stopPropagation(),h.allowEdit&&a.getEditDocUrl(h.doc.id).then(function(a){a&&(window.location=a)})},h.getExtension=function(){if(!h.doc)return"";if(!h.doc.filename)return"";var a=h.doc.filename.split(".").pop();return a&&a!==h.doc.filename?"."+a:""},h.showDocDetailsModal=function(d){var e={allowRename:h.allowRename,allowLink:h.allowLink,allowMove:h.allowMove,allowHashtags:h.allowHashtags,allowUpdate:h.allowUpdate,allowEdit:h.allowEdit},f=c.open({animation:!0,templateUrl:"{0}/docs/doc.details.modal.html".format(b.viewRoot),controller:"docDetailsModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-details-modal",resolve:{document:function(){return a.getDocByID(h.doc.id).then(function(a){return a})},activeTab:function(){return d},permissions:function(){return e}}});f.result.then(function(a){a&&(h.doc=a)})},h.showDocDetails=function(a,b){b.stopPropagation(),("properties"===a||"update"===a&&h.allowUpdate||"docLinks"===a&&h.allowLink)&&h.showDocDetailsModal(a)},h.showDocMoveModal=function(a){if(a.stopPropagation(),h.settings.isDocOptionsOpen=!1,h.allowRename){c.open({animation:!0,templateUrl:"{0}/docs/doc.move.modal.html".format(b.viewRoot),controller:"docMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-move-modal",resolve:{docID:function(){return h.doc.id},allowMove:function(){return h.allowMove}}})}}}}}angular.module("Crops").directive("docDownload",a),a.$inject=["docService","config","$uibModal","$timeout","confirmService","faxService","projectService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){a.projectFolders=null,d.getProjectFolders().then(function(b){a.projectFolders=b})}a.modalMode={},a.folder=null,a.settings={isMovingFolder:!1,isJumping:!1},a.folderTreeSettings={selectedFolder:null,selectedFolderId:null,currentFolder:null,currentLocationId:null,canSelectCurrent:!1,autoSelectCurrent:!1,canSelectParent:!1,showDescendants:!1,openToCurrent:!0,disabled:!1,onSelect:null},g&&(a.modalMode[g]=!0,"jump"===g&&(a.folderTreeSettings.canSelectParent=!0,a.folderTreeSettings.showDescendants=!0,a.folderTreeSettings.onSelect=function(c){c&&(b.go("projectLayout.project.docs",{folderID:c.id}),a.close())})),a.project=e.project(),a.loading=function(){return!a.folderTreeSettings.currentFolder||!a.projectFolders},f&&d.getFolder(f).then(function(b){a.folderTreeSettings.currentFolder=b,b&&a.modalMode.move&&(a.folderTreeSettings.currentLocationId=b.parentID)}),a.$on(d.currentFolderChanged,function(){a.folderTreeSettings.currentFolder=d.currentFolder(),a.folderTreeSettings.currentFolder&&a.modalMode.move&&(a.folderTreeSettings.currentLocationId=a.folderTreeSettings.currentFolder.parentID)}),i(),a.nowhereToMoveTo=function(){return!a.projectFolders||!a.folderTreeSettings.currentFolder||a.projectFolders.id===a.folderTreeSettings.currentFolder.parentID&&1===a.projectFolders.children.length},a.canMoveFolder=function(){return a.settings&&!a.settings.isMovingFolder&&a.folderTreeSettings.currentFolder&&!a.folderTreeSettings.currentFolder.isProjectRootFolder&&a.project&&a.project.currentUserAccessLevel>=2&&a.folderTreeSettings.selectedFolderId&&!a.nowhereToMoveTo()},a.close=function(){c.dismiss("close")},a.moveFolder=function(){a.canMoveFolder()&&(a.settings.isMovingFolder=!0,a.folderTreeSettings.disabled=!0,d.moveFolder(a.folderTreeSettings.currentFolder.id,a.folderTreeSettings.selectedFolderId).then(function(){c.dismiss("onFolderMoveSuccess")},function(){a.settings.isMovingFolder=!1,a.folderTreeSettings.disabled=!1}))}}angular.module("Crops").controller("docFolderMoveModalController",a),a.$inject=["$scope","$state","$uibModalInstance","docService","projectService","folderID","mode","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.docLink=b,a.docLink.allowedUserIDs=a.docLink.allowedUserIDs||[],a.docLink.allowedUsers=a.docLink.allowedUsers||[],a.docLink.password="",a.docLink.passwordConfirm="",a.docLink.originallyHadPassword=a.docLink.challengeType===a.settings.challengeTypes.password,a.docLink.newExpirationDate=angular.copy(a.docLink.expirationDate),a.docLinkClone=angular.copy(a.docLink),a.settings.isEditingExpirationDate=!1,a.settings.expirationDateTagText=o(a.docLink.expirationDate),a.settings.userInput="",a.settings.showAllowedUsersPanel=a.docLink.challengeType===a.settings.challengeTypes.users,a.settings.showPasswordPanel=!1,m(),a.settings.expirySelector=""}function m(){a.docLink.password="",a.docLink.passwordConfirm="",n("passConfirm","passwordConfirm",!0),a.form&&a.form.linkEditorForm&&a.form.linkEditorForm.passConfirm&&a.form.linkEditorForm.linkPass&&(a.form.linkEditorForm.passConfirm.$setPristine(!1),a.form.linkEditorForm.linkPass.$setPristine(!1))}function n(b,c,d){a.form&&a.form.linkEditorForm&&a.form.linkEditorForm[b]&&a.form.linkEditorForm[b].$setValidity(c,d)}function o(a){return a?moment().diff(moment(moment.utc(a).format()),"hours")>0?"":moment(moment.utc(a).format()).calendar(null,{sameDay:"[Today]",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[]",lastWeek:"[]",sameElse:"[]"}).split(" at")[0]:""}function p(b){c.createDocLink(a.doc.id,b).then(function(b){l(b),a.settings.isSaving=!1},function(b){a.settings.isSaving=!1,i.alertFail(b)})}function q(b){c.updateDocLink(a.doc.id,a.docLink.id,b).then(function(b){l(b),a.settings.isSaving=!1},function(b){a.settings.isSaving=!1,i.alertFail(b)})}a.settings={isSaving:!1,isRemoving:!1,loadingUsers:!1,showAllowedUserPanel:!1,isEditingPassword:!1,showPasswordPanel:!1,showPassword:!1,challengeTypes:{"public":0,users:1,password:2},isEditingExpirationDate:!0,expirySelector:null,expiryOptions:[{label:"1 day",value:"1"},{label:"7 days",value:"7"},{label:"30 days",value:"30"},{label:"60 days",value:"60"},{label:"custom",value:"custom"}],customExpiryDays:null,expirationDateTagText:"",isCopied:!1},a.form={},d?l(d):(a.docLink={challengeType:a.settings.challengeTypes["public"],expirationDate:moment().add(60,"d").format(),password:"",allowedUserIDs:[],allowedUsers:[]},a.docLink.newExpirationDate=angular.copy(a.docLink.expirationDate),a.settings.expirySelector="60"),e&&(a.doc=e),a.updateChallengeTypeView=function(){a.docLink&&(a.docLink.challengeType||0===a.docLink.challengeType)&&(a.docLink.challengeType===a.settings.challengeTypes["public"]?(a.settings.showPasswordPanel=!1,a.settings.showAllowedUsersPanel=!1):a.docLink.challengeType===a.settings.challengeTypes.password?(a.settings.showAllowedUsersPanel=!1,a.docLink.originallyHadPassword||(a.settings.showPasswordPanel=!0)):a.docLink.challengeType===a.settings.challengeTypes.users&&(a.settings.showPasswordPanel=!1,a.settings.showAllowedUsersPanel=!0))},a.beginEditingPassword=function(){a.settings.isEditingPassword=!0,f(function(){a.$broadcast("onEditingPassword")})},a.cancelEditingPassword=function(){m(),a.settings.isEditingPassword=!1},a.onPasswordChanged=function(){if(a.docLink&&a.docLink.password){var b=a.docLink.password===a.docLink.passwordConfirm;n("passConfirm","passwordConfirm",b)}},a.beginEditingExpirationDate=function(){a.settings.isEditingExpirationDate=!0},a.cancelEditingExpirationDate=function(){a.docLink.newExpirationDate=angular.copy(a.docLink.expirationDate),a.settings.expirationDateTagText=o(a.docLink.newExpirationDate),a.settings.isEditingExpirationDate=!1,a.settings.expirySelector="",a.settings.customExpiryDays=null},a.updateExpirationDate=function(){if("custom"===a.settings.expirySelector){if(!a.settings.customExpiryDays)return;+a.settings.customExpiryDays<=0?a.settings.customExpiryDays=null:a.docLink.newExpirationDate=moment().utc().add(+a.settings.customExpiryDays,"d").format()}else a.settings.customExpiryDays=null,a.docLink.newExpirationDate=moment().utc().add(+a.settings.expirySelector,"d").format();a.settings.expirationDateTagText=o(a.docLink.newExpirationDate)},a.getUserList=function(b){return"@"===b[0]&&(b=b.slice(1)),b?h.getRelatedUsers(b).then(function(b){var c=_(b).reject(function(b){return a.docLink.allowedUserIDs.indexOf(b.userID)>-1});return c}):null},a.onUserSelected=function(b){a.docLink.allowedUsers.push(b),a.docLink.allowedUserIDs.push(b.userID),a.settings.userInput=""},a.removeAllowedUser=function(b){var c=b.userID?b.userID:b.id;if(c){a.docLink.allowedUsers=_(a.docLink.allowedUsers).reject(function(a){return a.userID===c}),g.removeFromList(a.docLink.allowedUsers,c);var d=a.docLink.allowedUserIDs.indexOf(c);d>-1&&a.docLink.allowedUserIDs.splice(d,1)}},a.canCancel=function(){return!a.settings.isSaving&&!a.settings.isRemoving},a.canRemove=function(){return!a.settings.isSaving&&!a.settings.isRemoving},a.canSave=function(){return a.settings&&a.docLink&&!a.settings.isSaving&&!a.settings.isRemoving&&a.form.linkEditorForm&&a.form.linkEditorForm.$valid&&("custom"!==a.settings.expirySelector||a.settings.customExpiryDays>0)&&(a.docLink.challengeType===a.settings.challengeTypes["public"]||a.docLink.challengeType===a.settings.challengeTypes.password&&(a.docLink.password||a.docLink.originallyHadPassword)||a.docLink.challengeType===a.settings.challengeTypes.users&&a.docLink.allowedUserIDs&&a.docLink.allowedUserIDs.length)},a.needsSave=function(){return!a.docLinkClone||!angular.equals(a.docLink.challengeType,a.docLinkClone.challengeType)||a.docLink.challengeType===a.settings.challengeTypes.password&&!angular.equals(a.docLink.password,a.docLinkClone.password)||a.docLink.challengeType===a.settings.challengeTypes.users&&!angular.equals(a.docLink.allowedUserIDs,a.docLinkClone.allowedUserIDs)||!angular.equals(a.docLink.expirationDate,a.docLink.newExpirationDate)},a.saveLink=function(){if(a.canSave()&&a.needsSave()){a.settings.isSaving=!0;var b=a.docLink.challengeType===a.settings.challengeTypes.users?a.docLink.allowedUserIDs:[],c=a.docLink.challengeType===a.settings.challengeTypes.password?a.docLink.password:"",d={challengeType:a.docLink.challengeType,expirationDateTime:a.docLink.newExpirationDate||a.docLink.expirationDate,filevineUsers:b,password:c,addGuestShares:0};a.docLink.id?q(d):p(d)}},a.removeDocLink=function(){a.canRemove()&&j.confirm({text:"Are you sure you wish to remove this share link?",confirmButtonText:"Remove Share Link",isLoadingButtonText:"Removing Share Link"},function(){return a.settings.isRemoving=!0,c.removeDocLink(a.doc.id,a.docLink.id).then(function(){a.settings.isRemoving=!1,b.dismiss("onDocLinksChanged")},function(b){a.settings.isRemoving=!1,i.alertFail(b)})})},a.selectLink=function(a){var b=a.currentTarget;b.setSelectionRange(0,b.value.length)},a.canCopyToClipboard=function(){return!navigator.userAgent.match(/ipad|iphone/i)&&document.queryCommandSupported&&document.queryCommandSupported("copy")},a.copyToClipboard=function(b){if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",b);if(a.canCopyToClipboard()){var c=document.createElement("textarea");c.textContent=b,c.style.position="fixed",c.style.opacity="0",document.body.appendChild(c),c.select();var d=!0;try{return document.execCommand("copy")}catch(e){return d=!1,console.warn("Copy to clipboard failed.",e),!1}finally{d&&(a.settings.isCopied=!0),document.body.removeChild(c)}}},a.generateEmailHref=function(){if(!a.doc||!a.docLink.shareableLink||!a.doc.filename)return"";var b=k.project()?"cc="+encodeURI(k.project().emailAddress):"",c="mailto:?"+b+(b?"&":"")+"subject="+encodeURI(a.doc.filename)+"&body="+encodeURI('The document, "'+a.doc.filename+'," has been shared with you on Filevine: ')+"%0D%0A%0D%0A"+encodeURI(a.docLink.shareableLink);return c},a.close=function(){a.canCancel()&&b.dismiss("close")}}angular.module("Crops").controller("docLinkEditorModalController",a),a.$inject=["$scope","$uibModalInstance","docService","docLink","doc","$timeout","fvUtils","userService","fvAlertsService","confirmService","projectService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){return{restrict:"E",replace:!0,scope:{doc:"=",currentFolder:"=",filterQuery:"=",project:"="},templateUrl:"{0}/docs/doc.list.item.html".format(b.viewRoot),link:function(i,j){function k(a){return a.replace(/\.[^\/.]+$/,"")}$(j).find("#docRenamePopup");i.settings={isEditingName:!1,isRenaming:!1,newFilename:"",isRemoving:!1,isConvertingToPdf:!1},i.permissions={allowRename:i.doc.canBeRenamed||!angular.isDefined(i.doc.canBeRenamed)&&i.project&&i.project.currentUserAccessLevel>=2,allowRemove:i.doc.canBeRemoved||!angular.isDefined(i.doc.canBeRemoved)&&i.project&&i.project.currentUserAccessLevel>=3,allowShare:!(!i.doc.canBeShared||!i.doc.shares.length)},i.permissions.allowLink=i.permissions.allowRename,i.permissions.allowEdit=i.permissions.allowRename&&i.doc.canEditInPlace,i.permissions.allowUpdate=i.permissions.allowRename,i.permissions.allowMove=i.permissions.allowRename,i.permissions.allowHashtags=i.permissions.allowRename;var l=[".pdf",".docx",".doc",".xls",".xlsx"];i.permissions.allowFax=i.permissions.allowRename&&i.project&&i.project.currentUserAccessLevel>1&&i.project.smsNumber&&i.project.faxEnabled&&_(l).any(function(a){return i.doc.filename.endsWith(a)});var m=[".docx",".doc",".xls",".xlsx",".ppt",".pptx"];i.permissions.allowPdfConversion=i.project&&i.project.currentUserAccessLevel>1&&_(m).any(function(a){return i.doc.filename.endsWith(a)}),i.canBeMoved=function(){return i.permissions.allowMove&&i.doc&&i.currentFolder&&(i.doc.folderID&&i.doc.folderID===i.currentFolder.id&&!i.currentFolder.isProjectRootFolder||i.currentFolder.isProjectRootFolder&&i.currentFolder.children&&i.currentFolder.children.length)},i.beginEditingName=function(){i.settings.newFilename=k(angular.copy(i.doc.filename)),i.settings.isEditingName=!0,f(function(){i.$broadcast("onEditingName")})},i.cancelEditingName=function(){i.isRenaming||(i.settings.isEditingName=!1,i.settings.newFilename="")},i.rename=function(){!i.settings.isRenaming&&i.settings.newFilename.trim()&&(i.settings.isRenaming=!0,a.renameDoc(i.doc.id,i.settings.newFilename.trim()).then(function(a){i.doc.filename=a,i.settings.isRenaming=!1,i.cancelEditingName()},function(){i.settings.isRenaming=!1}))},i.openFaxModal=function(a){i.permissions.allowFax&&h.showProjectFaxModal(i.project,a)},i.convertToPdf=function(b){!i.settings.isConvertingToPdf&&i.permissions.allowPdfConversion&&(i.settings.isConvertingToPdf=!0,a.convertToPdf(b.id).then(function(b){a.onDocAdded(b),d.alertSuccess("File converted to PDF and added to the top of the list")},function(a){d.alertFail(a)})["finally"](function(){i.settings.isConvertingToPdf=!1}))},i.getUrl=function(b){a.getDownloadUrl(b.id).then(function(a){window.location=a.url})},i.remove=function(b){i.permissions.allowRemove&&!i.settings.isRemoving&&g.confirm({text:"Are you sure you wish to remove this document?",confirmButtonText:"Remove Doc",isLoadingButtonText:"Removing Doc"},function(){return i.settings.isRemoving=!0,a.removeDoc(b.id)})},i.getExtension=function(){if(!i.doc)return"";if(!i.doc.filename)return"";var a=i.doc.filename.split(".").pop();return a&&a!==i.doc.filename?"."+a:""},i.preview=function(b){a.previewDoc(b,i.permissions.allowEdit)},i.isShared=function(a){return!!a&&_(a).any(function(a){return a.isShared})},i.showDocDetailsModal=function(c,d){var f=e.open({animation:!0,templateUrl:"{0}/docs/doc.details.modal.html".format(b.viewRoot),controller:"docDetailsModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-details-modal",resolve:{document:function(){return a.getDocByID(i.doc.id).then(function(a){return a})},activeTab:function(){return c},permissions:function(){return d}}});f.result.then(function(a){a&&(i.doc=a)})},i.editDoc=function(){i.permissions.allowEdit&&a.getEditDocUrl(i.doc.id).then(function(a){a&&(window.location=a)})},i.showDocDetails=function(a){("properties"===a||"update"===a&&i.permissions.allowUpdate||"docLinks"===a&&i.permissions.allowLink)&&i.showDocDetailsModal(a,i.permissions)},i.showDocMoveModal=function(){if(i.canBeMoved()){e.open({animation:!0,templateUrl:"{0}/docs/doc.move.modal.html".format(b.viewRoot),controller:"docMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"doc-modal doc-move-modal",resolve:{docID:function(){return i.doc.id},allowMove:function(){return i.permissions.allowMove}}})}},i.clearFilterAndGotoFolder=function(a){i.filterQuery="",f(function(){c.go("projectLayout.project.docs",{folderID:a})})}}}}angular.module("Crops").directive("docListItem",a),a.$inject=["docService","config","$state","fvAlertsService","$uibModal","$timeout","confirmService","faxService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){var c=b.projectID||a.doc.projectID;d.getProjectFolders(c).then(function(b){a.projectFolders=b})}function l(){if(e){angular.copy(a.doc);a.doc=null,d.getDocByID(e).then(function(b){a.doc=b,a.doc?(a.docIcon=d.getIconForFileType(a.doc.filename),m(),k()):a.folderTreeSettings.currentFolder=null})}}function m(){if(a.folderTreeSettings.currentFolder=null,a.folderTreeSettings.currentLocationId=null,a.doc){var c=b.projectID||a.doc.projectID;a.doc.folderID?d.getFolder(a.doc.folderID,c).then(n):d.getProjectRootFolder(c).then(n)}}function n(b){b&&(a.folderTreeSettings.currentFolder=b,a.folderTreeSettings.currentLocationId=b.id)}function o(){var b=a.folderTreeSettings.selectedFolder;return b&&a.settings.newFolder.name.trim()&&b.children&&b.children.length&&_(b.children).any(function(b){return b.name.toLowerCase()===a.settings.newFolder.name.trim().toLowerCase()})}a.doc=null,a.folderTreeSettings={selectedFolder:null,selectedFolderId:null,currentFolder:null,currentLocationId:null,canSelectCurrent:!1,autoSelectCurrent:!1,canSelectParent:!0,showDescendants:!0,openToCurrent:!0,disabled:!1},a.settings={newFilename:null,isMovingDoc:!1,isAddingFolder:!1,isCreatingFolder:!1,moveToNewlyCreatedFolder:!1,invalidFolderNameChars:j.folderNameInvalidCharacters},a.allowMove=function(){return"undefined"!=typeof f?f:a.doc&&a.doc.canBeRenamed},a.canMoveDoc=function(){return!a.settings.isMovingDoc&&!a.settings.isCreatingFolder&&a.doc&&a.allowMove()&&a.folderTreeSettings.selectedFolderId},a.projectExternalIDs=d.projectExternalIDs(),a.projectExternalIDType=d.projectExternalIDType(),a.showIntegrationWarning=function(){return a.projectExternalIDs&&a.projectExternalIDs.length&&a.projectExternalIDs[0].integrationTypeID<=11&&a.folderTreeSettings&&a.folderTreeSettings.currentFolder&&!a.folderTreeSettings.currentFolder.isProjectRootFolder&&!a.folderTreeSettings.selectedFolder.isProjectRootFolder},a.loading=function(){return!a.doc||!a.folderTreeSettings.currentFolder||!a.projectFolders},l(),a.close=function(){c.dismiss("close")},a.moveDoc=function(){a.canMoveDoc()&&(a.settings.isMovingDoc=!0,a.folderTreeSettings.disabled=!0,d.moveDocToFolder(a.doc.id,a.folderTreeSettings.selectedFolderId))},a.$on(d.onDocMoved,function(d,e){i.includes("projectLayout.project.docs")&&b.projectID?i.go("projectLayout.project.docs",{folderID:e}):h.alertSuccess("Document successfully moved!"),a.doc.folderID=e,c.close(a.doc)}),a.$on(d.onDocMoveFail,function(b,c){h.alertFail(c),a.settings.isMovingDoc=!1,a.folderTreeSettings.disabled=!1}),a.beginCreateFolder=function(){a.settings.newFolder={parentID:a.folderTreeSettings.selectedFolderId,name:""},a.settings.isAddingFolder=!0,a.folderTreeSettings.canSelectCurrent=!0},a.canCreateFolder=function(){return!a.settings.isCreatingFolder&&!a.settings.isMovingDoc&&a.allowMove()&&a.settings.newFolder&&a.settings.newFolder.parentID&&a.settings.newFolder.parentID===a.folderTreeSettings.selectedFolderId&&a.settings.newFolder.name.trim()&&a.settings.moveDocNewFolderForm&&a.settings.moveDocNewFolderForm.$valid},a.validateNewFolderName=function(){if(a.settings.newFolder&&a.settings.moveDocNewFolderForm){var b=a.settings.newFolder.name,c=a.settings.moveDocNewFolderForm.moveDocNewFolderName;c.$setValidity("invalidChars",!j.folderNameInvalidCharactersRegex.test(b)),c.$setValidity("duplicate",!o(b))}},a.$watch("folderTreeSettings.selectedFolderId",function(){a.settings&&a.settings.isAddingFolder&&a.settings.newFolder&&a.folderTreeSettings.selectedFolderId&&(a.settings.newFolder.parentID=a.folderTreeSettings.selectedFolderId,a.validateNewFolderName())}),a.createFolder=function(c){if(a.canCreateFolder()){a.settings.isCreatingFolder=!0,a.folderTreeSettings.disabled=!0,a.settings.moveToNewlyCreatedFolder=c,a.settings.newFolder.name=a.settings.newFolder.name.trim();var e=b.projectID||a.doc.projectID;d.createFolder(a.settings.newFolder,e)}},a.$on(d.onCreateFolderSuccess,function(b,c){a.folderTreeSettings.selectedFolder=c,a.folderTreeSettings.selectedFolderId=c.id,a.settings.moveToNewlyCreatedFolder&&a.folderTreeSettings.selectedFolderId&&a.doc?(a.settings.moveToNewlyCreatedFolder=!1,a.settings.isMovingDoc=!0,d.moveDocToFolder(a.doc.id,a.folderTreeSettings.selectedFolderId).then(function(){},function(){a.settings.isCreatingFolder=!1,a.cancelCreateFolder(),a.folderTreeSettings.currentFolder.id===c.parentID&&m(),k(),a.settings.isMovingDoc=!1,a.folderTreeSettings.disabled=!1;
})):(a.settings.isCreatingFolder=!1,a.cancelCreateFolder(),a.folderTreeSettings.currentFolder.id===c.parentID&&m(),k(),a.folderTreeSettings.disabled=!1)}),a.$on(d.onCreateFolderFail,function(){a.settings.isCreatingFolder=!1,a.folderTreeSettings.disabled=!1}),a.cancelCreateFolder=function(){a.settings.isCreatingFolder||(delete a.settings.newFolder,a.folderTreeSettings.canSelectCurrent=!1,a.folderTreeSettings.currentFolder.id===a.folderTreeSettings.selectedFolderId&&(a.folderTreeSettings.selectedFolder=null,a.folderTreeSettings.selectedFolderId=null),a.settings.isAddingFolder=!1)}}angular.module("Crops").controller("docMoveModalController",a),a.$inject=["$scope","$stateParams","$uibModalInstance","docService","docID","allowMove","$timeout","fvAlertsService","$state","config"]}(),function(){"use strict";function a(a,b,c,d,e){var f=0;return{restrict:"EA",replace:!0,scope:{doc:"=",projectId:"=",onSelect:"&?",placeholder:"@?",formControlName:"@?",allowUpload:"=?",docTypes:"@?",isUploadingDoc:"=?"},templateUrl:"{0}/docs/doc.selector.html".format(b.viewRoot),link:function(b,g,h){b.docSelectorID=f,b.docInputID=b.formControlName?b.formControlName:"docInput"+f,b.docUploadID="docUpload"+f,b.isUploadingDoc=!1,f++,b.settings={selectedDoc:null,uploads:[]},b.placeholder=b.placeholder||"Type to search",b.removeDoc=function(){b.disabled||(b.doc=null,b.onSelect&&angular.isFunction(b.onSelect)&&b.onSelect({doc:null}))},b.onDocSelected=function(a,c,d){b.onSelect&&angular.isFunction(b.onSelect)&&b.onSelect({doc:a}),b.doc=a,b.settings.selectedDoc=null},b.docList=function(b){return c.projectID?a.get("/api/docs/glimpse/project?q={0}&projectID={1}".format(encodeURIComponent(b),c.projectID)).then(function(a){return a}):[]},b.preview=function(a){d.previewDoc(a,!1)},b.uploadDoc=function(a,d){a.length>0&&(b.isUploadingDoc=!0,b.$apply(function(){b.settings.uploads=[{file:a[0],percent:0,id:-1,projectID:c.projectID,complete:function(){b.isUploadingDoc=!1,this.file.id=this.id,this.file.filename=this.file.filename||this.file.name,b.onDocSelected(this.file),b.settings.uploads=[]}}]}))},b.removeUpload=function(a){var c=b.settings.uploads.indexOf(a);c>=0&&(b.settings.uploads=_(b.settings.uploads).reject(function(b){return b.id===a.id}),b.doc=null)},e(function(){b.docTypes&&b.allowUpload&&$("#"+b.docUploadID).attr("accept",b.docTypes)})}}}angular.module("Crops").directive("docSelector",a),a.$inject=["fvApi","config","$stateParams","docService","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k){function l(b){return a.get(na.getDocByID,[b])}function m(b,c,d,e,f,g){var h={orgID:c,targetNumber:d,coverSheetDocID:e,mainFaxDocID:f,personFaxID:g};return a.post(na.sendProjectFax,[b],h).then(function(a){k.subscribeToNote(a.id)})}function n(d,e,f,g){if(c.projectID&&c.projectID===qa){if(d||e!==wa||f!==xa){pa.docs=!0,b.$broadcast(Ka),oa=[],wa=e,xa=f,ya=g||0;var h=za?za.id:null;c.projectID&&a.get(na.getDocs,[c.projectID,0,wa,xa,ya,h,!!wa]).then(function(a){(e||wa)&&e!==wa||(oa=a,va=!a||30===a.length,pa.docs=!1,b.$broadcast(Ca))})}}else V()}function o(){!va||pa.docs||pa.moreDocs||(pa.moreDocs=!0,b.$broadcast(Ka),a.get(na.getDocs,[c.projectID,oa.length,wa,xa,ya,za.id,!!wa]).then(function(a){oa=oa.concat(a),pa.moreDocs=!1,va=!a||30===a.length,b.$broadcast(Ca)}))}function p(){return c.projectID&&c.projectID===qa?oa:(V(),[])}function q(){c.projectID&&ta&&c.projectID===sa?b.$broadcast(Ja):c.projectID&&(sa=c.projectID,ta=null,ua=null,a.get(na.externalIDsForProject,[c.projectID]).then(function(a){ta=a,ta&&ta.length&&(ua=ra[ta[0].integrationTypeID])})["finally"](function(){b.$broadcast(Ja)}))}function r(){return ta}function s(){return ua}function t(){return ra}function u(b){return a.post(na.setExternalIDForProject,[c.projectID,b.integrationTypeID],JSON.stringify(b.externalID))}function v(a){a&&a.length&&(a[0].folderID===za.id||!a[0].folderID&&za.isProjectRootFolder)&&(oa=oa.concat(a))}function w(a){a&&(a.folderID===za.id||!a.folderID&&za.isProjectRootFolder)&&oa.unshift(a)}function x(){return pa}function y(a){var b=f.defer();return e.post(na.docsDownload.format(a)).then(function(a){if(a&&a.data&&a.data.url)b.resolve(a.data);else{var c=a&&a.data&&a.data.message?a.data.message:Pa;b.reject(c),h.alertFail(c)}},function(){b.reject(Pa),h.alertFail(Pa)}),b.promise}function z(a){var b=f.defer();return e.post(na.docsEdit.format(a)).then(function(a){if(a&&a.data&&a.data.success)b.resolve(a.data.data);else{var c=a&&a.data&&a.data.message?a.data.message:Pa;b.reject(c),h.alertFail(c)}},function(){b.reject(Pa),h.alertFail(Pa)}),b.promise}function A(b){return a.del(na.docsEdit,[b])}function B(a,c,d,e){var f=b.pendingUploads[a];null!==f&&void 0!==f&&null!==f.onProgress&&f.onProgress(Math.round(d/e*100))}function C(a,c,d,e){var f=b.pendingUploads[a];null!==f&&void 0!==f&&null!==f.onComplete&&f.onComplete(f.docID,d.success)}function D(a){var c=b.pendingUploads["new"];return b.pendingUploads[a]=c,E(c)}function E(a){var b=new qq.Promise,c=JSON.stringify({filename:a.filename,size:a.size,projectID:a.projectID,folderID:a.folderID});return e.post(na.docsUploadKey,c).success(function(c){a.docID=c.docID,b.success(c.key)}).error(function(){b.failure("cannot get upload key")}),b}function F(a,c,d){b.pendingUploads["new"]={size:a.size||0,filename:a.name,projectID:c,docID:-1,onProgress:d.onProgress,onComplete:d.onComplete},Ra.addFiles(a)}function G(a){var c=0;for(var d in b.pendingUploads)if(b.pendingUploads.hasOwnProperty(d)){if(d.filename===a.file.name&&d.size===a.file.size)try{Qa.uploader.cancel(c)}catch(e){console.log(e)}c++}}function H(c){return a.del(na.docRemove,[c]).then(function(){oa&&(oa=_(oa).reject(function(a){return a.id===c}),b.$broadcast(Na,{hasMore:va,curLength:oa.length}))})}function I(b,c){return a.post(na.docRename,[b],{newName:c})}function J(b){return a.post(na.convertToPdf,[b])}function K(b,c){return a.get(na.updateDoc,[b,c])}function L(b){return a.get(na.getRevisionList,[b])}function M(b,c){return a.get(na.revertToRevision,[b,c])}function N(a,b){var c=f.defer();return e.post(na.revisionDownload.format(a,b)).then(function(a){if(a&&a.data&&a.data.url)c.resolve(a.data);else{var b=a&&a.data&&a.data.message?a.data.message:Pa;c.reject(b),h.alertFail(b)}},function(){c.reject(Pa),h.alertFail(Pa)}),c.promise}function O(a,b){e.post(na.revisionDownloadInline.format(a.id,b)).then(function(c){if(c&&c.data&&c.data.url)c.data.rev=b,ma(a,c.data);else{var d=c&&c.data&&c.data.message?c.data.message:Pa;h.alertFail(d)}},function(){h.alertFail(Pa)})}function P(a,b){e.post(na.docsDownloadInline.format(a.id)).then(function(c){if(c&&c.data&&c.data.url)ma(a,c.data,b);else{var d=c&&c.data&&c.data.message?c.data.message:Pa;h.alertFail(d)}},function(){h.alertFail(Pa)})}function Q(a){var b=f.defer();return e.post(na.docsDownloadInline.format(a.id)).then(function(a){if(a&&a.data&&a.data.url)b.resolve(g.trustAsResourceUrl(a.data.url));else{var c=a&&a.data&&a.data.message?a.data.message:Pa;h.alertFail(c)}},function(){b.reject(Pa),h.alertFail(Pa)}),b.promise}function R(){b.$broadcast(Oa)}function S(){return c.projectID&&c.projectID===qa?za:(V(),null)}function T(b){return b=b||c.projectID,b?a.get(na.getProjectFolders,[b]):f.when(null)}function U(b){return b=b||c.projectID,b?a.get(na.getProjectRootFolder,[b]):f.when(null)}function V(){qa=c.projectID,oa=null,za=null,pa.folder=!0,b.$broadcast(Ca),U().then(function(a){za=a,pa.folder=!1,b.$broadcast(Ea)})}function W(d,e){e=e||c.projectID,e?a.post(na.createFolder,[e],d).then(function(a){a&&za&&a.parentID===za.id&&(za.children.unshift(a),b.$broadcast(Ea)),b.$broadcast(Ha,a)},function(a){h.alertFail(a),b.$broadcast(Ia)}):console.error("Error: docService.createFolder - No project ID")}function X(d,e){return c.projectID?a.post(na.moveFolder,[c.projectID,d],{parentID:e}).then(function(a){za=a,b.$broadcast(Ea)}):f.when(null)}function Y(d,e){c.projectID?a.put(na.renameFolder,[c.projectID,d],{name:e}).then(function(a){za=a,b.$broadcast(Ea)},function(a){h.alertFail(a),b.$broadcast(Fa,d)}):console.error("Error: docService.renameFolder - No project ID")}function Z(b,d){return d=d||c.projectID,d?a.get(na.getFolder,[d,b]):f.when(null)}function $(a){return qa=c.projectID,pa.folder=!0,Z(a).then(function(a){a?(za=a,pa.folder=!1,b.$broadcast(Ea)):(za=null,oa=null,b.$broadcast(Ca),b.$broadcast(Ea))},function(){d.includes("projectLayout.project.docs")&&d.go("projectLayout.project.docs",{folderID:null})})}function aa(){c.folderID?$(c.folderID):V()}function ba(d){return c.projectID?a.del(na.removeFolder,[c.projectID,d]).then(function(){b.$broadcast(Ga,d)}):(console.error("Error: docService.removeFolder - No project ID"),f.reject("Error: docService.removeFolder - No project ID"))}function ca(c,d){return a.post(na.moveDocToFolder,[c],{id:d}).then(function(a){return b.$broadcast(La,d),a},function(a){b.$broadcast(Ma,a)})}function da(a){var b=a?a.split(".").pop().toLowerCase():"";return b===a?"":b}function ea(a){var b=a?a.split(".").pop().toLowerCase():"";switch(b){case"pdf":return"fa-file-pdf-o";case"xls":case"xlsx":case"csv":case"xlsm":return"fa-file-excel-o";case"doc":case"docx":case"docm":case"docb":return"fa-file-word-o";case"wav":case"mp3":case"aiff":case"wma":case"aac":return"fa-file-sound-o";case"zip":case"gz":case"tar":case"7z":case"rar":return"fa-file-zip-o";case"gif":case"jpg":case"jpeg":case"png":case"tiff":case"tif":case"bmp":case"svg":case"ps":return"fa-file-image-o";case"avi":case"wmv":case"mov":case"mp4":case"qt":case"mpg":case"mpeg":case"flv":case"swf":return"fa-file-movie-o";case"txt":return"fa-file-text-o";case"ppt":case"pps":case"pptx":case"potx":case"potm":case"ppsx":case"ppsm":case"sldx":case"sldm":return"fa-file-powerpoint-o";default:return"fa-file-o"}}function fa(b){return a.get(na.getShareableLink,[b])}function ga(b,c){return a.post(na.processShareableLink,[b],{password:c})}function ha(b,c){return a.post(na.createDocLink,[b],c)}function ia(b){return a.get(na.getDocLinksForDoc,[b])}function ja(b,c){return a.get(na.getDocLink,[b,c])}function ka(b,c){return a.del(na.removeDocLink,[b,c])}function la(b,c,d){return a.put(na.updateDocLink,[b,c],d)}function ma(a,b,c){if(!Aa&&b&&b.url){Aa=!0,b.url=g.trustAsResourceUrl(b.url);var d=i.open({animation:!0,templateUrl:"{0}/docs/doc.viewer.modal.html".format(j.viewRoot),controller:"docViewerModalController",size:"full",windowClass:"doc-modal doc-viewer-modal",resolve:{doc:function(){return a},viewSettings:function(){return b},allowEdit:function(){return c}}});d.result.then(function(){Aa=!1},function(){Aa=!1})}}var na={docsEdit:"/api/docedit/{0}/editing",docsDownload:"/api/docs/download/{0}",docsDownloadInline:"/api/docs/downloadinline/{0}",docsUploadKey:"/api/docs/uploadkey",docsSignPolicy:"/api/docs/signpolicy",getDocs:"/api/docs/project/{0}?offset={1}&filter={2}&sort={3}&id={4}&folderID={5}&recursive={6}",getDocByID:"api/docs/{0}/details",docRemove:"/api/docs/{0}/remove",docRename:"/api/docs/{0}/rename",convertToPdf:"/api/docs/{0}/convertToPdf",sendProjectFax:"/api/docs/sendProjectFax/{0}",updateDoc:"/api/docs/{0}/claimDocAsRevision/{1}",getRevisionList:"/api/docs/{0}/versions",revertToRevision:"/api/docs/{0}/RevertToRevision/{1}",revisionDownload:"/api/docs/download/{0}/revisions/{1}",revisionDownloadInline:"/api/docs/downloadinline/{0}/revisions/{1}",claimDocForProject:"/api/docs/{0}/claimForProject/{1}",externalIDsForProject:"/api/integrationItems/project/{0}",setExternalIDForProject:"/api/integrationItems/project/{0}/{1}/",getProjectFolders:"api/projects/{0}/rootfolder",createFolder:"api/projects/{0}/folders",getProjectRootFolder:"api/projects/{0}/folders",moveFolder:"api/projects/{0}/folders/{1}",renameFolder:"api/projects/{0}/folders/{1}",getFolder:"api/projects/{0}/folders/{1}",removeFolder:"api/projects/{0}/folders/{1}",getChildFolders:"api/projects/{0}/folders/{1}/children",moveDocToFolder:"api/docs/{0}/move",getShareableLink:"api/doclinks/links/{0}",processShareableLink:"api/doclinks/links/{0}",createDocLink:"api/docs/{0}/links",getDocLinksForDoc:"api/docs/{0}/links",getDocLink:"api/docs/{0}/links/{1}",removeDocLink:"api/docs/{0}/links/{1}",updateDocLink:"api/docs/{0}/links/{1}"},oa=null,pa={docs:!1,moreDocs:!1,folder:!1},qa=-1,ra={1:{name:"Net Documents",icon:"fv-icon-netdocuments"},2:{name:"Dropbox",icon:"fv-icon-dropbox"},3:{name:"Google Drive",icon:"fv-icon-google-drive"},7:{name:"Microsoft OneDrive",icon:"fv-icon-onedrive"},12:{name:"Dropbox",icon:"fv-icon-dropbox"},13:{name:"Google Drive",icon:"fv-icon-google-drive"},19:{name:"SpringCM",icon:"fv-icon-springcm"},20:{name:"Box",icon:"fv-icon-box"}},sa=null,ta=null,ua=null,va=!0,wa="",xa="",ya=0,za=null,Aa=!1,Ba="docService.onPreviewDoc",Ca="docService.onDocListChanged",Da="docService.onFolderChanged",Ea="docService.onCurrentFolderChanged",Fa="docService.onCurrentFolderRenameFail",Ga="docService.onFolderRemoved",Ha="docService.onCreateFolderSuccess",Ia="docService.onCreateFolderFail",Ja="docService.onProjectExternalIDsChanged",Ka="docService.onLoadingChanged",La="docService.onDocMoved",Ma="docService.onDocMoveFail",Na="docService.onDocRemoved",Oa="docService.onDocHashtagsModalClosed",Pa="File unavailable. If the problem persists, please contact your Administrator.",Qa={getDocByID:l,loadDocs:n,docList:p,onDocsAdded:v,onDocAdded:w,onDocListChanged:Ca,onPreviewDoc:Ba,onFolderChanged:Da,onCurrentFolderChanged:Ea,onCurrentFolderRenameFail:Fa,onFolderRemoved:Ga,onCreateFolderSuccess:Ha,onCreateFolderFail:Ia,onProjectExternalIDsChanged:Ja,onLoadingChanged:Ka,isLoading:x,onDocMoved:La,onDocMoveFail:Ma,onDocRemoved:Na,closeDocsHashtagsModal:R,onDocHashtagsModalClosed:Oa,loadMore:o,getDownloadUrl:y,getEditDocUrl:z,releaseDoc:A,callProgress:B,callComplete:C,generateKey:D,generateKeyFromObject:E,addFiles:F,removeUpload:G,removeDoc:H,renameDoc:I,convertToPdf:J,sendProjectFax:m,updateDoc:K,getRevisionList:L,revertToRevision:M,getRevisionDownloadUrl:N,previewRevision:O,previewDoc:P,previewDocUrl:Q,claimDocForProject:function(b,c){return a.get(na.claimDocForProject,[b,c])},getExternalIDsForProject:q,projectExternalIDs:r,projectExternalIDType:s,integrationTypes:t,setProjectExternalID:u,getIconForFileType:ea,getExtension:da,currentFolder:S,getProjectFolders:T,createFolder:W,getProjectRootFolder:U,setProjectRootFolderAsCurrent:V,moveFolder:X,renameFolder:Y,getFolder:Z,setAsCurrentFolder:$,loadFolder:aa,removeFolder:ba,moveDocToFolder:ca,getShareableLink:fa,processShareableLink:ga,createDocLink:ha,getDocLinksForDoc:ia,getDocLink:ja,removeDocLink:ka,updateDocLink:la};b.pendingUploads={};var Ra=new qq.s3.FineUploaderBasic({debug:!0,callbacks:{onComplete:function(a,b,c,d){return Qa.callComplete(a,b,c,d)},onProgress:function(a,b,c,d){return Qa.callProgress(a,b,c,d)}},request:{endpoint:Crops.AwsDocsEndpoint,accessKey:Crops.AwsAccessKey},signature:{endpoint:na.docsSignPolicy,version:4},retry:{enableRetry:!0,maxAutoAttempts:3,autoAttemptsDelay:3},objectProperties:{region:Crops.AwsRegion,key:function(a){return Qa.generateKey(a)}}});return Qa}angular.module("Crops").service("docService",a),a.$inject=["fvApi","$rootScope","$stateParams","$state","$http","$q","$sce","fvAlertsService","$uibModal","config","pushService"]}(),function(){"use strict";function a(a,b){return{restrict:"E",templateUrl:"{0}/docs/doc.upload.html".format(b.viewRoot),link:function(b,c){b.isComplete=!1,b.showProgressBar=function(){return!b.isComplete},b.progress=function(){return{width:b.upload.percent+"%"}},b.onProgress=function(a){b.$apply(function(){b.upload.percent=a})},b.onComplete=function(a,c){b.$apply(function(){c?(b.upload.percent=100,b.upload.id=a,b.upload.complete&&angular.isFunction(b.upload.complete)&&b.upload.complete(),b.isComplete=!0):b.$parent.removeUpload(b.upload)})},b.uploadDoc=function(){var c=a.addFiles(b.upload.file,b.upload.projectID,{onProgress:b.onProgress,onComplete:b.onComplete});return c},b.uploadDoc(),b.removeUpload=function(){b.$parent.removeUpload(b.upload),a.removeUpload(b.upload)}}}}angular.module("Crops").directive("docUpload",a),a.$inject=["docService","config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(b){if(!a.imageDimensions){var c=angular.element(document.getElementById("fv-image-view"))[0];c&&(a.imageDimensions={width:c.clientWidth,height:c.clientHeight})}a.imageDimensions&&a.$applyAsync(function(){var c=a.imageDimensions.width,d=a.imageDimensions.height;90===b||270===b?(a.viewSettings.imageStyle={width:c+"px",height:d+"px","max-height":"none","max-width":"none"},a.viewSettings.imageContainerStyle={width:d+"px",height:c+"px"}):(a.viewSettings.imageStyle={width:c+"px",height:d+"px","max-height":"none","max-width":"none"},a.viewSettings.imageContainerStyle={width:c+"px",height:d+"px"})})}e&&(a.doc=e,a.doc.imageRotation=0,a.docIcon=d.getIconForFileType(a.doc.filename)),f&&(a.viewSettings=f||{},a.viewSettings.isImage&&e&&"svg"===d.getExtension(e.filename)&&(a.viewSettings.isSvg=!0)),a.viewSettings.imageStyle={},a.viewSettings.imageContainerStyle={},a.rotateLeft=function(){a.doc.imageRotation-=90,a.doc.imageRotation<0&&(a.doc.imageRotation+=360),h(a.doc.imageRotation)},a.rotateRight=function(){a.doc.imageRotation+=90,a.doc.imageRotation>270&&(a.doc.imageRotation-=360),h(a.doc.imageRotation)},a.allowEdit=function(){return a.doc&&(g||"undefined"==typeof g&&a.doc.canBeRenamed&&a.doc.canEditInPlace)},a.editDoc=function(){a.allowEdit&&d.getEditDocUrl(a.doc.id).then(function(b){b&&(a.close(),window.location=b)})},a.close=function(){b.dismiss("onDocViewerClosed")}}angular.module("Crops").controller("docViewerModalController",a),a.$inject=["$scope","$uibModalInstance","config","docService","doc","viewSettings","allowEdit"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{rootFolder:"=",settings:"="},templateUrl:"{0}/docs/folder.tree.html".format(a.viewRoot),link:function(b,d){b.folderNameError={},b.isCurrentFolder=function(){return b.settings.currentFolder&&b.rootFolder&&b.rootFolder.id===b.settings.currentFolder.id},b.isCurrentLocation=function(){return b.settings.currentLocationId&&b.rootFolder&&b.rootFolder.id===b.settings.currentLocationId},b.isParent=function(){return b.settings.currentFolder&&b.rootFolder&&b.rootFolder.id===b.settings.currentFolder.parentID},b.hideCurrentFolder=function(){return!b.settings.canSelectCurrent&&!b.settings.showDescendants},b.selectFolder=function(a){!b.settings||b.settings.isRenaming&&b.settings.isRenaming[a.id]||b.isCurrentFolder()&&!b.settings.canSelectCurrent||b.isParent()&&!b.settings.canSelectParent||b.settings.disabled||(b.settings.selectedFolder=a,b.settings.selectedFolderId=a.id,b.settings.onSelect&&angular.isFunction(b.settings.onSelect)&&b.settings.onSelect(a))},b.beginRename=function(a){a.stopPropagation(),b.rootFolderCopy=angular.copy(b.rootFolder),b.settings.isRenaming=b.settings.isRenaming||{},b.settings.isRenaming[b.rootFolder.id]=!0},b.canRename=function(){return b.rootFolderCopy&&b.rootFolderCopy.name&&b.rootFolderCopy.name!==b.rootFolder.name&&(!Object.keys(b.folderNameError).length||!_(Object.values(b.folderNameError)).compact().length)},b.rename=function(a){a&&a.stopPropagation(),b.rootFolderCopy.name=b.rootFolderCopy.name.trim(),b.canRename&&(b.rootFolder.name=b.rootFolderCopy.name,b.cancelRenaming())},b.cancelRenaming=function(a){a&&a.stopPropagation(),b.settings.isRenaming[b.rootFolder.id]=!1,delete b.rootFolderCopy},b.validateFolderName=function(){b.folderNameError={},b.rootFolderCopy&&(b.settings.validateFolderName&&angular.isFunction(b.settings.validateFolderName)&&(b.folderNameError=b.settings.validateFolderName(b.rootFolderCopy)),b.folderNameError.required||b.rootFolderCopy.name?!b.folderNameError.invalidChars&&a.folderNameInvalidCharactersRegex.test(b.rootFolderCopy.name)&&(b.folderNameError.invalidChars="Folder name cannot contain: "+a.folderNameInvalidCharacters):b.folderNameError.required="Folder name cannot be blank")},c.$on("folderTreeItem.onFolderRemoved",function(a,c){c.parentID&&c.parentID!==b.rootFolder.id||(b.rootFolder.children=_(b.rootFolder.children).reject(function(a){return a.id===c.id}),b.settings.selectedFolderId===c.id&&(b.settings.selectedFolderId=null,b.settings.selectedFolder=null))})}}}angular.module("Crops").directive("folderTree",a),a.$inject=["config","$timeout","$rootScope"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",replace:!0,scope:{folder:"=",siblings:"=",settings:"=",onSelect:"&?"},templateUrl:"{0}/docs/folder.tree.item.html".format(a.viewRoot),link:function(b,e){function f(a,b){return _(a.parents).findWhere({id:b})}function g(a,b){return _(a.children).any(function(a){return a.id===b||g(a,b)})}b.folderSettings={isOpen:!1},b.folderNameError={},b.toggleFolderOpen=function(a){a.stopPropagation(),b.folderSettings.isOpen=!b.folderSettings.isOpen},b.$on("onFolderOpened",function(a,c){c===b.folder.id&&(b.folderSettings.isOpen=!0)}),b.isCurrentFolder=function(){return b.settings.currentFolder&&b.folder.id===b.settings.currentFolder.id},b.isCurrentLocation=function(){return b.settings.currentLocationId&&b.folder&&b.folder.id===b.settings.currentLocationId},b.isParent=function(){return b.settings.currentFolder&&b.folder.id===b.settings.currentFolder.parentID},b.hideCurrentFolder=function(){return!b.settings.canSelectCurrent&&!b.settings.showDescendants},b.selectFolder=function(a){!b.settings||b.settings.isRenaming&&b.settings.isRenaming[a.id]||b.isCurrentFolder()&&!b.settings.canSelectCurrent||b.isParent()&&!b.settings.canSelectParent||b.settings.disabled||(b.settings.selectedFolder=a,b.settings.selectedFolderId=a.id,b.settings.onSelect&&angular.isFunction(b.settings.onSelect)&&b.settings.onSelect(a))},b.removeFolder=function(a,d){a.stopPropagation(),b.settings.allowRemove&&(d.children&&d.children.length?c.confirm({text:"Remove '"+d.name+"' folder and all of its subfolders?",confirmButtonText:"Remove",isLoadingText:"Removing"}).then(function(){b.$emit("folderTreeItem.onFolderRemoved",d)}):b.$emit("folderTreeItem.onFolderRemoved",d))},d.$on("folderTreeItem.onFolderRemoved",function(a,c){c.parentID===b.folder.id&&(b.folder.children=_(b.folder.children).reject(function(a){return a.id===c.id}),b.settings.selectedFolderId===c.id&&(b.settings.selectedFolderId=null,b.settings.selectedFolder=null))}),b.$watch("settings.currentFolder",function(){b.settings&&b.settings.currentFolder&&(b.folder&&b.settings.openToCurrent&&b.settings.currentFolder.parents&&f(b.settings.currentFolder,b.folder.id)&&(b.folderSettings.isOpen=!0),b.settings.autoSelectCurrent&&b.settings.canSelectCurrent&&(b.settings.selectedFolderId=b.settings.currentFolder.id))}),b.settings.selectedFolderId&&g(b.folder,b.settings.selectedFolderId)&&(b.folderSettings.isOpen=!0),b.beginRename=function(a){a.stopPropagation(),b.folderCopy=angular.copy(b.folder),b.settings.isRenaming=b.settings.isRenaming||{},b.settings.isRenaming[b.folder.id]=!0},b.canRename=function(){return b.folderCopy&&b.folderCopy.name&&b.folderCopy.name!==b.folder.name&&(!Object.keys(b.folderNameError).length||!_(Object.values(b.folderNameError)).compact().length)},b.rename=function(a){a&&a.stopPropagation(),b.folderCopy.name=b.folderCopy.name.trim(),b.validateFolderName(),b.canRename&&(b.folder.name=b.folderCopy.name,b.cancelRenaming())},b.cancelRenaming=function(a){a&&a.stopPropagation(),b.settings.isRenaming[b.folder.id]=!1,b.folderNameError={},delete b.folderCopy},b.validateFolderName=function(){b.folderNameError={},b.folderCopy&&(b.settings.validateFolderName&&angular.isFunction(b.settings.validateFolderName)&&(b.folderNameError=b.settings.validateFolderName(b.folderCopy)),b.folderNameError.required||b.folderCopy.name?(!b.folderNameError.invalidChars&&a.folderNameInvalidCharactersRegex.test(b.folderCopy.name)&&(b.folderNameError.invalidChars="Folder name cannot contain: "+a.folderNameInvalidCharacters),!b.folderNameError.duplicate&&b.siblings&&b.siblings.length&&_(b.siblings).any(function(a){return a.id!==b.folderCopy.id&&a.name.toLowerCase()===b.folderCopy.name.trim().toLowerCase()})&&(b.folderNameError.duplicate="Folder name must be unique")):b.folderNameError.required="Folder name cannot be blank")}}}}angular.module("Crops").directive("folderTreeItem",a),a.$inject=["config","$timeout","confirmService","$rootScope"]}(),function(){"use strict";function a(a,b,c,d,f,g){return{restrict:"E",replace:"true",scope:{uploadButtonText:"@",dropZoneText:"@",projectId:"=",folderId:"=?",completed:"=",hasPendingUploads:"=",hideCompletedFilesAfterAWhile:"="},link:function(b,h){var i={};b.completed=b.completed||[],b.hasPendingUploads=!1;var j=b.hideCompletedFilesAfterAWhile||!1;$(h).fineUploaderS3({debug:!0,callbacks:{onSubmitted:function(a,c){var d={size:$(h).fineUploader("getSize",a)||0,filename:c,projectID:b.projectId,folderID:b.folderId||null,docID:-1};i[a]=d,b.hasPendingUploads=!0,b.$emit("uploadStart",d)},onComplete:function(a,c,d){var e=i[a];if(e&&d.success){delete i[a],e.percent=100,e.isComplete=!0,e.id=e.docID;var g=this;e.hideInUploader=function(){$(g.getItemByFileId(a)).hide("slow")},b.completed.push(e),b.$emit("uploadComplete",e),console.info(e),j&&f(function(){e.hideInUploader()},1e4)}else b.removeUpload(e)},onProgress:function(a,b,c,d){i[a].percent=Math.round(c/d*100)}},request:{endpoint:Crops.AwsDocsEndpoint,accessKey:Crops.AwsAccessKey},signature:{endpoint:"/api/docs/signpolicy",version:4},retry:{enableRetry:!0,maxAutoAttempts:3,autoAttemptsDelay:3},objectProperties:{region:Crops.AwsRegion,key:function(b){return a.generateKeyFromObject(i[b])}},display:{prependFiles:!0},failedUploadTextDisplay:{mode:"custom"},deleteFile:{enabled:!1},resume:{enabled:!0},showMessage:function(a){console.warn(a),g.alertFail(a)}}),e(c,b,d,h),b.removeUpload=function(a){if(a.isComplete){var c=b.completed.indexOf(a);c>=0&&b.completed.splice(c,1)}else delete i[a]}}}}function b(){return"ontouchstart"in window||navigator.msMaxTouchPoints>0}function c(a){var b=document.createElement("input");b.setAttribute("multiple","true"),b.multiple!==!0||qq.android()?a.uploadButtonText="Select a File":a.uploadButtonText="Select Files"}function d(a,c){qq.supportedFeatures.folderDrop&&!b()?a.dropZoneText="Drop Files or Folders Here":qq.supportedFeatures.fileDrop&&!b()?a.dropZoneText="Drop Files Here":a.dropZoneText=a.$eval(c("Press '{{uploadButtonText}}'"))}function e(a,b,e,f){a(f.contents())(b),c(b),d(b,e)}angular.module("Crops").directive("multidocUpload",a),a.$inject=["docService","config","$compile","$interpolate","$timeout","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(a){a&&a.orgID&&a.smsNumber&&a.isFaxEnabled&&d.open({animation:!0,templateUrl:"{0}/fax/org.fax.modal.html".format(b.viewRoot),controller:"orgFaxModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"fax-modal org-fax-modal",resolve:{org:function(){return a}}})}function g(a,c){a&&a.id&&a.smsNumber&&a.faxEnabled&&d.open({animation:!0,templateUrl:"{0}/fax/project.fax.modal.html".format(b.viewRoot),controller:"projectFaxModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"fax-modal project-fax-modal",resolve:{document:function(){return c},project:function(){return a}}})}var h={showOrgFaxModal:f,showProjectFaxModal:g};return h}angular.module("Crops").service("faxService",a),a.$inject=["fvApi","config","$rootScope","$uibModal","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a){a.wrap("<form>").closest("form").get(0).reset(),a.unwrap()}e&&(a.org=e,a.orgID=e.orgID||e.id,a.orgName=e.orgName||e.name),a.status={isSendingFax:!1},a.settings={targetNumber:null,errorMessage:null,mainDocUploads:[],coverSheetUploads:[],mainFaxDoc:null,coverSheet:null},a.removeUpload=function(b){var c=a.settings.coverSheetUploads.indexOf(b);if(c>=0)a.settings.coverSheetUploads=_(a.settings.coverSheetUploads).reject(function(a){return a.id===b.id}),a.settings.coverSheet=null;else{var d=a.settings.mainDocUploads.indexOf(b);d>=0&&(a.settings.mainDocUploads=_(a.settings.mainDocUploads).reject(function(a){return a.id===b.id}),a.settings.mainFaxDoc=null)}},a.uploadMainFaxDoc=function(b,c){b.length>0&&a.$apply(function(){a.settings.mainDocUploads=[{file:b[0],percent:0,id:-1,projectID:null}],a.settings.mainFaxDoc=a.settings.mainDocUploads[0],g($(c))})},a.uploadCoverSheet=function(b,c){b.length>0&&a.$apply(function(){a.settings.coverSheetUploads=[{file:b[0],percent:0,id:-1,projectID:null}],g($(c)),a.settings.coverSheet=a.settings.coverSheetUploads[0]})},a.validateTargetNumber=function(b){var c;b?11===b.replace(/\D/g,"").length?(c="1"===b.charAt(0),a.sendFaxForm.targetNumber.$setValidity("required",!0),a.sendFaxForm.targetNumber.$setValidity("validFaxNumber",c)):(c=10===b.replace(/\D/g,"").length,a.sendFaxForm.targetNumber.$setValidity("required",!0),a.sendFaxForm.targetNumber.$setValidity("validFaxNumber",c)):a.sendFaxForm.targetNumber.$setValidity("required",!1)},a.canSendFax=function(){var b=!(a.settings.coverSheet&&(!a.settings.coverSheet||100!==a.settings.coverSheet.percent));return!a.status.isSendingFax&&a.orgID&&a.org.smsNumber&&a.org.isFaxEnabled&&a.settings.mainFaxDoc&&100===a.settings.mainFaxDoc.percent&&a.settings.targetNumber&&(10===a.settings.targetNumber.replace(/\D/g,"").length||11===a.settings.targetNumber.replace(/\D/g,"").length&&"1"===a.settings.targetNumber.charAt(0))&&a.sendFaxForm.$valid&&b},a.sendFax=function(){a.canSendFax()&&(a.status.isSendingFax=!0,d.sendOrgFax(a.orgID,a.settings.targetNumber,a.settings.coverSheet?a.settings.coverSheet.id:null,a.settings.mainFaxDoc.id).then(function(){a.status.isSendingFax=!1,f.alertSuccess("Fax message sent."),a.close()},function(){a.status.isSendingFax=!1,f.alertFail("There was a problem sending this Fax message. Please refresh and try again.")}))},a.close=function(){b.close()}}angular.module("Crops").controller("orgFaxModalController",a),a.$inject=["$scope","$uibModalInstance","$rootScope","mailroomService","org","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){a.project=g,a.isSendingFax=!1,a.coverSheet=null,a.faxRecipient=null,a.firstFaxNumber=null,a.faxRecipient=null,a.isCoverSheetUploading=!1,a.close=function(){d.dismiss()},a.selectCoverSheet=function(b){b&&(a.coverSheet=b)},a.selectMainDoc=function(b){b&&b.filename.toLowerCase().indexOf("cover")!==-1?a.coverSheet=b:b&&(a.mainFaxDoc=b)},a.selectMainDoc(f),a.swapDocs=function(){var b=a.mainFaxDoc;a.mainFaxDoc=a.coverSheet,a.coverSheet=b},a.selectPerson=function(b){b?(a.faxRecipient=b,a.firstFaxNumber=_(b.phones).find(function(a){return a&&"Fax"===a.label}),a.showFaxNumberError=!a.firstFaxNumber):a.showFaxNumberError=!1},a.canSendFax=function(){return!a.isSendingFax&&a.project&&a.project.id&&a.project.orgID&&a.faxRecipient&&a.firstFaxNumber&&a.firstFaxNumber.rawNumber&&a.mainFaxDoc&&a.mainFaxDoc.id},a.sendFax=function(){a.canSendFax()&&(a.isSendingFax=!0,h.sendProjectFax(a.project.id,a.project.orgID,a.firstFaxNumber.rawNumber,a.coverSheet?a.coverSheet.id:null,a.mainFaxDoc.id,a.faxRecipient.id).then(function(b){e.alertSuccess("Fax Queued"),a.close()},function(a){e.alertFail(a)})["finally"](function(){a.isSendingFax=!1}))}}angular.module("Crops").controller("projectFaxModalController",a),a.$inject=["$scope","$stateParams","config","$uibModalInstance","fvAlertsService","document","project","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){if(k.path().match(/(feed)|(recent)$/gi)){var b=k.search();if(b.hashtag){var c=angular.copy(a.defaultFilter);c.filterHashtagsList.push(k.search().hashtag),angular.equals(c,a.activeFilter)||(a.activeFilter=c,k.search("hashtag",null))}a.activeMode=e.includes("feedLayout.recent")?"recent":"feed"}}j.init(),a.feedList=[],a.pinnedList=[],a.unpinnedList=[],a.isLoading=!0,a.noteListEmpty=!1,a.flashPrevent=!1,a.activeMode="feed",a.noteListTitle="My Feed",a.selectingDate=!1,a.noteBeingParsed=!1,a.busy=!1,a.noteUiSettings={bottomMenuExpanded:n.getNoteBottomMenuState()},a.$on(n.onUiSettingsChanged,function(){a.noteUiSettings.bottomMenuExpanded=n.getNoteBottomMenuState()}),a.activeFilter=d.defaultFilter(),
a.defaultFilter=d.defaultFilter(),a.$watch("activeFilter",function(b,c){angular.equals(b,c)||d.loadFeed(a.activeMode,a.activeFilter)},!0),a.$watch("activeMode",function(b,c){angular.equals(b,c)||d.loadFeed(a.activeMode,a.activeFilter)},!0),a.$on(d.onNoteListChanged,function(b,c){c&&0===c.listState.indexOf("feed")&&(a.feedList=d.noteList(),a.pinnedList=_(a.feedList).filter(function(a){return a.isPinnedToFeed}),a.unpinnedList=_(a.feedList).filter(function(a){return!a.isPinnedToFeed}),a.isLoading=d.isLoading(),a.noteListEmpty=d.noteListEmpty(),a.flashPrevent=d.isBetweenTimeout()),c.noteID&&h(function(){a.$broadcast("onNotePushed",{noteID:c.noteID,pushType:c.pushType})})}),a.$on("$locationChangeSuccess",function(){o()},!0),o(),d.loadFeed(a.activeMode,a.activeFilter),a.$on(d.onNotePinnedToFeed,function(b,c){a.activeFilter.filterUnpinnedOnly?d.removeNote(c):(c.isExpanded=!0,d.mergeNote(c),h(function(){k.hash("note-"+c.id),l(),k.hash("")}))}),a.$on(d.onNoteUnpinnedFromFeed,function(b,c){a.activeFilter.filterPinnedOnly?d.removeNote(c):c.isExpanded||c.isUnread?d.mergeNote(c):d.removeNote(c)}),a.noteListSubtitle=function(){return""},a.getMoreNotes=function(){d.getMore()},a.isShared=function(a){return!(!a||!a.length)&&a.some(function(a){return a.isShared})},a.uploadDoc=function(b){b.length>0&&a.$apply(function(){var c={file:b[0],percent:0,id:-1,projectID:a.newNote.projectID};a.newNote.uploads.push(c);var d=i.find("#fileinput");angular.element(d).val(null)})},a.removeUpload=function(b){var c=a.newNote.uploads.indexOf(b);c>=0&&a.newNote.uploads.splice(c,1)},a.noteLength=function(a){return a=_.str.stripTags(a),a=a.replace("&nbsp;",""),a=a.replace(/\s+/," "),a=_.str.trim(a),a.length},a.$on("add-feed-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){d.mergeNote(c,"feed",!0)})}),a.$on("update-feed-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){d.mergeNote(c,"feed",!0)})}),a.$on(d.isPrintingVine,function(){h(function(){m.print(),a.$broadcast("onPrintFinished")})})}angular.module("Crops").controller("FeedController",a),a.$inject=["$scope","fvApi","$rootScope","noteService","$state","$sce","config","$timeout","$document","pushService","$location","$anchorScroll","$window","uiSettingsService"]}(),function(){"use strict";function a(a,b,c,d){function e(){a.activeMode=d.includes("feedLayout.recent")?"recent":"feed"}a.noteCount=0,a.$on(b.onNoteCountChanged,function(){a.noteCount=b.noteCount()}),a.$on("$locationChangeSuccess",function(){e()}),e()}angular.module("Crops").controller("FeedPageHeaderController",a),a.$inject=["$scope","noteService","$location","$state"]}(),Crops.filter("shortnum",function(){"use strict";return function(a,b,c,d){if(isNaN(parseFloat(a))||!isFinite(a))return"--";b=b||3,d=d||" KMBTQ",c=c||"";var e=Math.floor((String(parseInt(a)).length-1)/3),f=Number((a/Math.pow(1e3,e)).toPrecision(b));return(c+f+d[e]).replace(/\s+$/g,"")}}),Crops.filter("daysuntil",function(){"use strict";return function(a){if(null!==a){var b=864e5,c=new Date(a).getTime()-(new Date).getTime();return Math.round(c/b)}return"?"}}),Crops.filter("filesize",function(){"use strict";return function(a){return isNaN(a)&&(a=0),a<1024?a+" Bytes":(a/=1024,a<1024?a.toFixed(2)+" KB":(a/=1024,a<1024?a.toFixed(2)+" MB":(a/=1024,a<1024?a.toFixed(2)+" GB":(a/=1024,a.toFixed(2)+" TB"))))}}),function(){"use strict";function a(a){return function(b){if(!b||!b.length||"undefined"==typeof b[0].fullName)return"";var c=b.filter(function(a){return a.isShared}).map(function(a){return a.fullName});return a.arrayToCommaList(c)}}angular.module("Crops").filter("peoplecommalist",a),a.$inject=["fvUtils"]}(),Crops.filter("yesNo",function(){"use strict";return function(a){return a===!0||"true"===a||"True"===a||"Yes"===a||"yes"===a?"Yes":a===!1||"false"===a||"False"===a||"No"===a||"no"===a?"No":""}}),function(){"use strict";function a(a){return angular.element("<div>"+a+"</div>").text()}function b(b){return function(c){if(!c)return"";try{return b.trustAsHtml(a(c).replace(/\n/g,"<br/>"))}catch(d){return console.debug(c),c}}}angular.module("Crops").filter("newlines",b),b.$inject=["$sce"]}(),Crops.filter("momentDateFormat",function(){"use strict";return function(a){var b=moment(a);return a&&b.isValid()?b.format("MM/DD/YYYY"):""}}),Crops.filter("localizeUtcDate",function(){"use strict";return function(a){var b=moment.utc(a).local();return a&&b.isValid()?b.format("MM/DD/YYYY"):""}}),Crops.filter("localizeUtcDateTime",function(){"use strict";return function(a){var b=moment.utc(a).local();return a&&b.isValid()?b.format("MM/DD/YYYY h:mm a"):""}}),Crops.filter("truncate",function(){"use strict";return function(a,b,c){return a?(c||(c="…"),(b=parseInt(b,10))?a.length<=b?a:(a=a.substr(0,b),a+c):a):""}}),Crops.filter("titleCase",function(){"use strict";return function(a){if(!a)return"";for(var b=a.split(" "),c=0;c<b.length;c++)b[c]=b[c].charAt(0).toUpperCase()+b[c].slice(1);return b.join(" ")}}),Crops.filter("camelCaseToTitleCase",function(){"use strict";return function(a){return a?a.replace(/([A-Z]+)/g," $1").replace(/([A-Z][a-z])/g," $1").trim():""}}),function(){"use strict";function a(a){return function(b){if(!b||!b.length)return"";var c=_(b).pluck("hashtag");return a.arrayToCommaList(c)}}angular.module("Crops").filter("hashtagsToList",a),a.$inject=["fvUtils"]}(),function(){"use strict";function a(a,b){var c=new RegExp(b+"=[^&]*","i"),d=a.match(c);return d?d[0].replace(b+"=",""):""}function b(b,c){b=b.replace(/'/gi,"%27").replace(/\+/g,"%2B").replace(/^mailto:/i,"");var d=b.match(/^[^?]*/i)?b.match(/^[^?]*/i)[0]:"";if(!d)return"";var e=d===c;if(d===b)return"mailto:"+d+(c&&!e?"?cc="+c:"");var f=navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)?",%20":";%20",g=a(b,"to");d=_([d,g]).compact().join(f),e=c&&d.indexOf(c)>-1;var h=a(b,"bcc");h=h?"bcc="+h:"";var i=a(b,"cc");i=_([i,e?"":c]).compact().join(f),i=i?"cc="+i:"";var j=a(b,"subject");j=j?"subject="+encodeURI(decodeURI(j)):"";var k=a(b,"body");k=k?"body="+encodeURI(decodeURI(k)):"";var l=_([i,h,j,k]).compact().join("&");return"mailto:"+d+(l?"?"+l:"")}function c(a,c){return function(d){if(!d)return"";var e=d.match(/^mailto:/)||d.split("?")[0].match(a.emailRegex);if(e){var f=c.project()?c.project().emailAddress:"";return b(d,f)}return a.hasUrlProtocolRegex.test(d)?d:"//"+d}}angular.module("Crops").filter("formatUriScheme",c),c.$inject=["config","projectService"]}(),function(){"use strict";function a(a){return angular.element("<div>"+a+"</div>").text()}function b(b){return function(c){if(!c)return"";try{return b.trustAsHtml(a(c.split("<mark>").join("|||mark|||").split("</mark>").join("|||/mark|||").split("</mark").join("|||/mark|||").split("</mar").join("|||/mark|||").split("</ma").join("|||/mark|||").split("</m").join("|||/mark|||")).split("|||mark|||").join("<mark>").split("|||/mark|||").join("</mark>"))}catch(d){return console.debug(c),c}}}angular.module("Crops").filter("allowMarkTagsOnly",b),b.$inject=["$sce"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){a.incidentCopy={incidentDate:a.project.incidentDate,estimatedSettlementValue:a.project.estimatedSettlementValue,description:a.project.description,referrer:angular.copy(a.project.referrer)}}function i(){return c.updateIncident(a.project).then(function(b){h(),a.incidentForm.$setPristine(),a.incidentForm.$setUntouched(),a.isSaving=!1,a.hasChangedPerson=!1},function(){a.isSaving=!1})}a.project=null,a.isSaving=!1,a.enableExtendedInfo=!0,a.hasChangedPerson=!1,a.$on(c.onStateChange,function(){a.project=c.project(),h(),a.isLoading=c.isLoading(),a.project&&a.project.sections&&(!a.isLoading.fullProject&&_(a.project.sections).findWhere({customSectionType:37})||f.go("projectLayout.project.activity"))}),c.loadProject(),a.testshare=function(){c.testshare()},a.saveReferrer=function(b){var c=null===b&&a.incidentCopy.referrer===b||b&&b.id&&a.incidentCopy.referrer&&a.incidentCopy.referrer.id===b.id;c&&(a.incidentCopy.referrer=b),a.project.referrer=b,a.project.referrerID=b&&b.id?b.id:null,a.hasChangedPerson=!c},a.needsSave=function(b){return a.hasChangedPerson||b},a.canSave=function(b){return b&&!a.isSaving},a.save=function(b,c){return a.needsSave(b)&&a.canSave(c)?(a.isSaving=!0,a.project.referrer?a.project.referrer.fullname&&a.project.referrer.fullname.trim()?i():(a.project.referrer=null,a.project.referrerID=null,i()):i()):g.reject("Doesn't pass canSave or needsSave")},a.resetIncident=function(){a.project.incidentDate=a.incidentCopy.incidentDate,a.project.estimatedSettlementValue=a.incidentCopy.estimatedSettlementValue,a.project.description=a.incidentCopy.description,a.project.referrer=angular.copy(a.incidentCopy.referrer),a.hasChangedPerson=!1,a.incidentForm&&(a.incidentForm.$setPristine(),a.incidentForm.$setUntouched())},a.$on("$stateChangeStart",function(){void 0!==typeof b.ignoreStateChangeStart&&angular.isFunction(b.ignoreStateChangeStart)&&b.ignoreStateChangeStart()||a.resetIncident()})}angular.module("Crops").controller("IncidentController",a),a.$inject=["$scope","$rootScope","projectService","fvUtils","config","$state","$q"]}(),function(){"use strict";function a(a,b,c,d,e){return{scope:{},restrict:"E",replace:!0,templateUrl:"{0}/layout/app.header.html".format(d.viewRoot),link:function(a){function f(){var a=b.location.hostname.split(".");return a.length>1&&"filevinedev"===a[1]?a[0]:"qa-xz3e6qkq"===a[0]?"qa":"localhost"===a[0]?"local":null}function g(){var a=b.location.hostname.split(".");return a.length>1&&"ca"===a[a.length-1]}function h(){c.getSavedReports()}function i(b){var c=j[0]!==b.target&&0===j.find(b.target).length;c&&a.$evalAsync(function(){a.bannerAlertSettings.isOpen=!1,angular.element(document).unbind("click",i)})}a.specialHostNameTag=f(),a.isCanadianServer=g(),a.isAdmin=!!Crops.AdminPath,a.isAdv=!!Crops.AdvancedPath,h(),a.$on(c.onSavedReportsChanged,function(){a.savedReports=c.savedReports(),a.version=e.version()}),a.isMobileSearchOpen=!1,a.$on("$stateChangeSuccess",function(){a.isMobileSearchOpen=!1});var j=angular.element("#banner-alert");a.bannerAlert=d.getBannerAlert(),a.bannerAlertSettings={isOpen:!1},a.bannerAlertIsActive=function(){return a.bannerAlert&&(!a.bannerAlert.expirationDate||moment(a.bannerAlert.expirationDate).diff(moment())>=0)},a.$watch("bannerAlertSettings.isOpen",function(){a.bannerAlertSettings.isOpen?angular.element(document).bind("click",i):angular.element(document).unbind("click",i)}),a.$on("$destroy",function(){angular.element(document).unbind("click",i)}),a.logout=function(){document.getElementById("logoutForm").submit()}}}}angular.module("Crops").directive("appHeader",a),a.$inject=["$rootScope","$window","reportService","config","fvApi"]}(),function(){"use strict";function a(a,b,c){return{scope:{menuName:"="},restrict:"E",replace:!0,templateUrl:"{0}/layout/fvMenu.html".format(c.viewRoot),link:function(c){function d(){var b=a.get(c.menuName);b?(c.items=b.items||[],c.type=b.type||a.types.selector,c.closeSidenavOnClick=b.closeSidenavOnClick,c.label=b.label,c.isLabelVisible=b.isLabelVisible,c.selectClickFirstItem=b.selectClickFirstItem,c.items&&c.items.length&&c.type===a.types.selector&&c.selectClickFirstItem&&(c.selectedItem=c.items[0],c.items[0].click())):(c.items=[],c.type="",c.label="",c.isLabelVisible=!1,c.closeSidenavOnClick=!1,c.selectClickFirstItem=!1),c.isMenuHidden=!1}function e(){b.toggleSidenav("close")}c.menuName=c.menuName||"",c.menuName||console.warn("fv-menu without name"),c.$on(a.onItemsChanged(c.menuName),d),c.$on(a.onNeedSelectDropdownItem(c.menuName),function(a,b){c.selectedItem=_(c.items).findWhere({value:b})});var f=!1,g={};c.isDisabled=function(a){return a?!!a.title&&g[a.title]:f},c.$on(a.onMenuDisabled,function(a,b){b.menuName===c.menuName&&(b.item?b.item.title&&(g[b.item.title]=!0):f=!0)}),c.$on(a.onMenuEnabled,function(a,b){b.menuName===c.menuName&&(b.item?b.item.title&&(g[b.item.title]=!1):f=!1)}),d(),c.click=function(a){a&&(a.click(),c.closeSidenavOnClick&&e())},c.toggleMenu=function(){c.isMenuHidden=!c.isMenuHidden}}}}angular.module("Crops").directive("fvMenu",a),a.$inject=["fvMenuService","sidenavService","config"]}(),function(){"use strict";function a(a){function b(a,b){angular.isFunction(a.click)||(a.click=function(){console.log("User clicked menu item, but there was no click function defined!")}),a.title||a.text||b===m.selector||console.warn("Menu item needs 'title' or 'text'"),a.url||b!==m.urlLinks||console.warn("urlLinks menu item missing 'url'"),a.value||b!==m.selector||console.warn("selector menu item missing unique 'value'")}function c(b,c){a.$broadcast(l(b),c)}function d(c,d,e,f,g,h,i){d=d||[],_(d).each(function(a){return b(a,e)}),j[c]={items:d,type:e||m.selector,closeSidenavOnClick:f,label:g||"Menu",isLabelVisible:h,selectClickFirstItem:i},a.$broadcast(k(c))}function e(b){j[b]=null,a.$broadcast(k(b))}function f(c,d){j[c]||(j[c]={items:[],type:m.selector,closeSidenavOnClick:!1,label:"Menu",isLabelVisible:!1,selectClickFirstItem:!1}),b(d,j[c].type),j[c].items.push(d),a.$broadcast(k(c))}function g(a){return j[a]}function h(b,c){a.$broadcast(n,{menuName:b,item:c})}function i(b,c){a.$broadcast(o,{menuName:b,item:c})}var j={},k=function(a){return"fvMenuService.onItemsChanged:"+a},l=function(a){return"fvMenuService.onNeedSelectDropdownItem:"+a},m={selector:"selector",links:"links",editLinks:"editLinks",urlLinks:"urlLinks",buttons:"buttons",toolbar:"toolbar"},n="fvMenuService.onMenuDisabled",o="fvMenuService.onMenuEnabled",p={onItemsChanged:function(a){return k(a)},onNeedSelectDropdownItem:function(a){return l(a)},types:m,replace:d,clear:e,add:f,get:g,selectDropdownItem:c,onMenuDisabled:n,onMenuEnabled:o,disableMenu:h,enableMenu:i};return p}angular.module("Crops").service("fvMenuService",a),a.$inject=["$rootScope"]}(),function(){"use strict";function a(a,b){return{scope:{currentSectionName:"=",currentSectionIcon:"=?",currentSectionBadge:"=?",onSelect:"&?",disableSelectCurrent:"&?",isMobileHeader:"="},restrict:"E",replace:!0,templateUrl:"{0}/layout/sidenav.current.section.html".format(a.viewRoot),link:function(a,c){a.isSidenavOpen=!1,a.settings={},a.disableSelectCurrent=a.disableSelectCurrent&&angular.isFunction(a.disableSelectCurrent)?a.disableSelectCurrent:function(){return!1},a.$on(b.onSidenavChanged,function(b,c){a.settings.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(a){b.toggleSidenav(a)},a.selectCurrentSection=function(){!a.disableSelectCurrent()&&a.onSelect&&angular.isFunction(a.onSelect)&&a.onSelect()}}}}angular.module("Crops").directive("sidenavCurrentSection",a),a.$inject=["config","sidenavService"]}(),function(){"use strict";function a(a,b,c){return{scope:{sections:"=",currentSection:"=",isProjectPage:"=",isReportsPage:"=",onSelect:"&",disableSelectCurrent:"&?"},restrict:"E",replace:!0,templateUrl:"{0}/layout/sidenav.section.menu.html".format(a.viewRoot),link:function(a,d){function e(){if(null!==a.focusedSectionIndex&&a.filteredSections.length){var c=a.filteredSections[a.focusedSectionIndex];a.isProjectPage?a.gotoProjectSection(c):a.isReportsPage?b.go("reportLayout.reports",{reportID:c.id}):b.go(c.url),a.hideSectionFilter(),a.onSectionSelected(c)}}function f(a){return b.includes(a.state)&&(!a.params.sectionName&&!b.params.sectionName||a.params.sectionName===b.params.sectionName)}function g(a){var b=a.url,c={};if(a.url.match(/\//)){var d=a.url.split("/");b=d[0],c={sectionName:d[1]}}return{state:"projectLayout.project."+b,params:c}}a.focusedSectionIndex=null,a.isSectionFilterShown=!1,a.isSectionFilterToggleShown=!0,a.filteredSections=[],a.disableSelectCurrent=a.disableSelectCurrent&&angular.isFunction(a.disableSelectCurrent)?a.disableSelectCurrent:function(){return!1},a.onSectionSelected=function(b){b.id===a.currentSection.id&&a.disableSelectCurrent()||!angular.isFunction(a.onSelect)||a.onSelect({section:b})},a.onSectionFilterKeydown=function(b){if(null!==a.focusedSectionIndex)switch(b.which){case 13:event.preventDefault(),e();break;case 27:event.preventDefault(),a.hideSectionFilter();break;case 40:event.preventDefault(),a.focusedSectionIndex<a.filteredSections.length-1?a.focusedSectionIndex++:a.focusedSectionIndex=0;break;case 38:event.preventDefault(),a.focusedSectionIndex>0?a.focusedSectionIndex--:a.focusedSectionIndex=a.filteredSections.length-1;break;case 34:event.preventDefault(),a.focusedSectionIndex=a.filteredSections.length-1;break;case 33:event.preventDefault(),a.focusedSectionIndex=0}};var h;a.onSectionFilterTriggerMouseenter=function(){h=c(function(){a.showSectionFilter()},300)},a.onSectionFilterTriggerMouseleave=function(){c.cancel(h)},a.showSectionFilter=function(){a.isSectionFilterToggleShown=!1,a.isSectionFilterShown=!0,a.$broadcast("onSectionFilterShown")},a.hideSectionFilter=function(){c(function(){a.sectionFilter="",a.focusedSectionIndex=null,a.isSectionFilterShown=!1,c(function(){a.isSectionFilterToggleShown=!0},300)},500)},a.gotoProjectSection=function(a){if(!a.disabled){var c=g(a);f(c)?b.reload():b.go(c.state,c.params)}},a.getProjectHref=function(a){if(!a.disabled){var c=g(a);return b.href(c.state,c.params)}}}}}angular.module("Crops").directive("sidenavSectionMenu",a),a.$inject=["config","$state","$timeout"]}(),function(){"use strict";function a(a,b){function c(){return e}function d(b){e="close"!==b&&("open"===b||!e),a.$broadcast(f,{isSidenavOpen:e})}var e=!1,f="setupServiceOnSidenavChanged",g={toggleSidenav:d,isSidenavOpen:c,onSidenavChanged:f};return g}angular.module("Crops").service("sidenavService",a),a.$inject=["$rootScope","$state"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{},templateUrl:"{0}/layout/user.avatar.html".format(b.viewRoot),link:function(b){function c(){b.currentUser=a.currentUser()}c(),b.$on(a.onCurrentUserChanged,c),b.logout=function(){document.getElementById("avatarMenulogoutForm").submit()}}}}angular.module("Crops").directive("userAvatar",a),a.$inject=["currentUserService","config"]}(),function(){"use strict";function a(a,b,c,d,e,f){a.isLoading=!0,a.currentOrg=null,a.items=[],a.busy=!1,a.isPrintingItemId={},a.isPrintingSingleItem=!1,a.noteUiSettings={bottomMenuExpanded:f.getNoteBottomMenuState()},a.$on(f.onUiSettingsChanged,function(){a.noteUiSettings.bottomMenuExpanded=f.getNoteBottomMenuState()}),c.init(),a.$on(b.onCurrentOrgChanged,function(){a.currentOrg=b.currentOrg()}),a.$on(b.onItemsChanged,function(){a.isLoading=b.isLoadingItems(),a.isLoading||(a.items=b.items(),a.hasMoreItems=b.hasMoreItems(),a.busy=!1)}),b.loadMailroom(),a.getMoreItems=function(){a.hasMoreItems&&(a.busy=!0,b.loadItems())},a.assignItemToProject=function(a,c){b.assignItemToProject(a,c)},a.$on("remove-mailroom-vine",function(c,d){d.filterMismatch||a.$applyAsync(function(){b.removeItem(d)})}),a.$on("add-mailroom-vine",function(c,d){d.filterMismatch||a.$applyAsync(function(){b.addItem(d)})}),a.$on("update-mailroom-vine",function(c,d){d.filterMismatch||a.$applyAsync(function(){b.updateItem(d)})}),a.archive=function(a,c){c.stopPropagation(),b.archive(a)},a.printMailroomItem=function(b,c){c.stopPropagation(),a.isPrintingItemId[b]=!0,a.isPrintingSingleItem=!0,e(function(){console.log("isPrintingSingleItem: "+a.isPrintingSingleItem),console.log(a.isPrintingItemId),d.print(),a.isPrintingSingleItem=!1,a.isPrintingItemId[b]=!1},250)}}angular.module("Crops").controller("MailroomController",a),a.$inject=["$scope","mailroomService","pushService","$window","$timeout","uiSettingsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){a.settings={newOrgEmail:"",isEditingOrgEmail:!1,isUpdatingOrgEmail:!1},a.form={},a.emailPrefixPattern=/^(?=.{6,})[A-Za-z0-9_-]+(?:\.[A-Za-z0-9_-]+)*$/,e&&(a.org=e),a.beginEditingEmailAddress=function(){try{a.settings.newOrgEmail=a.org.emailAddress.slice(0,a.org.emailAddress.indexOf("@"))}finally{a.settings.isEditingOrgEmail=!0,g(function(){a.$broadcast("onEditingOrgEmail")})}},a.canUpdateOrgEmail=function(){return!a.settings.isUpdatingOrgEmail&&a.form&&a.form.orgEmailForm&&a.form.orgEmailForm.$valid&&a.settings.newOrgEmail!==a.org.emailAddress.slice(0,a.org.emailAddress.indexOf("@"))},a.updateOrgEmail=function(){a.canUpdateOrgEmail()&&(a.settings.isUpdatingOrgEmail=!0,d.saveOrgUniqueKey(a.org.id,a.settings.newOrgEmail).then(function(b){a.org.emailAddress=b,f.alertSuccess("This org's email address is now "+b),a.cancelEditingOrgEmail()},function(b){f.alertFail(b),a.form.orgEmailForm.orgEmail.$setValidity("updateException",!1)})["finally"](function(){a.settings.isUpdatingOrgEmail=!1}))},a.resetOrgEmailUpdateExceptionValidity=function(){a.form.orgEmailForm.orgEmail.$error.updateException&&a.form.orgEmailForm.orgEmail.$setValidity("updateException",!0)},a.cancelEditingOrgEmail=function(){a.form.orgEmailForm.$setPristine(),a.form.orgEmailForm.$setUntouched(),a.settings.isEditingOrgEmail=!1,a.settings.newOrgEmail=""},a.close=function(){b.dismiss("close"),a.calendarEvent=null},a.$on("$stateChangeSuccess",a.close),a.close=function(){b.close()}}angular.module("Crops").controller("mailroomEmailModalController",a),a.$inject=["$scope","$uibModalInstance","$rootScope","mailroomService","emailInfo","fvAlertsService","$timeout"]}(),function(){"use strict";function a(a,b){b.toggleSidenav("close"),a.$on(b.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){b.toggleSidenav()}}angular.module("Crops").controller("MailroomLayoutController",a),a.$inject=["$scope","sidenavService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(d){z||(C&&C.length&&B.orgID+""===c.params.orgID&&!d?(b.$broadcast(w),b.$broadcast(x),b.$broadcast(y)):(z=!0,C=[],E=[],D=!1,B=null,b.$broadcast(w),a.get(v.getOrgs).then(function(a){C=a})["finally"](function(){z=!1,b.$broadcast(w),g()})))}function g(a){a=a||s();var d=B;d&&d.orgID===a.orgID||(B=a,c.go("mailroomLayout.mailroom",{orgID:a.orgID},{notify:!1}),b.$broadcast(x),E=[],D=!1,b.$broadcast(y),k())}function h(a){if(a.orgID===B.orgID)E.unshift(a),B.itemCount++;else{var b=r(a.orgID);b&&b.itemCount++}}function i(a){if(a.orgID===B.orgID)for(var b=0;b<E.length;b++)if(E[b].id===a.id){a.note.isExpanded=E[b].note.isExpanded,E.splice(b,1,a);break}}function j(a){if(a.orgID===B.orgID)t(a.id);else{var b=r(a.orgID);b&&b.itemCount--}}function k(){!A&&B&&(A=!0,b.$broadcast(y),a.get(v.getItems,[B.orgID,E.length]).then(function(a){E=E.concat(a),D=25===a.length})["finally"](function(){A=!1,b.$broadcast(y)}))}function l(c,d){a.get(v.assignItemToProject,[c,d]).then(function(){t(c),b.$broadcast(y)})}function m(c){return a.del(v.archive,[c]).then(function(){t(c),b.$broadcast(y)})}function n(b,c){return a.get(v.getMailroomItemByNoteID,[b,c])}function o(b,c){return a.post(v.saveOrgUniqueKey,[b],{orgUniqueKey:c})}function p(c,d,e){var f={targetNumber:d,message:e};return a.post(v.sendOrgSms,[c],f).then(function(a){B.orgID+""===c&&(E.unshift(a),b.$broadcast(y))})}function q(c,d,e,f){var g={targetNumber:d,coverSheetDocID:e,mainFaxDocID:f};return a.post(v.sendOrgFax,[c],g).then(function(a){B.orgID+""===c&&(E.unshift(a),b.$broadcast(y))})}function r(a){for(var b=0;b<C.length;b++)if(C[b].orgID===a)return C[b]}function s(){if(c.params.orgID&&"0"!==c.params.orgID){for(var a=0;a<C.length;a++)if(C[a].orgID+""===c.params.orgID)return C[a]}else if(C.length>0)return C[0];return null}function t(a){for(var b=0;b<E.length;b++)if(E[b].id===a){E.splice(b,1),B.itemCount--;break}}function u(a){d.open({animation:!0,templateUrl:"{0}/mailroom/mailroom.email.modal.html".format(e.viewRoot),controller:"mailroomEmailModalController",size:"md",backdrop:"static",keyboard:!1,resolve:{emailInfo:function(){return a}}})}var v={getOrgs:"/api/mailroom/orgs",assignItemToProject:"/api/mailroom/assign/{0}/{1}",getItems:"/api/mailroom/{0}/items/{1}",archive:"/api/mailroom/archive/{0}",sendOrgSms:"/api/sendorgsms/{0}",sendOrgFax:"api/sendorgfax/{0}",getMailroomItemByNoteID:"api/mailroom/{0}/itemByNoteId/{1}",saveOrgUniqueKey:"/api/orgs/{0}/replaceOrgEmailAddress"},w="mailroomService.onOrgsChanged",x="mailroomService.onCurrentOrgChanged",y="mailroomService.onItemsChanged",z=!1,A=!1,B=null,C=[],D=!1,E=[],F={loadMailroom:f,loadItems:k,addItem:h,updateItem:i,removeItem:j,orgs:function(){return C},currentOrg:function(){return B},items:function(){return E},isLoadingOrgs:function(){return z},isLoadingItems:function(){return A},setCurrentOrgAndLoadItems:g,getMailroomItemByNoteID:n,saveOrgUniqueKey:o,assignItemToProject:l,archive:m,sendOrgSms:p,sendOrgFax:q,onOrgsChanged:w,onCurrentOrgChanged:x,showEmailSetupModal:u,onItemsChanged:y,hasMoreItems:function(){return D}};return F}angular.module("Crops").service("mailroomService",a),a.$inject=["fvApi","$rootScope","$state","$uibModal","config"]}(),function(){"use strict";function a(a,b,c,d,e){a.orgs=[],a.currentOrg={},a.isLoading=!1,a.$on(b.onOrgsChanged,function(){a.isLoading=b.isLoadingOrgs(),a.isLoading||(a.orgs=b.orgs())}),a.$on(b.onCurrentOrgChanged,function(){a.currentOrg=b.currentOrg()}),a.isAdmin=function(){return a.currentOrg&&a.currentOrg.userIsAdmin},a.showEmailSetupModal=function(){var c={id:a.currentOrg.orgID,name:a.currentOrg.orgName,emailAddress:a.currentOrg.emailAddress};b.showEmailSetupModal(c)},a.showSmsSetupModal=function(){if(a.isAdmin()){var b={name:a.currentOrg.orgName,type:"org",id:a.currentOrg.orgID,number:a.currentOrg.smsNumber};d.showSmsSetupModal(b)}},a.showOrgFaxModal=function(){e.showOrgFaxModal(a.currentOrg)},a.showSendOrgSmsModal=function(){d.showSendOrgSmsModal(a.currentOrg)},a.$on(d.onDetailChanged,function(b,c,d){"success"===c&&(a.currentOrg.smsNumber=d)}),b.loadMailroom(),a.setCurrentOrg=function(c){b.setCurrentOrgAndLoadItems(c),a.toggleSidenav("close")},a.disableSelectCurrentOrg=function(){return!0},a.isSidenavOpen=!1,a.$on(c.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(a){c.toggleSidenav(a)}}angular.module("Crops").controller("MailroomSidenavController",a),a.$inject=["$scope","mailroomService","sidenavService","smsService","faxService"]}(),function(){function a(a,b,c,d,e,f){return{restrict:"E",scope:{comment:"=",note:"=",mode:"="},replace:!0,templateUrl:"{0}/notes/comment.html".format(a.viewRoot),link:function(a,g){function h(){var b;a.comment.reactions&&a.comment.reactions.length&&(b=_.chain(a.comment.reactions).filter(function(a){return _(a.reactingUsers).findWhere({id:e.currentUser().id})}).map(function(a){return a.reactionType}).value()),_(a.noteReactionOptions).each(function(c){a.commentReactionIsActive[c.reactionType]=!!(b&&b.indexOf(c.reactionType)>-1)})}a.noteReactionOptions=b.noteReactionOptions(),a.reactionParentType=b.noteReactionParentTypes().comment,a.commentReactionIsActive={},a.showCommentPushIndicator=!1;var i;c(function(){i=$(g).find("#editCommentInput-"+a.note.id+"-"+a.comment.id)[0]}),a.editedBody="",a.status={isEditing:!1},a.noteReactionOptions=b.noteReactionOptions(),a.saveEditing=function(){b.updateComment(a.comment.id,a.comment.newBody).then(function(b){b&&(a.comment.body=b.body,a.cancelEditing())})},a.startEditing=function(){a.comment.allowEditing&&(a.status.isEditing=!0,a.comment.newBody=angular.copy(a.comment.body),c(function(){a.adjustEditorHeight()}))},a.cancelEditing=function(){delete a.comment.newBody,a.status.isEditing=!1},a.adjustEditorHeight=function(){i&&(i.style.height=i.scrollHeight>=i.clientHeight?i.scrollHeight+"px":"35px")},a.userCardOpen={commenter:!1},a.showUserCard=function(b,c){b.stopPropagation(),d.loadUserCardData(c,a.userCardOpen.commenter,a.note,!1)},a.$on(d.onShow,function(b,c){a.$evalAsync(function(){a.userCardOpen.commenter=c&&c.note&&a.comment&&c.note===a.comment&&!c.isAssignee})}),a.isOriginalComment=function(){return a.comment&&(!a.comment.copiedFromCommentID||a.comment.copiedFromCommentID===a.comment.id)},a.isCurrentUser=function(a){return a&&a.id===e.currentUser().id},a.removeDoc=function(b){return f.removeDoc(b.id).then(function(){a.comment.docs=_(a.comment.docs).reject(function(a){return a.id===b.id})})},h(),a.$on("showCommentPushIndicator",function(){a.comment.id===a.note.comments[a.note.comments.length-1].id&&(a.showCommentPushIndicator=!0,c(function(){a.showCommentPushIndicator=!1}))})}}}angular.module("Crops").directive("comment",a),a.$inject=["config","noteService","$timeout","userCardService","currentUserService","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return{restrict:"E",templateUrl:"{0}/notes/comments.html".format(e.viewRoot),scope:{note:"=",mode:"=",targetDateChanged:"&"},link:function(e,j){e.commentBeingParsed=!1,e.pauseCommentParser=!1,e.showTaskSettingsPushIndicator=!1,e.status={},e.uploadClick=function(){console.log("clicked")},e._newComment=function(){return{noteID:0,body:"",uploads:[],message:"",_isSms:e.note&&"sms"===e.note.typeTag}},e.smsCharacterCountMessage=function(){var a=$("<span />").html(e.newComment.body),b=a.text().length+2*a.find("div").length,c=1;return Math.ceil(b/160)<=10&&Math.ceil(b/160)>1?c=Math.ceil(b/160):Math.ceil(b/160)>10&&(c=10),b>1600?l('<span class="text-danger">('+b+"/"+160*c+") This reply will be truncated to 1600 in 10 text messages.</span>")(e):c>1?l('<span class="text-warning">('+b+"/"+160*c+") This reply may be sent in "+c+" text messages.</span>")(e):l('<span class="text-meta">('+b+"/"+160*c+")</span>")(e)},e.newComment=e._newComment(),e.uploadDoc=function(a){a.length>0&&e.$apply(function(){var b={file:a[0],percent:0,id:-1,projectID:e.note.projectID};e.newComment.uploads.push(b)})},e.removeDoc=function(a){return m.removeDoc(a.id).then(function(){e.newComment.docs=_(e.newComment.docs).reject(function(b){return b.id===a.id})})},e.parseNewComment=_.debounce(function(){"sms"!==e.note.typeTag&&e._parseNewComment()},750),e.$watch("newComment.body",function(a,b){a||(e.newComment=e._newComment()),!e.pauseCommentParser&&a&&a!==b&&e.parseNewComment()}),e._parseNewComment=function(){if(!e.pauseCommentParser&&!e.commentBeingParsed){e.commentBeingParsed=!0,e.newComment.noteID=e.note.id;var b="/api/notes/{0}/parsecomment".format(e.note.id);a.post(b,[],e.newComment).then(function(a){e.newComment.message=d.trustAsHtml(a.commentMessage)})["finally"](function(){e.commentBeingParsed=!1})}},e.canAddComment=function(){return!!e.note.isLoaded&&(!e.commentSaving&&(!_.any(e.newComment.uploads,function(a){return a.percent<100})&&(!!e.newComment.body.trim()||e.newComment.uploads.length>0)))},e.addComment=function(a){var d=$("<pre />").html($(j).find(".new-comment-input").html());d.find("div").replaceWith(function(){return"\n"+this.innerHTML}),d.find("p").replaceWith(function(){return this.innerHTML+"<br><br>"}),d.find("br").replaceWith("\n"),e.pauseCommentParser=!0,e.newComment.body=d.text(),e.canAddComment&&(e.commentSaving=!0,c.addComment(a,e.newComment).then(function(c){a.isUnread=!1,a.targetDate=c.targetDate,a.assignee=c.assignee,a.typeTag=c.typeTag,a.doSwitch=!0,a.comments.push(c.comment),a.commentCount=a.commentCount+1,c.comment.docs&&c.comment.docs.length&&b.$broadcast("docAdded",c.comment.docs)},function(){})["finally"](function(){e.newComment=e._newComment(),$(j).find(".new-comment-input").text(""),e.pauseCommentParser=!1,e.commentSaving=!1,e.showMobileCommentInputControls=!1}))},e.showMobileCommentInputControls=!1,e.onFocusComment=function(){c.initMentionableUsers(e.note.projectID),e.showMobileCommentInputControls=!0},e.removeUpload=function(a){var b=e.newComment.uploads.indexOf(a);b>=0&&e.newComment.uploads.splice(b,1)},e.isShared=function(a){return!!a&&_(a).any(function(a){return a.isShared})},e.userCardOpen={assignee:!1},e.showUserCard=function(a){a.stopPropagation(),f.loadUserCardData(e.note,e.userCardOpen.assignee,null,!0)},e.$on(f.onShow,function(a,b){e.$evalAsync(function(){e.userCardOpen.assignee=b&&b.note&&e.note&&b.note===e.note&&b.isAssignee})}),e.snooze=function(a){e.$emit("noteSnoozed",a)},e.dateChanged=function(a){e.targetDateChanged({targetDate:a})},e.isTogglingShare=!1,e.shareToggle=function(a){var b=a.isShared?h.shareRemove:h.shareAdd;e.isTogglingShare=!0,b("notes",e.note.id,a.id).then(function(){a.isShared=!a.isShared},function(){})["finally"](function(){e.isTogglingShare=!1,e.$emit("onSharedUsersChanged")})},e.complete=function(){
c.complete(e.note,g.projectID)},e.uncomplete=function(){c.uncomplete(e.note)},e.mentionableUsers=function(){return c.mentionableUsers(e.note.projectID)},e.assign=function(a){c.assign(e.note,a)},e.unassign=function(){c.unassign(e.note)},e.$on("showTaskSettingsPushIndicator",function(){e.showTaskSettingsPushIndicator=!0,k(function(){e.showTaskSettingsPushIndicator=!1})}),e.getTriggeredByUrl=function(a){if(!a||!a.projectID||!a.autoTaskTriggeredBySectionKey)return"";var b="#/project/"+a.projectID+"/custom/"+a.autoTaskTriggeredBySectionKey+(a.autoTaskTriggeredByCollectionItemGuid?"?item="+a.autoTaskTriggeredByCollectionItemGuid:"");return[i.protocol(),"://",i.host(),b].join("")}}}}angular.module("Crops").directive("comments",a),a.$inject=["fvApi","$rootScope","noteService","$sce","config","userCardService","$stateParams","shareService","$location","$anchorScroll","$timeout","$interpolate","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k){return{restrict:"E",replace:!0,scope:{note:"=",project:"=",mode:"@",isBottomMenu:"=",isOpen:"=?",targetDateChanged:"&"},templateUrl:"{0}/notes/note.actions.html".format(d.viewRoot),link:function(b,l){b.isTogglingShare={},b.status={},b.settings={showUrl:!1,isCopied:!1},b.dateChanged=function(a){b.targetDateChanged({targetDate:a})},b.snooze=function(a){b.$emit("noteSnoozed",a)},b.mentionableUsers=function(){return a.mentionableUsers(b.note.projectID)},b.showCompletedAction=function(){return!b.note.isCompleted&&("task"===b.note.typeTag||"question"===b.note.typeTag)},b.showSnoozeAction=function(){return"sms"!==b.note.typeTag},b.showAssignAction=function(){return"sms"!==b.note.typeTag},b.showDismissAction=function(){return b.note.isUnread},b.complete=function(d){d.stopPropagation(),a.complete(b.note,c.projectID)},b.uncomplete=function(c){c.stopPropagation(),a.uncomplete(b.note)},b.dismiss=function(c){c.stopPropagation(),b.note.isUnread=!1,a.dismiss(b.note),b.isBottomMenu||(b.isOpen=!1)},b.assign=function(c){a.assign(b.note,c)},b.unassign=function(){a.unassign(b.note)},b.shareToggle=function(a){var c=a.isShared?e.shareRemove:e.shareAdd;b.isTogglingShare[a.id]=!0,c("notes",b.note.id,a.id).then(function(){a.isShared=!a.isShared},function(){})["finally"](function(){b.isTogglingShare[a.id]=!1,b.$emit("onSharedUsersChanged")})},b.printVine=function(c,d){d.stopPropagation(),a.printVine(c),b.isBottomMenu||(b.isOpen=!1)},b.canCopyNote=function(){return"project"===b.mode&&b.project&&b.project.currentUserAccessLevel>=2&&"note"===b.note.typeTag},b.canPostToRelatedProjects=function(){if(!b.project||!b.project.relatedProjects)return!1;var a=_(b.project.relatedProjects).filter(function(a){return a.projectOrClientName});return b.canCopyNote()&&b.project.relatedProjects&&a.length},b.canMoveNote=function(){return"project"===b.mode&&b.project&&b.project.currentUserAccessLevel>=3&&"reminder"!==b.note.typeTag},b.openCopyModal=function(a,c,e){var h=g.open({animation:!0,templateUrl:"{0}/notes/notes.copy.modal.html".format(d.viewRoot),controller:"notesCopyModalController",size:"md",windowClass:"notes-copy-modal",resolve:{note:function(){return b.note},mode:function(){return a},countRelatedProjects:function(){return c},countProjectLinks:function(){return e}}});h.result.then(function(){},function(a){"onCopyToRelatedSuccess"!==a&&"onCopySuccess"!==a||(b.note.copiedFromNoteID=b.note.id,b.note.copierUser=f.currentUser())})},b.copyNote=function(a){a.stopPropagation(),b.canCopyNote()&&b.openCopyModal("copy"),b.isBottomMenu||(b.isOpen=!1)},b.postToRelatedProjects=function(a){if(a.stopPropagation(),b.canPostToRelatedProjects()){var c=0,d=_(b.project.relatedProjects).filter(function(a){return a.projectOrClientName});k.getLinkedProjectsCount(b.project.id).then(function(a){c=a,b.openCopyModal("copyToRelated",d.length,c),b.isBottomMenu||(b.isOpen=!1)})}},b.moveNote=function(a){a.stopPropagation(),b.canMoveNote()&&b.openCopyModal("move"),b.isBottomMenu||(b.isOpen=!1)},b.canPinToProject=function(){return"project"===b.mode&&b.project&&b.project.currentUserAccessLevel>=3},b.togglePinToProject=function(c){c.stopPropagation(),b.note.isPinnedToProject?a.unpinFromProject(b.note):a.pinToProject(b.note),b.isBottomMenu||(b.isOpen=!1)},b.togglePinToFeed=function(c){c.stopPropagation(),b.note.isPinnedToFeed?a.unpinFromFeed(b.note):a.pinToFeed(b.note),b.isBottomMenu||(b.isOpen=!1)},b.gotoNoteTop=function(a){a.stopPropagation(),h.hash("note-"+b.note.id),i(),h.hash("")},b.typeTagDisplay=function(){return"sms"===b.note.typeTag?"Text":b.note.destination&&"fax"===b.note.typeTag?"fax":b.note.destination&&"task"!==b.note.typeTag?"Email":b.note.typeTag},b.isIOS=function(){return navigator.userAgent.match(/ipad|iphone/i)},b.canCopyToClipboard=function(){return!b.isIOS()&&document.queryCommandSupported&&document.queryCommandSupported("copy")},b.getNoteUrl=function(){var a=c.projectID||b.note.projectID;return a?Crops.ShortUrlPrefix+"n/"+b.note.id:null},b.copyNoteUrl=function(a){a.stopPropagation(),console.log(h.absUrl()),b.copyToClipboard(b.getNoteUrl()),j(function(){b.settings.isCopied=!1,b.isBottomMenu||j(function(){b.isOpen=!1})},400)},b.copyToClipboard=function(a){if(window.clipboardData&&window.clipboardData.setData&&a)return clipboardData.setData("Text",a);if(b.canCopyToClipboard()&&a){var c=document.createElement("textarea");c.textContent=a,c.style.position="fixed",c.style.opacity="0",c.contentEditable=!0,c.readOnly=!1,document.body.appendChild(c),c.select();var d=!0;try{return document.execCommand("copy")}catch(e){return d=!1,console.warn("Copy to clipboard failed.",e),!1}finally{d&&(b.settings.isCopied=!0),document.body.removeChild(c)}}}}}}angular.module("Crops").directive("noteActions",a),a.$inject=["noteService","$state","$stateParams","config","shareService","currentUserService","$uibModal","$location","$anchorScroll","$timeout","relatedProjectsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"A",scope:{note:"=fvNote",ngModel:"=",orgId:"="},link:function(d,g,h){function i(){return d.note?d.note.projectID:c.projectID}function j(){r.find("a").bind("keydown",x),angular.element(document).bind("click",w)}function k(a){var b,c,d;a.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange?(b=document.createRange(),b.selectNodeContents(a),b.collapse(!1),c=window.getSelection(),c.removeAllRanges(),c.addRange(b)):"undefined"!=typeof document.body.createTextRange&&(d=document.body.createTextRange(),d.moveToElementText(a),d.collapse(!1),d.select())}function l(){angular.element(document).unbind("click",w),s="",r.hide(),t=!1}function m(a,b){return a.slice(0,-b.length)}function n(a){var b=d.mentionableUsers();if(b.length){var c=[],e=[];return""===a?_(b).first(20):(_.each(b,function(b){var d=b.username.toLowerCase().indexOf(a.toLowerCase());0===d?c.push(b):d>0&&e.push(b)}),_(c.concat(e)).first(20))}return[]}function o(a,b){if(a.length)_.each(a,function(a){r.append(p(a,b))});else{var c="user"===b?"No matching project team members found":"";c&&r.append('<li class="list-group-item person-list-item no-results"><em class="text-meta">'+c+"</em></li>")}}function p(a,b){var c;return c="user"===b?$('<li class="list-group-item person-list-item"><a role="menuitem" class="person-block" href="" ng-click="onSelect(\''+a.username+"', '"+b+'\')"><div class="media media-top"><div class="media-left"><div class="media-object avatar avatar-sm"><img src="'+a.pictureUrl+'" role="presentation" /></div></div><div class="media-body"><h3 class="person-name">'+a.fullname+'</h3><div class="person-details">@'+a.username+"</div></div></div></a></li>"):$('<li class="list-group-item person-list-item"><a role="menuitem" href="" ng-click="onSelect(\''+a+"', '"+b+"')\">"+a+"</a></li>"),e(c)(d)}function q(){r.css({top:g[0].offsetHeight,left:0})}d.mentionableUsers=function(){var b=i();return b?a.mentionableUsers(b):null};var r=$('<ul class="list-group dropdown-menu person-list maxh-50" style="display:none; position:absolute; z-index:100" ></ul>');$(g).after(e(r)(d));var s,t=!1;d.$watch("ngModel",function(){if(r.empty(),d.ngModel&&i()){var a,c,e=angular.copy(d.ngModel),f=e.match(/(^|\s|[\.\+])((@)([A-Za-z0-9-_]+)?)$/),g=e.match(/(^|\s)((#)([A-Za-z0-9-_]+)?)$/);if(f){a=f[2],c=a.replace("@",""),s=m(e,a);var h=n(c);o(h,"user"),q(),r.show(),t=!0,j()}else g&&d.orgId?(a=g[2],c=a.replace("#",""),s=m(e,a),d.loadingOrgHashtags=!0,b.searchHashtags(d.orgId,c,"note").then(function(a){a.length?(o(a,"hashtag"),q(),r.show(),t=!0,j()):l(),d.loadingOrgHashtags=!1},function(){l(),d.loadingOrgHashtags=!1})):l()}else l()});var u={down:40,up:38,esc:27},v=function(a){t&&a.keyCode==u.down&&(a.preventDefault(),r.find("a").first().focus())},w=function(a){var b=g[0]!==a.target&&0===r.find(a.target).length;b&&l()},x=function(a){t&&(a.keyCode==u.down?(a.preventDefault(),$(this).parent().is(":last-child")?r.find("a").first().focus():$(this).parent().next("li").find("a").last().focus()):a.keyCode==u.up?(a.preventDefault(),$(this).parent().is(":first-child")?r.find("a").last().focus():$(this).parent().prev("li").find("a").last().focus()):a.keyCode==u.esc&&(a.preventDefault(),l(),f(function(){k($(g)[0])})))};$(g).bind("keydown",v),d.$on("$destroy",function(){angular.element(document).unbind("click",w)}),d.onSelect=function(a,b){d.ngModel=s+("user"===b?"@":"")+a+"&nbsp;",l(),f(function(){k($(g)[0])})}}}}angular.module("Crops").directive("noteAutocomplete",a),a.$inject=["noteService","hashtagService","$stateParams","config","$compile","$timeout","$window"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){return{restrict:"E",scope:{note:"=",mode:"@",startExpanded:"=",noteIndex:"=",project:"=?",noteUiSettings:"="},templateUrl:"{0}/notes/note.html".format(c.viewRoot),link:function(a,c){function o(){var b=c[0].getBoundingClientRect(),d=Math.max(l[0].documentElement.clientHeight,k.innerHeight);(b.bottom<0||b.top-d>=0)&&a.gotoNoteTop()}function p(b){if(b.parentType.toLowerCase()===a.reactionParentTypes.note.toLowerCase())return a.note.reactions;if(b.parentType.toLowerCase()===a.reactionParentTypes.comment.toLowerCase()){if(!a.note.comments||!a.note.comments.length)return null;var c=_.indexOf(a.note.comments,_(a.note.comments).findWhere({id:b.parentID}));return isNaN(c)||c<0?null:a.note.comments[c].reactions}return null}function q(){if(a.note){var b;a.note.reactions&&a.note.reactions.length&&(b=_.chain(a.note.reactions).filter(function(a){return _(a.reactingUsers).findWhere({id:e.currentUser().id})}).map(function(a){return a.reactionType}).value()),_(a.noteReactionOptions).each(function(c){a.noteReactionIsActive[c.reactionType]=!!(b&&b.indexOf(c.reactionType)>-1)})}}a.status={noteEditable:!0,isEditing:!1,showPushIndicator:!1,showProjectLink:"tasks"===a.mode||"feed"===a.mode||"recent"===a.mode},a.hideForPrint=!1,a.isPrintingSingleNote=!1,a.collapsedViewHeight=67,a.collapsedNoteMaxDocs=3,a.noteReactionOptions=b.noteReactionOptions(),a.reactionParentTypes=b.noteReactionParentTypes(),a.noteReactionIsActive={},a.isOverflowing=function(){var b=c.find("#notebody-"+a.note.id)[0];return!!b&&(!a.note.isExpanded&&b.offsetHeight>a.collapsedViewHeight)},a.toggleNote=function(){var c,g,h,i=a.note;if(i.isExpanded=!i.isExpanded,i.isExpanded&&!i.isLoaded&&b.getNote(i.id).then(function(c){a.note=c,q(),a.note.isExpanded=!0,b.mergeNote(c,a.mode),a.subscribeToReactions()}),!a.status.isEditing&&!i.isExpanded){if("tasks"===a.mode&&(!i.assignee||i.assignee&&i.assignee.id!==e.currentUser().id))return void b.removeNote(i);if("feed"===a.mode&&!i.isUnread&&!i.isPinnedToFeed)return void b.removeNote(i);if("tasks"===a.mode&&i.isCompleted)return void b.removeNote(i);if("tasks"===a.mode&&(c=moment(d.targetDate).startOf("day"),g=moment().startOf("day"),h=moment(i.targetDate).startOf("day"),c.isSame(g)&&h.isAfter(g)||c.isAfter(g)&&!h.isSame(c)))return void b.removeNote(i);f(function(){o()})}},a.startExpanded&&a.toggleNote(),a.typeTagDisplay=function(){return"sms"===a.note.typeTag?"Text":a.note.destination&&"fax"===a.note.typeTag?"fax":a.note.destination&&"task"!==a.note.typeTag?"Email":a.note.typeTag},a.typeIcon=function(a){return"note"===a?"fa-sticky-note-o":"Email"===a?"fa-envelope":"fax"===a?"fa-fax":"Text"===a?"fa-commenting":"task"===a?"fa-list-ul":"reminder"===a?"fa-bell":"fa-sticky-note-o"},a.getSmsRecipient=function(b){if(!b.peopleForSms)return"";var c=b.peopleForSms.filter(function(a){return a.id===b.smsPersonId});return 1===c.length?"Outbound text message to {0}".format(c[0].fullname):(a.status.noteEditable=!1,"Outbound recipient not set for this note.")},a.isSmsAndRecipient=function(a){return"sms"===a.typeTag&&a.smsPersonId},a.showDismissAction=function(){return a.note.isUnread},a.dismiss=function(c){c&&c.stopPropagation(),a.note.isUnread=!1,b.dismiss(a.note),"feed"!==a.mode||a.note.isExpanded||a.note.isPinnedToFeed||b.removeNote(a.note)},a.removeDoc=function(b){return n.removeDoc(b.id).then(function(){a.note.docs=_(a.note.docs).reject(function(a){return a.id===b.id})})},a.canUnpinFromProject=function(){return a.note.isPinnedToProject&&a.project&&a.project.currentUserAccessLevel>=3},a.unpinFromFeed=function(c,d){d&&d.stopPropagation(),b.unpinFromFeed(a.note),"feed"!==c||a.note.isExpanded||a.note.isUnread||b.removeNote(a.note)},a.unpinFromProject=function(c,d){d&&d.stopPropagation(),b.unpinFromProject(a.note)},a.isShared=function(a){return!!a&&_(a).any(function(a){return a.isShared})},a.saveEditing=function(c){c.stopPropagation(),b.updateNote(a.note.id,a.note.newBody).then(function(b){b&&(a.note.body=b.body,a.cancelEditing())})},a.startEditing=function(b){b.stopPropagation(),a.note.allowEditing&&(a.status.isEditing=!0,a.note.newBody=angular.copy(a.note.body),f(function(){a.adjustEditorHeight()}))},a.cancelEditing=function(b){b&&b.stopPropagation(),delete a.note.newBody,a.status.isEditing=!1},a.adjustEditorHeight=function(){var b=$(c).find("#editNoteInput-"+a.note.id)[0];b.style.height=b.scrollHeight>=b.clientHeight?b.scrollHeight+"px":"36px"},a.hasRecentActivity=function(){return moment().diff(moment.utc(a.note.lastActivity),"minutes")<241},a.targetDateTagText=function(){return a.note.completedDate?"":a.note.targetDate?moment().diff(moment(moment.utc(a.note.targetDate).format("YYYY-MM-DD")),"hours")>24?"Overdue":moment(moment.utc(a.note.targetDate).format("YYYY-MM-DD")).calendar(null,{sameDay:"[Due Today]",nextDay:"[Due Tomorrow]",nextWeek:"[Due] ddd",lastDay:"[]",lastWeek:"[]",sameElse:"[]"}).split(" at")[0]:""},a.userCardOpen={noteAuthor:!1},a.showUserCard=function(b,c){b.stopPropagation(),g.loadUserCardData(c,a.userCardOpen.noteAuthor,null,!1)},a.$on(g.onShow,function(b,c){a.$evalAsync(function(){a.userCardOpen.noteAuthor=c&&c.note&&a.note&&c.note===a.note&&!c.isAssignee})}),a.$on(b.isPrintingVine,function(b,c){c!==a.note.id?a.hideForPrint=!0:a.isPrintingSingleNote=!0}),a.$on("onPrintFinished",function(){a.hideForPrint=!1,a.isPrintingSingleNote=!1}),a.showCopiedMessage=function(){return a.note&&a.note.canBeShared&&a.note.copiedFromNoteID&&a.note.copierUser},a.isOriginalNote=function(){return a.note&&(!a.note.copiedFromNoteID||a.note.copiedFromNoteID===a.note.id)},a.isCurrentUser=function(a){return a&&a.id===e.currentUser().id},a.toggleBottomMenu=function(b){b.stopPropagation(),a.noteUiSettings.bottomMenuExpanded=!a.noteUiSettings.bottomMenuExpanded,h.setNoteBottomMenuState(a.noteUiSettings.bottomMenuExpanded)},a.gotoNoteTop=function(b){b.stopPropagation(),i.hash("note-"+a.note.id),j(),i.hash("")},a.targetDateChanged=function(b){a.snooze("date",b)},a.snooze=function(c,e){b.snooze(a.note,c,e,d.projectID)},a.subscribeToReactions=function(){m.subscribeToNote(a.note.id)},a.$on("noteSnoozed",function(b,c){b.stopPropagation(),a.snooze(c)}),a.$on("reaction-added",function(b,c){if(c&&c.reactionResponse&&(c.reactionResponse.parentType.toLowerCase()!==a.reactionParentTypes.note.toLowerCase()||c.reactionResponse.parentID===a.note.id)&&a.note.isLoaded){var d=p(c.reactionResponse);d=d||[];var e=c.reactionResponse,f=_.indexOf(d,_(d).findWhere({reactionType:e.reactionType}));a.$apply(function(){f>-1?d[f].reactingUsers=e.reactingUsers:d.push({reactionType:e.reactionType,reactingUsers:e.reactingUsers})})}}),a.$on("update-delivery-status",function(b,c){if(c&&a.note&&c.noteID===a.note.id)if("note"===c.deliverableType.toLowerCase()&&c.deliverableID===a.note.id)a.$apply(function(){a.note.deliveryStatus=c.deliveryStatus,a.note.deliveryDate=c.deliveryDate,c.docs&&c.docs.length>0&&(a.note.docs=c.docs),c.noteBody&&(a.note.body=c.noteBody)});else if("comment"===c.deliverableType.toLowerCase()&&a.note.isLoaded&&a.note.comments&&a.note.comments.length){var d=a.note.comments.find(function(a){return a.id===c.deliverableID});d&&a.$apply(function(){d.deliveryStatus=c.deliveryStatus,d.deliveryDate=c.deliveryDate})}}),a.$on("reaction-removed",function(b,c){if(c&&c.reactionResponse&&(c.reactionResponse.parentType.toLowerCase()!==a.reactionParentTypes.note.toLowerCase()||c.reactionResponse.parentID===a.note.id)&&a.note.isLoaded){var d=p(c.reactionResponse),e=c.reactionResponse;if(d){var f=_.indexOf(d,_(d).findWhere({reactionType:e.reactionType}));f>-1&&a.$apply(function(){e.reactingUsers&&e.reactingUsers.length?d[f].reactingUsers=e.reactingUsers:d.splice(f,1)})}}}),a.getTriggeredByUrl=function(a){if(!a||!a.projectID||!a.autoTaskTriggeredBySectionKey)return"";var b="#/project/"+a.projectID+"/custom/"+a.autoTaskTriggeredBySectionKey+(a.autoTaskTriggeredByCollectionItemGuid?"?item="+a.autoTaskTriggeredByCollectionItemGuid:"");return[i.protocol(),"://",i.host(),b].join("")},a.$on("$destroy",function(){a.note.isLoaded&&m.unsubscribeFromNote(a.note.id)}),a.note.isLoaded&&a.subscribeToReactions(),a.$on("onNotePushed",function(b,c){c.noteID&&c.noteID===a.note.id&&(a.note.isExpanded?c.pushType&&f(function(){"commentsChange"===c.pushType?a.$broadcast("showCommentPushIndicator"):"taskChange"===c.pushType&&a.$broadcast("showTaskSettingsPushIndicator")}):(a.status.showPushIndicator=!0,f(function(){a.status.showPushIndicator=!1})))})}}}angular.module("Crops").directive("note",a),a.$inject=["$rootScope","noteService","config","$stateParams","currentUserService","$timeout","userCardService","uiSettingsService","$location","$anchorScroll","$window","$document","pushService","docService"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){return ma&&!na}function h(){return angular.copy({filterByType:0,filterIncompleteOnlySet:!1,filterCompleteOnlySet:!1,filterAssignedToMeSet:!1,filterCompletedByMeSet:!1,filterCreatedByMeSet:!1,filterUtcCreateDateRangeStart:null,filterUtcCreateDateRangeEnd:null,filterRawTaskTargetDateRangeStart:null,filterRawTaskTargetDateRangeEnd:null,filterPinnedOnly:!1,filterUnpinnedOnly:!1,filterHashtagsList:[],noteId:null})}function i(){return na}function j(){return ca}function k(){oa=!0}function l(){return!(ma||na||ba&&ba.length)}function m(){!ha&&!ia&&ja&&ka&&n()}function n(){ha=!0;var b=da,d=ka.slice();d.push(ba.length||0),console.debug("filter",la),a.post(ja,d,la).then(function(a){console.debug("internalGetMoreUrl.Response",a),da===b&&(ba.length?(ba=_.reject(ba,function(b){return _.any(a.notes,function(a){return a.id===b.id})}),ba=ba.concat(a.notes)):ba=a.notes,ca=a.totalCount,ma=!1,ia=a.notes.length<25,ha=!1,c.$broadcast(ra,{listState:da,noteID:null}),c.$broadcast(qa))},function(){ma=!1,ha=!1,ia=!1,c.$broadcast(ra,{listState:da,noteID:null})})}function o(a,b,d){if("mailroom"===b)return a;for(var e=-1,f=0;f<ba.length;f++)if(ba[f].id===a.id){e=f;break}var g;e>-1?(g=angular.copy(ba[e]),a.isExpanded=a.isExpanded||d&&ba[e].isExpanded,ba.splice(e,1,a)):(ba.unshift(a),ca++);var h=null;return d&&g&&a.isExpanded&&(h=g.commentCount!==a.commentCount?"commentsChange":"taskChange"),c.$broadcast(qa),c.$broadcast(ra,{listState:da,noteID:d?a.id:null,pushType:h}),a}function p(b,c){return a.post(aa.updateNote,[b],{body:c})}function q(b,c){return a.post(aa.updateComment,[b],{body:c})}function r(b,c){return a.post(aa.addCommentReaction,[b],{reactionType:c})}function s(b,c){return a.post(aa.addNoteReaction,[b],{reactionType:c})}function t(b,c){return a.del(aa.removeCommentReaction,[b,c])}function u(b,c){return a.del(aa.removeNoteReaction,[b,c])}function v(b){return a.post(aa.postNoteToRelatedProjects,[b])}function w(b,c){return a.post(aa.copyNoteTo,[b,c])}function x(b,c){return a.post(aa.moveNoteTo,[b,c])}function y(){return ba}function z(a,b){ca=0,ba=[],da="feed."+JSON.stringify(b),ma=!0,c.$broadcast(ra,{listState:da,noteID:null}),ja="recent"===a?aa.recentNotes:aa.notesFeed,ka=[],la=b,c.$broadcast(qa),n()}function A(b){return a.get(aa.getNote,[b])}function B(b){return a.suppress403errors=!0,a.post(aa.getNote,[b],la)["finally"](function(){a.suppress403errors=!1})}function C(a){ca=0,ba=[],da="tasks."+JSON.stringify(a),ma=!0,c.$broadcast(ra,{listState:da,noteID:null}),ja=aa.notesTasks,ka=[],la=a,c.$broadcast(qa),n()}function D(a){var b=d.projectID,e="project."+b+"."+JSON.stringify(a);!oa&&da===e||ma||(ca=0,ba=[],da=e,ma=!0,oa=!1,c.$broadcast(ra,{listState:da,noteID:null}),ja=aa.projectNotes,ka=[b],la=a||h(),c.$broadcast(qa),n())}function E(){return a.get(aa.getPeopleForSms,[d.projectID])}function F(b){if(b||(b=d.projectID),ea[0]=[],fa=[],ga=0,b){ea[b]=[];var c=e.project();c&&c.id===b&&c.team&&c.team.length?ea[b]=c.team:pa[b]||(pa[b]=!0,a.get(aa.notesMentionable,b).then(function(a){ea[b]=a,fa=[],ga=b;for(var c=0;c<ea[b].length;c++)fa.push("@"+ea[b][c].username);pa[b]=!1},function(){ea[b]=[],fa=[],ga=b,pa[b]=!1}))}}function G(a){return a||(a=d.projectID),ea||F(a),ea[a]?ea[a]:(F(a),[])}function H(a){return ga===a?fa:(F(a),[])}function I(b,c,d){var e=moment.utc(d);switch(c){case"week":e=e.add(7,"day");break;case"month":e=e.add(30,"day");break;case"tomorrow":e=e.add(1,"day");break;case"date":e=moment.utc(d)}return a.put(aa.noteSnooze,[b.id],{snoozeDate:e.format()}).then(function(a){console.log(a),L(a)})}function J(b,c){a.post(aa.noteAssign,[b.id,c]).then(function(a){L(a)})}function K(b){a.post(aa.noteUnAssign,[b.id]).then(function(a){L(a)})}function L(a,b){for(var c=0;c<ba.length;c++)if(ba[c].id===a.id){var d=ba[c].isExpanded;angular.copy(a,ba[c]),b||(ba[c].isExpanded=d);break}}function M(a){for(var b=0;b<ba.length;b++)if(ba[b].id===a.id){ba.splice(b,1),ca--,ba.length<25&&!ia?m():(c.$broadcast(ra,{listState:da,noteID:null}),c.$broadcast(qa));break}}function N(b){a.post(aa.noteDismiss,[b.id])}function O(b){a.post(aa.notePinToProject,[b.id]).then(function(a){c.$broadcast(sa,a)})}function P(b){a.post(aa.noteUnpinFromProject,[b.id]).then(function(a){c.$broadcast(ta,a)})}function Q(b){a.post(aa.notePinToFeed,[b.id]).then(function(a){c.$broadcast(ua,a)})}function R(b){a.post(aa.noteUnpinFromFeed,[b.id]).then(function(a){a.wasExpanded=b.isExpanded,c.$broadcast(va,a)})}function S(b){a.post(aa.noteComplete,[b.id]).then(function(a){L(a),c.$broadcast(ra,{listState:da,noteID:null})})}function T(b){a.post(aa.noteUncomplete,[b.id]).then(function(a){L(a),c.$broadcast(ra,{listState:da,noteID:null})})}function U(b,c){return c.noteID=b.id,a.post(aa.noteComment,[b.id],c)}function V(b,c){return a.post(aa.noteCreate,[b],c)}function W(a){c.$broadcast(wa,a)}function X(){return xa}function Y(){return ya}function Z(a){var b=a.parentType.toLowerCase()===ya.note,c=a.parentType.toLowerCase()===ya.comment,d=b?u:c?t:null;return d?d(a.parentID,a.reactionType):f.reject("Reaction parent type not recognized.")}function $(a){var b=a.parentType.toLowerCase()===ya.note,c=a.parentType.toLowerCase()===ya.comment,d=b?s:c?r:null;return d?d(a.parentID,a.reactionType):f.reject("Reaction parent type not recognized.")}var aa={notesFeed:"/api/notes/feed?offset={0}",recentNotes:"/api/notes/recent?offset={0}",notesTasks:"/api/notes/tasks?offset={0}",projectNotes:"/api/projects/{0}/notes?offset={1}",getPeopleForSms:"/api/projects/{0}/smspeople",notesMentionable:"/api/users/project/{0}",noteSnooze:"/api/notes/{0}/snooze",noteDismiss:"/api/notes/{0}/dismiss",notePinToProject:"api/notes/{0}/pin",noteUnpinFromProject:"api/notes/{0}/unpin",notePinToFeed:"api/notes/{0}/feed/pin",noteUnpinFromFeed:"api/notes/{0}/feed/unpin",noteAssign:"/api/notes/{0}/assign/{1}",noteUnAssign:"/api/notes/{0}/unassign",noteComplete:"/api/notes/{0}/complete",noteUncomplete:"/api/notes/{0}/uncomplete",noteComment:"/api/notes/{0}/comment",noteCreate:"/api/projects/{0}/notes/create",getNote:"/api/notes/{0}",updateNote:"/api/notes/{0}/update",updateComment:"/api/comments/{0}/update",addCommentReaction:"/api/comments/{0}/reactions",addNoteReaction:"/api/notes/{0}/reactions",removeCommentReaction:"/api/comments/{0}/reactions/{1}",removeNoteReaction:"/api/notes/{0}/reactions/{1}",postNoteToRelatedProjects:"api/notes/{0}/postToRelated",copyNoteTo:"api/notes/{0}/copyTo/{1}",moveNoteTo:"api/notes/{0}/moveTo/{1}"},ba=null,ca=0,da=null,ea={},fa=[],ga=0,ha=!1,ia=!1,ja=null,ka=null,la=null,ma=!1,na=!1,oa=!1,pa={},qa="noteService.onNoteCountChanged",ra="noteService.onNoteListChanged",sa="noteService.onNotePinnedToProject",ta="noteService.onNoteUnpinnedFromProject",ua="noteService.onNotePinnedToFeed",va="noteService.onNoteUnpinnedFromFeed",wa="noteService.isPrintingVine",xa=[{reactionType:"ThumbsUp",iconClass:"fa-thumbs-o-up"},{reactionType:"ThumbsDown",iconClass:"fa-thumbs-o-down"},{reactionType:"Happy",iconClass:"fa-smile-o"},{reactionType:"Meh",iconClass:"fa-meh-o"},{reactionType:"Sad",iconClass:"fa-frown-o"},{reactionType:"Checkmark",iconClass:"fa-check"}],ya={note:"note",comment:"comment"},za={loadFeed:z,loadTasks:C,loadProject:D,noteList:y,getMore:m,mergeNote:o,removeNote:M,noteListEmpty:l,getNote:A,getNoteWithFilter:B,isLoading:g,isBetweenTimeout:i,getPeopleForSms:E,initMentionableUsers:F,mentionableUsers:G,userParseList:H,snooze:I,assign:J,unassign:K,dismiss:N,pinToProject:O,unpinFromProject:P,pinToFeed:Q,unpinFromFeed:R,onNotePinnedToProject:sa,onNoteUnpinnedFromProject:ta,onNotePinnedToFeed:ua,onNoteUnpinnedFromFeed:va,complete:S,uncomplete:T,addComment:U,create:V,updateNote:p,updateComment:q,postNoteToRelatedProjects:v,copyNoteTo:w,moveNoteTo:x,forceNextReload:k,onNoteCountChanged:qa,onNoteListChanged:ra,noteCount:j,defaultFilter:h,printVine:W,isPrintingVine:wa,noteReactionOptions:X,noteReactionParentTypes:Y,removeReaction:Z,addReaction:$};return za}angular.module("Crops").service("noteService",a),a.$inject=["fvApi","$sce","$rootScope","$stateParams","projectService","$q"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){a.settings={modalMode:{},destinationProject:null,isCopyingOrMoving:!1},c&&(a.note=c),d&&(a.settings.modalMode[d]=!0),e&&(a.settings.countRelatedProjects=e),f&&(a.settings.countProjectLinks=f),a.close=function(){b.dismiss("close")},a.selectProject=function(b){a.settings.destinationProject=b},a.clientName=function(){return a.settings.destinationProject&&a.settings.destinationProject.client?a.settings.destinationProject.client.fullname||"(Unknown)":""},a.canCopyOrMove=function(){return!a.settings.isCopyingOrMoving&&a.note&&a.note.id&&a.settings.destinationProject&&a.settings.destinationProject.id&&a.settings.destinationProject.id!==a.note.projectID},a.typeTagDisplay=function(){return"sms"===a.note.typeTag?"text":a.note.destination&&"task"!==a.note.typeTag?"email":a.note.typeTag},a.copyNote=function(){!a.settings.isCopyingOrMoving&&a.settings.modalMode.copy&&a.canCopyOrMove()&&(a.settings.isCopyingOrMoving=!0,h.copyNoteTo(a.note.id,a.settings.destinationProject.id).then(function(){a.settings.isCopyingOrMoving=!1,b.dismiss("onCopySuccess")},function(b){a.settings.isCopyingOrMoving=!1,g.alertFail(b)}))},a.moveNote=function(){!a.settings.isCopyingOrMoving&&a.settings.modalMode.move&&a.canCopyOrMove()&&(a.settings.isCopyingOrMoving=!0,h.moveNoteTo(a.note.id,a.settings.destinationProject.id).then(function(){h.removeNote(a.note),a.settings.isCopyingOrMoving=!1,b.dismiss("onNoteMoveSuccess")},function(b){a.settings.isCopyingOrMoving=!1,g.alertFail(b)}))},a.postToRelatedProjects=function(){!a.settings.isCopyingOrMoving&&a.settings.modalMode.copyToRelated&&(a.settings.isCopyingOrMoving=!0,h.postNoteToRelatedProjects(a.note.id).then(function(){b.dismiss("onCopyToRelatedSuccess")},function(b){a.settings.isCopyingOrMoving=!1,g.alertFail(b)}))}}angular.module("Crops").controller("notesCopyModalController",a),a.$inject=["$scope","$uibModalInstance","note","mode","countRelatedProjects","countProjectLinks","fvAlertsService","noteService","$state"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",templateUrl:"{0}/notes/notes.filter.html".format(d.viewRoot),scope:{filter:"=",defaultFilter:"=",disabled:"=",isTasks:"="},link:function(a,b){function e(a){return j.indexOf(a)>-1}function g(b,c){return c?_.findWhere(a.filterTags,{filterKey:b,text:c}):_.findWhere(a.filterTags,{filterKey:b})}function h(){return _.every(j,function(b){return a.filter[b]===a.defaultFilter[b]})}function i(){!a.isTasks&&g("filterByType","Tasks")&&2!==a.filter.filterByType&&h()&&(a.filterTags=_.reject(a.filterTags,function(a){return"filterByType"===a.filterKey&&"Tasks"===a.text}))}a.filterTags=[],a.modalMode={},a.typeIsSetButNotTasks=function(){return a.filter&&(1===a.filter.filterByType||3===a.filter.filterByType||4===a.filter.filterByType)};var j=["filterIncompleteOnlySet","filterCompleteOnlySet","filterAssignedToMeSet","filterCompletedByMeSet","filterRawTaskTargetDateRangeStart","filterRawTaskTargetDateRangeEnd"],k={filterKey:"filterByType",filterType:0,text:"Tasks",icon:"fa-list-ul"};a.applyFilter=function(b,c,d,f,h){if(!a.typeIsSetButNotTasks()||!e(b)){var i={filterKey:b,filterType:d,text:f,icon:h},j=_.findWhere(a.filterTags,{filterType:d});j&&(j.filterKey!==b?a.rmFilter(j):a.rmFilterTag(j)),!a.isTasks&&e(b)&&(g("filterByType","Tasks")||a.addFilterTag(k)),a.filter[b]=c,a.addFilterTag(i)}},a.rmFilter=function(b,d){b.stopPropagation(),"createdDate"===d.text?(a.filter.filterUtcCreateDateRangeStart=angular.copy(a.defaultFilter.filterUtcCreateDateRangeStart),a.filter.filterUtcCreateDateRangeEnd=angular.copy(a.defaultFilter.filterUtcCreateDateRangeEnd)):"dueDate"===d.text?(a.filter.filterRawTaskTargetDateRangeStart=angular.copy(a.defaultFilter.filterRawTaskTargetDateRangeStart),a.filter.filterRawTaskTargetDateRangeEnd=angular.copy(a.defaultFilter.filterRawTaskTargetDateRangeEnd)):"hashtags"===d.text?(a.filter.filterHashtagsList=angular.copy(a.defaultFilter.filterHashtagsList),c.search({})):"searchResults"===d.text?(a.filter.noteId=angular.copy(a.defaultFilter.noteId),c.search({})):(a.filter[d.filterKey]=angular.copy(a.defaultFilter[d.filterKey]),a.rmFilterTag(d))},a.addFilterTag=function(b){a.filterTags.length?a.filterTags.splice(b.filterType,0,b):a.filterTags.push(b)},a.rmFilterTag=function(b){var c=a.filterTags.indexOf(b);c>-1&&a.filterTags.splice(c,1),i()},a.isTagVisible=g,a.$watch("filter.filterRawTaskTargetDateRangeStart",function(b,c){a.isTasks||!b||c||g("filterByType","Tasks")?!b&&c&&a.defaultFilter&&(a.filter.filterRawTaskTargetDateRangeStart=a.defaultFilter.filterRawTaskTargetDateRangeStart,i()):a.addFilterTag(k)}),a.$watch("filter.filterRawTaskTargetDateRangeEnd",function(b,c){a.isTasks||!b||c||g("filterByType","Tasks")?!b&&c&&a.defaultFilter&&(a.filter.filterRawTaskTargetDateRangeEnd=a.defaultFilter.filterRawTaskTargetDateRangeEnd,i()):a.addFilterTag(k)}),a.$watch("filter.filterUtcCreateDateRangeStart",function(b,c){!b&&c&&a.defaultFilter&&(a.filter.filterUtcCreateDateRangeStart=a.defaultFilter.filterUtcCreateDateRangeStart)}),a.$watch("filter.filterUtcCreateDateRangeEnd",function(b,c){!b&&c&&a.defaultFilter&&(a.filter.filterUtcCreateDateRangeEnd=a.defaultFilter.filterUtcCreateDateRangeEnd)}),a.hideRemoveBtn=function(b){return"filterByType"===b.filterKey&&"Tasks"===b.text&&(2!==a.filter.filterByType||!h())},a.clearAllFilters=function(){a.filter=angular.copy(a.defaultFilter),a.filterTags=[],c.search({})},a.isFilterActive=function(){return!angular.equals(a.filter,a.defaultFilter)},a.openFilterModal=function(b){var c=f.open({animation:!0,templateUrl:"{0}/notes/notes.filter.modal.html".format(d.viewRoot),controller:"notesFilterModalController",
size:"md",windowClass:"notes-filter-modal",resolve:{filter:function(){return a.filter},mode:function(){return b}}});c.result.then(function(c){"hashtags"===b?a.filter.filterHashtagsList=angular.copy(c.filterHashtagsList):"createDate"===b?(a.filter.filterUtcCreateDateRangeStart=angular.copy(c.filterUtcCreateDateRangeStart),a.filter.filterUtcCreateDateRangeEnd=angular.copy(c.filterUtcCreateDateRangeEnd)):"targetDate"===b&&(a.filter.filterRawTaskTargetDateRangeStart=angular.copy(c.filterRawTaskTargetDateRangeStart),a.filter.filterRawTaskTargetDateRangeEnd=angular.copy(c.filterRawTaskTargetDateRangeEnd))})},a.friendlyDateUtc=function(a){return moment.utc(a,"MM/DD/YYYY",!1).local().calendar().split(" at")[0]},a.friendlyDate=function(a){return moment(a,"MM/DD/YYYY",!1).calendar().split(" at")[0]}}}}angular.module("Crops").directive("notesFilter",a),a.$inject=["fvApi","$rootScope","$location","config","$timeout","$uibModal"]}(),function(){"use strict";function a(a,b,c,d,e){a.filterModal={},a.modalMode={},a.form={},c&&d&&(a.modalMode[d]=!0,"hashtags"===d?(a.filterModal.filterHashtagsList=angular.copy(c.filterHashtagsList),e(function(){a.$broadcast("focusOnTagListInput")},300)):"createDate"===d?(a.filterModal.filterUtcCreateDateRangeStart=angular.copy(c.filterUtcCreateDateRangeStart),a.filterModal.filterUtcCreateDateRangeEnd=angular.copy(c.filterUtcCreateDateRangeEnd)):"targetDate"===d&&(a.filterModal.filterRawTaskTargetDateRangeStart=angular.copy(c.filterRawTaskTargetDateRangeStart),a.filterModal.filterRawTaskTargetDateRangeEnd=angular.copy(c.filterRawTaskTargetDateRangeEnd))),a.close=function(){b.dismiss("close")},a.canSave=function(){return Object.keys(a.modalMode).length&&(a.modalMode.hashtags||a.modalMode.createDate&&a.form.createDate.$valid||a.modalMode.targetDate&&a.form.targetDate.$valid)},a.save=function(){a.canSave()&&b.close(a.filterModal)}}angular.module("Crops").controller("notesFilterModalController",a),a.$inject=["$scope","$uibModalInstance","filter","mode","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){function t(){y&&(k.unsubscribeToSection(y,"Activity"),y=null)}function u(){if(m.path().match(/activity$/gi)){if(m.search().hashtag){var b=angular.copy(a.defaultFilter);b.filterHashtagsList.push(m.search().hashtag),angular.equals(b,a.activeFilter)||(a.activeFilter=b,m.search("hashtag",null))}m.search().note&&a.activeFilter.noteId!==+m.search().note?a.activeFilter.noteId=+m.search().note||null:a.activeFilter.noteId=null}}function v(){return{body:"",projectID:f.projectID,uploads:[],message:"",smsPersonId:0}}function w(){if(!a.noteBeingParsed&&!a.pauseNoteParser){a.noteBeingParsed=!0;var c="/api/projects/{0}/notes/parse".format(f.projectID);return b.post(c,[],a.newNote).then(function(b){a.newNote.message=g.trustAsHtml(b.noteMessage)})["finally"](function(){a.noteBeingParsed=!1})}}function x(){a.project&&a.project.currentUserAccessLevel>1&&a.project.smsNumber?(a.isLoadingPeopleForSms=!0,d.getPeopleForSms(f.projectID).then(function(b){a.peopleForSmsUnavailable=!(a.project.smsNumber&&b.length),a.peopleForSms=b,a.isLoadingPeopleForSms=!1},function(){a.isLoadingPeopleForSms=!1})):(a.peopleForSmsUnavailable=!0,a.peopleForSms=[])}var y=null;a.$on("$destroy",t),a.peopleForSmsUnavailable=!0,a.peopleForSms=[],a.noteList=[],a.pinnedList=[],a.unpinnedList=[],a.noteCount=0,a.isLoading=!0,a.noteListEmpty=!1,a.flashPrevent=!1,a.defaultFilter=d.defaultFilter(),a.activeFilter=d.defaultFilter(),a.noteBeingParsed=!1,a.pauseNoteParser=!1,a.noteUiSettings={bottomMenuExpanded:q.getNoteBottomMenuState()},a.$on(q.onUiSettingsChanged,function(){a.noteUiSettings.bottomMenuExpanded=q.getNoteBottomMenuState()}),a.$on(l.onStateChange,function(){a.project=l.project(),y!==f.projectID&&(t(),y=k.subscribeToSection(f.projectID,"Activity"))}),a.$on(p.onPersonChanged,function(b,c){a.project&&a.project.client&&a.project.client.id===c.id&&x()}),a.$watch("project.smsNumber",x),l.loadProject(),d.forceNextReload(),u(),a.$on("$locationChangeSuccess",function(){u()},!0),d.initMentionableUsers(),a.$on(d.onNoteListChanged,function(b,c){c&&0===c.listState.indexOf("project."+f.projectID)&&(a.noteList=d.noteList(),a.pinnedList=_(a.noteList).filter(function(a){return a.isPinnedToProject}),a.unpinnedList=_(a.noteList).filter(function(a){return!a.isPinnedToProject}),a.isLoading=d.isLoading(),a.noteListEmpty=d.noteListEmpty(),a.flashPrevent=d.isBetweenTimeout()),c.noteID&&i(function(){a.$broadcast("onNotePushed",{noteID:c.noteID,pushType:c.pushType})})}),a.onPersonCreated=function(b,c,d){if(b){var e={personID:b.id,role:null};s.add(a.project.id,e),x();var f=_(b.phones).find(function(a){return a&&"Fax"!==a.label});a.setSmsPerson(b,f)}},a.createSmsPerson=function(){var b={id:0,orgID:a.project.orgID,isSingleName:!1,fullname:"",pictureUrl:h.defaultPicture,addresses:[],phones:[],emails:[]};p.show(b,{readonly:!1,enforceMustHaveSms:!0},a.onPersonCreated)},a.$on(d.onNoteCountChanged,function(){a.noteCount=d.noteCount()}),a.$on(d.onNotePinnedToProject,function(b,c){a.activeFilter.filterUnpinnedOnly?d.removeNote(c):(c.isExpanded=!0,d.mergeNote(c),i(function(){m.hash("note-"+c.id),n(),m.hash("")}))}),a.$on(d.onNoteUnpinnedFromProject,function(b,c){a.activeFilter.filterPinnedOnly?d.removeNote(c):d.mergeNote(c)}),a.$on(d.onNotePinnedToFeed,function(a,b){b.isExpanded=!0,d.mergeNote(b)}),a.$on(d.onNoteUnpinnedFromFeed,function(a,b){b.isExpanded=b.wasExpanded,d.mergeNote(b)}),d.loadProject(a.activeFilter),a.busy=!1,a.noteListSubtitle=function(){return""},a.clearFilter=function(){a.activeFilter=d.defaultFilter(),m.search({})},a.$watch("activeFilter",function(){d.loadProject(a.activeFilter)},!0),a.getMoreNotes=function(){d.getMore()},a.newNote=v(),a.isShared=function(a){return!(!a||!a.length)&&a.some(function(a){return a.isShared})},a.canCreateNote=function(){return!a.isLoading&&(!a.createSaving&&(!_.any(a.newNote.uploads,function(a){return a.percent<100})&&(!!a.newNote.body.trim()||a.newNote.uploads.length>0)))},a.uploadDoc=function(b){a.optionsMenuStatus.isOpen=!1,b.length>0&&a.$apply(function(){var c={file:b[0],percent:0,id:-1,projectID:a.newNote.projectID};a.newNote.uploads.push(c);var d=j.find("#fileinput");angular.element(d).val(null)})},a.removeUpload=function(b){var c=a.newNote.uploads.indexOf(b);c>=0&&a.newNote.uploads.splice(c,1)},a.removeDoc=function(b){return r.removeDoc(b.id).then(function(){a.newNote.docs=_(a.newNote.docs).reject(function(a){return a.id===b.id})})},a.parseNewNote=_.debounce(w,750),a.$watch("newNote.body",function(b,c){b||(a.newNote=v()),!a.pauseNoteParser&&b&&b!==c&&a.parseNewNote()}),a.noteLength=function(a){return a=_.str.stripTags(a),a=a.replace("&nbsp;",""),a=a.replace(/\s+/," "),a=_.str.trim(a),a.length},a.createNote=function(){var b=$("<pre />").html($("#new-note-input").html());b.find("div").replaceWith(function(){return"\n"+this.innerHTML}),b.find("p").replaceWith(function(){return this.innerHTML+"<br><br>"}),b.find("br").replaceWith("\n"),a.pauseNoteParser=!0,a.newNote.body=b.text(),a.canCreateNote()&&(a.createSaving=!0,d.create(f.projectID,a.newNote).then(function(b){d.mergeNote(b,"project"),a.newNote=v()},function(){})["finally"](function(){$("#new-note-input").text("").trigger("blur"),a.pauseNoteParser=!1,a.createSaving=!1,a.showMobileNoteInputControls=!1}))},a.setSmsPerson=function(b,c){b.phones.length?(a.newNote.smsPhoneNumber!==c.number?(a.newNote.smsPersonId=b.id,a.newNote.smsPhoneNumber=c.number):(a.newNote.smsPersonId=0,a.newNote.smsPhoneNumber=null,a.newNote.message=""),a.parseNewNote()):console.log(b.fullname+" does not have a valid phone number")},a.$on("add-project-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){f.projectID===c.projectID.toString()&&d.mergeNote(c,"project",!0)})}),a.$on("update-project-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){f.projectID===c.projectID.toString()&&d.mergeNote(c,"project",!0)})}),a.$on(d.isPrintingVine,function(){i(function(){o.print(),a.$broadcast("onPrintFinished")})})}angular.module("Crops").controller("ProjectActivityController",a),a.$inject=["$scope","fvApi","$rootScope","noteService","$state","$stateParams","$sce","config","$timeout","$document","pushService","projectService","$location","$anchorScroll","$window","personPanelService","uiSettingsService","docService","contactService"]}(),function(){function a(a,b,c,d,e,f){return{restrict:"E",scope:{},replace:!0,templateUrl:"{0}/notes/reaction.details.popup.template.html".format(a.viewRoot),link:function(a,b){}}}angular.module("Crops").directive("reactionDetails",a),a.$inject=["config","noteService","$timeout","userCardService","currentUserService","$rootScope"]}(),function(){function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{reactions:"=",isActive:"=",parentId:"=",parentType:"="},replace:!0,templateUrl:"{0}/notes/reaction.menu.html".format(a.viewRoot),link:function(a,c){a.noteReactionOptions=b.noteReactionOptions(),a.settings={isAddingReaction:!1,isPopoverOpen:!1},a.$watch("settings.isPopoverOpen",function(){a.settings.isPopoverOpen&&f.$broadcast("reactionMenu.onPopoverOpened",{parentType:a.parentType,parentId:a.parentId})}),a.$on("reactionMenu.onPopoverOpened",function(b,c){c.parentType.toLowerCase()===a.parentType.toLowerCase()&&c.parentId===a.parentId||(a.settings.isPopoverOpen=!1),a.settings.isAddingReaction=!1}),a.reactionMenuFilter=function(b){return!a.isActive[b.reactionType]},a.canAddReaction=function(){return!a.settings.isAddingReaction&&a.parentType&&a.parentId&&a.reactions},a.addReaction=function(c){if(a.canAddReaction()&&c&&!a.isActive[c]){a.settings.isAddingReaction=!0;var d=_(a.noteReactionOptions).findWhere({reactionType:c}),e=_.indexOf(a.reactions,_(a.reactions).findWhere({reactionType:c})),f={reactionType:c,parentType:a.parentType,parentID:a.parentId};b.addReaction(f).then(function(b){e>-1?a.reactions[e].reactingUsers=b.reactingUsers:a.reactions.push({reactionType:b.reactionType,reactingUsers:b.reactingUsers}),d&&(a.isActive[d.reactionType]=!0)})["finally"](function(){a.settings.isPopoverOpen=!1})}}}}}angular.module("Crops").directive("reactionMenu",a),a.$inject=["config","noteService","$timeout","userCardService","currentUserService","$rootScope","$document"]}(),function(){function a(a,b,c,d,e,f){return{restrict:"E",scope:{},replace:!0,templateUrl:"{0}/notes/reaction.menu.popup.template.html".format(a.viewRoot),link:function(a,b){}}}angular.module("Crops").directive("reactionsMenu",a),a.$inject=["config","noteService","$timeout","userCardService","currentUserService","$rootScope"]}(),function(){function a(a,b,c,d,e,f){return{restrict:"E",scope:{reactions:"=",isActive:"=",parentId:"=",parentType:"="},replace:!0,templateUrl:"{0}/notes/reactions.html".format(a.viewRoot),link:function(a,c){a.settings={isAddingOrRemovingReaction:!1},a.noteReactionOptions=b.noteReactionOptions(),a.canAddReaction=function(){return!a.settings.isAddingOrRemovingReaction&&a.parentType&&a.parentId&&a.reactions},a.addReaction=function(c){if(a.canAddReaction()&&c&&!a.isActive[c]){a.settings.isAddingOrRemovingReaction=!0;var d=_(a.noteReactionOptions).findWhere({reactionType:c}),e=_.indexOf(a.reactions,_(a.reactions).findWhere({reactionType:c})),f={reactionType:c,parentType:a.parentType,parentID:a.parentId};b.addReaction(f).then(function(b){b&&(e>-1?a.reactions[e].reactingUsers=b.reactingUsers:a.reactions.push({reactionType:b.reactionType,reactingUsers:b.reactingUsers}),d&&(a.isActive[d.reactionType]=!0))})["finally"](function(){a.settings.isAddingOrRemovingReaction=!1})}},a.canRemoveReaction=function(){return!a.settings.isAddingOrRemovingReaction&&a.parentType&&a.parentId&&a.reactions},a.removeReaction=function(c){if(a.canRemoveReaction()&&c&&a.isActive[c]){a.settings.isAddingOrRemovingReaction=!0;var d=_(a.noteReactionOptions).findWhere({reactionType:c}),e=_.indexOf(a.reactions,_(a.reactions).findWhere({reactionType:c})),f={reactionType:c,parentType:a.parentType,parentID:a.parentId};b.removeReaction(f).then(function(b){b&&(e>-1&&(b.reactingUsers&&b.reactingUsers.length?a.reactions[e].reactingUsers=b.reactingUsers:a.reactions.splice(e,1)),d&&(a.isActive[d.reactionType]=!1))})["finally"](function(){a.settings.isAddingOrRemovingReaction=!1})}},a.toggleReaction=function(b){var c=_(a.noteReactionOptions).findWhere({reactionType:b.reactionType});c&&(a.isActive[c.reactionType]?a.removeReaction(b.reactionType):a.addReaction(b.reactionType))},a.reactingUsersToFullnameList=function(a){if(!a||!a.length||"undefined"==typeof a[0].fullname)return"";var b=_.chain(a).sortBy(function(a){return a.id===e.currentUser().id?"aaaaa":a.fullname.toLowerCase()}).map(function(a){return a.id===e.currentUser().id?"You":a.fullname}).value();return b.length?(b.length>10&&(b.splice(10),b.push("more")),1===b.length?b[0]:[b.slice(0,-1).join(", "),b.slice(-1)[0]].join(b.length>2?", and ":" and ")):""},a.getReactionClass=function(b){var c=_(a.noteReactionOptions).findWhere({reactionType:b});return c?c.iconClass:""}}}}angular.module("Crops").directive("reactions",a),a.$inject=["config","noteService","$timeout","userCardService","currentUserService","$rootScope"]}(),function(){"use strict";function a(a,b,c){return{restrict:"EA",scope:{person:"=",isEmailInteractive:"=?",personBlockMin:"=?",showFaxNumberFirst:"=?",useVineStyle:"=?"},templateUrl:"{0}/person/person.block.html".format(a.viewRoot),link:function(a,d,e){function f(){if(!a.person||!a.person.phones||!a.person.phones.length)return a.firstAvailablePhone=null,void(a.firstAvailablePhoneIsFax=!1);var b=_(a.person.phones).find(function(a){return a&&a.number});if(!b)return a.firstAvailablePhone=null,void(a.firstAvailablePhoneIsFax=!1);if(a.showFaxNumberFirst){var c=_(a.person.phones).find(function(a){return a&&"Fax"===a.label&&a.number});a.firstAvailablePhone=c?c:b}else{var d=_(a.person.phones).find(function(a){return a&&"Fax"!==a.label&&a.number});a.firstAvailablePhone=d?d:b}a.firstAvailablePhoneIsFax=a.firstAvailablePhone&&a.firstAvailablePhone.label&&"Fax"===a.firstAvailablePhone.label}$(d).addClass("person-block"+(a.personBlockSm?" person-block-sm":"")+(a.useVineStyle?" vine-person":"")),f(),a.labelAbbr=function(a){if(a&&"Other"!==a){if("Home"===a)return"h:";if("Personal Mobile"===a)return"m:";if("Work"===a||"Work Mobile"===a)return"w:";if("Fax"===a)return"f:"}return""},a.$on(b.onPersonChanged,function(b,d){c(function(){d.id===a.person.id&&(a.person=angular.copy(d),f())})})}}}angular.module("Crops").directive("personBlock",a),a.$inject=["config","personPanelService","$timeout"]}(),function(){"use strict";function a(a){return{restrict:"E",scope:{contact:"=",isAddress:"=",isPhone:"=",isEmail:"="},replace:!0,templateUrl:"{0}/person/person.contact.label.html".format(a.viewRoot),link:function(a){a.contactType=a.isAddress?"Address":a.isPhone?"Phone":a.isEmail?"Email":"",a.contactLabels={Address:["Home","Work","Other","None"],Phone:["Home","Personal Mobile","Fax","Work","Work Mobile","Other","None"],Email:["Personal","Work","Other","None"]},a.addLabel=function(b){"None"===b&&(b=""),a.contact.label=b,a.$emit("onLabelChanged")}}}}angular.module("Crops").directive("contactLabel",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){return{restrict:"E",scope:{},templateUrl:"{0}/person/person.panel.view.html".format(c.viewRoot),link:function(a,c,e,f){function i(){a.isLoadingRelatedProjects=!0,b.getRelatedProjects(a.person.id,a.relatedProjectsList.length).then(function(b){a.relatedProjectsList=a.relatedProjectsList.concat(b),a.hasMoreProjects=25===b.length,a.isLoadingRelatedProjects=!1,a.isInitialRelatedProjectsLoad&&(a.isInitialRelatedProjectsLoad=!1),console.log(a.relatedProjectsList)})}function j(){if(a.person&&a.person.emails)for(var b=0;b<a.person.emails.length;b++)a.validateEmail(a.person.emails[b].address,b)}function k(b,c){a.person=b,n();for(var d in a.personRef)a.personRef.hasOwnProperty(d)&&delete a.personRef[d];if(angular.copy(b,a.personRef),t(a.personRef),a.editing=!1,a.saving=!1,r=!1,c.$setPristine(),a.settings.contactInfoPosChanged=!1,a.settings.isArrangingContactInfo=!1,a.$broadcast("resetFvImageUpload","person-avatar-upload"),s)return void a.cancelModal()}function l(b){a.error=b,a.saving=!1}function m(b){a.person.emails=_(b.emails).reject(function(a){return!a.address}),a.person.addresses=_(b.addresses).reject(function(a){return!(a.line1||a.line2||a.city||a.state||a.zip)}),a.person.phones=_(b.phones).reject(function(a){return!a.number})}function n(){if(a.person.birthDate){var b=moment.utc(a.person.birthDate);b.isValid()?a.person.dob={month:b.format("MM"),date:b.format("DD"),year:b.format("YYYY")}:a.person.dob={month:"",date:"",year:""}}else a.person.dob={month:"",date:"",year:""};a.person.emails=a.person.emails||[],a.person.phones=a.person.phones||[],a.person.addresses=a.person.addresses||[],m(a.person)}function o(){r=!1,s=!1,a.editing=!1,a.personRef=null,a.person=null,a.saving=!1,a.settings={contactInfoPosChanged:!1,isArrangingContactInfo:!1},a.options={isClient:!1,readonly:!1,isMerge:!1},a.isLoadingRelatedProjects=!1,a.relatedProjectsList=[],t=function(){},u=null,a.isVisibleSsnErrorMessage=!1,a.isVisibleEmailErrorMessage={}}function p(){a.person=angular.copy(a.personRef),a.person&&!a.person.firstName&&a.person.lastName&&(a.person.firstName=a.person.lastName,a.person.lastName=null),a.$broadcast("resetFvImageUpload","person-avatar-upload"),n(),a.validateSSN(),j()}function q(){a.personRef&&(a.personRef.phones&&!angular.equals(a.personRef.phones,a.person.phones)||a.personRef.addresses&&!angular.equals(a.personRef.addresses,a.person.addresses)||a.personRef.emails&&!angular.equals(a.personRef.emails,a.person.emails))?a.settings.contactInfoPosChanged=!0:a.settings.contactInfoPosChanged=!1}var r,s,t,u,v=null;a.isVisibleEmailErrorMessage={},a.isActiveTab={},a.projectID=function(){return h.projectID||null},a.$on(b.showDialogBroadcast,function(b,c){a.personRef=c.person||{},p(),a.person.id?a.editing=!1:(s=!0,a.beginEdit(),r=!0);var d=c.options||{};a.options.readonly=d.readonly||!1,a.options.isMerge=d.isMerge||!1,a.options.enforceMustHaveFax=d.enforceMustHaveFax||!1,a.options.enforceMustHaveSms=d.enforceMustHaveSms||!1,a.showEnforceMessage=a.options.enforceMustHaveFax||a.options.enforceMustHaveSms,t=angular.isFunction(c.onPersonUpdated)?c.onPersonUpdated:function(){},v.modal("show")}),a.$on("onBreadcrumbClicked",function(){a.cancelModal()}),a.$on(b.hideDialogBroadcast,function(){a.cancelModal()}),a.loadRelatedProjects=function(){a.person&&a.person.id&&!a.relatedProjectsList.length&&i()},a.isInitialRelatedProjectsLoad=!0,a.getMoreProjects=function(){a.hasMoreProjects&&i()},a.personPictureSaveUrl=function(){return"/api/people/uploadimage"},a.beginEdit=function(b){a.editing=!0,u=b,a.person.addresses.length||a.person.addresses.push({label:"",line1:"",line2:"",city:"",state:"",zip:""}),a.person.phones.length||a.person.phones.push({label:"",number:""}),a.person.emails.length||a.person.emails.push({label:"",address:""})},a.pattern={email:new RegExp(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/i),ssn:new RegExp(/(^[\dX]{3}-[\dX]{2}-[\dX]{4}$)|(^[\dX]{9}$)|(^[1-9]\d?-\d{7}$)|([\dX]{3}-[\dX]{3}-[\dX]{3})/i)},a.validateSSN=function(){a.pattern.ssn.test(a.person.ssn)||(a.isVisibleSsnErrorMessage=!0)},a.resetSsnError=function(){a.isVisibleSsnErrorMessage=!1},a.validateEmail=function(b,c){b&&""!==b&&!a.pattern.email.test(b)?a.isVisibleEmailErrorMessage[c]=!0:a.isVisibleEmailErrorMessage[c]=!1},a.resetEmailError=function(b){a.isVisibleEmailErrorMessage[b]=!1},a.canAddPhone=function(){if(!a.person.phones.length)return!0;var b=a.person.phones[a.person.phones.length-1];return b.number&&""!==b.number.trim()},a.canAddAddress=function(){if(!a.person.addresses.length)return!0;var b=a.person.addresses[a.person.addresses.length-1];return b.line1&&""!==b.line1.trim()||b.line2&&""!==b.line2.trim()||b.city&&""!==b.city.trim()||b.state&&""!==b.state.trim()||b.zip&&""!==b.zip.trim()},a.canAddEmail=function(){if(!a.person.emails.length)return!0;var b=a.person.emails[a.person.emails.length-1];return b.address&&""!==b.address.trim()},a.addPhone=function(){a.canAddPhone()&&a.person.phones.push({label:"",number:""})},a.addAddress=function(){a.canAddAddress()&&a.person.addresses.push({label:"",line1:"",line2:"",city:"",state:"",zip:""})},a.addEmail=function(){a.canAddEmail()&&a.person.emails.push({label:"",address:""})},a.rmPhone=function(b){r=!0,a.person.phones.splice(b,1),a.person.phones.length||a.person.phones.push({label:"",number:""})},a.rmAddress=function(b){r=!0,a.person.addresses.splice(b,1),a.person.addresses.length||a.person.addresses.push({label:"",line1:"",line2:"",city:"",state:"",zip:""})},a.rmEmail=function(b){r=!0,a.person.emails.splice(b,1),a.person.emails.length||a.person.emails.push({label:"",address:""})},a.$watch("person.isPictureChanged",function(a,b){a&&(r=!0)}),a.$watch("person.isPersonTypeChanged",function(a,b){a&&(r=!0)}),a.$on("onLabelChanged",function(){r=!0}),a.canSave=function(b){return!a.saving&&b&&(r||!b.$pristine||a.person.isPersonTypeChanged||a.settings.contactInfoPosChanged)&&!b.$invalid&&!a.options.readonly&&a.person.firstName&&""!==a.person.firstName.trim()&&a.hasValidSms()&&a.hasValidFax()},a.hasDob=function(){return a.person.dob.month&&a.person.dob.date&&a.person.dob.year},a.dobIsValid=function(){return!a.hasDob()||moment([a.person.dob.year,a.person.dob.month-1,a.person.dob.date]).isValid()},a.selectSingleName=function(){a.person.isSingleName||(a.person.firstName=((a.person.salutation||"")+" "+(a.person.firstName||"")+(a.person.middleName?" "+a.person.middleName:"")+" "+(a.person.lastName||"")).trim(),a.person.salutation="",a.person.lastName="",a.person.middleName="",a.person.fromCompany=null,r=!0),a.person.isSingleName=!0},a.unselectSingleName=function(){if(a.person.firstName&&a.person.isSingleName){var b=g.splitName(a.person.firstName);a.person.firstName=b.firstName,a.person.middleName=b.middleName,a.person.lastName=b.suffix?b.lastName+" "+b.suffix:b.lastName,a.person.salutation=b.salutation||"",a.person.fromCompany=a.personRef.fromCompany,r=!0}a.person.isSingleName=!1},a.savePerson=function(c){if(a.canSave(c)){a.saving=!0,a.hasDob()&&(a.person.birthDate=moment.utc([a.person.dob.year,a.person.dob.month-1,a.person.dob.date]).toDate());var d=angular.copy(a.person);m(d),b.createOrUpdatePerson(d,k,l,c)}},a.saveMerge=function(b){if(a.canSave(b)){a.hasDob()&&(a.person.birthDate=moment.utc([a.person.dob.year,a.person.dob.month-1,a.person.dob.date]).toDate());var c=angular.copy(a.person);m(c),t(c)}},a.$on(b.personSaveHokeyPressed,function(b,c,d){a.editing&&u&&a.canSave(u)&&a.savePerson(u)}),a.cancelModal=function(){v.modal("hide"),b.dialogIsHidden(),o()},a.cancelEditing=function(){return a.person.id?(a.editing=!1,r=!1,u.$setPristine(),void p()):void a.cancelModal()},a.genderList=[{name:"Unknown",value:"U"},{name:"Male",value:"M"},{name:"Female",value:"F"}],a.getGenderStatusText=function(b){b&&(b=b.toUpperCase());var c=a.genderList.find(function(a){return a.value===b});return c?c.name:"Unknown"+(b?" ("+b+")":"")},a.maritalStatusList=[{name:"Unknown",value:"U"},{name:"Married",value:"M"},{name:"Single",value:"S"},{name:"Divorced",value:"D"},{name:"Widowed",value:"W"}],a.getMaritalStatusText=function(b){b&&(b=b.toUpperCase());var c=a.maritalStatusList.find(function(a){return a.value===b});return c?c.name:"Unknown"+(b?" ("+b+")":"")},a.calcAge=function(a){return moment().diff(moment(a.year+"-"+a.month+"-"+a.date+"T00:00:00"),"years")},d.ready(function(){v=c.find("#personModal")}),o(),a.contactInfoDndOptions={axis:"y",handle:".dnd-handle",disabled:!0,stop:function(a){q()}},a.toggleArrangeContactInfo=function(b){b.stopPropagation(),a.settings.isArrangingContactInfo?(a.settings.isArrangingContactInfo=!1,a.contactInfoDndOptions.disabled=!0):(a.settings.isArrangingContactInfo=!0,a.contactInfoDndOptions.disabled=!1)},a.enforceMessage=function(){return a.options.enforceMustHaveFax?"This person must have a Fax number":"This Person must have an sms number"},a.hasValidSms=function(){if(a.options.enforceMustHaveSms){if(1===a.person.phones.length&&a.person.phones[0].number){var b=_(a.person.phones).some(function(a){return a&&"Fax"!==a.label});return!!b}return!1}return!0},a.hasValidFax=function(){if(a.options.enforceMustHaveFax){if(1===a.person.phones.length&&a.person.phones[0].number){var b=_(a.person.phones).some(function(a){return a&&"Fax"===a.label});return!!b}return!1}return!0}}}}angular.module("Crops").directive("personPanel",a),a.$inject=["$rootScope","personPanelService","config","$document","$timeout","$location","nameService","$stateParams"]}(),function(){"use strict";function a(a,b,c,d){function e(a,c,d){c=c||{readonly:!1};var e={person:a,options:{readonly:c.readonly||!1,isMerge:c.isMerge||!1,enforceMustHaveFax:c.enforceMustHaveFax||!1,enforceMustHaveSms:c.enforceMustHaveSms||!1},onPersonUpdated:d};l(),b.$broadcast(o,e)}function f(){m(),b.$broadcast(p)}function g(){b.$broadcast(q)}function h(d,e,f,g){var h=angular.isFunction(e)?e:function(){},i=angular.isFunction(f)?f:function(){};d.id?a.post(r.updatePerson,[c.projectID,d.id],d).then(function(a){h(a,g),b.$broadcast(t,a)},function(a){i("Could not save person. Please refresh and try again")}):(c.projectID?a.post(r.createPerson,[c.projectID],d):a.post(r.createPersonFromOrg,[d.orgID],d)).then(function(a){h(a,g)},function(a){i("Could not save person. Please refresh and try again")})}function i(b,c){return a.get(r.getRelatedProjects,[b,c])}function j(){return a.get(r.getPersonTypeFilterList)}function k(){return s}function l(){n=d.get("ctrl+s"),d.del("ctrl+s"),d.bindTo(b).add({combo:"ctrl+s",description:"save button",allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(a,c){a.preventDefault(),b.$broadcast(u.personSaveHokeyPressed,c,a)}})}function m(){d.del("ctrl+s"),n&&d.bindTo(b).add(n)}var n,o="personPanelServiceShowDialogBroadcast",p="personPanelServiceHideDialogBroadcast",q="personPanelService.onDialogIsHidden",r={createPerson:"/api/projects/{0}/person/create",createPersonFromOrg:"/api/org/{0}/person/create",updatePerson:"/api/projects/{0}/person/{1}/update",getRelatedProjects:"api/person/{0}/projects/{1}",getPersonTypeFilterList:"api/people/listFilters"},s=["Adjuster","Attorney","Client","Court","Defendant","Plaintiff","Expert","Firm","Insurance Company","Involved Party","Judge","Medical Provider"],t="personPanelService.onPersonChanged",u={show:e,hide:f,createOrUpdatePerson:h,showDialogBroadcast:o,hideDialogBroadcast:p,dialogIsHidden:g,onDialogIsHidden:q,getRelatedProjects:i,getPersonTypeFilterList:j,personTypes:k,personSaveHokeyPressed:"personSaveHokeyPressed",onPersonChanged:t};return u}angular.module("Crops").service("personPanelService",a),a.$inject=["fvApi","$rootScope","$stateParams","hotkeys"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){var i=0;return{restrict:"EA",replace:!0,scope:{onSelect:"&",person:"=",placeholder:"@",orgid:"=?",disabled:"=?",readonlyForExisting:"=?",isReadonly:"=?",newPersonParams:"=?",personFilter:"@?",personFilterHuman:"@?",formControlName:"@?",peopleToExclude:"=?",showFaxNumberFirst:"=?",personBlockEmailLinks:"=?"},templateUrl:"{0}/person/person.selector.html".format(b.viewRoot),link:function(e,j,k){function l(a){var c=a&&a.fullname&&""!==a.fullname.trim()?a.fullname:"",d={id:0,orgID:e.orgid,isSingleName:2===+e.personFilter,fullname:c,pictureUrl:b.defaultPicture,addresses:[],phones:[],emails:[]};if(+e.personFilter>100&&+e.personFilter<200&&(d["isType"+e.personFilterHuman.replace(" ","")]=!0),""!==c)if(d.isSingleName)d.firstName=c;else{var f=h.splitName(c);d.salutation=f.salutation||"",d.firstName=f.firstName,d.middleName=f.middleName,d.lastName=f.suffix?f.lastName+" "+f.suffix:f.lastName}return e.newPersonParams&&_(e.newPersonParams).each(function(a,b){d[b]=a}),d}function m(a){if(a.id>0){!e.person||e.person&&!e.person.id;e.person=a,e.onSelect({person:a})}}function n(a){return e.orgid?"/api/org/{0}/person/suggest?q={1}&type={2}".format(e.orgid,encodeURIComponent(a),e.settings.limitToTypeFilter?+e.personFilter:0):"/api/projects/{0}/person/suggest?q={1}&type={2}".format(g.projectID,encodeURIComponent(a),e.settings.limitToTypeFilter?+e.personFilter:0)}function o(){return p||(p=angular.element("#"+e.personInputID).controller("ngModel")),p}e.personSelectorID=i,e.personInputID=e.formControlName?e.formControlName:"personInput"+i,e.personResultsID="person-results-"+i,i++,e.personBlockEmailLinks=e.personBlockEmailLinks||!1,e.personFilter=+e.personFilter||0,e.settings={limitToTypeFilter:+e.personFilter>0},e.placeholder=e.placeholder||"Type to search",e.$watch("person",function(){e.person?!e.person.fullname||e.person.fullname&&(""===e.person.fullname||""===e.person.fullname.trim())?(e.person=null,e.personSelectorForm[e.personInputID].$setValidity("person",!0)):e.person.id&&0!==e.person.id?e.personSelectorForm[e.personInputID].$setValidity("person",!0):e.personSelectorForm[e.personInputID].$setValidity("person",!1):e.personSelectorForm[e.personInputID].$setValidity("person",!0)},!0),e.removePerson=function(){e.disabled||(e.person=null,e.onSelect({person:null}))},e.onPersonSelected=function(a,b,c){e.disabled||(a&&e.onSelect({person:a}),e.person=a)},e.showPersonDetails=function(){if(!e.disabled){var a=e.person;e.person&&e.person.id&&0!==e.person.id||(a=l(e.person)),f.show(a,{readonly:a.id&&e.readonlyForExisting||e.isReadonly,enforceMustHaveFax:e.enforceMustHaveFax||null},m)}},e.peopleList=function(b){return e.disabled?[]:(d.personSearchTerm=b,d.activePersonSelector=e.personSelectorID,a.get(n(b)).then(function(a){if(e.peopleToExclude&&e.peopleToExclude.length){var b=_(e.peopleToExclude).map(function(a){return a.id});return _(a).reject(function(a){return b.indexOf(a.id)>-1})}return a}))},e.$watch("settings.limitToTypeFilter",function(){if(e.person&&e.person.fullname&&!e.person.id){var a=o();if(a){var b=e.person.fullname;a.$setViewValue(""),a.$setViewValue(b)}}}),e.$on("onPersonSelectorInputNeedsFocus-"+e.personInputID,function(){c(function(){e.$broadcast("personSelector.onInputNeedsFocus")})});var p;e.resetInput=function(){e.disabled||(e.person=null,e.settings.limitToTypeFilter=+e.personFilter>0)}}}}angular.module("Crops").directive("personSelector",a),a.$inject=["fvApi","config","$timeout","$rootScope","$location","personPanelService","$stateParams","nameService"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{person:"=",isReadonly:"="},replace:!0,templateUrl:"{0}/person/person.type.selector.html".format(a.viewRoot),link:function(a){function c(){var b=[];_(a.personTypeList).each(function(c){var e=d(c);a.person[e]&&b.push(c)}),a.currentPersonTypes=b.length?b.join(", "):""}function d(a){return"isType"+a.replace(" ","")}a.isPersonTypeTouched=!1,a.currentPersonTypes="",a.personTypeList=b.personTypes(),c(),a.isPersonType=function(b){var c=d(b);return a.person[c]},a.toggleType=function(b){var e=d(b);a.person[e]=!a.person[e],a.person.isPersonTypeChanged=!0,c()}}}}angular.module("Crops").directive("personTypeSelector",a),a.$inject=["config","personPanelService"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{person:"="},replace:!0,templateUrl:"{0}/person/person.type.tags.html".format(a.viewRoot),link:function(a){function c(){a.currentPersonTypes=[],a.person&&_(a.personTypeList).each(function(b){var c=d(b);a.person[c]&&a.currentPersonTypes.push(b)})}function d(a){return"isType"+a.replace(" ","")}a.personTypeList=b.personTypes(),a.currentPersonTypes=[],a.$watch("person",c,!0),c()}}}angular.module("Crops").directive("personTypeTags",a),a.$inject=["config","personPanelService"]}(),function(){"use strict";function a(a,b){a.onProjectCreated=function(a){b.go("projectLayout.project.activity",{projectID:a.id})}}angular.module("Crops").controller("CreateProjectController",a),a.$inject=["$scope","$state"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){var b=e.project();a.currentOrgID=b?b.orgID:null}function i(b){
a.project=b,j()}function j(){d.close(a.project)}a.currentOrgID=null,a.projectTypeId=f||0,a.projectName=g||"",a.$on(e.onStateChange,h),a.onProjectCreated=i,a.close=j,e.loadProject()}angular.module("Crops").controller("createProjectModalController",a),a.$inject=["$scope","$stateParams","config","$uibModalInstance","projectService","projectTypeId","projectName"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",scope:{onCreated:"&",orgId:"=?",projectTypeId:"=?",projectName:"@?"},templateUrl:"{0}/projects/create/create.project.view.html".format(a.viewRoot),link:function(a){a.newProjectLoading=!1,a.orgList=[],a.isLoadingOrgList=!0,a.creatingProject=!1,a.personFilter=101,a.personFilterHuman="Client",a.disableOrg=!!a.orgId,a.disableProjectType=!!a.projectTypeId,a.selected={org:null,customProjectType:null,projectName:a.projectName||"",newPerson:{}},a.newPersonParams={isTypeClient:!0},a.$on(e.onOrgListChanged,function(){a.orgList=e.orgList(),a.orgList&&a.orgId?a.selected.org=_(a.orgList).find(function(b){return b.id===a.orgId}):a.orgList&&1===a.orgList.length&&(a.selected.org=a.orgList[0]),a.isLoadingOrgList=e.isLoading().isLoadingOrgList}),e.loadOrgs(!1,!0,!1),a.$watch("selected.org",function(b){b&&(a.selected.newPerson={},a.selected.customProjectType=a.projectTypeId?_(b.availableProjectTypes).findWhere({id:a.projectTypeId}):b.availableProjectTypes&&1===b.availableProjectTypes.length?b.availableProjectTypes[0]:null,a.newProjectForm.$setPristine())}),a.selectedPerson=function(b){a.selected.newPerson=b},a.createProject=function(){a.creatingProject||(a.creatingProject=!0,a.selected&&a.selected.org.id&&a.selected.newPerson&&a.selected.newPerson.id&&a.selected.customProjectType&&a.selected.customProjectType.id&&(a.newProjectLoading=!0,d.create(a.selected.org.id,a.selected.customProjectType.id,a.selected.newPerson.id,a.selected.projectName,!0).then(function(b){if(b){var c={id:b.id,title:b.projectOrClientName,pictureUrl:b.clientPictureUrl,details:b.details};a.onCreated({project:c})}},function(b){a.creatingProject=!1,a.newProjectLoading=!1,console.log(b),f.alertFail("Unable to create a new project at this time. Please try again later")})))}}}}angular.module("Crops").directive("createProjectView",a),a.$inject=["config","$rootScope","$state","projectService","orgService","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e){a.isLoading={projectPreview:!0,fullProject:!0,sectionView:!0},a.$on(d.onStateChange,function(){a.project=d.project(),a.notFound=d.notFound(),a.isLoading=d.isLoading(),a.sections=d.sections(),a.currentSection=d.currentSection()}),a.$on("$stateChangeStart",function(c,d){void 0!==typeof b.ignoreStateChangeStart&&angular.isFunction(b.ignoreStateChangeStart)&&b.ignoreStateChangeStart()||(a.isLoading.sectionView=!(d&&"projectLayout.project.calendar"===d.name))}),a.$on("$stateChangeSuccess",function(){a.isLoading.sectionView=!1}),d.loadProject(),a.projectType=1,a.newProjectLoading=!1,a.transitioning=!1,a.activeTab=c.current.name,a.selected=function(a){return b.activeDetail===a},a.redirectToCase=function(a,b){if(b)if(b.match(/\//)){var d=b.split("/");c.go("projectLayout.project."+d[0],{projectId:a.id,sectionName:d[1]})}else c.go("projectLayout.project."+b,{projectId:a.id});else c.go("projectLayout.project",{projectId:a.id})},e.toggleSidenav("close"),a.$on(e.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){e.toggleSidenav()}}angular.module("Crops").controller("ProjectController",a),a.$inject=["$scope","$rootScope","$state","projectService","sidenavService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){e&&(a.project=e),f&&(a.mode=f),a.showSms=a.project&&(a.project.currentUserAccessLevel>2||a.project.smsNumber&&""!==a.project.smsNumber),a.isAdmin=function(){return a.project&&3===a.project.currentUserAccessLevel},a.updatePhase_loading=!1,a.settings={newProjectEmail:"",isEditingProjectEmail:!1,isUpdatingProjectEmail:!1},a.form={},a.emailPrefixPattern=/^(?=.{6,})[A-Za-z0-9_-]+(?:\.[A-Za-z0-9_-]+)*$/,a.showSmsSetupModal=function(){if(a.isAdmin()){var b={name:a.project.projectName||a.project.client.fullname,type:"project",id:a.project.id,number:a.project.smsNumber};d.showSmsSetupModal(b)}},a.changePhase=function(b){a.project&&a.project.phase!==b&&(a.updatePhase_loading=!0,c.updatePhase(a.project.id,b.id).then(function(c){a.updatePhase_loading=!1,a.project.phase=b},function(){}))},a.beginEditingEmailAddress=function(){try{a.settings.newProjectEmail=a.project.emailAddress.slice(0,a.project.emailAddress.indexOf("@"))}finally{a.settings.isEditingProjectEmail=!0,h(function(){a.$broadcast("onEditingProjectEmail")})}},a.canUpdateProjectEmail=function(){return!a.settings.isUpdatingProjectEmail&&a.form&&a.form.projectEmailForm&&a.form.projectEmailForm.$valid&&a.settings.newProjectEmail!==a.project.emailAddress.slice(0,a.project.emailAddress.indexOf("@"))},a.updateProjectEmail=function(){a.canUpdateProjectEmail()&&(a.settings.isUpdatingProjectEmail=!0,c.saveProjectUniqueKey(a.project.id,a.settings.newProjectEmail).then(function(b){a.project.emailAddress=b,g.alertSuccess("This project's email address is now "+b),a.cancelEditingProjectEmail()},function(b){g.alertFail(b),a.form.projectEmailForm.projectEmail.$setValidity("updateException",!1)})["finally"](function(){a.settings.isUpdatingProjectEmail=!1}))},a.resetProjectEmailUpdateExceptionValidity=function(){a.form.projectEmailForm.projectEmail.$error.updateException&&a.form.projectEmailForm.projectEmail.$setValidity("updateException",!0)},a.cancelEditingProjectEmail=function(){a.form.projectEmailForm.$setPristine(),a.form.projectEmailForm.$setUntouched(),a.settings.isEditingProjectEmail=!1,a.settings.newProjectEmail=""},a.close=function(){b.dismiss("close"),a.calendarEvent=null},a.$on("$stateChangeSuccess",a.close)}angular.module("Crops").controller("projectDetailsModalController",a),a.$inject=["$scope","$uibModalInstance","projectService","smsService","project","mode","fvAlertsService","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(a){l()}function k(b){var c=angular.element("#projectNameForm"),d=c[0]!==b.target&&0===c.find(b.target).length;d&&a.$evalAsync(function(){a.cancelEditingProjectName()})}function l(){a.clientPhoneList=m(),a.clientPhone=o(),a.clientEmailList=n(),a.clientEmail=a.clientEmailList&&a.clientEmailList.length?a.clientEmailList[0]:void 0}function m(){if(a.project&&a.project.client)return a.project.client.phones}function n(){if(a.project&&a.project.client)return a.project.client.emails}function o(){if(a.clientPhoneList&&a.clientPhoneList.length){if(1===a.clientPhoneList.length&&a.clientPhoneList[0].number)return a.clientPhoneList[0];var b=_(a.clientPhoneList).find(function(a){return"Fax"!==a.label&&a.number});return b?b:a.clientPhoneList[0].number?a.clientPhoneList[0]:void 0}}a.fullView=!1,a.actions={isEditingProjectName:!1},a.$on("$stateChangeSuccess",function(){b.loadProject()}),a.$on(b.onStateChange,function(){a.project=b.project(),a.isLoading=b.isLoading(),a.project&&a.project.client&&(a.project.client.firstName||a.project.client.lastName)&&l(),a.showSms=a.project&&(a.project.currentUserAccessLevel>2||a.project.smsNumber&&""!==a.project.smsNumber),a.fullView=a.project&&a.project.currentUserAccessLevel>1}),a.$on(f.onPersonChanged,function(b,c){c.id===a.project.client.id&&(a.project.client=angular.copy(c),l())}),a.isAdmin=function(){return a.project&&3===a.project.currentUserAccessLevel},b.loadProject(),a.showClientDetail=function(){a.project&&a.project.client&&(a.project.client.firstName||a.project.client.lastName)&&f.show(a.project.client,{readonly:!a.fullView},j)},a.showSmsSetupModal=function(){if(a.isAdmin()){var b={name:a.project.projectName||a.project.client.fullname,type:"project",id:a.project.id,number:a.project.smsNumber};a.close(),c.showSmsSetupModal(b)}},a.$on(c.onDetailChanged,function(b,c,d){"success"===c&&(a.project.smsNumber=d)}),a.clientName=function(){return a.project&&a.project.client?a.project.client.fullname||"(Unknown)":""},a.labelAbbr=function(a){if(a&&"Other"!==a){if("Home"===a)return"h:";if("Personal Mobile"===a)return"m:";if("Work"===a||"Work Mobile"===a)return"w:";if("Fax"===a)return"f:"}return""},a.saveProjectName=function(){b.saveProjectName(a.project.id,a.project.newProjectName).then(function(b){a.project.projectName=b,a.cancelEditingProjectName()})},a.changeProjectName=function(){a.fullView&&!a.isLoading.fullProject&&(a.project&&a.project.projectName&&(a.project.newProjectName=angular.copy(a.project.projectName)),a.actions.isEditingProjectName=!0,g(function(){angular.element(document).bind("click",k),a.$broadcast("onEditingProjectName")}))},a.changePhase=function(c){a.project&&a.project.phase!==c&&(a.updatePhase_loading=!0,b.updatePhase(a.project.id,c.id).then(function(b){a.updatePhase_loading=!1,a.project.phase=c},function(){}))},a.cancelEditingProjectName=function(){a.actions.isEditingProjectName=!1,angular.element(document).unbind("click",k),a.project&&a.project.newProjectName&&delete a.project.newProjectName},a.$on("$destroy",function(){angular.element(document).unbind("click",k)}),a.openProjectDetailsModal=function(b,c){"vitals"===b&&c&&c.currentTarget.blur();h.open({animation:!0,templateUrl:"{0}/projects/project.details.modal.html".format(e.viewRoot),controller:"projectDetailsModalController",size:"phase"===b?"sm":"md",resolve:{project:function(){return a.project},mode:function(){return b},showSms:function(){return a.showSms}}})},a.hideClientDetailsOnPrint=function(){return i.includes("projectLayout.project.activity")}}angular.module("Crops").controller("ProjectPageHeaderController",a),a.$inject=["$scope","projectService","smsService","$rootScope","config","personPanelService","$timeout","$uibModal","$state"]}(),function(){"use strict";function a(a,b,c,d,e){var f=0;return{restrict:"E",scope:{onSelect:"&",project:"=?",placeholder:"@?",showSearchDeeper:"=?",limitToOrg:"=?",limitToProjectTypeId:"@?",limitToProjectTypeName:"@?",projectsToExclude:"=?",onlyCloneable:"@?",loadDetails:"=?",formControlName:"@?",formControlIgnoreDirty:"=?"},templateUrl:"{0}/projects/project.selector.html".format(b.viewRoot),link:function(b,g,h){function i(a){var c="/api/suggest?q={0}&archived={1}";return b.onlyCloneable?"/api/cloneableProjects?q={0}".format(encodeURIComponent(a)):b.limitToOrg?b.limitToProjectTypeId?(c+"&org={2}&projectTypeID={3}").format(encodeURIComponent(a),d.projectSearchIncludeArchived?"true":"false",b.limitToOrg,b.limitToProjectTypeId):(c+"&org={2}").format(encodeURIComponent(a),d.projectSearchIncludeArchived?"true":"false",b.limitToOrg):b.limitToProjectTypeId?(c+"&projectTypeID={2}").format(encodeURIComponent(a),d.projectSearchIncludeArchived?"true":"false",b.limitToProjectTypeId):c.format(encodeURIComponent(a),d.projectSearchIncludeArchived?"true":"false")}b.projectSelectorID=f,b.includeArchivedID="include-archived-"+f,b.searchInputID=b.formControlName?b.formControlName:"project-search-input-"+f,b.searchResultsID="project-search-results-"+f,f++,b.project=b.project||{title:""},b.includeArchivedProjects=!1,b.placeholder=b.placeholder||"search for a project",d.$watch("projectSearchIncludeArchived",function(){d.activeProjectSelector===b.projectSelectorID&&$("#"+b.searchInputID).click()}),d.$watch("projectSearchDeeper",function(a){a&&(b.searchDeeper(),d.projectSearchDeeper=!1)}),b.searchDeeper=function(){var a=d.projectSearchTerm?"?q="+encodeURIComponent(d.projectSearchTerm):"";a&&d.projectSearchIncludeArchived&&(a+="&archived"),e.url("/search"+a)},b.onProjectSelected=function(c,d,e){c&&(b.loadDetails?a.get("/api/glance/"+c.id).then(function(a){b.onSelect({project:a})}):b.onSelect({project:c})),b.project=void 0},b.search=function(c){return d.projectSearchTerm=c,d.activeProjectSelector=b.projectSelectorID,a.get(i(c)).then(function(a){if(b.projectsToExclude&&b.projectsToExclude.length){var c=_(b.projectsToExclude).pluck("id");return _(a).reject(function(a){return c.indexOf(a.id)>-1})}return a})};var j;b.showSearchMeta=function(){b.isSearchMetaOpen=!0,c.cancel(j)},b.hideSearchMeta=function(){j=c(function(){b.isSearchMetaOpen=!1},500)}}}}angular.module("Crops").directive("projectSelector",a),a.$inject=["fvApi","config","$timeout","$rootScope","$location"]}(),function(){"use strict";angular.module("Crops").directive("typeaheadFocus",function(){return{require:"ngModel",link:function(a,b,c,d){b.bind("click",function(){var a=d.$viewValue;" "===d.$viewValue&&d.$setViewValue(null),d.$setViewValue(" "),d.$setViewValue(a||" ")}),a.emptyOrMatch=function(a,b){return" "===b||a.indexOf(b)>-1}}}})}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){C=-1,B=null,D=[],E=null}function h(){return!C||c.projectID&&C===c.projectID||g(),B}function i(){return B&&B.currentUserAccessLevel>2}function j(){return B&&3===B.currentUserAccessLevel}function k(){return A}function l(){return D}function m(){return E}function n(a){E=a,b.$broadcast(G)}function o(){return!A.fullProject&&C===c.projectID&&!B}function p(){if(C!==c.projectID){g(),A.projectPreview=!0,A.fullProject=!0,C=c.projectID,f.resetVitalsList(),b.$broadcast(F);var d=!1;a.get(z.getProjectPreview,[c.projectID]).then(function(a){d||q(a,!1)})["finally"](function(){A.projectPreview=!1}),a.get(z.getProject,[c.projectID]).then(function(a){d=!0,q(a,!0)})["finally"](function(){A.fullProject=!1})}else b.$broadcast(F)}function q(a,c){B=a,D=B.sections;for(var f=0;f<D.length;f++)if(D[f].url===d.current.name){E=D[f];break}B.phase=_.findWhere(B.phases,{id:B.phaseID}),document.title="Filevine"+(B.projectName?" - "+B.projectName:B.client?" - "+B.client.fullname:""),c&&B.incidentDate&&(B.incidentDate=e.getDateOnlyMoment(B.incidentDate).format("MM/DD/YYYY")),!c&&B.sections&&_(B.sections).each(function(a){a.disabled=37===a.customSectionType||38===a.customSectionType}),b.$broadcast(F)}function r(b,c,d,e,f){f=f||!1;var g={CustomProjectTypeID:c,ClientID:d,ProjectName:e};return f?a.post(z.createProjectGlance,[b],g):a.post(z.createProject,[b],g)}function s(b,c){return a.post(z.saveProjectName,[b],{projectName:c})}function t(b,c){return a.post(z.saveProjectUniqueKey,[b],{projectUniqueKey:c})}function u(b){if(b.estmatedSettlementValue&&"number"!=typeof b.estimatedSettlementValue&&(b.estimatedSettlementValue=parseFloat(b.estimatedSettlementValue.replace(/,/g,""))),isNaN(b.estimatedSettlementValue))return deferred.reject("Unable to post incident - input not a number"),deferred.promise;var c={IncidentDate:b.incidentDate,EstimatedSettlementValue:b.estimatedSettlementValue,Description:b.description,ReferrerID:b.referrerID};return a.put(z.updateIncident,[b.id],c)}function v(c,d){a.put(z.relateProject,[c.id,d.id]).then(function(a){c.projectGroupID=a.id,c.relatedProjects=a.projects,b.$broadcast(F)})}function w(c,d){a.put(z.unrelateProject,[c.id,d.id]).then(function(a){c.projectGroupID=a.id,c.relatedProjects=a.projects,b.$broadcast(F)})}function x(b,c){return a.put(z.updateProjectPhase,[b,c])}function y(b,c){return a.post(z.personCreate,[b],{fullname:c})}var z={getProjectPreview:"/api/projects/{0}/preview",getProject:"/api/projects/{0}",createProject:"/api/projects/{0}/create",createProjectGlance:"/api/projects/{0}/create/glance",updateIncident:"/api/projects/{0}/updateIncident",saveProjectName:"/api/projects/{0}/saveprojectname",saveProjectUniqueKey:"/api/projects/{0}/replaceProjectEmailAddress",updateProjectPhase:"/api/projects/{0}/changephase/{1}",relateProject:"/api/projects/{0}/relate/{1}",unrelateProject:"/api/projects/{0}/unrelate/{1}",personCreate:"/api/projects/{0}/person/create"},A={projectPreview:!1,fullProject:!1},B=null,C=-1,D=[],E=null,F="projectServiceOnStateChange",G="projectService.onCurrentSectionChanged",H={loadProject:p,isLoading:k,project:h,notFound:o,sections:l,currentSection:m,setCurrentSection:n,create:r,updateIncident:u,saveProjectName:s,saveProjectUniqueKey:t,relate:v,unrelate:w,updatePhase:x,saveNewPerson:y,onStateChange:F,onCurrentSectionChanged:G,canDeleteItems:i,currentUserIsAdmin:j};return H}angular.module("Crops").service("projectService",a),a.$inject=["fvApi","$rootScope","$stateParams","$state","fvUtils","projectVitalsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){for(var b=a.currentSection,d=0;d<a.sections.length;d++)if(i(a.sections[d])&&(!b||a.sections[d].id!==b.id)){c.setCurrentSection(a.sections[d]);break}}function i(a){var b=j(a);return e.includes(b.state)&&(!b.params.sectionName&&!e.params.sectionName||b.params.sectionName===e.params.sectionName)}function j(a){var b=a.url,c={};if(a.url.match(/\//)){var d=a.url.split("/");b=d[0],c={sectionName:d[1]}}return{state:"projectLayout.project."+b,params:c}}function k(){return a.project&&a.project.client?a.project.client.pictureUrl:""}function l(){if(a.project){if(a.project.projectName)return a.project.projectName;if(a.project.client)return a.project.client.fullname||"(Unknown)"}return""}a.fullView=!1,a.isAdmin=!1,a.disableSelectCurrent=function(){return g.getIsEditingItem()},a.$on(c.onStateChange,function(){a.sections=c.sections(),a.isLoading=c.isLoading(),a.project=c.project(),a.clientPictureUrl=k(),a.projectName=l(),a.isAdmin=a.project&&3===a.project.currentUserAccessLevel,a.fullView=a.project&&a.project.currentUserAccessLevel>1,h()}),a.$on("$stateChangeSuccess",function(){h()}),a.$on(c.onCurrentSectionChanged,function(b,d){a.currentSection=c.currentSection()}),a.openIntraProjectSearch=function(){f.openIntraProjectSearch(a.projectName,a.clientPictureUrl),a.toggleSidenav("close")},a.isShared=function(a){return!(!a||!a.length)&&a.some(function(a){return a.isShared})},a.isSidenavOpen=!1,a.$on(d.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(a){d.toggleSidenav(a)},a.onSectionSelected=function(b){b.id===a.currentSection.id&&e.reload(),a.toggleSidenav("close")},c.loadProject()}angular.module("Crops").controller("ProjectSidenavController",a),a.$inject=["$scope","$rootScope","projectService","sidenavService","$state","searchService","customService"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{},templateUrl:"{0}/projects/project.vitals.html".format(b.viewRoot),link:function(b){b.vitalsList=a.vitalsList,b.isLoading=a.isLoading,b.jumpTo=function(a){if(a)if(a.match(/\//)){var b=a.split("/");c.go("projectLayout.project."+b[0],{sectionName:b[1]})}else c.go("projectLayout.project."+a);else c.go("projectLayout.project")}}}}angular.module("Crops").directive("projectVitals",a),a.$inject=["projectVitalsService","config","$state"]}(),function(){"use strict";function a(a){function b(b,c){a.projectID===b.toString()&&(d=c)}function c(){d=null}var d=null,e={vitalsList:function(){return d},isLoading:function(){return internalIsLoading},onVitalsUpdated:b,resetVitalsList:c};return e}angular.module("Crops").service("projectVitalsService",a),a.$inject=["$stateParams"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{org:"="},templateUrl:"{0}/pros/pro.approval.html".format(a.viewRoot),link:function(a){a.availableList=[],a.isLoading=!0,a.$on(b.onListChanged,function(){a.availableList=b.availableList(),a.isLoading=b.isLoading()}),a.$on(c.onCategoriesChanged,function(){a.categoryList=c.categoryList()}),c.loadCategoryList(),b.loadAvailableList(a.org.id),a.approvePro=function(c,d){b.approvePro(a.org.id,pro.id)},a.unapprovePro=function(c,d){b.unapprovePro(a.org.id,pro.id)},a.categoryHasPros=function(b){if(a.availableList&&b){for(var c=0;c<a.availableList.length;c++)if(a.availableList[c].category===b)return!0;return!1}}}}}angular.module("Crops").directive("proApproval",a),a.$inject=["config","proApprovalService","proAdminService"]}(),function(){"use strict";function a(a,b,c){function d(c){return m===c?void b.$broadcast(j):(m=c,l=!0,k=[],b.$broadcast(j),void a.get(i.getAvailablePros,[c]).then(function(a){k=a,l=!1,b.$broadcast(j)}))}function e(){return k}function f(){return l}function g(b,c){a.post(i.approvePro,[b,c])}function h(b,c){a.post(i.unapprovePro,[b,c])}var i={getAvailablePros:"/api/orgs/{0}/availablepros",approvePro:"/api/orgs/{0}/pros/{1}/approve",unapprovePro:"/api/orgs/{0}/pros/{1}/unapprove"},j="proApprovalService.onAvailableListChanged",k=[],l=!1,m=null,n={loadAvailableList:d,availableList:e,isLoading:f,approvePro:g,unapprovePro:h,onListChanged:j};return n}angular.module("Crops").service("proApprovalService",a),a.$inject=["fvApi","$rootScope","$stateParams"]}(),function(){"use strict";function a(a){return{restrict:"E",scope:{pro:"="},templateUrl:"{0}/pros/pro.html".format(a.viewRoot),link:function(a){}}}angular.module("Crops").directive("pro",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c){function d(d){return l===c.projectID&&m===d?void b.$broadcast(i):(l=c.projectID,m=d,j=[],k=!0,b.$broadcast(i),void a.get(h.getApprovedPros,[projectID,d]).then(function(a){j=a,k=!1,b.$broadcast(i)}))}function e(){return j}function f(){return k}function g(b){a.post(h.hirePro,[c.projectID,b]).then(function(a){})}var h={getApprovedPros:"/api/projects/{0}/approvedpros/{1}",hirePro:"/api/projects/{0}/pros/{1}/hire"},i="proService.onListChanged",j=[],k=!1,l=null,m=null,n={loadApprovedList:d,approvedList:e,isLoading:f,hirePro:g,onListChanged:i};return n}angular.module("Crops").service("proService",a),a.$inject=["fvApi","$rootScope","$stateParams"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{proCategoryID:"=",fieldPrompt:"="},templateUrl:"{0}/pros/project.pro.html".format(a.viewRoot),link:function(a){loadApprovedList(proCategoryID),a.$on(proService.onListChanged,function(){a.approvedList=proService.approvedList()})}}}angular.module("Crops").directive("projectPro",a),a.$inject=["config","projectProService"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",templateUrl:"{0}/push/push.notifications.html".format(b.viewRoot),link:function(b){var d="feed",e="feedLayout.feed",f="mailroom",g="mailroomLayout.mailroom",h="tasks",i="tasksLayout.tasks";b.taskList=function(){return a.notificationList(h)},b.mailroomList=function(){return a.notificationList(f)},b.feedList=function(){return a.notificationList(d)},b.showTaskNotifications=function(){return a.haveNotifications(h)},b.showMailroomNotifications=function(){return a.haveNotifications(f)},b.showFeedNotifications=function(){return a.haveNotifications(d)},b.feedNotificationTitle=function(){return a.haveNotifications(d)?"Feed updates have arrived":"Feed"},b.taskNotificationTitle=function(){return a.haveNotifications(h)?"Task updates have arrived":"Tasks"},b.mailroomNotificationTitle=function(){return a.haveNotifications(f)?"Mailroom updates have arrived":"Mailroom"},b.clearAllNotifications=function(){a.clearAllNotifications()},b.$on("add-task-vine",function(d,e){b.$applyAsync(function(){c.current.name!==i&&a.addNotification(h,e)})}),b.$on("update-task-vine",function(d,e){b.$applyAsync(function(){c.current.name!==i&&a.updateNotification(h,e)})}),b.$on("remove-task-vine",function(c,d){b.$applyAsync(function(){a.removeNotification(h,d)})}),b.$on("add-mailroom-vine",function(d,e){b.$applyAsync(function(){c.current.name!==g&&a.addNotification(f,e)})}),b.$on("update-mailroom-vine",function(d,e){b.$applyAsync(function(){c.current.name!==g&&a.updateNotification(f,e)})}),b.$on("remove-mailroom-vine",function(c,d){b.$applyAsync(function(){a.removeNotification(f,d)})}),b.$on("add-feed-vine",function(f,g){b.$applyAsync(function(){c.current.name!==e&&a.addNotification(d,g)})}),b.$on("update-feed-vine",function(f,g){b.$applyAsync(function(){c.current.name!==e&&a.updateNotification(d,g)})}),b.$on("$stateChangeSuccess",function(b,c){c.name===i&&a.clearNotifications(h),c.name!==g&&c.name!==g+".org"||a.clearNotifications(f),c.name===e&&a.clearNotifications(d)})}}}angular.module("Crops").directive("pushNotifications",a),a.$inject=["pushNotificationService","config","$state"]}(),function(){"use strict";function a(a){function b(b){a.notifications[b]||(a.notifications[b]=[])}function c(c){return b(c),a.notifications[c]}function d(c,d){b(c),a.notifications[c].push(d)}function e(c,d){b(c);for(var e=0;e<a.notifications[c].length;e++)a.notifications[c][e].id===d.id&&a.notifications[c].splice(e,1)}function f(a,b){e(a,b),d(a,b)}function g(b){a.notifications[b]=[]}function h(){a.notifications.task=[],a.notifications.mailroom=[],a.notifications.feed=[]}function i(c){return b(c),a.notifications[c].length>0}return a.notifications={},{notificationList:c,addNotification:d,updateNotification:f,removeNotification:e,clearNotifications:g,clearAllNotifications:h,haveNotifications:i}}angular.module("Crops").service("pushNotificationService",a),a.$inject=["$rootScope"]}(),function(){"use strict";function a(a,b,c){function d(){return Math.floor(5001*Math.random())}function e(){if(m){var a=$.Deferred();return a.resolve(),a}return $.connection.hub.disconnected(function(){m=!1,$.connection.hub.lastError&&console.log("Disconnected. Reason: "+$.connection.hub.lastError.message),setTimeout(function(){console.log("Attempting to reconnect to SignalR"),$.connection.hub.start().done(f).fail(g)},n),n+=2e3+d()}),$.connection.hub.start().done(f).fail(g)}function f(){console.log("Now connected, connection ID="+$.connection.hub.id),Crops.signalrSessionID=$.connection.hub.id,l.server.subscribeUser(),console.log("Subscribed User"),m=!0}function g(){console.warn("Could not Connect to SignalR!",n)}function h(a,b){return e().done(function(){console.log("Subscribing Section: "+a+","+b);try{l.server.subscribeSection(a,b)}catch(c){console.warn("caught and ignored exception while trying to subscribeToSection",c)}}),a}function i(a,b){e().done(function(){try{console.log("Unsubscribing Section: "+a+","+b),l.server.unsubscribeSection(a,b)}catch(c){console.warn("caught and ignored exception while trying to unsubscribeToSection",c)}})}function j(a){e().done(function(){console.log("Subscribing Note: "+a);try{l.server.subscribeNote(a)}catch(b){console.warn("caught and ignored exception while trying to subscribeToNote",b)}})}function k(a){e().done(function(){console.log("Unsubscribing Note: "+a);try{l.server.unsubscribeNote(a)}catch(b){console.warn("caught and ignored exception while trying to unsubscribeFromNote",b)}})}var l=$.connection.filevineHub,m=!1;l.client.newDocGenCompleted=function(b){if(console.log("RECEIVED newDocGenCompleted",b),Crops.signalrSessionID!==b.originSessionID)for(var c=0;c<b.messageTypes.length;c++)console.log("BROADCASTING DocGenComplete",b.messageTypes[c],b.docResponse),a.$broadcast(b.messageTypes[c],b)},l.client.newMailroomItemMessage=function(b){if(console.log(Crops.signalrSessionID),console.log(b.originSessionID),Crops.signalrSessionID!==b.originSessionID)if(b.messageTypes.indexOf("remove-mailroom-vine")>-1){var d={OrgID:b.orgID,id:b.itemID};console.log("BROADCASTING","remove-mailroom-vine",d),a.$broadcast("remove-mailroom-vine",d)}else{var e=["add-mailroom-vine","update-mailroom-vine"];c.getMailroomItemByNoteID(b.orgID,b.itemID).then(function(c){if(c)for(var d=0;d<b.messageTypes.length;d++){var f=b.messageTypes[d];e.indexOf(f)>-1&&(console.log("BROADCASTING",f,c),a.$broadcast(f,c))}})}},l.client.newVineMessage=function(c){console.log("RECEIEVED newVineMessage",c),Crops.signalrSessionID!==c.originSessionID&&c.noteID&&c.projectID&&b.getNoteWithFilter(c.noteID).then(function(b){b||(b={filterMismatch:!0,id:c.noteID});for(var d=0;d<c.messageTypes.length;d++){var e=c.messageTypes[d];console.log("BROADCASTING",e,b),a.$broadcast(e,b)}})},l.client.reactionMessage=function(b){if(console.log("RECEIVED reactionMessage",b),Crops.signalrSessionID!==b.originSessionID)for(var c=0;c<b.messageTypes.length;c++)console.log("BROADCASTING ReactionMessage",b.messageTypes[c],b),a.$broadcast(b.messageTypes[c],b)},l.client.deliveryStatusUpdated=function(b){console.log("RECEIVED deliveryStatusUpdated",b);for(var c=0;c<b.messageTypes.length;c++)console.log("BROADCASTING delivery status updated",b.messageTypes[c],b),a.$broadcast(b.messageTypes[c],b)};var n=1e4+d();return{subscribeToSection:h,unsubscribeToSection:i,subscribeToNote:j,unsubscribeFromNote:k,init:e}}angular.module("Crops").service("pushService",a),a.$inject=["$rootScope","noteService","mailroomService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{sectionId:"@",itemId:"=",needsSave:"=",isReadonly:"=",isCollection:"="},templateUrl:"{0}/quickbooks/quickbooks.action.button.html".format(a.viewRoot),link:function(a){function e(){var c=a.isCollection?a.itemId:a.nonCollectionItemID;c&&b.getItemStatus(a.sectionId,c).then(function(b){a.sendButtonEnabled=b.isEnabled,a.displayText=b.displayText})}a.displayText="",a.sendButtonEnabled=!1,a.nonCollectionItemID=c.nonCollectionItemID(),e(),a.openModal=function(){$("#qbModal").modal("show")},a.getVendorList=function(c){return b.getVendors(a.sectionId,c).then(function(a){return a})},a.onVendorChanged=function(b,c,d){console.log(b),a.qbVendorID=b.id},a.send=function(c){$("#qbModal").modal("hide");var e=a.isCollection?a.itemId:a.nonCollectionItemID;e&&b.sendBill(a.sectionId,e,c).then(function(b){a.sendButtonEnabled=b.isEnabled,a.displayText=b.displayText,d.alertSuccess(b.displayText)},function(a){d.alertFail(a)})}}}}angular.module("Crops").directive("quickbooksActionButton",a),a.$inject=["config","quickbooksActionButtonService","customService","fvAlertsService"]}(),function(){"use strict";function a(a,b,c){function d(b,d){return a.get(g.getItemStatus,[c.projectID,b,d])}function e(b,d){return a.get(g.getVendors,[c.projectID,b,d])}function f(b,d,e){var f={sectionID:b,itemID:d,vendorID:e};return a.post(g.sendBill,[c.projectID,b],f)}var g={getItemStatus:"/api/integrations/quickbooks/{0}/{1}/{2}/getitemstatus",getVendors:"/api/integrations/quickbooks/{0}/{1}/getvendors/?q={2}",sendBill:"/api/quickbooks/{0}/{1}/sendbill"},h={getItemStatus:d,getVendors:e,sendBill:f};return h}angular.module("Crops").service("quickbooksActionButtonService",a),a.$inject=["fvApi","$rootScope","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){a.project=d.project(),a.isLoading=d.isLoading(),a.project&&a.project.id&&a.project.sections&&(_(a.project.sections).findWhere({customSectionType:38})||b.go("projectLayout.project.activity"))}function g(){a.linkedProjects.isLoading=!0,e.getLinkedProjects(c.projectID).then(function(b){a.linkedProjects.all=b,a.linkedProjects.permitted=_(b).filter(function(a){return a.project&&a.project.projectOrClientName})},function(a){console.log(a)})["finally"](function(){a.linkedProjects.isLoading=!1})}function h(){return a.linkedProjects.allCount&&a.linkedProjects.list?a.linkedProjects.allCount-a.linkedProjects.list.length:null}function i(a){b.go("projectLayout.project.activity",{projectID:a.id})}function j(b){d.relate(a.project,b),$("#findProject").val("")}function k(b){d.unrelate(a.project,b)}function l(b){return a.project.id!==b.id}a.project={},a.isLoading={},a.linkedProjects={list:null,isLoading:!1,allCount:null,unauthorizedCount:h},a.$on(d.onStateChange,f),d.loadProject(),g(),a.gotoProject=i,a.relate=j,a.unrelate=k,a.showRelatedProjects=l}angular.module("Crops").controller("RelatedProjectsController",a),a.$inject=["$scope","$state","$stateParams","projectService","relatedProjectsService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{relatedProject:"="},replace:!0,templateUrl:"{0}/related/related.project.card.html".format(a.viewRoot),link:function(a){a.settings={showBreadcrumbs:!1},a.gotoUrl=function(a){var e=a.breadcrumbs.length;if(e>0){var f=a.breadcrumbs[e-1].linkUrl.replace("#","");d.hide(),b.url(f)}else c.go("projectLayout.project.activity",{projectID:a.project.id})}}}}angular.module("Crops").directive("relatedProjectCard",a),a.$inject=["config","$location","$state","personPanelService"]}(),function(){"use strict";function a(a){function b(b){return a.get(d.getLinkedProjects,[b])}function c(b){return a.get(d.getLinkedProjectsCount,[b])}var d={getLinkedProjects:"/api/projects/{0}/custom/linkedProjects",getLinkedProjectsCount:"/api/projects/{0}/custom/linkedProjectsCount"
},e={getLinkedProjects:b,getLinkedProjectsCount:c};return e}angular.module("Crops").service("relatedProjectsService",a),a.$inject=["fvApi"]}(),function(){"use strict";function a(a){return{scope:{availableColumns:"=",numberOfSelectedColumns:"=",columnOptions:"=",isValid:"=",loading:"="},restrict:"E",templateUrl:"{0}/reports/builder/report.builder.columns.view.html".format(a.viewRoot),link:function(a){function b(){a.categories=[],a.columnFromTypeahead="",a.allColumns=[],a.selectedCategory=null,a.selectedColumns={}}function c(b){a.columnOptions||(a.columnOptions=[]);var c=_.findWhere(a.columnOptions,{fieldName:b.fieldName});c?(c.isHidden=b.isHidden,c.position=b.position,b=c):a.columnOptions.push(b),a.isValid=d(),a.$emit("columnChanged",b)}function d(){return a.numberOfSelectedColumns>0&&a.numberOfSelectedColumns<=g}function e(){a.reportColumns.length<=1||(f(a.reportColumns),_(a.reportColumns).each(function(a){c(a)}),a.isInitialized&&a.$emit("columnsChanged"))}function f(a){for(var b=0,c=a.length;b<c;b++)a[b].position!=b&&(a[b].position=b)}var g=50;a.isValid=d(),a.isLoading=!0,a.isInitialized=!1,a.isCollapsed={availableColumnInstructions:!0,reportColumnInstructions:!0},b(),a.$watch("availableColumns",function(c,d){a.availableColumns&&Object.keys(a.availableColumns).length&&(a.isLoading=!0,b(),_(a.availableColumns).each(function(b,c){a.categories.push(c),_(b).each(function(a){a.category=c,a.originalPosition=a.position}),a.allColumns=a.allColumns.concat(b)}),a.reportColumns=_.chain(a.allColumns).filter(function(a){return!a.isHidden}).sortBy("position").value(),e(),a.selectedCategory=a.categories[0],a.isLoading=!1,a.isInitialized?a.$emit("columnsChanged"):a.isInitialized=!0)}),a.reportColumnSortOptions={axis:"y",stop:e},a.$watch("numberOfSelectedColumns",function(){a.isValid=d()}),a.toggleColumn=function(b){a.selectedColumns[b.fieldName]?a.selectedColumns[b.fieldName]=!1:a.selectedColumns[b.fieldName]=!0},a.addToggledColumnsToReport=function(){var b=_(a.allColumns).filter(function(b){return a.selectedColumns[b.fieldName]&&b.isHidden});if(b)for(var c,d=0;d<b.length;d++)c=b[d],a.addAvailableColumn(c),a.selectedColumns[c.fieldName]=!1},a.addAvailableColumn=function(b){b.isHidden=!1,a.reportColumns.push(b),e(),a.numberOfSelectedColumns++,c(b),a.$emit("columnsChanged")},a.quickSelect=function(b){a.addAvailableColumn(b),a.columnFromTypeahead="",a.$broadcast("onQuickSelectCompleted")},a.removeToggledColumnsFromReport=function(){var b=_(a.reportColumns).filter(function(b){return a.selectedColumns[b.fieldName]});if(b)for(var c,d=0;d<b.length;d++)c=b[d],a.removeReportColumn(c),a.selectedColumns[c.fieldName]=!1},a.removeReportColumn=function(b){for(var d=0;d<a.reportColumns.length;d++)if(a.reportColumns[d].fieldName===b.fieldName){a.reportColumns.splice(d,1);break}e();var f=_(a.allColumns).findWhere({fieldName:b.fieldName});f&&(f.isHidden=!0),a.numberOfSelectedColumns--,c(b),a.$emit("columnsChanged")}}}}angular.module("Crops").directive("reportBuilderColumns",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){b.listPanel.isOpen=!1,b.columnsPanel.isOpen=!1,b.criteriaPanel.isOpen=!1,b.exportPanel.isOpen=!1,b.resultsPanel.isOpen=!1}function k(){return c.getUserShareList(b.selectedReport.id).then(function(a){b.fullUserShareList=a})}function l(){return c.getOrgShareList(b.selectedReport.id).then(function(a){b.fullOrgShareList=a})}function m(){b.userShareList=o(b.fullUserShareList,b.reportUserShareList)}function n(){b.orgShareList=p(b.fullOrgShareList,b.reportOrgShareList)}function o(a,b){var c={};_(b).each(function(a){c[a.userID]=!0});var d=_(a).filter(function(a){return!c[a.userID]});return d}function p(a,b){var c={};_(b).each(function(a){c[a.orgID]=!0});var d=_(a).filter(function(a){return!c[a.orgID]});return d}function q(a){return c.addUserShare(b.selectedReport.id,a)}function r(a){return c.removeUserShare(b.selectedReport.id,a)}function s(a){return c.addOrgShare(b.selectedReport.id,a)}function t(a){return c.removeOrgShare(b.selectedReport.id,a)}function u(){b.listPanel.reset(),b.listPanel.clearSelection()}function v(){!b.listPanel.reportTypesIsLoading&&!b.listPanel.myReportsIsLoading&&b.listPanel.savedReports&&e.search()&&e.search().id&&(b.listPanel.selectedSavedReport=_(b.listPanel.savedReports).findWhere({id:+e.search().id}),e.search({}))}function w(){b.listPanel.reportTypes&&b.listPanel.reportTypes.length?(b.listPanel.filteredReportTypes=_(b.listPanel.reportTypes).filter(function(a){return(null===a.orgID||b.listPanel.criteria.org&&a.orgID===b.listPanel.criteria.org.id)&&(null===a.projectTypeID||b.listPanel.criteria.projectType&&a.projectTypeID===b.listPanel.criteria.projectType.id)}),b.listPanel.selectedReportType&&!_(b.listPanel.filteredReportTypes).findWhere({id:b.listPanel.selectedReportType.id})&&(b.listPanel.reset(),b.listPanel.clearSelection())):b.listPanel.filteredReportTypes=null}function x(a){b.exportSettings.exportedDoc=a,b.exportStatus.isExporting=!1,b.exportSettings.canClose=!0,b.$broadcast("exportFinished")}function y(a){b.exportSettings.showOptions?(b.exportStatus.isExporting=!1,b.exportSettings.canClose=!0):$("#exportModal").modal("hide"),b.$broadcast("exportFinished"),b.selectedReport.excelTemplate?a?f.alertFail(a):f.alertFail("We are having trouble exporting the report using this template. Please double-check that it only includes the fields set as Report Columns in the Set Up Columns step and that the repeating row(s) have both a ##BEGIN_REPEAT and ##END_REPEAT comment (see instructions in Export Options)",12e3):f.alertFail("We were unable to export this report. Please refresh the page and try again.")}function z(a){a.id&&(b.exportStatus.isUploadingTemplate=!0,b.exportSettings.canClose=!1,c.uploadExportTemplate(b.selectedReport.id,a.id).then(function(a){b.exportSettings.exportedDoc=void 0,b.selectedReport=a,b.resultsPanel.reportResult.title=a.displayName,P(b.selectedReport),O(b.selectedReport),f.alertSuccess("Export template uploaded"),b.exportStatus.isUploadingTemplate=!1,b.exportSettings.canClose=!0},function(){b.exportStatus.isUploadingTemplate=!1,b.exportSettings.canClose=!0,f.alertFail("Unable to upload export template. Please refresh the page and try again.")}))}function A(a){a.wrap("<form>").closest("form").get(0).reset(),a.unwrap()}function B(){b.listPanel.reportTypesIsLoading=!0,c.getReportTypes().then(function(a){b.listPanel.reportTypes=a;for(var c=[],d=0;d<a.length;d++)C(c,a[d]);b.listPanel.orgs=c,b.listPanel.reportTypesIsLoading=!1})}function C(a,b){if(b.orgID&&b.projectTypeID){var c=_(a).findWhere({id:b.orgID});c||(c={id:b.orgID,name:b.orgName,projectTypes:[]},a.push(c)),D(c,{id:b.projectTypeID,name:b.projectTypeName})}}function D(a,b){_(a.projectTypes).any(function(a){return a.id===b.id})||a.projectTypes.push(b)}function E(){b.listPanel.myReportsIsLoading=!0,c.getSavedReports()}function F(){b.criteriaPanel.isLoading=!0;var a=b.selectedReport.reportType.parameters;c.refreshParameters(b.selectedReport).then(function(c){R(c.parameters,b.selectedReport.parameters),S(c.parameters,b.selectedReport.parameters),b.selectedReport.reportType=c,O(b.selectedReport),b.criteriaPanel.isLoading=!1,T(a,c.parameters)&&b.$broadcast("criteriaAdded")})}function G(a){b.selectedReport.displayName=a,b.resultsPanel.reportResult.title=a,b.selectedReport.sortOverride=b.resultsPanel.reportResult.sort,b.selectedReport.groupByOverride=b.resultsPanel.reportResult.groupBy,H(),console.log(b.selectedReport)}function H(){for(var a=b.selectedReport.columnOptions,c=b.resultsPanel.reportResult.columns,d=0;d<a.length;d++)for(var e=0;e<c.length;e++)if(a[d].fieldName===c[e].fieldName){a[d].position=c[e].position,a[d].isHidden=c[e].isHidden;break}}function I(a){f.alertSuccess(a.displayName+" Saved"),b.selectedReport=a,b.resultsPanel.reportResult.title=a.displayName,P(b.selectedReport),O(b.selectedReport),b.listPanel.selectedReportType=null,a.alreadyLoaded=!0,b.listPanel.selectedSavedReport=a,E()}function J(a){b.listPanel.reset(),a.fullyLoaded?K(a):c.getReportType(a.id).then(function(b){angular.copy(b,a),K(a)})}function K(a){var c=JSON.parse(JSON.stringify(a)),d=[];b.onlyOneOrg=!1;var e=_(c.parameters).findWhere({key:"Org"});if(e){var f=Object.keys(e.dropdownItems);b.onlyOneOrg=1===f.length,b.onlyOneOrg&&(e.value=f[0],e.sequence=1,d.push(e),c.parameters=_(c.parameters).reject(function(a){return"Org"===a.key}))}b.selectedReport={reportType:c,columnOptions:_.where(c.columns,{isHidden:!1}),numberOfSelectedColumns:L(c.columns),parameters:d,displayName:"",reportID:c.id,isNew:!0},e&&b.onlyOneOrg&&F(e),b.columnsPanel.isDisabled=!1,b.criteriaPanel.isDisabled=!1,b.resultsPanel.isDisabled=!1,b.columnsPanel.open()}function L(a){var b=0;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b+=M(d)}return b}function M(a){for(var b=0,c=0,d=a.length;c<d;c++)a[c].isHidden||b++;return b}function N(a){if(b.listPanel.selectedReportType=null,b.resultsPanel.clear(),b.listPanel.reset(),a.reportType){b.resultsPanel.open(null,!0);var c=JSON.parse(JSON.stringify(a));b.selectedReport=c,P(b.selectedReport),O(b.selectedReport),d(function(){b.criteriaPanel.isValid=!0,b.runReport()})}}function O(a){a.reportType.columns=a.reportType.columns||[],a.columnOptions=a.columnOptions||[];for(var b in a.reportType.columns)if(a.reportType.columns.hasOwnProperty(b))for(var c=0,d=a.reportType.columns[b].length;c<d;c++)for(var e=a.reportType.columns[b],f=0,g=a.columnOptions.length;f<g;f++)e[c].fieldName===a.columnOptions[f].fieldName&&(e[c].isHidden=a.columnOptions[f].isHidden);a.numberOfSelectedColumns=L(a.reportType.columns)}function P(a){for(var b=a.reportType.parameters||[],c=a.parameters||[],d=b.length;d--;)for(var e=0,f=c.length;e<f;e++)if(b[d].key===c[e].key){var g=c[e];if(c[e]=b.splice(d,1)[0],c[e].id=g.id,c[e].sequence=g.sequence,c[e].filterType=g.filterType,"between"===g.filterType)c[e].rangeValue1=Q(g.rangeValue1,c[e].fieldType),c[e].rangeValue2=Q(g.rangeValue2,c[e].fieldType);else if("list"===g.filterType){if(c[e].inValues=[],g.inValues&&g.inValues.length>0)for(var h=0;h<g.inValues.length;h++)c[e].inValues.push(Q(g.inValues[h],c[e].fieldType))}else c[e].value=Q(g.value,c[e].fieldType);break}a.parameters=c,a.reportType.parameters=b}function Q(a,b){switch(b){case"Integer":return parseInt(a,10);case"Decimal":return parseFloat(a);default:return a}}function R(a,b){if(b)for(var c=b.length;c--;){for(var d=!1,e=0,f=a.length;e<f;e++)if(a[e].key===b[c].key){"Dropdown"===b[c].fieldType&&(b[c].value&&(a[e].dropdownItems[b[c].value]||(b[c].value=void 0)),b[c].dropdownItems=a[e].dropdownItems),d=!0;break}d||b.splice(c,1)}}function S(a,b){if(a&&b)for(var c=a.length;c--;)for(var d=0,e=b.length;d<e;d++)if(a[c].key===b[d].key){a.splice(c,1);break}}function T(a,b){for(var c=0,d=b.length;c<d;c++){for(var e=!1,f=0,g=a.length;f<g;f++)if(b[c].key===a[f].key){e=!0;break}if(!e)return!0}return!1}b.selectedReport=null,b.exportSettings={canClose:!0,exportedDoc:void 0,showOptions:!1,showInstructions:!1,defaultTemplate:void 0,uploads:[]},b.exportStatus={isGeneratingDefaultTemplate:!1,isUploadingTemplate:!1,isExporting:!1},b.listPanel={isOpen:!0,isDisabled:!0,reportTypes:null,filteredReportTypes:null,savedReports:null,selectedReportType:null,selectedSavedReport:null,myReportsIsLoading:!0,reportTypesIsLoading:!0,open:function(){this.isDisabled||this.isOpen||(j(),this.isOpen=!0)},reset:function(){this.isOpen||(j(),this.isOpen=!0),this.isDisabled=!0,b.resultsPanel.clear(),b.columnsPanel.isDisabled=!0,b.criteriaPanel.isDisabled=!0,b.resultsPanel.isDisabled=!0,b.exportPanel.isDisabled=!0},clearSelection:function(){this.selectedReportType=null,this.selectedSavedReport=null,b.selectedReport=null},orgs:[],criteria:{org:null,projectType:null}},b.columnsPanel={isOpen:!1,isDisabled:!0,isValid:!0,isLoading:!1,open:function(){this.isDisabled||this.isOpen||(b.listPanel.isDisabled=!1,j(),this.isOpen=!0)}},b.criteriaPanel={isOpen:!1,isDisabled:!0,isValid:!0,isLoading:!1,open:function(){this.isDisabled||this.isOpen||(j(),this.isOpen=!0)}},b.resultsPanel={isOpen:!1,isDisabled:!0,isLoading:!1,reportResult:null,open:function(a,c){a?(console.debug(a),this.reportResult=a,this.isOpen||(j(),this.isDisabled=!1,b.listPanel.isDisabled=!1,b.columnsPanel.isDisabled=!1,b.criteriaPanel.isDisabled=!1,b.exportPanel.isDisabled=!1,this.isOpen=!0),b.exportPanel.isDisabled=!1):this.isDisabled&&!c||this.isOpen||(j(),b.listPanel.isDisabled=!1,b.columnsPanel.isDisabled=!1,b.criteriaPanel.isDisabled=!1,this.isDisabled=!1,this.isOpen=!0)},clear:function(){this.reportResult=null,b.exportPanel.isDisabled=!0}},b.exportPanel={isOpen:!1,isDisabled:!0,isValid:!1,isLoading:!1,isUnarchiving:!1,open:function(){this.isDisabled||this.isOpen||(j(),this.isOpen=!0)}},B(),E(),b.update=function(){b.selectedReport.id&&b.selectedReport.canEdit&&(G(b.resultsPanel.reportResult.title),c.updateSavedReport(b.selectedReport).then(I,function(){f.alertFail("Save Failed")}))};var U=$("#shareWithModal");b.openShareWithModal=function(){b.userShareList=[],b.orgShareList=[],b.reportUserShareList=b.selectedReport.userShares,b.reportOrgShareList=b.selectedReport.orgShares,k().then(function(){m()}),l().then(function(){n()}),U.modal("show")},U.on("hidden.bs.modal",function(){b.shareableFilterOrig="",b.shareableFilter="",b.shareWithFilterOrig="",b.shareWithFilter=""}),b.dropShareableAtSign=function(){0===b.shareableFilterOrig.indexOf("@")?b.shareableFilter=b.shareableFilterOrig.substring(1):b.shareableFilter=b.shareableFilterOrig},b.dropShareWithAtSign=function(){0===b.shareWithFilterOrig.indexOf("@")?b.shareWithFilter=b.shareWithFilterOrig.substring(1):b.shareWithFilter=b.shareWithFilterOrig},b.toggleSelected=function(a){a.isSelected=!a.isSelected},b.shareReportWithUser=function(a){q(a.userID).then(function(){a.isSelected=!1,b.reportUserShareList.push(a),m()})},b.unshareReportWithUser=function(a){r(a.userID).then(function(){a.isSelected=!1;var c=b.reportUserShareList.indexOf(a);b.reportUserShareList.splice(c,1),m()})},b.shareReportWithOrg=function(a){s(a.orgID).then(function(){a.isSelected=!1,n(),b.reportOrgShareList.push(a)})},b.unshareReportWithOrg=function(a){t(a.orgID).then(function(){a.isSelected=!1;var c=b.reportOrgShareList.indexOf(a);b.reportOrgShareList.splice(c,1),n()})},b.shareReportWithSelected=function(){var a=_(b.orgShareList).where({isSelected:!0}),c=_(b.userShareList).where({isSelected:!0});if(a.length){for(var d=0;d<a.length;d++)s(a[d].orgID),a[d].isSelected=!1,b.reportOrgShareList.push(a[d]);n()}if(c.length){for(var e=0;e<c.length;e++)q(c[e].userID),c[e].isSelected=!1,b.reportUserShareList.push(c[e]);m()}},b.unshareReportWithSelected=function(){var a=_(b.reportOrgShareList).where({isSelected:!0}),c=_(b.reportUserShareList).where({isSelected:!0});if(a.length){for(var d=0;d<a.length;d++){t(a[d].orgID),a[d].isSelected=!1;var e=b.reportOrgShareList.indexOf(a[d]);b.reportOrgShareList.splice(e,1)}n()}if(c.length){for(var f=0;f<c.length;f++){r(c[f].userID),c[f].isSelected=!1;var g=b.reportUserShareList.indexOf(c[f]);b.reportUserShareList.splice(g,1)}m()}},b.openSaveAs=function(){b.saveAsName=b.resultsPanel.reportResult.title,$("#saveAsModal").modal("show")},b.saveAs=function(a){a&&(G(a),b.selectedReport.id?c.saveAsNewReport(b.selectedReport).then(function(a){I(a),$("#saveAsModal").modal("hide")},function(){f.alertFail("We were unable to save this report. Please try again or contact Filevine."),$("#saveAsModal").modal("hide")}):c.createSavedReport(b.selectedReport).then(function(a){I(a),$("#saveAsModal").modal("hide")},function(){f.alertFail("We were unable to save this report. Please try again or contact Filevine."),$("#saveAsModal").modal("hide")}))},b.runReport=function(){if(b.selectedReport&&b.selectedReport.parameters&&b.criteriaPanel.isValid){b.resultsPanel.isLoading=!0,b.resultsPanel.open(null,!0);var a=new Date;b.selectedReport.timezoneOffset=a.getTimezoneOffset(),c.runAdhocReport(b.selectedReport).then(function(a){b.resultsPanel.isLoading=!1,b.resultsPanel.open(a),b.exportPanel.isUnarchiving&&(b.exportPanel.isUnarchiving=!1,b.exportPanel.open())},function(){f.alertFail("Could not run report. Please try again later."),b.resultsPanel.isLoading=!1})}},b.archiveSavedReport=function(){b.selectedReport&&b.selectedReport.id&&!b.selectedReport.isHidden&&i.confirm({text:'Do you want to archive "'+b.selectedReport.displayName+'?"',confirmButtonText:"Archive",isLoadingText:"Archiving"},function(){return c.hideSavedReport(b.selectedReport.id).then(function(){f.alertSuccess("Report Archived"),u()},function(){f.alertFail("Could not archive this report.")})})},b.$on("onSelectedReportArchived",u),b.unarchiveSavedReport=function(){b.selectedReport&&b.selectedReport.id&&b.selectedReport.isHidden&&i.confirm({text:'Do you want to unarchive "'+b.selectedReport.displayName+'?"',confirmButtonText:"Unarchive",isLoadingText:"Unarchiving"},function(){return c.unhideSavedReport(b.selectedReport.id).then(function(){f.alertSuccess("Report unarchived"),b.selectedReport.isHidden=!1,b.exportPanel.isUnarchiving=!0,b.$broadcast("startOver",b.selectedReport)},function(){f.alertFail("Could not unarchive this report.")})})},b.$watch("listPanel.reportTypes",w),b.$watch("listPanel.criteria.org",w),b.$watch("listPanel.criteria.projectType",w),b.$watch("listPanel.reportTypesIsLoading",v),b.$watch("listPanel.myReportsIsLoading",v),b.$on("$locationChangeSuccess",v,!0),b.$watch("listPanel.selectedReportType",function(a){a&&(a.automaticallySelected||J(a))}),b.$watch("columnsPanel.isValid",function(a){b.criteriaPanel.isDisabled=!b.selectedReport||!a,b.resultsPanel.isDisabled=!b.selectedReport||!a||!b.criteriaPanel.isValid,b.exportPanel.isDisabled=!(b.selectedReport&&b.resultsPanel.reportResult&&a&&b.criteriaPanel.isValid)}),b.$watch("criteriaPanel.isValid",function(a){b.resultsPanel.isDisabled=!b.selectedReport||!b.columnsPanel.isValid||!a,b.exportPanel.isDisabled=!(b.selectedReport&&b.resultsPanel.reportResult&&b.columnsPanel.isValid&&a)}),b.$watch("listPanel.selectedSavedReport",function(a){a&&(a.alreadyLoaded||c.getSavedReport(a.id).then(function(a){N(a)},function(){f.alertFail("Could not load "+a.displayName)}))}),b.$on("startOver",function(a,d){d&&b.listPanel.selectedReportType===d?J(d):c.getSavedReport(d.id).then(function(a){N(a)},function(){f.alertFail("Could not reload "+selectedSavedReport.displayName)})}),b.$on("parameterChanged",function(a,c){b.resultsPanel.clear(),b.selectedReport.needsSave=!0,c.enablesMoreParameters&&F()}),b.$on("columnsChanged",function(){b.resultsPanel.clear(),b.selectedReport.needsSave=!0}),b.$on("resultsChanged",function(a,c){G(c),b.selectedReport.needsSave=!0}),b.canExport=function(){return b.selectedReport&&(!b.selectedReport.id||!b.selectedReport.excelTemplate||!b.selectedReport.needsSave)},b["export"]=function(a){if(b.canExport){G(b.resultsPanel.reportResult.title);var d=new Date;b.selectedReport.timezoneOffset=d.getTimezoneOffset(),b.exportSettings.exportedDoc=void 0,b.exportSettings.showOptions||$("#exportModal").modal({backdrop:"static",keyboard:!1,show:!0}),b.selectedReport.id&&b.selectedReport.excelTemplate?(b.exportSettings.canClose=!1,b.exportStatus.isExporting=!0,c.exportSavedReport(b.selectedReport.id,b.selectedReport.timezoneOffset).then(function(a){x(a)},function(a){y(a)})):(b.exportSettings.canClose=!1,b.exportStatus.isExporting=!0,c.exportAdhocReport(b.selectedReport).then(function(a){x(a)},function(){y()}))}},b.exportOptions=function(a){b.selectedReport.id&&b.selectedReport.canEdit&&(b.exportSettings.showOptions=!0,b.exportSettings.canClose=!0,$("#exportModal").modal({backdrop:"static",keyboard:!1,show:!0}))},b.generateDefaultExportTemplate=function(){if(!b.exportSettings.defaultTemplate){b.exportStatus.isGeneratingDefaultTemplate=!0,b.exportSettings.canClose=!1;var a=new Date;b.selectedReport.timezoneOffset=a.getTimezoneOffset(),c.generateExportTemplate(b.selectedReport.id,b.selectedReport.timezoneOffset).then(function(a){b.exportSettings.defaultTemplate=a,b.exportStatus.isGeneratingDefaultTemplate=!1,b.exportSettings.canClose=!0},function(){b.exportStatus.isGeneratingDefaultTemplate=!1,b.exportSettings.canClose=!0,f.alertFail("Unable to generate export template. Please refresh the page and try again.")})}},b.uploadExportTemplate=function(a,c,d){a.length>0&&b.$apply(function(){d.exportSettings.uploads=[{file:a[0],percent:0,id:-1,exportSettings:d.exportSettings,complete:function(){return z(this)}}],A($(c))})},b.removeUpload=function(a){a.isComplete||(a.exportSettings.uploads=_(a.exportSettings.uploads).reject(function(b){return b===a}))},b.removeExportTemplate=function(){c.removeExportTemplate(b.selectedReport.id).then(function(){b.selectedReport.excelTemplate=null})},$("#exportModal").on("hidden.bs.modal",function(){b.exportSettings.canClose=!0,b.exportSettings.exportedDoc=void 0,b.exportSettings.showOptions=!1,b.exportSettings.defaultTemplate=void 0,b.exportSettings.uploads=[],b.exportStatus.isGeneratingDefaultTemplate=!1,b.exportStatus.isUploadingTemplate=!1,b.exportStatus.isExporting=!1,b.$apply()}),b.showAutoReportScheduleModal=function(){var a=g.open({animation:!0,templateUrl:"{0}/reports/report.autoreport.modal.html".format(h.viewRoot),controller:"autoReportScheduleModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"report-modal report-autoreport-modal",resolve:{reportID:function(){return b.selectedReport.id},settings:function(){return b.selectedReport.autoReportScheduleSettings}}});a.result.then(function(a){b.selectedReport.autoReportScheduleSettings=a})},b.$on(c.onSavedReportsChanged,function(){b.listPanel.savedReports=c.savedReports(),b.listPanel.selectedSavedReport&&b.listPanel.selectedSavedReport.id&&!_(b.listPanel.savedReports).findWhere({id:b.listPanel.selectedSavedReport.id})&&(b.listPanel.reset(),b.listPanel.clearSelection()),b.listPanel.myReportsIsLoading=!1})}angular.module("Crops").controller("ReportBuilderController",a),a.$inject=["$rootScope","$scope","reportService","$timeout","$location","fvAlertsService","$uibModal","config","confirmService"]}(),function(){"use strict";function a(a){return{scope:{availableParameters:"=",selectedParameters:"=",isValid:"=",loading:"="},restrict:"E",templateUrl:"{0}/reports/builder/report.builder.criteria.view.html".format(a.viewRoot),link:function(a){function b(){return!_(a.selectedParameters).any(function(a){return"list"===a.filterType&&(!a.inValues||0===a.inValues.length||_(a.inValues).any(function(a){return null===a||""===a}))})}function c(a){if(a.filterTypes){var b=Object.keys(a.filterTypes);b.length&&(a.filterType=b[0])}}a.selectItems={},a.objectToArray=function(b,c){return a.selectItems[b]=[],angular.forEach(c,function(c,d){a.selectItems[b].push({key:d,value:c})}),a.selectItems[b]},a.add=function(b){a.selectedParameters||(a.selectedParameters=[]),a.selectedParameters.indexOf(b)===-1&&(b.sequence=a.selectedParameters.length+1,c(b),a.selectedParameters.push(b)),a.availableParameters=_(a.availableParameters).reject(function(a){return a.key===b.key}),a.added=null,a.$emit("parameterChanged",b)},a.remove=function(b){a.selectedParameters=_(a.selectedParameters).reject(function(a){return a.key===b.key}),delete b.value,delete b.inValues,delete b.rangeValue1,delete b.rangeValue2,delete b.sequence,delete b.filterType,delete b.soleFilterType,a.availableParameters.push(b),a.$emit("parameterChanged",b)},a.parameterChanged=function(b){a.$emit("parameterChanged",b)},a.$on("criteriaAdded",function(){a.newCriteria=!0}),a.$watchCollection("selectedParameters",function(){a.isValid=!a.selectedParameters||!a.selectedParameters.length||a.parameterForm.$valid&&b()}),a.$watch("parameterForm.$valid",function(b){a.isValid=!a.selectedParameters||!a.selectedParameters.length||b}),a.soleFilterType=function(a){if(a.filterTypes){if(a.soleFilterType)return a.soleFilterType;var b=Object.keys(a.filterTypes);return 1===b.length?(a.filterType=b[0],a.soleFilterType=a.filterTypes[a.filterType],a.soleFilterType):void 0}},a.newInValue=function(c){c.inValues?(c.inValues=_(c.inValues).uniq(),c.inValues.push(null)):c.inValues=[null],a.isValid=!a.selectedParameters||!a.selectedParameters.length||a.parameterForm.$valid&&b()},a.removeInValue=function(c,d){c.inValues.splice(d,1),c.inValues=_(c.inValues).uniq(),a.isValid=!a.selectedParameters||!a.selectedParameters.length||a.parameterForm.$valid&&b()}}}}angular.module("Crops").directive("reportBuilderCriteria",a),a.$inject=["config","$timeout"]}(),function(){"use strict";function a(a){return{scope:{orgs:"=",criteria:"=",loading:"="},restrict:"E",replace:!0,templateUrl:"{0}/reports/builder/report.builder.list.criteria.selector.view.html".format(a.viewRoot),link:function(a){a.reset=function(b){!b&&a.criteria.org&&_(a.orgs).any(function(b){return b.id===a.criteria.org.id})||(a.projectType=null,a.org=1===a.orgs.length?a.orgs[0]:null,a.criteria={org:a.org||null,orgID:a.org?a.org.id:null,projectTypeID:null})},a.$watch("orgs",a.reset)}}}angular.module("Crops").directive("reportBuilderListCriteriaSelector",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d,e){return{scope:{selected:"=",onSelect:"&",list:"=",listTitle:"@",startOverText:"@",loading:"=",isSavedReports:"="},restrict:"E",replace:!0,templateUrl:"{0}/reports/builder/report.builder.list.view.html".format(a.viewRoot),link:function(a){function f(){a.isSavedReports&&a.list&&a.list.length&&(a.list=_.chain(a.list).sortBy(function(a){return a.displayName}).sortBy(function(a){return a.isHidden?1:0}).sortBy(function(a){return a.isFavorite?0:1}).value())}function g(){a.savedReports.showArchived&&a.savedReports.filteredArchived.length?(a.savedReports.focusedIndex=a.savedReports.filteredArchived.length-1,a.savedReports.focusedIsArchived=!0):(a.savedReports.focusedIndex=a.savedReports.filtered.length-1,a.savedReports.focusedIsArchived=!1)}function h(){a.savedReports.focusedIndex=0,a.savedReports.focusedIsArchived=a.savedReports.showArchived&&a.savedReports.filteredArchived.length}function i(){a.savedReports.filtered.length?(a.savedReports.focusedIndex=a.savedReports.filtered.length-1,a.savedReports.focusedIsArchived=!1):(a.savedReports.focusedIndex=a.savedReports.filteredArchived.length-1,a.savedReports.focusedIsArchived=!0)}function j(){if(null!==a.savedReports.focusedIndex){var b=a.savedReports.focusedIsArchived?a.savedReports.filteredArchived[a.savedReports.focusedIndex]:a.savedReports.filtered[a.savedReports.focusedIndex];b&&a.select(b)}}a.select=function(b){a.selected&&a.selected.id===b.id?a.$emit("startOver",b):a.onSelect&&angular.isFunction(a.onSelect)?(a.onSelect(),c(function(){a.selected=b})):a.selected=b},a.savedReports={filter:"",filtered:[],filteredArchived:[],showArchived:!1,focusedIndex:null},a.isSavedReports&&a.$watch("list",f,!0),a.toggleFavorite=function(a,c){c.stopPropagation(),c.preventDefault(),a.isFavorite?b.unfavoriteReport(a.id).then(function(){a.isFavorite=!1}):b.favoriteReport(a.id).then(function(){a.isFavorite=!0})},a.archiveSavedReport=function(c,f){f&&(f.stopPropagation(),f.preventDefault()),c&&c.id&&!c.isHidden&&d.confirm({text:'Do you want to archive "'+c.displayName+'?"',confirmButtonText:"Archive",isLoadingText:"Archiving"},function(){return b.hideSavedReport(c.id).then(function(){a.selected&&a.selected.id&&a.selected.id===c.id&&a.$emit("onSelectedReportArchived"),e.alertSuccess("Report Archived")},function(){e.alertFail("Could not archive this report.")})})},a.unarchiveSavedReport=function(a,c){c&&(c.stopPropagation(),c.preventDefault()),a&&a.id&&a.isHidden&&d.confirm({text:'Do you want to unarchive "'+a.displayName+'?"',confirmButtonText:"Unarchive",isLoadingText:"Unarchiving"},function(){return b.unhideSavedReport(a.id).then(function(){a.isHidden=!1,e.alertSuccess("Report Unarchived")},function(){e.alertFail("Could not unarchive this report.")})})},a.toggleArchive=function(b){b.isHidden?a.unarchiveSavedReport(b):a.archiveSavedReport(b)},f(),a.savedReports.focusedIndex=null,a.savedReports.focusedIsArchived=!1,a.onSavedReportsFilterKeydown=function(b){if((a.savedReports.filtered.length||a.savedReports.filteredArchived.length)&&null!==a.savedReports.focusedIndex){var d;switch(b.which){case 13:event.preventDefault(),j();break;case 27:event.preventDefault(),a.savedReports.filter="",c(a.focusOnFirst);break;case 40:event.preventDefault(),a.savedReports.focusedIsArchived?a.savedReports.filteredArchived.length&&a.savedReports.focusedIndex<a.savedReports.filteredArchived.length-1?a.savedReports.focusedIndex++:a.focusOnFirst():a.savedReports.filtered.length&&a.savedReports.focusedIndex<a.savedReports.filtered.length-1?a.savedReports.focusedIndex++:h();break;case 38:event.preventDefault(),a.savedReports.focusedIndex>0?a.savedReports.focusedIndex--:a.savedReports.focusedIsArchived?i():g();break;case 34:event.preventDefault(),d=[a.savedReports.focusedIndex,a.savedReports.focusedIsArchived],g(),angular.equals(d,[a.savedReports.focusedIndex,a.savedReports.focusedIsArchived])&&a.focusOnFirst();break;case 33:event.preventDefault(),d=[a.savedReports.focusedIndex,a.savedReports.focusedIsArchived],a.focusOnFirst(),angular.equals(d,[a.savedReports.focusedIndex,a.savedReports.focusedIsArchived])&&g()}}},a.focusOnFirst=function(){a.savedReports.focusedIndex=0,a.savedReports.focusedIsArchived=!a.savedReports.filtered.length&&a.savedReports.showArchived&&a.savedReports.filteredArchived.length}}}}angular.module("Crops").directive("reportBuilderList",a),a.$inject=["config","reportService","$timeout","confirmService","fvAlertsService"]}(),function(){"use strict";function a(a){return{scope:{availableParameters:"=",selectedParameters:"=",isValid:"=",loading:"=",onlyOneOrg:"="},restrict:"E",templateUrl:"{0}/reports/builder/report.builder.mini.criteria.view.html".format(a.viewRoot),link:function(a){function b(a){if(a.filterTypes){var b=Object.keys(a.filterTypes);b.length&&(a.filterType=b[0])}}a.isCollapsed={instructions:!0},a.add=function(c){a.selectedParameters||(a.selectedParameters=[]),a.selectedParameters.indexOf(c)===-1&&(c.sequence=a.selectedParameters.length+1,b(c),a.selectedParameters.push(c)),a.availableParameters.splice(a.availableParameters.indexOf(c),1),a.added=null,a.parameterChanged(c)},a.remove=function(b){a.selectedParameters.splice(a.selectedParameters.indexOf(b),1),delete b.value,delete b.sequence,delete b.filterType,delete b.soleFilterType,a.availableParameters.push(b),a.$emit("parameterChanged",b)},a.parameterChanged=function(b){""===b.value||null===b.value?a.remove(b):a.$emit("parameterChanged",b)},a.$on("criteriaAdded",function(){a.newCriteria=!0}),a.soleFilterType=function(a){if(a.filterTypes){if(a.soleFilterType)return a.soleFilterType;var b=Object.keys(a.filterTypes);return 1===b.length?(a.filterType=b[0],a.soleFilterType=a.filterTypes[a.filterType],a.soleFilterType):void 0}}}}}angular.module("Crops").directive("reportBuilderMiniCriteria",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){angular.copy(a.originalSettings,a.settings)}function i(b,d){if(b&&b.id===a.reportID&&b.autoReportScheduleSettings){var f=b.autoReportScheduleSettings.autoReportTimeOfDay?"Auto report successfully scheduled.":"You have been unsubscribed from this auto report.";e.alertSuccess(f),c.close(b.autoReportScheduleSettings)}else{var g=d.autoReportTimeOfDay?"There was a problem scheduling this auto report.":"There was a problem unsubscribing your from this auto report.";g+=" Please refresh and try again.",e.alertFail(g)}}function j(a,b){var c=b.autoReportTimeOfDay?"There was a problem scheduling this auto report.":"There was a problem unsubscribing your from this auto report.";c+=" Please refresh and try again.",e.alertFail(c)}a.currentUserEmail=Crops.currentUserEmail,a.isSavingAutoReportSchedule=!1,a.timeOfDay={Mornings:1,Evenings:2},f&&(a.reportID=f),g&&(a.settings=g,a.settings.autoReportTimeOfDay=a.settings.autoReportTimeOfDay||a.timeOfDay.Mornings,a.originalSettings=angular.copy(a.settings)),a.toggleTimeOfDay=function(b){a.settings.autoReportTimeOfDay=b},a.canUnsubscribe=function(){return a.originalSettings&&a.originalSettings.autoReportScheduleType>0;
},a.canSave=function(){return!a.isSavingAutoReportSchedule&&a.settings&&!angular.equals(a.settings,a.originalSettings)&&(0===a.settings.autoReportScheduleType||a.settings.autoReportSchedulesList.length&&a.settings.autoReportTimeOfDay)},a.save=function(){if(a.canSave()){a.isSavingAutoReportSchedule=!0;var b=0===a.settings.autoReportScheduleType?{}:{autoReportTimeOfDay:a.settings.autoReportTimeOfDay,autoReportScheduleType:a.settings.autoReportScheduleType,autoReportScheduleDays:a.settings.autoReportSchedulesList};d.setAutoReportSettings(a.reportID,b).then(function(a){i(a,b)},function(a){j(a,b)})["finally"](function(){a.isSavingAutoReportSchedule=!1})}},a.unsub=function(){!a.isSavingAutoReportSchedule&&a.canUnsubscribe()&&(a.isSavingAutoReportSchedule=!0,d.setAutoReportSettings(a.reportID,{}).then(function(a){i(a,{})},function(a){j(a,{})})["finally"](function(){a.isSavingAutoReportSchedule=!1}))},a.cancel=function(){h(),c.dismiss("onAutoReportScheduleModalClosed")}}angular.module("Crops").controller("autoReportScheduleModalController",a),a.$inject=["$scope","config","$uibModalInstance","reportService","fvAlertsService","reportID","settings"]}(),function(){"use strict";function a(a){return{scope:{autoReportSettings:"=",isSaving:"="},restrict:"E",replace:!0,templateUrl:"{0}/reports/report.autoreport.schedule.html".format(a.viewRoot),link:function(a){a.scheduleTypes={Off:0,Weekly:1,Monthly:2,Yearly:3},a.daysOfWeek={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6},a.daysOfMonth=function(){var a=new Array(31);return a},a.months={January:1,February:2,March:3,April:4,May:5,June:6,July:7,August:8,September:9,October:10,November:11,December:12},a.changeType=function(){a.autoReportSettings.autoReportSchedulesList.length=0},a.isDayScheduled=function(b){return a.autoReportSettings.autoReportSchedulesList.indexOf(b)>=0},a.toggleDay=function(b){var c=a.autoReportSettings.autoReportSchedulesList.indexOf(b);c<0?a.autoReportSettings.autoReportSchedulesList.push(b):a.autoReportSettings.autoReportSchedulesList.splice(c,1)}}}}angular.module("Crops").directive("reportAutoreportSchedule",a),a.$inject=["config"]}(),function(){"use strict";function a(a){var b=function(a,b,c){function d(){a.report&&a.report.columns?a.showableColumns=_.chain(a.report.columns).sortBy("position").filter(function(a){return!a.isHidden}).value():a.showableColumns=[]}function e(){if(!a.isColspanSet){var b=$(".ui-sortable-helper"),c=$(".report_table_header_row th").index(b);$(".report-table tbody").addClass("reordering").find("td:nth-child("+(+c+1)+")").attr("colspan","2"),a.isColspanSet=!0}}function f(){$(".report-table tbody").removeClass("reordering").find("td").removeAttr("colspan"),a.isColspanSet=!1;var b=a.showableColumns;g(b,!1),d(),a.$emit("resultsChanged",a.report.title)}function g(a,b){b&&(a=_(a).sortBy("position"));for(var c=0,d=a.length;c<d;c++)a[c].position!=c&&(a[c].position=c)}function h(){for(var b=a.report.columns||[],c=0,d=b.length;c<d;c++)if(b[c].groupable)return!0;return!1}function i(){for(var b=a.report.columns||[],c=0,d=b.length;c<d;c++)if(b[c].isHidden)return!0;return!1}var j=function(){a.isViewer=a.isViewer,a.report=a.report||{},a.report.columns=a.report.columns||[],d(),a.report.data=a.report.data||[],a.report.sort=a.report.sort||{},a.report.groupBy=a.report.groupBy||void 0,a.initialSort=a.report.sort,a.initialGroupBy=a.groupBy,a.groupable=h(),a.hasHidden=i(),a.titleSettings={isEditing:!1},a.tableParams=new c({page:1,count:25,sorting:a.report.sort},{groupBy:a.report.groupBy,total:a.report.data.length,getData:function(c,d){a.report.sort=d.sorting();var e=d.sorting()?b("orderBy")(a.report.data,d.orderBy()):a.report.data,f=e.slice((d.page()-1)*d.count(),d.page()*d.count());c.resolve(f)}})};a.hide=function(b){b.canToggleHidden&&(b.isHidden=!0,d()),a.hasHidden=i()},a.show=function(b){b.isHidden=!1,d(),a.hasHidden=i()},a.sort=function(b){b.sortable&&a.tableParams.sorting(b.sortable,a.tableParams.isSortBy(b.sortable,"asc")?"desc":"asc"),a.$emit("resultsChanged",a.report.title)},a.$watch("report",function(){j()}),a.$watch("report.data",function(b){a.tableParams.total(b.length),a.tableParams.reload(),a.tableParams.page(1)}),a.$watch("report.groupBy",function(b){b&&(a.report.sort={},a.report.sort[b]="asc",a.tableParams.sorting(a.sort)),a.tableParams.settings().groupBy=b,a.tableParams.reload()}),a.beginEditingTitle=function(){a.titleSettings.isEditing=!0,a.titleSettings.newTitle=angular.copy(a.report.title)},a.updateTitle=function(){a.report.title=angular.copy(a.titleSettings.newTitle),delete a.titleSettings.newTitle,a.titleSettings.isEditing=!1,a.$emit("resultsChanged",a.report.title)},a.cancelEditingTitle=function(){delete a.titleSettings.newTitle,a.titleSettings.isEditing=!1},a["export"]=function(b){b.stopPropagation(),a.exporting=!0,a.$emit("xlsExportClicked",b)},a.$on("exportFinished",function(){a.exporting=!1}),a.columnPositionOptions={axis:"x",items:"> .draggable",sort:e,stop:f},a.isColspanSet=!1,a.decreaseColPosition=function(b,c){if(b.stopPropagation(),!(a.showableColumns.length<=1)){var e=a.showableColumns;g(e,!0);for(var f=1,h=e.length;f<h;f++)if(e[f].fieldName===c.fieldName){var i=e[f].position;e[f].position=e[f-1].position,e[f-1].position=i;break}d(),a.$emit("resultsChanged",a.report.title)}},a.sendColToFront=function(b,c){if(b.stopPropagation(),!(a.showableColumns.length<=1)){var e=a.showableColumns;g(e,!0);for(var f=1,h=e.length;f<h;f++)if(e[f].fieldName===c.fieldName){e[f].position=-1;break}g(e,!0),d(),a.$emit("resultsChanged",a.report.title)}},a.increaseColPosition=function(b,c){if(b.stopPropagation(),!(a.showableColumns.length<=1)){var e=a.showableColumns;g(e,!0);for(var f=0,h=e.length-1;f<h;f++)if(e[f].fieldName===c.fieldName){var i=e[f].position;e[f].position=e[f+1].position,e[f+1].position=i;break}d(),a.$emit("resultsChanged",a.report.title)}},a.sendColToBack=function(b,c){if(b.stopPropagation(),!(a.showableColumns.length<=1)){var e=a.showableColumns;g(e,!0);for(var f=0,h=e.length-1;f<h;f++)if(e[f].fieldName===c.fieldName){e[f].position=e.length;break}g(e,!0),d(),a.$emit("resultsChanged",a.report.title)}}};return b.$inject=["$scope","$filter","ngTableParams"],{scope:{report:"=",isViewer:"="},restrict:"E",templateUrl:"{0}/reports/report.results.html?i={1}".format(a.viewRoot),controller:b}}angular.module("Crops").directive("reportResults",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b){function c(){H||(H=!0,b.get(E.getSavedReports,null,!0).then(function(b){G=b,a.$broadcast(F)})["finally"](function(){H=!1}))}function d(){return G}function e(a){return b.get(E.getSavedReport,a)}function f(a,c){return b.get(E.runSavedReport,[a,c]).then(function(a){return a.reportDateTime=new Date,a})}function g(a){return b.post(E.runAdhocReport,null,a).then(function(a){return a.reportDateTime=new Date,a})}function h(a){return b.clearCacheEntry(E.getSavedReports),b.post(E.createSavedReport,null,a)}function i(a){return b.clearCacheEntry(E.getSavedReports),b.post(E.updateSavedReport,a.id,a)}function j(a){return b.clearCacheEntry(E.getSavedReports),b.post(E.saveAsNewReport,a.id,a)}function k(d){return b.clearCacheEntry(E.getSavedReports),b.post(E.hideSavedReport,d).then(function(){I&&(I.isHidden=!0,I.isFavorite=!1,a.$broadcast(J)),c()})}function l(d){return b.clearCacheEntry(E.getSavedReports),b.post(E.unhideSavedReport,d).then(function(){I&&(I.isHidden=!1,a.$broadcast(J)),c()})}function m(a){return b.get(E.getReportType,a)}function n(){return b.get(E.getReportTypes,null,!0)}function o(b,c){e(b).then(function(b){b&&c&&(b.dataLength=c),I=b,a.$broadcast(J)})}function p(){return I}function q(a){return b.post(E.refreshParameters,null,a)}function r(a){return b.post(E.exportAdhocReport,null,a)}function s(a,c){return b.post(E.exportSavedReport,[a,c])}function t(a,c){return b.post(E.generateExportTemplate,[a,c])}function u(a,c){return b.put(E.uploadExportTemplate,[a,c])}function v(a){return b.get(E.getUserShareList,[a])}function w(a){return b.get(E.getOrgShareList,[a])}function x(a,c){return b.put(E.addUserShare,[a,c])}function y(a,c){return b.del(E.removeUserShare,[a,c])}function z(a,c){return b.put(E.addOrgShare,[a,c])}function A(a,c){return b.del(E.removeOrgShare,[a,c])}function B(d){return b.clearCacheEntry(E.getSavedReports),b.post(E.favoriteReport,[d]).then(function(b){I=b,a.$broadcast(J),c()})}function C(d){return b.clearCacheEntry(E.getSavedReports),b.post(E.unfavoriteReport,[d]).then(function(b){I=b,a.$broadcast(J),c()})}function D(d,e){return b.clearCacheEntry(E.getSavedReports),b.post(E.setAutoReportSettings,d,e).then(function(b){return I&&b&&b.id===I.id&&(I.autoReportScheduleSettings=b.autoReportScheduleSettings,a.$broadcast(J),c()),b})}var E={getSavedReports:"/api/savedreports",getSavedReport:"/api/savedreports/{0}",runSavedReport:"/api/savedreports/{0}/run?tzoffset={1}",runAdhocReport:"/api/savedreports/runadhoc",createSavedReport:"/api/savedreports/create",updateSavedReport:"/api/savedreports/{0}/update",saveAsNewReport:"api/savedreports/{0}/saveas",hideSavedReport:"/api/savedreports/{0}/hide",unhideSavedReport:"/api/savedreports/{0}/unhide",getReportTypes:"/api/reporttypes",getReportType:"/api/reporttype/{0}",refreshParameters:"/api/savedReports/refreshParameters",exportAdhocReport:"/api/savedreports/export/xls",exportSavedReport:"/api/savedreports/export/{0}/xls?tzoffset={1}",generateExportTemplate:"/api/savedreports/{0}/generateTemplate?tzoffset={1}",uploadExportTemplate:"/api/savedreports/{0}/template/{1}",getUserShareList:"/api/savedreports/{0}/usersAllowedToShareWith",getOrgShareList:"/api/savedreports/{0}/orgsAllowedToShareWith",addUserShare:"/api/savedreports/{0}/user/{1}",removeUserShare:"/api/savedreports/{0}/user/{1}",addOrgShare:"/api/savedreports/{0}/org/{1}",removeOrgShare:"/api/savedreports/{0}/org/{1}",favoriteReport:"/api/savedreports/{0}/favorite",unfavoriteReport:"/api/savedreports/{0}/unfavorite",setAutoReportSettings:"/api/savedreports/{0}/autoreport"},F="reportService.onSavedReportsChanged",G=null,H=!1,I=null,J="reportService.onCurrentReportChanged",K={getSavedReports:c,savedReports:d,getSavedReport:e,runSavedReport:f,runAdhocReport:g,createSavedReport:h,updateSavedReport:i,saveAsNewReport:j,hideSavedReport:k,unhideSavedReport:l,getReportType:m,getReportTypes:n,setCurrentReport:o,getCurrentReport:p,refreshParameters:q,exportAdhocReport:r,exportSavedReport:s,generateExportTemplate:t,uploadExportTemplate:u,removeExportTemplate:function(a){return u(a,0)},getUserShareList:v,getOrgShareList:w,addUserShare:x,removeUserShare:y,addOrgShare:z,removeOrgShare:A,favoriteReport:B,unfavoriteReport:C,setAutoReportSettings:D,onSavedReportsChanged:F,onCurrentReportChanged:J};return K}angular.module("Crops").service("reportService",a),a.$inject=["$rootScope","fvApi"]}(),function(){"use strict";function a(a,b,c,d,e){a.loading=!0,a.noResults=!1,a.noAccess=!1;var f=new Date,g=f.getTimezoneOffset();c.reportID?b.runSavedReport(c.reportID,g).then(function(d){a.loading=!1,a.report=d;var e=a.report&&a.report.data?a.report.data.length:null;b.setCurrentReport(c.reportID,e)},function(){d.alertFail("Report could not be run."),a.report=null,a.loading=!1,a.noAccess=!0}):(a.report=null,a.loading=!1,a.noResults=!0)}angular.module("Crops").controller("ReportViewerController",a),a.$inject=["$scope","reportService","$stateParams","fvAlertsService","$state"]}(),function(){"use strict";function a(a,b){b.toggleSidenav("close"),a.$on(b.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){b.toggleSidenav()}}angular.module("Crops").controller("ReportViewerLayoutController",a),a.$inject=["$scope","sidenavService"]}(),function(){"use strict";function a(a,b){a.isLoading=!0,a.$on(b.onCurrentReportChanged,function(){a.currentReport=b.getCurrentReport(),a.isLoading=!1})}angular.module("Crops").controller("ReportViewerPageHeaderController",a),a.$inject=["$scope","reportService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){e.getSavedReports()}function k(a){for(var c=!1,d=0;d<b.savedReports.length;d++)if(b.savedReports[d].id===a&&!b.savedReports[d].isHidden){c=!0;break}return c}function l(a){a&&a.id&&i.confirm({text:'Do you want to archive "'+a.displayName+'?"',confirmButtonText:"Archive",isLoadingText:"Archiving"},function(){return e.hideSavedReport(a.id).then(function(){g.alertSuccess("Report Archived")},function(){g.alertFail("Could not archive this report.")})})}function m(a){a&&a.id&&i.confirm({text:'Do you want to unarchive "'+a.displayName+'?"',confirmButtonText:"Unarchive",isLoadingText:"Unarchiving"},function(){return e.unhideSavedReport(a.id).then(function(){g.alertSuccess("Report Unarchived")},function(){g.alertFail("Could not unarchive this report.")})})}b.isLoading=!0,j(),b.currentReport=e.getCurrentReport(),b.$on(e.onSavedReportsChanged,function(){var a=e.savedReports();if(b.savedReports=_.chain(a).reject(function(a){return a.isHidden}).sortBy(function(a){return a.displayName.toLowerCase()}).sortBy(function(a){return a.isFavorite?"a":"z"}).value(),b.currentReport&&!k(b.currentReport.id)){var c=b.savedReports[0].id;f.go("reportLayout.reports",{reportID:c})}b.currentReport=e.getCurrentReport()}),b.$on(e.onCurrentReportChanged,function(){b.currentReport=e.getCurrentReport(),b.isLoading=!1}),b["export"]=function(){b.exporting=!0,b.exportedDoc=void 0,$("#exportModal").modal({backdrop:"static",keyboard:!1,show:!0});var a=new Date;b.currentReport.timezoneOffset=a.getTimezoneOffset(),e.exportSavedReport(b.currentReport.id,b.currentReport.timezoneOffset).then(function(a){b.exportedDoc=a,b.exporting=!1},function(a){$("#exportModal").modal("hide"),b.exporting=!1,a?g.alertFail(a):g.alertFail("Export Failed, Please refresh the page and try again.")})},b.toggleFavorite=function(a){a.stopPropagation(),b.currentReport.isFavorite?e.unfavoriteReport(b.currentReport.id):e.favoriteReport(b.currentReport.id)},b.showAutoReportScheduleModal=function(){h.open({animation:!0,templateUrl:"{0}/reports/report.autoreport.modal.html".format(c.viewRoot),controller:"autoReportScheduleModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"report-modal report-autoreport-modal",resolve:{reportID:function(){return b.currentReport.id},settings:function(){return b.currentReport.autoReportScheduleSettings}}})},b.onCurrentSectionSelected=function(){f.reload()},b.toggleArchive=function(a){a.isHidden?m(a):l(a)},b.isSidenavOpen=!1,b.$on(d.onSidenavChanged,function(a,c){b.isSidenavOpen=c.isSidenavOpen}),b.toggleSidenav=function(a){d.toggleSidenav(a)}}angular.module("Crops").controller("ReportViewerSidenavController",a),a.$inject=["$rootScope","$scope","config","sidenavService","reportService","$state","fvAlertsService","$uibModal","confirmService"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{save:"&",canSave:"&",needsSave:"&?",isSaving:"=?",saveBtnText:"@?",isSavingText:"@?",needsSaveText:"@?",saveTargetName:"@?",triggerEvent:"@?"},templateUrl:"{0}/savebutton/save.button.html".format(a.viewRoot),link:function(d,g,h){function i(a){d.isConfirming=!0,d.exit=a,e.confirm({text:"You have unsaved changes"+(d.canSave()?". Do you want to save?":", but we cannot save because one or more fields appears to be invalid."),showConfirmButton:d.canSave()&&d.save&&angular.isFunction(d.save),confirmButtonText:"Save",isLoadingButtonText:"Saving",showDenyButton:!0,denyButtonText:"Leave Without Saving"},j,k)}function j(){return d.save().then(function(){f.alertSuccess(d.saveTargetName+" saved."),d.exit&&angular.isFunction(d.exit)&&d.exit()},function(a){console.log(a),f.alertFail("There was a problem saving. Please try again.")})["finally"](function(){d.isConfirming=!1,delete d.exit})}function k(){d.exit&&angular.isFunction(d.exit)&&d.exit(),d.isConfirming=!1,delete d.exit}d.btnType=h.type?null:"button",d.saveBtnText=d.saveBtnText||"Saved",d.needsSave=d.needsSave&&angular.isFunction(d.needsSave)?d.needsSave:d.canSave,d.needsSaveText=d.needsSaveText||"Save",d.isSavingText=d.isSavingText||"Saving",d.saveTargetName=d.saveTargetName||"item",d.isSaving="undefined"!=typeof d.isSaving&&d.isSaving,d.isConfirming="undefined"!=typeof d.isConfirming&&d.isConfirming,b.saveButtonCount++,b.saveButtonCount>1&&console.error("Unexpected: More than one save button!"),b.ignoreStateChangeStart=function(){return d.needsSave()},d.overrideConfirm=!1;var l=window.onbeforeunload;window.onbeforeunload=function(a){if(d.needsSave()){var b="You have unsaved changes on this page. Are you sure you want to leave?";return a.returnValue=b,b}},d.$on(a.globalSaveHotkeyPressed,function(a,b,c){d.canSave&&d.needsSave&&(d.isConfirming?j().then(function(){e.close()}):d.save())}),d.$on("$stateChangeStart",function(a,e,f,g,h,j){!d.overrideConfirm&&d.needsSave()&&(a.preventDefault(),i(function(){d.overrideConfirm=!0,b.ignoreStateChangeStart=!1,c.go(e.name,f)}))}),d.$on("onExitingSavableView",function(a,b){b&&angular.isFunction(b)&&(d.needsSave()?i(b):b())}),d.$on("$destroy",function(){b.saveButtonCount--,0===b.saveButtonCount&&(b.ignoreStateChangeStart=!1,window.onbeforeunload=l)})}}}angular.module("Crops").directive("saveButton",a),a.$inject=["config","$rootScope","$state","$location","confirmService","fvAlertsService"]}(),function(){"use strict";function a(a,b){function c(a,c){return b.post(f.updateProjectHashtags,[a],{hashtags:c})}function d(a,c){return b.post(f.updateDocHashtags,[a],{hashtags:c})}function e(a,c,d){return b.get(f.searchHashtags,[a,c,d])}var f={updateProjectHashtags:"/api/projects/{0}/hashtags",updateDocHashtags:"/api/docs/{0}/hashtags",searchHashtags:"/api/hashtags/{0}?q={1}&type={2}"},g=!1,h={updateProjectHashtags:c,updateDocHashtags:d,searchHashtags:e,isLoading:function(){return g}};return h}angular.module("Crops").service("hashtagService",a),a.$inject=["$rootScope","fvApi","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{hashtags:"=",projectId:"=",docId:"=",isAddingHashtag:"=?",minimizeAddBtn:"=?"},replace:!0,templateUrl:"{0}/search/hashtags/hashtag.view.html".format(a.viewRoot),link:function(a){function c(){b.updateDocHashtags(a.docId,h).then(function(b){a.hashtags=b.hashtags||[],h=[],a.reset()})["finally"](function(){a.isUpdating=!1})}a.isAddingHashtag=!1,a.isInputFocused=!1,a.isUpdating=!1;var h=[];a.save=function(){a.newHashtag&&!a.isUpdating&&(a.isUpdating=!0,h=a.hashtags?angular.copy(a.hashtags):[],h.unshift(a.newHashtag),c())},a["delete"]=function(b,d){if(b.preventDefault(),b.stopPropagation(),!a.isUpdating){a.isUpdating=!0,h=a.hashtags?angular.copy(a.hashtags):[];for(var e=-1,f=0;f<h.length;f++)if(h[f]===d){e=f;break}f>-1&&(h.splice(f,1),c())}},a.startAddingHashtag=function(){a.isAddingHashtag=!0,a.$broadcast("onAddingHashtag")},a.reset=function(){a.newHashtag="",a.isAddingHashtag=!1,a.isInputFocused=!1},a.getHashtags=function(a){var c=e.project()?e.project().orgID:null;return c?b.searchHashtags(c,a,"doc").then(function(a){return a}):null},a.removeOctothorp=function(a){return a.slice(1)};var i;a.filterOrSearch=function(b){a.projectId&&!i?i=g(function(){d.url("/project/"+a.projectId+"/docs/?hashtag=%23"+a.removeOctothorp(b)),f.closeDocsHashtagsModal()},250):(g.cancel(i),d.url("/search?q=%23"+a.removeOctothorp(b)),f.closeDocsHashtagsModal())}}}}angular.module("Crops").directive("hashtagView",a),a.$inject=["config","hashtagService","$stateParams","$location","projectService","docService","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e){return{restrict:"E",scope:{hashtags:"=",projectId:"=",isAddingHashtag:"=?"},replace:!0,templateUrl:"{0}/search/hashtags/project.hashtag.view.html".format(a.viewRoot),link:function(a){function f(){a.hashtags&&(a.autoHashtags=_(a.hashtags).filter(function(a){return a.isAutoHashtag}),a.userHashtags=_(a.hashtags).filter(function(a){return!a.isAutoHashtag}))}function g(){b.updateProjectHashtags(c.projectID,h).then(function(b){a.hashtags=b.hashtags||[],f(),h=[],a.reset()})["finally"](function(){a.isUpdating=!1})}a.isAddingHashtag=!1,a.isInputFocused=!1,a.isUpdating=!1;var h=[];a.save=function(){a.newHashtag&&!a.isUpdating&&(a.isUpdating=!0,h=a.hashtags?angular.copy(a.hashtags):[],h.unshift(a.newHashtag),g())},a["delete"]=function(b,c){if(b.preventDefault(),b.stopPropagation(),!c.isAutoHashtag&&!a.isUpdating){a.isUpdating=!0,h=a.hashtags?angular.copy(a.hashtags):[];for(var d=-1,e=0;e<h.length;e++)if(h[e].hashtag===c.hashtag){d=e;break}e>-1&&(h.splice(e,1),g())}},a.startAddingHashtag=function(){a.isAddingHashtag=!0,a.$broadcast("onAddingHashtag")},a.reset=function(){a.newHashtag={hashtag:"",isAutoHashtag:!1},a.isAddingHashtag=!1,a.isInputFocused=!1},a.getHashtagsForTypeahead=function(a){var c=e.project()?e.project().orgID:null;return c?b.searchHashtags(e.project().orgID,a,"project").then(function(a){return a}):null},a.removeOctothorp=function(a){return a?a.slice(1):""},a.search=function(b){d.url("/search?q=%23"+a.removeOctothorp(b.hashtag))},f()}}}angular.module("Crops").directive("projectHashtagView",a),a.$inject=["config","hashtagService","$stateParams","$location","projectService"]}(),function(){"use strict";function a(a,b,c,d,e){return{restrict:"E",templateUrl:"{0}/search/hashtags/taglist.input.html".format(d.viewRoot),scope:{tagList:"=",isHashtags:"="},link:function(a,b){function d(){a.tagList.pop()}function f(){a.newTag=""}function g(b){return a.isHashtags?e.hashtagize(b):b}a.newTag="";var h={backspace:8,enter:13,comma:188,space:32};a.rmTag=function(b,d){b.stopPropagation();var e=a.tagList.indexOf(d);e>-1&&a.tagList.splice(e,1),c.search().hashtag&&c.search().hashtag===encodeURI(d)&&c.search({hashtag:null})},a.addTag=function(){var b=g(a.newTag);b&&(a.tagList.push(b),a.tagList=_.uniq(a.tagList)),f()},b.find("input").bind("keydown keypress",function(b){b.which===h.enter||b.which===h.comma||b.which===h.space?(b.preventDefault(),a.addTag()):b.which===h.backspace&&!a.newTag&&a.tagList.length&&(b.preventDefault(),d()),a.$apply()}),a.focusOnInput=function(){a.$broadcast("focusOnTagListInput")},a.removeOctothorp=function(a){return a.slice(1)}}}}angular.module("Crops").directive("taglistInput",a),a.$inject=["fvApi","$rootScope","$location","config","fvUtils"]}(),function(){"use strict";function a(a,b,c,d,e){return{restrict:"E",scope:{},replace:!0,templateUrl:"{0}/search/intraproject.search.html".format(a.viewRoot),link:function(a){function b(){a.$broadcast("clearSearchInput")}a.results=null,a.isLoading=!1,a.loadingMore=!1;var f=$("#intraprojectSearchModal");a.$on(c.onIntraProjectSearchOpened,function(c,d){a.projectName=d.projectName,a.projectAvatar=d.projectAvatar,f.modal("show"),b(),e(function(){a.$broadcast("focusOnSearchInput")})}),a.$on(c.onIntraProjectSearchClosed,function(){f.modal("hide")}),a.$on(c.onSearchResults,function(b,d){var e=angular.copy(d);a.results&&e&&a.results.hasMore&&e.page-a.results.page===1&&(e.hits=a.results.hits.concat(e.hits)),a.results=e,a.loadingMore=a.isLoading=c.isLoading()}),a.redirectToProject=function(a){d.go("projectLayout.project.activity",{projectID:a.id})},a.more=function(){a.results.hasMore&&!a.loadingMore&&(a.loadingMore=!0,c.more())},f.on("hidden.bs.modal",function(){delete a.results,b()})}}}angular.module("Crops").directive("intraprojectSearch",a),a.$inject=["config","fvApi","searchService","$state","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e){a.results=null,a.isLoading=e.search()&&e.search().q&&e.search().q.trim(),a.loadingMore=!1,a.$on(c.onSearchResults,function(b,d){var e=angular.copy(d);a.results&&e&&a.results.hasMore&&e.page-a.results.page===1&&(e.hits=a.results.hits.concat(e.hits)),a.results=e,a.loadingMore=a.isLoading=c.isLoading()}),a.redirectToProject=function(a){d.go("projectLayout.project.activity",{projectID:a.id})},a.more=function(){a.results.hasMore&&!a.loadingMore&&(a.loadingMore=!0,c.more())}}angular.module("Crops").controller("SearchController",a),a.$inject=["$scope","fvApi","searchService","$state","$location"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{restrict:"E",scope:{isIntraProject:"=",projectName:"=",projectAvatar:"="},replace:!0,templateUrl:"{0}/search/search.input.html".format(a.viewRoot),link:function(a){function c(){angular.element(e).unbind("resize",j)}function h(){f.search()&&f.search().q&&(a.searchRequest.q=f.search().q,a.searchRequest.archived=f.search().archived&&"false"!==f.search().archived&&f.search().archived!==!1,a.searchRequest.projects="false"!==f.search().projects&&f.search().projects!==!1,a.searchRequest.notes="false"!==f.search().notes&&f.search().notes!==!1,a.searchRequest.tasks="false"!==f.search().tasks&&f.search().tasks!==!1,a.searchRequest.emails="false"!==f.search().emails&&f.search().emails!==!1,a.searchRequest.faxes="false"!==f.search().faxes&&f.search().faxes!==!1,a.searchRequest.texts="false"!==f.search().texts&&f.search().texts!==!1,a.searchRequest.docs="false"!==f.search().docs&&f.search().docs!==!1,a.searchRequest.people="false"!==f.search().people&&f.search().people!==!1,a.searchRequest.calendarEvents="false"!==f.search().calendarEvents&&f.search().calendarEvents!==!1,a.searchRequest.other="false"!==f.search().other&&f.search().other!==!1,a.searchRequest.projectID=a.isIntraProject?b.projectID:null,a.isLoading||a.search())}function i(){a.searchRequest={q:"",archived:!1,projects:!a.isIntraProject,notes:!0,tasks:!0,emails:!0,texts:!0,faxes:!0,docs:!0,people:!0,calendarEvents:!0,other:!0,projectID:a.isIntraProject?b.projectID:null,sort:"Relevance"}}function j(){console.log(e.innerWidth),k()}function k(){var b=$("#panel-search-options").height();b?(0===a.panelHeight||a.panelHeight&&a.panelHeight!==b)&&(a.panelHeight=b,$("#search-results-container").css("margin-top",b+25+"px")):(a.panelHeight=0,$("#search-results-container").removeAttr("style"))}i(),a.optionsPanelSettings={isClosed:!0},a.panelHeight=0,a.$watch("optionsPanelSettings.isClosed",function(){g(function(){k()},350),a.optionsPanelSettings.isClosed?c():angular.element(e).bind("resize",j)}),a.$on("$destroy",function(){c()}),$("#intraprojectSearchModal").on("hidden.bs.modal",function(){a.optionsPanelSettings={isClosed:!0},a.$apply()});var l=["projects","notes","tasks","emails","faxes","texts","docs","people","calendarEvents","other"];a.resetOptions=function(){a.searchRequest.archived=!1,a.searchRequest.projects=!0,a.searchRequest.notes=!0,a.searchRequest.tasks=!0,a.searchRequest.emails=!0,a.searchRequest.faxes=!0,a.searchRequest.texts=!0,a.searchRequest.docs=!0,a.searchRequest.people=!0,a.searchRequest.other=!0,a.searchRequest.calendarEvents=!0,a.searchRequest.sort="Relevance"},a.isLoading=!1,a.results=null;var m,n=null;a.search=function(){a.isLoading=!0,a.isIntraProject||f.search(a.searchRequest),angular.equals(a.searchRequest,n)||(d.search(a.searchRequest,0),n=angular.copy(a.searchRequest))};var o=function(b,c){null!==b&&b!==c&&(m?(g.cancel(m),m=g(function(){a.search()},1e3)):m=g(function(){a.search()},500))};a.$watch("searchRequest.archived",o),a.$watch("searchRequest.projects",o),a.$watch("searchRequest.notes",o),a.$watch("searchRequest.tasks",o),a.$watch("searchRequest.faxes",o),a.$watch("searchRequest.emails",o),a.$watch("searchRequest.texts",o),a.$watch("searchRequest.docs",o),a.$watch("searchRequest.people",o),a.$watch("searchRequest.calendarEvents",o),a.$watch("searchRequest.other",o),a.$watch("searchRequest.sort",o),a.$on("$locationChangeSuccess",function(){!a.isIntraProject&&f.path().match(/search/gi)&&h()},!0),a.$on(d.onSearchResults,function(b,c){a.isLoading=d.isLoading(),a.results=c}),a.isIntraProject||h(),a.$on("clearSearchInput",function(a,b){i(),n=null}),a.cannotDeselectAnother=function(){return+a.searchRequest.projects+a.searchRequest.notes+a.searchRequest.tasks+a.searchRequest.emails+a.searchRequest.texts+a.searchRequest.docs+a.searchRequest.faxes+a.searchRequest.people+a.searchRequest.calendarEvents+a.searchRequest.other<2},a.toggle=function(b){a.searchRequest[b]=!a.searchRequest[b]},a.onlySelectThis=function(b){_(l).each(function(c){a.searchRequest[c]=c===b})},g(function(){a.isIntraProject||a.$broadcast("focusOnSearchInput")})}}}angular.module("Crops").directive("searchInput",a),a.$inject=["config","$stateParams","$state","searchService","$window","$location","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e){return{restrict:"E",scope:{hit:"=",isIntraProject:"="},templateUrl:"{0}/search/search.result.breadcrumbs.html".format(a.viewRoot),link:function(a){a.clickHandler=function(b,c){c.stopPropagation(),a.isIntraProject&&d.closeIntraProjectSearch(),e.$broadcast("onBreadcrumbClicked")}}}}angular.module("Crops").directive("searchResultBreadcrumbs",a),a.$inject=["config","$state","$location","searchService","$rootScope"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{hit:"=",isIntraProject:"="},replace:!0,templateUrl:"{0}/search/search.result.html".format(a.viewRoot),link:function(a){function d(){return(new Date).getTimezoneOffset()}a.gotoUrl=function(d,e){e.stopPropagation(),a.isIntraProject&&c.closeIntraProjectSearch(),b.url(d.lastCrumb.linkUrl.replace("#",""))},a.hit&&a.hit.result&&"CalendarEvent"===a.hit.result.searchResultType&&(a.hit.source&&(a.hit.source.isAllDay&&(a.hit.source.startDate=moment.utc(a.hit.source.startDate).add(d(),"minutes").format("MM/DD/YYYY"),a.hit.source.endDate=moment.utc(a.hit.source.endDate).add(d(),"minutes").format("MM/DD/YYYY")),a.hit.source.startDate=moment(a.hit.source.startDate).toDate(),a.hit.source.endDate=moment(a.hit.source.endDate).toDate(),a.hit.source.endDate=a.hit.source.isAllDay?moment(moment(a.hit.source.endDate).subtract(23,"h").format("YYYY-MM-DD HH:mm")).toDate():a.hit.source.endDate),a.settings={startsEndsSameDay:a.hit.source&&a.hit.source.startDate&&a.hit.source.endDate&&moment(a.hit.source.startDate).isSame(a.hit.source.endDate,"day")})}}}angular.module("Crops").directive("searchResult",a),a.$inject=["config","$location","searchService","fvUtils"]}(),function(){"use strict";function a(a,b,c){function d(){e(h,i+1)}function e(c,d){return h=c,i=d,c.q&&c.q.trim()?(k=!0,0===d&&a.$broadcast(l.onSearchResults,{}),b.post(j.search,[d],c).then(function(b){k=!1,a.$broadcast(l.onSearchResults,b)},function(){k=!1,a.$broadcast(l.onSearchResults,{})})):(k=!1,a.$broadcast(l.onSearchResults,{}),null)}function f(b,c){a.$broadcast(l.onIntraProjectSearchOpened,{projectName:b,projectAvatar:c})}function g(){a.$broadcast(l.onIntraProjectSearchClosed)}var h,i,j={search:"/api/search?page={0}"},k=!1,l={search:e,more:d,openIntraProjectSearch:f,closeIntraProjectSearch:g,onSearchResults:"searchService.onSearchResults",onIntraProjectSearchOpened:"searchService.onIntraProjectSearchOpened",onIntraProjectSearchClosed:"searchService.onIntraProjectSearchClosed",isLoading:function(){return k}};return l}angular.module("Crops").service("searchService",a),a.$inject=["$rootScope","fvApi","$timeout"]}(),function(){"use strict";function a(a){function b(b,c){a.$broadcast(b,c)}var c={broadcast:b};return c}angular.module("Crops").service("broadcastService",a),a.$inject=["$rootScope"]}(),function(){"use strict";function a(a){function b(){var b=a.location.hostname.split(".");return b&&b.length>1&&"ca"===b[b.length-1]}var c=Crops.ViewPath,d=Crops.AdminPath,e=Crops.AdvancedPath,f=b(),g=/^(?:(?:(?:0?[13578]|1[02])(\/|-|\.)31)\1|(?:(?:0?[1,3-9]|1[0-2])(\/|-|\.)(?:29|30)\2))(?:(?:1[6-9]|[2-9]\d)\d{2})$|^(?:0?2(\/|-|\.)29\3(?:(?:(?:1[6-9]|[2-9]\d)(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:(?:0?[1-9])|(?:1[0-2]))(\/|-|\.)(?:0?[1-9]|1\d|2[0-8])\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/,h=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/,i="https://filevine-dev-images.s3.amazonaws.com/avatar-user-placeholder.png",j=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,k=/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+#~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)$/i,l=/^((([A-Za-z]{3,9}:(?:\/\/))(?:www.|[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+)((?:\/[\+#~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)$/i,m=/^([A-Za-z]{3,9}:(?:\/\/))/i,n=/^@\w+/,o="< > \" \\ / | * ' ? : ",p=/[<>"'\\\/|*?:]+/,q=function(a){
return!jQuery.isArray(a)&&a-parseFloat(a)+1>=0},r={type:"newFeature",expirationDate:"2018-09-29"};return{viewRoot:c,adminPath:d,advancedPath:e,isCanada:f,dateRegex:g,dateISORegex:h,emailRegex:j,urlRegex:k,urlWithProtocolRegex:l,hasUrlProtocolRegex:m,usernameRegex:n,folderNameInvalidCharacters:o,folderNameInvalidCharactersRegex:p,defaultPicture:i,isNumber:q,messages:{showPerson:"showPerson"},globalSaveHotkeyPressed:"GlobalSaveHotkeyPressed",getBannerAlert:function(){return r}}}angular.module("Crops").service("config",a),a.$inject=["$window"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a,b){return function(d){console.timeEnd(a),d.data?(h(d),d.data.success?(d.data.projectID&&d.data.projectVitals&&c.onVitalsUpdated(d.data.projectID,d.data.projectVitals),b.resolve(d.data.data)):(console.debug("FAILED: "+a+": "+d.data.message),b.reject(d.data.message))):(console.debug("FAILED: "+a+": No response data"),console.debug(d),b.reject("No response data"))}}function h(a){if(a.data.version){if(!r)return r=angular.copy(a.data.version),void console.debug("Version",p(r));_.isEqual(r,a.data.version)||(console.debug("Old Version:",p(r)),console.debug("New Version:",p(a.data.version)),console.debug("Reloading..."),r=angular.copy(a.data.version),location.reload(!0))}}function i(a,b){return function(c){console.timeEnd(a),b.reject(c.statusText),console.warn("FAILED: "+a+"..."),console.warn(c),403!==c.status||s.suppress403errors||(e.alertFail("You do not have permission to view this.",2500),location.href="/")}}function j(c,d,e){var h=b.defer();if(c=f.replaceParams(c,d),console.time(c),e){var j=q.get(c);j&&console.debug("USING CACHED! "+c)}return a.get(c,{cache:e}).then(g(c,h),i(c,h)),h.promise}function k(a,b){a=f.replaceParams(a,b),q.remove(a),console.debug("Removed Cache entry for"+a)}function l(c,d,e){var h=b.defer();c=f.replaceParams(c,d);var j={url:c,method:"POST",data:e};return o(j),console.time(c),a(j).then(g(c,h),i(c,h)),h.promise}function m(c,d,e){var h=b.defer();c=f.replaceParams(c,d);var j={url:c,method:"PUT"};return"undefined"!=typeof e&&(j.data=e),o(j),console.time(c),a(j).then(g(c,h),i(c,h)),h.promise}function n(c,d){var e=b.defer();c=f.replaceParams(c,d),console.time(c);var h={url:c,method:"DELETE"};return o(h),a(h).then(g(c,e),i(c,e)),e.promise}function o(a){Crops.signalrSessionID&&(a.headers={SignalRSessionID:Crops.signalrSessionID})}function p(a){return a.major+"."+a.minor+"."+a.build+"."+a.revision}var q=d.get("$http"),r=null,s={get:j,post:l,put:m,del:n,version:function(){return p(r)},suppress403errors:!1,clearCacheEntry:k};return s}angular.module("Crops").service("fvApi",a),a.$inject=["$http","$q","projectVitalsService","$cacheFactory","fvAlertsService","fvUtils"]}(),function(){"use strict";function a(a){function b(a){var b=0;if(a)for(var c=0;c<a.length;c++)(angular.isNumber(a[c].amount)||/,/gi.test(a[c].amount))&&("string"==typeof a[c].amount&&(a[c].amount=a[c].amount.replace(/,/gi,"")),b+=parseFloat(a[c].amount));return b}function c(a,b){if(a&&a.length&&b&&b.id){for(var c=-1,d=0;d<a.length;d++)if(b.id===a[d].id){c=d;break}c!==-1&&(a[c]=b)}}function d(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c].id===b)return void a.splice(c,1)}function e(a,b){return"undefined"==typeof b||null===b?a:b.constructor===Array?a.replace(/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?encodeURIComponent(b[c]):a}):a.format(encodeURIComponent(b))}function f(a,b){var c=g(a),d=g(b);if(d&&d.isValid()||!c||!c.isValid())return null;var e={text:"",cssClass:""},f=i(),h=c.diff(f,"days");return e.days=h,h<0?(e.text="Overdue",e.cssClass="overdue"):(e.text=0===h?"Due Today":1===h?"Due Tomorrow":h<7?"Due "+j(f,h):h+" Days to go",e.cssClass=0===h?"today":1===h?"tomorrow":h<7?"this-week":"days"),e}function g(b){var c=new RegExp(a.dateRegex);return b?c.test(b)?moment.utc(h(b)):moment.utc(b):null}function h(a){var b=a.split(/\/|-|\./);return b[2]+"-"+k(b[0])+"-"+k(b[1])+"T00:00:00Z"}function i(){var a=moment().year(),b=moment().month(),c=moment().date(),d=a+"-"+k(b+1)+"-"+k(c)+"T00:00:00Z";return moment.utc(d)}function j(a,b){return a.add(b,"d").format("ddd")}function k(a){var b="00"+a;return b.substring(b.length-2)}function l(a){if(!a)return"";for(var b=a.trim().replace(/\s/g,"-").replace(/[^a-zA-Z0-9-]/g,"");"-"===b.charAt(0);)b=b.substring(1);for(;"-"===b.charAt(b.length-1);)b=b.substring(0,b.length-1);return b?"#"+b:""}function m(a){return a&&(a=_(a).compact()).length?1===a.length?a[0]:[a.slice(0,-1).join(", "),a.slice(-1)[0]].join(a.length>2?", and ":" and "):""}function n(a){return a&&(a=_(a).compact()).length?1===a.length?a[0]:[a.slice(0,-1).join(", "),a.slice(-1)[0]].join(", "):""}return{totalAmount:b,removeFromList:d,replaceInList:c,replaceParams:e,getDueDateTag:f,getDateOnlyMoment:g,hashtagize:l,arrayToCommaList:m,arrayToCommaListNoAnd:n}}angular.module("Crops").service("fvUtils",a),a.$inject=["config"]}(),function(){"use strict";function a(){function a(a){if(!a)return{};var f,h,i,j,k,l,m,n,o=[],p="",q=[],r="",s="",t={};for(a=a.trim(),h=a.split(" "),f=0;f<h.length;f++)"("!==h[f].charAt(0)&&o.push(h[f]);for(i=o.length,j=b(o[0]),k=c(o[i-1]),l=j?1:0,m=k?i-1:i,n=m-1,f=l;f<n;f++){var u=o[f];if(d(u)&&f!==l){n=f;break}e(u)?q.push(u.toUpperCase()):q.push(g(u))}if(p=q[0],q.length>1&&(r=q.splice(1).join(" ")),m-l>1)for(f=n;f<m;f++)s+=" "+g(o[f]);else p=g(o[f]);return t.salutation=j,t.firstName=p.trim(),t.middleName=r.trim(),t.lastName=s.trim(),t.suffix=k,t}function b(a){return a=a.replace(".","").toLowerCase(),"mr"==a||"master"==a||"mister"==a?"Mr.":"mrs"==a?"Mrs.":"miss"==a||"ms"==a?"Ms.":"dr"==a?"Dr.":"rev"==a?"Rev.":"fr"==a&&"Fr."}function c(a){a=a.replace(".","");for(var b=0;b<i.length;b++)if(i[b].toLowerCase()===a.toLowerCase())return i[b];return!1}function d(a){return a=a.toLowerCase(),j.indexOf(a)>=0}function e(a){return 1===a.length||2===a.length&&"."===a[1]}function f(a){return a!==a.toLowerCase()&&a!==a.toLowerCase}function g(a){return a=h("-",a),a=h(".",a)}function h(a,b){for(var c=b.split(a),d=[],e=0;e<c.length;e++){var g=f(c[e])?c[e]:c[e].charAt(0).toUpperCase()+c[e].slice(1);d.push(g)}return d.join(a)}var i=["I","II","III","IV","V","Senior","Junior","Jr","Sr","PhD","APR","RPh","PE","MD","MA","DMD","CME"],j=["vere","von","van","de","del","della","di","da","pietro","vanden","du","st.","st","la","ter"],k={splitName:a};return k}angular.module("Crops").service("nameService",a)}(),function(){"use strict";function a(a,b,c){function d(){i?b.$broadcast(h):a.get(g.getRoles).then(function(a){i=a,b.$broadcast(h)})}function e(){return i}function f(b,d){return a.post(g.changeRolesOnTeamMember,[c.projectID,b],{roleIDs:d})}var g={getRoles:"/api/roles",changeRolesOnTeamMember:"/api/projects/{0}/team/changeroles/{1}"},h="roleService.onRoleListChanged",i=null,j={loadRoles:d,roleList:e,onRoleListChanged:h,changeRoles:f};return j}angular.module("Crops").service("roleService",a),a.$inject=["fvApi","$rootScope","$stateParams"]}(),function(){"use strict";function a(a,b){function c(){a.get(k.getSetting,"uiSettings").then(function(a){a&&(l=JSON.parse(a),b.$broadcast(m))})}function d(){l&&a.post(k.postSetSetting,"uiSettings",JSON.stringify(JSON.stringify(l)))}function e(){return!!l.global&&l.global.noteBottomMenuState}function f(a){l.global||(l.global={}),l.global.noteBottomMenuState=a,d()}function g(){return!!l.global&&l.global.docSort}function h(a){l.global||(l.global={}),l.global.docSort=a,d()}function i(a){return a&&l[a]?l[a]:{}}function j(a,b){a&&(l[a]=b,d())}var k={getSetting:"/api/currentuser/setting/{0}",postSetSetting:"/api/currentuser/setting/{0}"},l={},m="uiSettingsService.onUiSettingsChanged",n={getNoteBottomMenuState:e,setNoteBottomMenuState:f,onUiSettingsChanged:m,getDocSort:g,setDocSort:h,getCustomSectionUiSettings:i,setCustomSectionUiSettings:j};return c(),n}angular.module("Crops").service("uiSettingsService",a),a.$inject=["fvApi","$rootScope"]}(),function(){"use strict";function a(a,b){a.currentUser=b.currentUser(),b.getAuthDetails(),a.$on(b.onCurrentUserChanged,function(){a.currentUser=b.currentUser(),b.getAuthDetails()}),a.$on(b.onAuthDetailsChanged,function(){a.authDetails=b.authDetails(),console.log(a.authDetails)})}angular.module("Crops").controller("UserAccountController",a),a.$inject=["$scope","currentUserService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(b,c,d){a.form.totpVerificationForm[b].$setValidity(c,d)}function g(b,c,d){a.form.phoneVerificationForm[b].$setValidity(c,d)}function h(){a.verificationDetails.barcodeUrl=null,a.verificationDetails.secretKey=null,a.verificationDetails.totpVerificationCode="",a.resetTotpCodeValidity(),a.form.totpVerificationForm.$setPristine(),a.status.isSettingUpTotp=!1}function i(){a.verificationDetails.phoneNumber="",a.verificationDetails.phoneVerificationCode="",a.resetPhoneCodeValidity(),a.resetPhoneNumberValidity(),a.form.phoneVerificationForm.$setPristine(),a.status.isSettingUpPhone=!1,a.status.isSendingSms=!1,a.status.hasSentSms=!1}d&&(a.authDetails=d),a.$on(c.onAuthDetailsChanged,function(){a.authDetails=c.authDetails()}),a.loading={},a.$on(c.onLoadingChanged,function(){a.loading=c.isLoading()}),a.status={isSettingUpTotp:!1,isLoadingTotpDetails:!1,isSettingUpPhone:!1,isEditingPhoneNumber:!1,isSendingSms:!1,hasSentSms:!1},a.form={totpVerificationForm:{},phoneVerificationForm:{}},a.verificationDetails={totpVerificationCode:"",phoneVerificationCode:"",phoneNumber:""};var j,k,l,m,n,o;a.startSettingUpTotp=function(){a.status.isSettingUpTotp=!0,a.status.isLoadingTotpDetails=!0,c.startVerifyTotpAuthentication().then(function(b){a.verificationDetails.barcodeUrl=b.barcodeUrl,a.verificationDetails.secretKey=b.secretKey,a.status.isLoadingTotpDetails=!1,a.$broadcast("onSettingUpTotp")},function(){a.status.isLoadingTotpDetails=!1})},a.cancelSettingUpTotp=function(){h()},a.canVerifyTotp=function(){return!a.loading.isVerifyingTotp&&a.verificationDetails.totpVerificationCode&&a.verificationDetails&&a.verificationDetails.secretKey},a.verifyTotp=function(){a.canVerifyTotp()&&c.enableTotpAuthentication(a.verificationDetails.totpVerificationCode,a.verificationDetails.secretKey)},a.$on(c.onCheckSuccess.totp,function(){h()}),a.$on(c.onCheckFail.totp,function(b,c){f("totpVerificationCode","verificationCode",!1),o=angular.copy(a.verificationDetails.totpVerificationCode),l=a.$watch("verificationDetails.totpVerificationCode",function(b,c){o&&c===o&&b!==c&&a.resetTotpCodeValidity()})}),a.resetTotpCodeValidity=function(){f("totpVerificationCode","verificationCode",!0),angular.isFunction(l)&&(l(),l=null)},a.removeTotp=function(){c.removeTotpAuthentication()},a.startSettingUpPhone=function(){a.status.isSettingUpPhone=!0,a.startEditingPhoneNumber()},a.startEditingPhoneNumber=function(){a.status.hasSentSms=!1,a.status.isSendingSms=!1,a.status.isEditingPhoneNumber=!0,e(function(){a.$broadcast("onEditingPhoneNumber")})},a.validatePhoneNumber=function(){var b=a.verificationDetails.phoneNumber,c=!b||10===b.replace(/\D/g,"").length;g("phoneNumber","phone",c),c||(m=angular.copy(a.verificationDetails.phoneNumber),j=a.$watch("verificationDetails.phoneNumber",function(b,c){m&&c===m&&b!==c&&a.resetPhoneNumberValidity()}))},a.resetPhoneNumberValidity=function(){g("phoneNumber","phone",!0),angular.isFunction(j)&&(j(),j=null)},a.canSendVerificationText=function(){return a.form.phoneVerificationForm&&a.form.phoneVerificationForm.phoneNumber&&a.form.phoneVerificationForm.phoneNumber.$valid&&a.verificationDetails.phoneNumber&&!a.status.isVerifyingPhone&&!a.status.isSendingSms},a.startVerifyPhoneNumber=function(){a.validatePhoneNumber(),a.form.phoneVerificationForm.phoneNumber.$valid&&(a.status.isEditingPhoneNumber=!1,a.status.isSendingSms=!0,c.startVerifyPhoneNumber(a.verificationDetails.phoneNumber).then(function(){a.status.isSendingSms=!1,a.status.hasSentSms=!0,a.$broadcast("onSmsSent")},function(b){a.status.isSendingSms=!1}))},a.cancelSettingUpPhone=function(){i()},a.canVerifyPhone=function(){return!a.status.isEditingPhoneNumber&&!a.status.isSendingSms&&a.status.hasSentSms&&!a.loading.isVerifyingPhone&&a.verificationDetails.phoneNumber&&a.verificationDetails.phoneVerificationCode},a.verifyPhone=function(){a.canVerifyPhone&&c.confirmPhoneNumberChange(a.verificationDetails.phoneVerificationCode,a.verificationDetails.phoneNumber)},a.removePhone=function(){c.removePhoneNumber().then(function(){a.status.isSettingUpPhone=!1,a.status.isEditingPhoneNumber=!1,a.status.hasSentSms=!1})},a.$on(c.onCheckSuccess.phone,function(){i()}),a.$on(c.onCheckFail.phone,function(b,c){g("phoneVerificationCode","verificationCode",!1),n=angular.copy(a.verificationDetails.phoneVerificationCode),k=a.$watch("verificationDetails.phoneVerificationCode",function(b,c){n&&c===n&&b!==c&&a.resetPhoneCodeValidity()})}),a.resetPhoneCodeValidity=function(){g("phoneVerificationCode","verificationCode",!0),angular.isFunction(k)&&(k(),k=null)},a.canToggle2Factor=function(){return!a.loading.isToggling2Factor&&(a.authDetails.phoneNumber||a.authDetails.isTotpAuthenticationEnabled)},a.toggle2Factor=function(){a.canToggle2Factor()&&(a.authDetails.twoFactor?c.enable2Factor():c.disable2Factor())},a.close=function(){b.dismiss("close")},a.$on("$stateChangeSuccess",a.close)}angular.module("Crops").controller("twoFactorSetupModalController",a),a.$inject=["$scope","$uibModalInstance","currentUserService","authDetails","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{authDetails:"=",form:"="},templateUrl:"{0}/setup/currentuser/account/user.change.email.html".format(b.viewRoot),link:function(b){function d(a,c,d){b.form[a].$setValidity(c,d)}function e(){b.emailPassword="",b.form.fvPassword.$setPristine()}function f(){b.isJustSaved=!0,c(function(){b.isJustSaved=!1},4e3)}b.isCheckingEmail=!1,b.isCheckFail=!1;var g="";b.isSavingEmail=!1,b.isJustSaved=!1,b.isSaveFail=!1,b.isAskingForPassword=!1,b.errorMessage="",b.currentUser=a.currentUser(),b.email=angular.copy(b.currentUser.email),b.$on(a.onCurrentUserChanged,function(){b.currentUser=a.currentUser(),b.email=angular.copy(b.currentUser.email)}),b.$on(a.onLoadingChanged,function(){b.isSavingEmail=a.isLoading().isSavingEmail,b.isCheckingEmail=a.isLoading().isCheckingEmail}),b.checkEmail=function(){b.authDetails.hasPassword&&!b.form.fvChangeEmail.$error.required&&b.email!==b.currentUser.email&&a.checkEmail(b.email)},b.$on(a.onCheckSuccess.email,function(a,c){b.isAskingForPassword=!0,b.email=c.email,g=c.email,b.resetEmailError()}),b.$on(a.onCheckFail.email,function(){b.isCheckFail=!0}),b.$on(a.onValidFail.email,function(a,c){b.errorMessage=c.errorMessage,d("fvChangeEmail","email",!1)}),b.resetEmailError=function(){d("fvChangeEmail","email",!0),b.errorMessage="",b.isSaveFail=!1},b.saveEmail=function(){b.authDetails.hasPassword&&a.changeEmail(g,b.emailPassword)},b.$on(a.onSaveSuccess.email,function(){b.isAskingForPassword=!1,b.resetEmailError(),e(),b.resetPasswordError(),f(),g=""}),b.$on(a.onSaveFail.emailPassword,function(){e(),d("fvPassword","password",!1)}),b.$on(a.onSaveFail.emailNewEmail,function(){b.isAskingForPassword=!1,e(),b.isSaveFail=!0,g=""}),b.resetPasswordError=function(){d("fvPassword","password",!0),b.isSaveFail=!1,b.isCheckFail=!1}}}}angular.module("Crops").directive("userChangeEmail",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{authDetails:"=",form:"="},templateUrl:"{0}/setup/currentuser/account/user.change.password.html".format(b.viewRoot),link:function(b){function d(a,c,d){b.form[a].$setValidity(c,d)}function e(){b.isJustSaved=!0,c(function(){b.isJustSaved=!1},4e3)}b.status={isChangingPassword:!1},b.request={newPassword:"",passwordConfirm:"",oldPassword:""},b.isSaving=!1,b.isJustSaved=!1,b.validatePasswordConfirm=function(){if(b.request.newPassword&&b.form.passConfirm.$dirty){var a=b.request.newPassword===b.request.passwordConfirm;d("passConfirm","passwordConfirm",a)}b.authDetails.hasPassword&&b.form.oldPass&&b.form.newPass.$dirty&&b.form.oldPass.$dirty&&d("oldPass","samePassword",b.request.newPassword!==b.request.oldPassword),d("newPass","saveFail",!0)},b.$on(a.onLoadingChanged,function(){b.isSaving=a.isLoading().isSavingPassword}),b.canSave=function(){return b.request.newPassword&&b.form.passConfirm.$valid&&!b.isSaving&&(!b.authDetails.hasPassword||b.request.oldPassword&&b.request.newPassword!==b.request.oldPassword)},b.save=function(){b.canSave()&&(b.authDetails.hasPassword?a.changePassword(b.request):a.setPassword(b.request))},b.$on(a.onSaveSuccess.password,function(){b.resetPasswordForm(),c(e)}),b.$on(a.onSaveFail.password,function(a,b){d("newPass","saveFail",!1)}),b.resetPasswordForm=function(){d("passConfirm","passwordConfirm",!0),d("newPass","saveFail",!0),b.form.oldPass&&d("oldPass","samePassword",!0),b.form.$setPristine(),b.request={newPassword:"",passwordConfirm:"",oldPassword:""},b.status.isChangingPassword=!1}}}}angular.module("Crops").directive("userChangePassword",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{form:"="},templateUrl:"{0}/setup/currentuser/account/user.change.username.html".format(b.viewRoot),link:function(b){function d(a,c){b.form.fvChangeUsername.$setValidity(a,c)}function e(){b.isJustSaved=!0,c(function(){b.isJustSaved=!1},4e3)}b.isSavingUsername=!1,b.isCheckingUsername=!1,b.isCheckFail=!1,b.isJustSaved=!1,b.isSaveFail=!1,b.isImageChanged=!1,b.errorMessage="",b.currentUser=a.currentUser(),b.username=angular.copy(b.currentUser.username),b.$on(a.onCurrentUserChanged,function(){b.currentUser=a.currentUser(),b.username=angular.copy(b.currentUser.username)}),b.$on(a.onLoadingChanged,function(){b.isSavingUsername=a.isLoading().isSavingUsername,b.isCheckingUsername=a.isLoading().isCheckingUsername}),b.checkUsername=function(){b.form.fvChangeUsername.$error.required||b.username===b.currentUser.username||a.checkUsername(b.username)},b.$on(a.onCheckSuccess.username,function(c,d){b.resetUsernameError(),a.changeUsername(d.username)}),b.$on(a.onCheckFail.username,function(){b.isCheckFail=!0}),b.$on(a.onValidFail.username,function(a,c){d("username",!1),b.errorMessage=c.errorMessage}),b.resetUsernameError=function(){d("username",!0),b.errorMessage="",b.isSaveFail=!1,b.isCheckFail=!1},b.$on(a.onSaveSuccess.username,function(){e()}),b.$on(a.onSaveFail.username,function(){b.isSaveFail=!0})}}}angular.module("Crops").directive("userChangeUsername",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{authDetails:"=",form:"="},templateUrl:"{0}/setup/currentuser/account/user.manage.ext.login.html".format(b.viewRoot),link:function(b){var c=[{label:"microsoft",title:"External Active Directory",logoUrl:"/img/logos/logo-azure-active-directory.svg"}];b.addLoginDetails=function(a){if(a.loginProvider)for(var b=0;b<c.length;b++)if(a.loginProvider.indexOf(c[b].label)>-1){a.title=c[b].title,a.logoUrl=c[b].logoUrl;break}},b.canRemove=function(){return b.authDetails.logins.length>1||b.authDetails.hasPassword},b.remove=function(c){b.canRemove()&&a.removeLogin(c)}}}}angular.module("Crops").directive("userManageExtLogin",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",replace:!0,scope:{authDetails:"=",form:"="},templateUrl:"{0}/setup/currentuser/account/user.manage.twofactor.html".format(b.viewRoot),link:function(d){d.status={isVerifying2faCode:!1,isSendingSms:!1,hasSentSms:!1},d.formControls={verificationCode:""};var e,f;d.send2faCode=function(){d.status.isVerifying2faCode=!0,d.$broadcast("onVerifying2faCode"),d.status.isSendingSms=!0,d.authDetails.twoFactor&&a.send2faCode().then(function(){d.status.isSendingSms=!1,d.status.hasSentSms=d.authDetails.phoneNumber&&!d.authDetails.isTotpAuthenticationEnabled},function(){d.status.isSendingSms=!1})},d.verify2faCode=function(){d.formControls.verificationCode&&a.verify2faCode(d.formControls.verificationCode).then(function(a){d.is2faCodeVerified=!0,d.openTwoFactorSetupModal(),d.resetVerificationForm()},function(){d.form.verificationCode.$setValidity("verificationCode",!1),f=d.formControls.verificationCode,e=d.$watch("formControls.verificationCode",function(a,b){f&&b===f&&a!==b&&d.resetValidity()})})},d.resetValidity=function(){d.form.verificationCode.$setValidity("verificationCode",!0),f=null,e=null},d.resetVerificationForm=function(){d.formControls.verificationCode="",d.resetValidity(),d.status.isVerifying2faCode=!1},d.openTwoFactorSetupModal=function(){if(!d.authDetails.twofactor||d.is2faCodeVerified){d.is2faCodeVerified=!1;c.open({animation:!0,templateUrl:"{0}/setup/currentuser/account/twofactor.setup.modal.html".format(b.viewRoot),controller:"twoFactorSetupModalController",size:"md",resolve:{authDetails:function(){return d.authDetails}}})}}}}}angular.module("Crops").directive("userManageTfa",a),a.$inject=["currentUserService","config","$uibModal"]}(),function(){"use strict";function a(a,b,c){function d(){c.Crops.currentUserID&&(J={id:c.Crops.currentUserID,username:c.Crops.currentUserUsername,fullname:c.Crops.currentUserFullname,firstName:c.Crops.currentUserFirstName,lastName:c.Crops.currentUserLastName,pictureUrl:c.Crops.currentUserPictureUrl,email:c.Crops.currentUserEmail,isBeta:c.Crops.currentUserIsBeta})}function e(){return{isSavingPicture:I.isSavingPicture,isSavingFirstName:I.isSavingFirstName,isSavingLastName:I.isSavingLastName,isSavingUsername:I.isSavingUsername,isSavingEmail:I.isSavingEmail,isSavingPassword:I.isLoadingPassword,isRefreshingIntegrations:I.isRefreshingIntegrations,isCheckingUsername:I.isCheckingUsername,isCheckingEmail:I.isCheckingEmail,isDeintegratingCalendar:I.isDeintegratingCalendar,isVerifyingTotp:I.isVerifyingTotp,isRemovingTotp:I.isRemovingTotp,isVerifyingPhone:I.isVerifyingPhone,isRemovingPhone:I.isRemovingPhone,isToggling2Factor:I.isToggling2Factor}}function f(){return J}function g(){return J.integrations}function h(){return H.changePicture.format(J.id)}function i(){F("isRefreshingIntegrations",!0),J.integrations=[],a.get(H.refreshUserIntegrations).then(function(a){J.integrations=a,F("isRefreshingIntegrations",!1),b.$broadcast(L)},function(){F("isRefreshingIntegrations",!1)})}function j(c){F("isSavingFirstName",!0),a.post(H.changeFirstName,[],{firstName:c||""}).then(function(a){if(a.success)J.fullname=a.fullname,J.firstName=a.firstName,F("isSavingFirstName",!1),b.$broadcast(L),b.$broadcast(S.firstName);else{F("isSavingFirstName",!1);var c=G(a.singleErrorMessage);b.$broadcast(R.firstName,{errorMessage:c})}},function(){F("isSavingFirstName",!1),b.$broadcast(T.firstName)})}function k(c){F("isSavingLastName",!0),a.post(H.changeLastName,[],{lastName:c||""}).then(function(a){J.fullname=a.fullname,J.lastName=a.lastName,F("isSavingLastName",!1),b.$broadcast(L),b.$broadcast(S.lastName)},function(){F("isSavingLastName",!1),b.$broadcast(T.lastName)})}function l(c){F("isCheckingUsername",!0),a.post(H.checkUsername,[],{username:c}).then(function(a){if(F("isCheckingUsername",!1),a.success)b.$broadcast(P.username,{username:a.username});else{var c=G(a.singleErrorMessage);b.$broadcast(R.username,{errorMessage:c})}},function(a){F("isCheckingUsername",!1),b.$broadcast(Q.username)})}function m(c){F("isSavingUsername",!0),a.post(H.changeUsername,[],{username:c}).then(function(a){J.username=a.username,F("isSavingUsername",!1),b.$broadcast(L),b.$broadcast(S.username)},function(){F("isSavingUsername",!1),b.$broadcast(T.username)})}function n(c){F("isCheckingEmail",!0),a.post(H.checkEmail,[c]).then(function(a){if(F("isCheckingEmail",!1),a.success)b.$broadcast(P.email,{email:a.email});else{var c=G(a.singleErrorMessage);b.$broadcast(R.email,{errorMessage:c})}},function(){F("isCheckingEmail",!1),b.$broadcast(Q.email)})}function o(c,d){F("isSavingEmail",!0);var e={newEmail:c,currentPassword:d};a.post(H.changeEmail,null,e).then(function(a){J.email=a.email,F("isSavingEmail",!1),b.$broadcast(L),b.$broadcast(S.email)},function(a){a.indexOf("Invalid Parameter: New Email")>-1?b.$broadcast(T.emailNewEmail):b.$broadcast(T.emailPassword),F("isSavingEmail",!1)})}function p(){F("isDeintegratingCalendar",!0),a.post(H.deintegrateCalendar).then(function(a){J.integrations=[],b.$broadcast(L),F("isDeintegratingCalendar",!1)})}function q(){a.get(H.getAuthDetails).then(function(a){K=a,b.$broadcast(U)})}function r(a){return K}function s(){return a.post(H.send2faCode)}function t(b){return a.post(H.verify2faCode,[b])}function u(b){var c={phoneNumber:b};return a.post(H.startVerifyPhoneNumber,null,c)}function v(c,d){F("isVerifyingPhone",!0);var e={code:c,phoneNumber:d};a.post(H.confirmPhoneNumberChange,null,e).then(function(a){K=a,b.$broadcast(U),b.$broadcast(P.phone),F("isVerifyingPhone",!1)},function(a){b.$broadcast(Q.phone,a),F("isVerifyingPhone",!1)})}function w(){return a.post(H.removePhoneNumber).then(function(a){K=a,b.$broadcast(U),F("isRemovingPhone",!1)},function(a){F("isRemovingPhone",!1)})}function x(){return a.get(H.startVerifyTotpAuthentication)}function y(c,d){F("isVerifyingTotp",!0);var e={code:c,secretKey:d};a.post(H.enableTotpAuthentication,null,e).then(function(a){K=a,b.$broadcast(U),b.$broadcast(P.totp),F("isVerifyingTotp",!1)},function(a){b.$broadcast(Q.totp,a),F("isVerifyingTotp",!1)})}function z(){a.post(H.removeTotpAuthentication).then(function(a){K=a,b.$broadcast(U),F("isRemovingTotp",!1)},function(a){F("isRemovingTotp",!1)})}function A(){F("isToggling2Factor",!0),a.post(H.disable2Factor).then(function(a){K=a,b.$broadcast(U),F("isToggling2Factor",!1)},function(a){q(),F("isToggling2Factor",!1)})}function B(){F("isToggling2Factor",!0),a.post(H.enable2Factor).then(function(a){K=a,b.$broadcast(U),F("isToggling2Factor",!1)},function(a){q(),F("isToggling2Factor",!1)})}function C(c){F("isSavingPassword",!0),a.post(H.changePassword,null,c).then(function(a){K=a,b.$broadcast(S.password),b.$broadcast(U),F("isSavingPassword",!1)},function(a){b.$broadcast(T.password,a),F("isSavingPassword",!1)})}function D(c){F("isSavingPassword",!0),a.post(H.setPassword,null,c).then(function(a){K=a,b.$broadcast(S.password),b.$broadcast(U),F("isSavingPassword",!1)},function(a){b.$broadcast(T.password,a),F("isSavingPassword",!1)})}function E(c){a.post(H.removeLogin,null,{loginProvider:c.loginProvider,providerKey:c.providerKey}).then(function(a){K=a,b.$broadcast(U)})}function F(a,c){a in I&&(I[a]=c,b.$broadcast(M))}function G(a){return a?a.indexOf(":")?a.substring(a.indexOf(":")+1):a:""}var H={changeFirstName:"/api/currentuser/changefirstname",changeLastName:"/api/currentuser/changelastname",changePicture:"/api/currentuser/changepicture",checkUsername:"/api/currentuser/checkusername",changeUsername:"/api/currentuser/changeusername",checkEmail:"/api/currentuser/checkemail?newEmail={0}",changeEmail:"/api/currentuser/changeemail",getGoogleCalendarAuthUrl:"/api/integrations/googlecalendarauthurl",getOffice365AuthUrl:"/api/integrations/office365authurl",refreshUserIntegrations:"/api/integrations/user/",deintegrateCalendar:"/api/currentuser/deintegratecalendar/",getSetting:"/api/currentuser/setting/{0}",postSetSetting:"/api/currentuser/setting/{0}",getAuthDetails:"/api/currentuser/auth/",send2faCode:"api/currentuser/auth/2fa/send",verify2faCode:"api/currentuser/auth/2fa/verify?code={0}",startVerifyPhoneNumber:"api/currentuser/auth/phoneNumber/startVerify",confirmPhoneNumberChange:"api/currentuser/auth/phoneNumber/confirmChange",removePhoneNumber:"api/currentuser/auth/phoneNumber/remove",startVerifyTotpAuthentication:"api/currentuser/auth/totp/startVerify",enableTotpAuthentication:"api/currentuser/auth/totp/verify",removeTotpAuthentication:"api/currentuser/auth/totp/remove",disable2Factor:"api/currentuser/auth/2fa/disable",enable2Factor:"api/currentuser/auth/2fa/enable",changePassword:"api/currentuser/auth/changePassword",setPassword:"api/currentuser/auth/setPassword",removeLogin:"api/currentuser/auth/external/remove"},I={isSavingPicture:!1,isSavingUsername:!1,isSavingFirstName:!1,isSavingLastName:!1,isRefreshingIntegrations:!1,isSavingEmail:!1,isSavingPassword:!1,isDeintegratingCalendar:!1,isCheckingUsername:!1,isCheckingEmail:!1,isVerifyingTotp:!1,isRemovingTotp:!1,isVerifyingPhone:!1,isRemovingPhone:!1,isToggling2Factor:!1},J=null,K=null,L="currentUserService.onCurrentUserChanged",M="currentUserService.onLoadingChanged",N="currentUserService.onCheckedUsername",O="currentUserService.onCheckedEmail",P={username:"currentUserService.onCheckSuccess.username",email:"currentUserService.onCheckSuccess.email",totp:"currentUserService.onCheckSuccess.totp",phone:"currentUserService.onCheckSuccess.phone"},Q={username:"currentUserService.onCheckFail.username",email:"currentUserService.onCheckFail.email",totp:"currentUserService.onCheckFail.totp",phone:"currentUserService.onCheckFail.phone"},R={firstName:"currentUserService.onValidFail.firstName",username:"currentUserService.onValidFail.username",email:"currentUserService.onValidFail.email"},S={firstName:"currentUserService.onSaveSuccess.firstName",lastName:"currentUserService.onSaveSuccess.lastName",username:"currentUserService.onSaveSuccess.username",email:"currentUserService.onSaveSuccess.email",password:"currentUserService.onSaveSuccess.password"},T={firstName:"currentUserService.onSaveFail.firstName",lastName:"currentUserService.onSaveFail.lastName",username:"currentUserService.onSaveFail.username",emailPassword:"currentUserService.onSaveFail.emailPassword",emailNewEmail:"currentUserService.onSaveFail.emailNewEmail",password:"currentUserService.onSaveFail.password"},U="currentUserService.onAuthDetailsChanged",V={isLoading:e,changeFirstName:j,changeLastName:k,checkUsername:l,changeUsername:m,checkEmail:n,changeEmail:o,savePictureUrl:h,currentUser:f,currentIntegrations:g,onCurrentUserChanged:L,onLoadingChanged:M,onCheckedUsername:N,onCheckedEmail:O,onCheckSuccess:{username:P.username,email:P.email,totp:P.totp,phone:P.phone},onCheckFail:{username:Q.username,email:Q.email,totp:Q.totp,phone:Q.phone},onValidFail:{firstName:R.firstName,username:R.username,email:R.email},onSaveSuccess:{firstName:S.firstName,lastName:S.lastName,username:S.username,email:S.email,password:S.password},onSaveFail:{firstName:T.firstName,lastName:T.lastName,username:T.username,emailPassword:T.emailPassword,emailNewEmail:T.emailNewEmail,password:T.password,enable2Factor:T.enable2Factor,disable2Factor:T.disable2Factor},onAuthDetailsChanged:U,getGoogleCalendarAuthUrl:function(){return a.get(H.getGoogleCalendarAuthUrl)},getOffice365AuthUrl:function(){return a.get(H.getOffice365AuthUrl)},deintegrateCalendar:p,refreshUserIntegrations:i,getSetting:function(b){return a.get(H.getSetting,b,!0)},setSetting:function(b,c){return a.post(H.postSetSetting,b,JSON.stringify(c)).then(function(c){return a.clearCacheEntry(H.getSetting,b),c})},getAuthDetails:q,authDetails:r,send2faCode:s,verify2faCode:t,startVerifyPhoneNumber:u,confirmPhoneNumberChange:v,removePhoneNumber:w,startVerifyTotpAuthentication:x,enableTotpAuthentication:y,removeTotpAuthentication:z,disable2Factor:A,enable2Factor:B,changePassword:C,setPassword:D,removeLogin:E};return d(),V}angular.module("Crops").service("currentUserService",a),a.$inject=["fvApi","$rootScope","$window"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){return!a.slack.isUpdating&&!angular.equals(a.slack.links,a.slack.linksCopy)}function g(){a.slack.isUpdating||(a.slack.isUpdating=!0,c.updateSlackLinks(a.slack.links).then(function(b){d.alertSuccess("Slack settings updated"),a.close()},function(a){d.alertFail("There was a problem updating Slack settings. Please refresh and try again.")})["finally"](function(){a.slack.isUpdating=!1}))}a.slack={setupForm:{},channelList:[],links:[],linksCopy:[],canUpdate:f,isUpdating:!1,updateLinks:g,isLoading:!0},e.all([c.getSlackChannelList().then(function(b){a.slack.channelList=b}),c.getSlackLinks().then(function(b){_(b).each(function(a){a.channel=a.channel||null}),a.slack.links=b,a.slack.linksCopy=angular.copy(a.slack.links);
})])["finally"](function(){a.slack.isLoading=!1}),a.close=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}angular.module("Crops").controller("notificationMethodConfigModalController",a),a.$inject=["$scope","$uibModalInstance","setupNotificationsService","fvAlertsService","$q"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){b.getNotificationPreferences().then(function(a){m(a)})["finally"](function(){a.notification.isLoading=!1})}function k(b,c){var d=_(a.notification.immediate).findWhere({trigger:"TaskAssigned"}),e=_(a.notification.immediate).findWhere({trigger:"NoteMentions"});return!a.notification.isSaving.immediate&&!a.notification.isSaving[b.trigger]&&("TaskAssignedFollow"!==b.trigger||d&&!d[c])&&("NoteMentionsFollow"!==b.trigger||e&&!e[c])}function l(d,e){var f=d.trigger;a.notification.isSaving[f]||(a.notification.isSaving[f]=!0,b.updateNotificationPreference(d).then(function(b){if("TaskAssigned"===d.trigger&&d[e]||"NoteMentions"===d.trigger&&d[e])for(var f=0;f<a.notification.immediate.length;f++){if("TaskAssignedFollow"===a.notification.immediate[f].trigger){a.notification.immediate[f][e]||(a.notification.immediate[f][e]=!0,l(a.notification.immediate[f],e));break}if("NoteMentionsFollow"===a.notification.immediate[x].trigger){a.notification.immediate[x][e]||(a.notification.immediate[x][e]=!0,l(a.notification.immediate[f],e));break}}else n(),c.alertSuccess("Notification preferences updated",null,!0)},function(b){c.alertFail("There was a problem updating notifications. Please refresh and try again.",null,!0);var e=_(a.notification.preferences).findWhere({trigger:d.trigger});d=e})["finally"](function(){a.notification.isSaving[f]=!1}))}function m(b){a.notification.preferences=b.preferences,a.notification.immediate=b.immediate,a.notification.digest=b.digest,a.sms.phoneNumber=b.notificationSmsNumber,a.sms.phoneNumber||a.sms.startSettingUp(),n()}function n(){var b=a.notification.immediate,c=a.notification.digest;a.notification.allSelected.immediateEmail=b&&b.length&&_(b).every(function(a){return a.email}),a.notification.allSelected.immediateSms=b&&b.length&&_(b).every(function(a){return a.sms}),a.notification.allSelected.immediateSlack=b&&b.length&&_(b).every(function(a){return a.slack}),a.notification.allSelected.digestMorning=c&&c.length&&_(c).every(function(a){return!a.morning||a.morning.email}),a.notification.allSelected.digestEvening=c&&c.length&&_(c).every(function(a){return!a.evening||a.evening.email})}function o(b,c,d){if(!a.notification.isSaving[b]&&a.notification[b]&&a.notification[b].length){var e,f=[];if("immediate"===b)for(e=0;e<a.notification.immediate.length;e++)a.notification.immediate[e][c]=d,f.push(a.notification.immediate[e]);else if("digest"===b)for(e=0;e<a.notification.digest.length;e++)a.notification.digest[e][c]&&(a.notification.digest[e][c].email=d,f.push(a.notification.digest[e][c]));p(f,b)}}function p(e,f){if(!a.notification.isSaving[f]){a.notification.isSaving[f]=!0;var g=[];d.all(e.map(function(a){return b.updateNotificationPreference(a).then(function(){},function(b){a.error=b,g.push(a)})})).then(function(){g.length?c.alertFail("There was a problem updating notifications. Please refresh and try again.",null,!0):c.alertSuccess("Notification preferences updated",null,!0),a.notification.isSaving[f]=!1})}}function q(){a.sms.isSettingUpPhone=!0,t()}function r(){a.sms.isSettingUpPhone=!1,i(function(){a.sms.newPhoneNumber=null,a.sms.hasSentSms=!1,a.sms.isSendingSms=!1,a.sms.isEditingPhoneNumber=!1,a.sms.confirmationCode=null,B(),A(),a.sms.setupForm.$setPristine(),a.sms.setupForm.$setUntouched(),a.sms.isSendingSms=!1,a.sms.hasSentSms=!1},500)}function s(){a.sms.isRemoving||h.confirm({text:"Are you sure you wish to remove your mobile phone number? You will no longer be able to receive Filevine notifications via text message.",confirmButtonText:"Remove Phone Number",isLoadingButtonText:"Removing Phone Number"},function(){return a.sms.isRemoving=!0,b.removeSmsNumber().then(function(){a.sms.phoneNumber=null,a.sms.startSettingUp()},function(a){c.alertFail("There was a problem removing your phone number. Please refresh and try again.")})["finally"](function(){a.sms.isRemoving=!1})})}function t(){a.sms.newPhoneNumber=a.sms.phoneNumber,a.sms.hasSentSms=!1,a.sms.isSendingSms=!1,a.sms.isEditingPhoneNumber=!0,i(function(){a.$broadcast("onEditingPhoneNumber")})}function u(b){var c=!b||10===b.replace(/\D/g,"").length;C("phoneNumber","phone",c),c||(K=b,I=a.$watch("sms.phoneNumber",function(a,b){K&&b===K&&a!==b&&A()}))}function v(){return a.sms.setupForm&&a.sms.setupForm.phoneNumber&&a.sms.setupForm.phoneNumber.$valid&&a.sms.newPhoneNumber&&!a.sms.isSendingSms}function w(d){u(d),v()&&(a.sms.isSendingSms=!0,b.startVerifySmsNumber(d).then(function(){a.sms.isEditingPhoneNumber=!1,a.sms.isSendingSms=!1,a.sms.hasSentSms=!0,a.$broadcast("onSmsSent")},function(b){a.sms.isSendingSms=!1,c.alertFail("There was a problem verifying your phone number. "+b)}))}function y(){return!a.sms.isEditingPhoneNumber&&!a.sms.isSendingSms&&a.sms.hasSentSms&&!a.sms.isConfirming&&a.sms.newPhoneNumber&&a.sms.confirmationCode}function z(d,e){y()&&(a.sms.isConfirming=!0,b.confirmSmsNumber(d,e).then(function(a){c.alertSuccess("Your phone number has been set up for text message notifications."),m(a),r()},function(b){C("confirmationCode","confirmationCode",!1),L=e,J=a.$watch("sms.confirmationCode",function(a,b){L&&b===L&&a!==b&&B()})})["finally"](function(){a.sms.isConfirming=!1}))}function A(){C("phoneNumber","phone",!0),angular.isFunction(I)&&(I(),I=null)}function B(){C("confirmationCode","confirmationCode",!0),angular.isFunction(J)&&(J(),J=null)}function C(b,c,d){a.sms&&a.sms.setupForm&&a.sms.setupForm[b]&&a.sms.setupForm[b].$setValidity(c,d)}function D(){a.slack.isGettingStatus||(a.slack.isGettingStatus=!0,b.getSlackStatus().then(function(b){a.slack.isConnected=b})["finally"](function(){a.slack.isGettingStatus=!1}))}function E(){a.slack.isConnecting||(a.slack.isConnecting=!0,b.connectSlack().then(function(a){D(),window.location=a},function(b){a.slack.isConnecting=!1}))}function F(){a.slack.isDisconnecting||h.confirm({text:"Are you sure you wish to disconnect from Slack? You will no longer be able to receive Filevine notifications in Slack.",confirmButtonText:"Disconnect",isLoadingButtonText:"Disconnecting"},function(){return a.slack.isDisconnecting=!0,b.disconnectSlack().then(function(a){D()})["finally"](function(){a.slack.isDisconnecting=!1})})}function G(){H("slack")}function H(b){f.open({animation:!0,templateUrl:"{0}/setup/currentuser/notifications/notification.method.config.modal.html".format(g.viewRoot),controller:"notificationMethodConfigModalController",size:"md",windowClass:"notification-method-config-modal",resolve:{mode:function(){return b},smsNumber:function(){return"sms"===b?a.sms.number:null}}})}a.notification={preferences:null,preferencesCopy:null,getPreferences:j,selectAll:o,allSelected:{immediateSlack:!1,immediateSms:!1,immediateEmail:!1,digestEmail:!1},canSelectImmediate:k,save:l,isLoading:!0,isSaving:{}},a.sms={phoneNumber:null,newPhoneNumber:null,startSettingUp:q,isSettingUpPhone:!1,cancelSettingUp:r,remove:s,isRemoving:!1,setupForm:{},startEditingPhone:t,isEditingPhoneNumber:!1,canSendVerificationText:v,validatePhone:u,startVerifyPhone:w,canConfirmPhone:y,confirmPhone:z,confirmationCode:null,isSendingSms:!1,hasSentSms:!1,isConfirming:!1},a.slack={isGettingStatus:!1,getStatus:D,isConnected:!1,isConnecting:!1,isDisconnecting:!1,connect:E,disconnect:F,startSettingUp:G,isLoading:function(){return this.isGettingStatus||this.isConnecting||this.isDisconnecting}},a.notification.getPreferences(),a.slack.getStatus(),a.tab={isActive:{immediate:!0,digest:!1,setup:!1},"goto":function(a){this.isActive.immediate=!1,this.isActive.digest=!1,this.isActive.setup=!1,this.isActive[a]=!0}},e.search().tab&&(a.tab.isActive.immediate=!1,a.tab.isActive[e.search().tab]=!0,G(),e.search({}));var I,J,K,L}angular.module("Crops").controller("UserSetupNotificationsController",a),a.$inject=["$scope","setupNotificationsService","fvAlertsService","$q","$location","$uibModal","config","confirmService","$timeout"]}(),function(){"use strict";function a(a){function b(a){var b=a.preferences;b=_(b).each(function(a){var b=o[a.trigger];b&&(a.category=b.category,a.description=b.description)});var c=_(b).filter(function(a){return"immediate"===a.category}),d=angular.copy(p);d.DigestDeadlineReminders.evening=_(b).findWhere({trigger:"DigestEveningDeadlineReminders"}),d.DigestTasks.morning=_(b).findWhere({trigger:"DigestMorningTasks"}),d.DigestTasks.evening=_(b).findWhere({trigger:"DigestEveningTasks"}),d.NoteMentions.morning=_(b).findWhere({trigger:"DigestMorningNoteMentions"}),d.NoteMentions.evening=_(b).findWhere({trigger:"DigestEveningNoteMentions"}),d.DigestTextsFaxes.morning=_(b).findWhere({trigger:"DigestMorningTextsFaxes"}),d.DigestTextsFaxes.evening=_(b).findWhere({trigger:"DigestEveningTextsFaxes"});var e=[];if(_(d).each(function(a,b,c){e.push(a)}),a.immediate=c,a.digest=e,a.notificationSmsNumber){var f=[a.notificationSmsNumber.slice(2,5),a.notificationSmsNumber.slice(5,8),a.notificationSmsNumber.slice(8)];a.notificationSmsNumber=f.join("-")}return a}function c(){return a.get(n.getNotificationPreferences).then(function(a){return a=b(a)})}function d(b){return a.post(n.updateNotificationPreference,[b.trigger],b)}function e(b){return a.post(n.startVerifySmsNumber,[],{phoneNumber:b})}function f(c,d){return a.post(n.confirmSmsNumber,[],{phoneNumber:c,code:d}).then(function(a){return a=b(a)})}function g(){return a.del(n.removeSmsNumber)}function h(){return a.get(n.getSlackStatus)}function i(){return a.get(n.connectSlack)}function j(){return a.post(n.disconnectSlack)}function k(){return a.get(n.getSlackLinks)}function l(b){return a.post(n.updateSlackLinks,[],b)}function m(){return a.get(n.getSlackChannelList)}var n={getNotificationPreferences:"/api/currentuser/notificationPreferences",updateNotificationPreference:"/api/currentuser/notificationPreference?trigger={0}",startVerifySmsNumber:"/api/currentuser/startVerifyNotificationSmsNumber",confirmSmsNumber:"/api/currentuser/confirmNotificationSmsNumber",removeSmsNumber:"/api/currentuser/removeNotificationSmsNumber",getSlackStatus:"/api/integrations/slack/getstatus",connectSlack:"/api/integrations/slack/connect",disconnectSlack:"/api/integrations/slack/disconnect",getSlackLinks:"/api/integrations/slack/getlinks",updateSlackLinks:"/api/integrations/slack/updatelinks",getSlackChannelList:"/api/integrations/slack/getchannellist"},o={TaskAssigned:{description:"Each task that gets assigned to me",category:"immediate"},TaskAssignedFollow:{description:"Each task that gets assigned to me for projects I follow",category:"immediate"},NoteMentions:{description:"Each note where I am mentioned",category:"immediate"},NoteMentionsFollow:{description:"Each note that I am mentioned on for projects I follow",category:"immediate"},IncomingTextMailroom:{description:"Each incoming text to Mailroom",category:"immediate"},IncomingTextProjectsFollow:{description:"Each incoming text to projects that I follow",category:"immediate"},IncomingFaxMailroom:{description:"Each incoming fax to Mailroom",category:"immediate"},IncomingFaxProjectsFollow:{description:"Each incoming fax to projects that I follow",category:"immediate"},RoleBasedTaskflow:{description:"Role-based taskflow notifications",category:"immediate"},DigestEveningDeadlineReminders:{description:"Deadline reminders for projects I follow",category:"digest"},DigestMorningTasks:{description:"New, uncompleted, tasks assigned to me",category:"digest"},DigestEveningTasks:{description:"New, uncompleted, tasks assigned to me",category:"digest"},DigestMorningNoteMentions:{description:"New notes that mention me",category:"digest"},DigestEveningNoteMentions:{description:"New notes that mention me",category:"digest"},DigestMorningTextsFaxes:{description:"Incoming texts/faxes to Mailroom and projects that I follow",category:"digest"},DigestEveningTextsFaxes:{description:"Incoming texts/faxes to Mailroom and projects that I follow",category:"digest"}},p={DigestDeadlineReminders:{trigger:"DigestDeadlineReminders",description:"Deadline reminders for projects I follow",category:"digest"},DigestTasks:{trigger:"DigestTasks",description:"New, uncompleted, tasks assigned to me",category:"digest"},NoteMentions:{trigger:"NoteMentions",description:"New notes that mention me",category:"digest"},DigestTextsFaxes:{trigger:"DigestTextsFaxes",description:"Incoming texts/faxes to Mailroom and projects that I follow",category:"digest"}},q={getNotificationPreferences:c,updateNotificationPreference:d,startVerifySmsNumber:e,confirmSmsNumber:f,removeSmsNumber:g,getSlackStatus:h,getSlackLinks:k,connectSlack:i,disconnectSlack:j,updateSlackLinks:l,getSlackChannelList:m};return q}angular.module("Crops").service("setupNotificationsService",a),a.$inject=["fvApi"]}(),function(){"use strict";function a(a,b,c){a.currentUser=b.currentUser(),a.$on(b.onCurrentUserChanged,function(){a.currentUser=b.currentUser()})}angular.module("Crops").controller("UserProfileController",a),a.$inject=["$scope","currentUserService","config"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{form:"="},replace:!0,templateUrl:"{0}/setup/currentuser/profile/user.change.first.name.html".format(b.viewRoot),link:function(b){function d(a){b.form.fvChangeFirstname.$setValidity("firstname",a)}function e(){b.isJustSaved=!0,c(function(){b.isJustSaved=!1},4e3)}b.isSavingFirstName=!1,b.isJustSaved=!1,b.isSaveFail=!1,b.errorMessage="",b.currentUser=a.currentUser(),b.firstName=angular.copy(b.currentUser.firstName),b.$on(a.onCurrentUserChanged,function(){b.currentUser=a.currentUser(),b.firstName=angular.copy(b.currentUser.firstName)}),b.changeFirstName=function(){b.form.fvChangeFirstname.$error.required||b.firstName===b.currentUser.firstName||a.changeFirstName(b.firstName)},b.$on(a.onLoadingChanged,function(){b.isSavingFirstName=a.isLoading().isSavingFirstName}),b.$on(a.onSaveSuccess.firstName,function(){b.resetFirstNameError(),e()}),b.$on(a.onValidFail.firstName,function(a,c){d(!1),b.errorMessage=c.errorMessage}),b.$on(a.onSaveFail.firstName,function(){b.isSaveFail=!0}),b.resetFirstNameError=function(){d(!0),b.errorMessage="",b.isSaveFail=!1}}}}angular.module("Crops").directive("userChangeFirstName",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{form:"="},replace:!0,templateUrl:"{0}/setup/currentuser/profile/user.change.last.name.html".format(b.viewRoot),link:function(b){function d(){b.isJustSaved=!0,c(function(){b.isJustSaved=!1},4e3)}b.isSavingLastName=!1,b.isJustSaved=!1,b.isSaveFail=!1,b.currentUser=a.currentUser(),b.lastName=angular.copy(b.currentUser.lastName),b.$on(a.onCurrentUserChanged,function(){b.currentUser=a.currentUser(),b.lastName=angular.copy(b.currentUser.lastName)}),b.changeLastName=function(){b.form.fvChangeLastname.$valid&&b.lastName!==b.currentUser.lastName&&a.changeLastName(b.lastName)},b.$on(a.onLoadingChanged,function(){b.isSavinglastName=a.isLoading().isSavinglastName}),b.$on(a.onSaveSuccess.lastName,function(){d()}),b.$on(a.onSaveFail.lastName,function(){b.isSaveFail=!0}),b.isSaveSuccess=!1,b.isSaveFail=!1}}}angular.module("Crops").directive("userChangeLastName",a),a.$inject=["currentUserService","config","$timeout"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{},replace:!0,templateUrl:"{0}/setup/currentuser/profile/user.change.picture.html".format(b.viewRoot),link:function(b){b.currentUser=a.currentUser(),b.$on(a.onCurrentUserChanged,function(){b.currentUser=a.currentUser()}),b.userPictureSaveUrl=function(){return a.savePictureUrl()}}}}angular.module("Crops").directive("userChangePicture",a),a.$inject=["currentUserService","config"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{form:"="},replace:!0,templateUrl:"{0}/setup/currentuser/profile/user.setup.calendar.html".format(c.viewRoot),link:function(c){c.isLoadingIntegrations=!0,c.newInvite="",c.viewers=[],c.viewedCalendars=[];var d=5,e=6,f=21,g=22;c.calendarType="",c.isCalendarSetup=!1,c.calendarAccount="",a.refreshUserIntegrations(),c.$on(a.onLoadingChanged,function(){c.isLoadingIntegrations=a.isLoading().isLoadingIntegrations,c.isDeintegratingCalendar=a.isLoading().isDeintegratingCalendar}),c.$on(a.onCurrentUserChanged,function(){var b=_(a.currentIntegrations()).find(function(a){return a.integrationTypeID===d||a.integrationTypeID===f}),h=_(a.currentIntegrations()).find(function(a){return a.integrationTypeID===e||a.integrationTypeID===g});b?(c.calendarType="Google",c.isCalendarSetup=b.isSetUp,c.calendarAccount=b.account,c.isV2Sync=b.integrationTypeID===f):h?(c.calendarType="Office 365",c.isCalendarSetup=h.isSetUp,c.calendarAccount=h.account,c.isV2Sync=h.integrationTypeID===g):(c.calendarType="",c.isCalendarSetup=!1,c.calendarAccount="")}),c.$on(b.onViewedListChanged,function(){c.viewedCalendars=b.viewedList()}),c.$on(b.onViewerListChanged,function(){c.viewers=b.viewerList()}),b.loadViewerList(),b.loadViewedList(),c.toggleEditingViewers=function(){c.isEditingViewers=!c.isEditingViewers},c.toggleEditingViewed=function(){c.isEditingViewed=!c.isEditingViewed},c.inviteViewer=function(){b.inviteViewer(c.newInvite),c.newInvite=""},c.removeViewer=function(a){b.removeViewer(a)},c.removeViewed=function(a){b.removeViewed(a)},c.setupGoogleCalendarIntegration=function(){a.getGoogleCalendarAuthUrl().then(function(a){window.location=a})},c.setupOffice365CalendarIntegration=function(){a.getOffice365AuthUrl().then(function(a){console.log(a),window.location=a})},c.deintegrateCalendar=function(){a.deintegrateCalendar()}}}}angular.module("Crops").directive("userSetupCalendar",a),a.$inject=["currentUserService","calendarSharingService","config"]}(),function(){"use strict";function a(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{currentOrg:"=",isAdding:"="},templateUrl:"{0}/setup/orgs/folders/org.current.folder.html".format(b.viewRoot),link:function(g,h){function i(){g.settings.folderOptionsIsOpen=!1,g.settings.showEditIcon=!1,g.settings.isEditingName=!1,g.settings.isRenaming=!1,g.settings.isCreatingFolder=!1,g.settings.isRemoving=!1,g.settings.newName=""}g.currentFolder=a.currentOrgFolder(),g.$on(a.onCurrentOrgFolderChanged,function(){g.currentFolder=a.currentOrgFolder(),i()}),g.settings={folderOptionsIsOpen:!1,showEditIcon:!1,isEditingName:!1,isRenaming:!1,isCreatingFolder:!1,isRemoving:!1,newName:""},g.integrationTypes=c.integrationTypes(),g.isPerformingFolderAction=function(){return g.settings.isRenaming||g.settings.isRemoving||g.settings.isCreatingFolder},g.isAdmin=function(){return g.currentOrg&&3===g.currentOrg.accessLevel},g.invalidFolderNameChars=b.folderNameInvalidCharacters,g.$on(a.onCurrentFolderChanged,i),g.canJumpToFolder=function(){return g.currentFolder&&(g.currentFolder.children&&g.currentFolder.children.length||g.currentFolder.parents&&g.currentFolder.parents.length)},g.allowRename=function(){return g.isAdmin()&&g.currentFolder},g.canRenameFolder=function(){return g.allowRename()&&!g.isPerformingFolderAction()&&g.settings.folderRenameForm&&g.settings.folderRenameForm.$valid},g.allowMove=function(){return g.isAdmin()&&g.currentFolder&&g.currentFolder.parentID},g.canMove=function(){return g.allowMove()&&!g.isPerformingFolderAction()},g.allowRemove=function(){return g.isAdmin()&&g.currentFolder&&!g.currentFolder.isProjectRoot&&g.currentFolder.canRemove&&g.currentFolder.parentID&&(!g.currentFolder.children||!g.currentFolder.children.length)},g.canRemoveFolder=function(){return g.allowRemove()&&!g.isPerformingFolderAction()},g.allowCreate=function(){return g.isAdmin()&&g.currentFolder&&!g.currentFolder.isProjectRoot},g.canCreateFolder=function(){return g.allowCreate()&&!g.isAdding&&!g.isPerformingFolderAction()},g.createFolder=function(a){g.canCreateFolder()&&(g.isAdding=!0)},g.gotoFolder=function(b){b&&b.id!==g.currentFolder.id&&a.gotoFolderByID(g.currentOrg.id,b.id)},g.beginEditingName=function(){g.allowRename()&&(g.settings.newName=angular.copy(g.currentFolder.name),g.settings.isEditingName=!0,e(function(){g.$broadcast("onEditingName",{selectAll:!0})}))},g.cancelEditingName=function(){g.settings.isRenaming||(g.settings.isEditingName=!1,g.settings.newName="")},g.validateNewFolderName=function(){if(g.settings&&g.settings.folderRenameForm){var a=g.settings.newName,c=g.settings.folderRenameForm.renameFolderInput;c.$setValidity("invalidChars",!b.folderNameInvalidCharactersRegex.test(a))}},g.renameFolder=function(){if(g.canRenameFolder()){g.settings.isRenaming=!0;var b=angular.copy(g.currentFolder);b.name=g.settings.newName,a.renameOrgFolder(g.currentOrg.id,b).then()["finally"](function(){g.settings.isRenaming=!1})}},g.removeFolder=function(){g.canRemoveFolder()&&f.confirm({text:"Are you sure you wish to remove this folder?",confirmButtonText:"Remove Folder",isLoadingButtonText:"Removing Folder"},function(){return a.removeOrgFolder(g.currentOrg.id,g.currentFolder)})},g.showFolderMoveModal=function(a){d.open({animation:!0,templateUrl:"{0}/setup/orgs/folders/org.folder.move.modal.html".format(b.viewRoot),controller:"orgFolderMoveModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"folder-move-modal org-folder-move-modal",resolve:{currentOrgID:function(){return g.currentOrg.id},folderID:function(){return g.currentFolder.id},mode:function(){return a}}})},g.jumpToFolder=function(){g.canJumpToFolder()&&g.showFolderMoveModal("jump")},g.moveFolder=function(){g.allowMove()&&g.showFolderMoveModal("move")}}}}angular.module("Crops").directive("orgCurrentFolder",a),a.$inject=["orgService","config","docService","$uibModal","$timeout","confirmService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){return a&&a.parents&&a.parents.length&&_(a.parents).any(function(a){return a.isProjectRootFolder})}function j(){a.orgRootFolder=null,d.getOrgRootFolder(e).then(function(b){a.orgRootFolder=b})}a.modalMode={},a.settings={isMovingFolder:!1,isJumping:!1},a.folderTreeSettings={selectedFolder:null,selectedFolderId:null,currentFolder:null,currentLocationId:null,canSelectCurrent:!1,autoSelectCurrent:!1,canSelectParent:!1,showDescendants:!1,openToCurrent:!0,disabled:!1,onSelect:null},g&&(a.modalMode[g]=!0,"jump"===g&&(a.folderTreeSettings.canSelectParent=!0,a.folderTreeSettings.showDescendants=!0,a.folderTreeSettings.onSelect=function(b){b&&d.gotoFolderByID(e,b.id).then(a.close)})),a.loading=function(){return!a.folderTreeSettings.currentFolder||!a.orgRootFolder},f&&d.getOrgFolder(e,f).then(function(b){i(b)?(h.alertFail("Project sub-folders may not be moved outside of the project root folder."),a.cancel()):(a.folderTreeSettings.currentFolder=b,b&&a.modalMode.move&&(a.folderTreeSettings.currentLocationId=b.parentID))}),j(),a.nowhereToMoveTo=function(){return!a.orgRootFolder||!a.folderTreeSettings.currentFolder||a.folderTreeSettings.currentFolder.isProjectRootFolder&&(!a.orgRootFolder.children||!a.orgRootFolder.children.length)||!a.folderTreeSettings.currentFolder.isProjectRootFolder&&a.orgRootFolder.id===a.folderTreeSettings.currentFolder.parentID&&(!a.orgRootFolder.children||a.orgRootFolder.children.length<=1)},a.canMoveFolder=function(){return a.settings&&!a.settings.isMovingFolder&&a.folderTreeSettings.currentFolder&&a.folderTreeSettings.currentFolder.parentID&&a.folderTreeSettings.selectedFolderId&&a.folderTreeSettings.selectedFolder&&!a.folderTreeSettings.selectedFolder.isProjectRootFolder&&!a.nowhereToMoveTo()},a.moveFolder=function(){if(a.canMoveFolder()){a.settings.isMovingFolder=!0,a.folderTreeSettings.disabled=!0;var b=angular.copy(a.folderTreeSettings.currentFolder);b.parentID=a.folderTreeSettings.selectedFolderId,d.moveOrgFolder(e,b).then(function(){a.close()})["finally"](function(){a.settings.isMovingFolder=!1,a.folderTreeSettings.disabled=!1})}},a.close=function(){c.close()},a.cancel=function(){c.dismiss("onOrgFolderMoveModalDismissed")}}angular.module("Crops").controller("orgFolderMoveModalController",a),a.$inject=["$scope","$state","$uibModalInstance","orgService","currentOrgID","folderID","mode","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d,e){return{restrict:"E",scope:{currentOrg:"="},replace:!0,templateUrl:"{0}/setup/orgs/folders/org.folders.html".format(b.viewRoot),link:function(d){function f(){!d.currentOrg||d.isLoadingCurrentFolder||d.currentFolder&&!d.currentFolder.parentID&&d.currentFolder.orgID===d.currentOrg.id||a.gotoOrgRootFolder(d.currentOrg.id)}function g(){d.newFolderSettings.isAdding=!1,d.newFolderSettings.isCreating=!1,d.newFolderSettings.newFolder={parentID:d.currentFolder?d.currentFolder.id:void 0,name:""},d.newFolderSettings.newFolderForm&&(d.newFolderSettings.newFolderForm.$setPristine(),d.newFolderSettings.newFolderForm.$setUntouched())}function h(a){return a&&d.currentFolder&&d.currentFolder.children&&d.currentFolder.children.length&&_(d.currentFolder.children).any(function(b){return b.name.toLowerCase()===a.toLowerCase()})}d.isAdmin=function(){return d.currentOrg&&3===d.currentOrg.accessLevel},d.currentFolder=null,d.isLoadingCurrentFolder=!1,d.$on(a.onCurrentOrgFolderChanged,function(){d.currentFolder=a.currentOrgFolder(),g()}),d.$on(a.onLoadingChanged,function(){d.isLoadingCurrentFolder=a.isLoading().currentOrgFolder}),d.$on("onOrgFoldersTabSelected",f),d.newFolderSettings={isAdding:!1,isCreating:!1,newFolder:{parentID:null,name:""},invalidChars:b.folderNameInvalidCharacters},d.allowCreate=function(){return d.isAdmin()},d.canCreateFolder=function(){return d.newFolderSettings&&!d.newFolderSettings.isCreating&&d.allowCreate()&&d.newFolderSettings.newFolderForm&&d.newFolderSettings.newFolderForm.newFolderName&&d.newFolderSettings.newFolderForm.$valid},d.allowRemove=function(){return d.isAdmin()&&d.currentFolder&&!d.currentFolder.isProjectRoot&&d.currentFolder.canRemove&&d.currentFolder.parentID&&(!d.currentFolder.children||!d.currentFolder.children.length)},d.canRemoveFolder=function(){return d.allowRemove()&&!d.newFolderSettings.isCreating},d.validateNewFolderName=function(){if(d.newFolderSettings.newFolder&&d.newFolderSettings.newFolderForm){var a=d.newFolderSettings.newFolder.name,c=d.newFolderSettings.newFolderForm.newFolderName;c.$setValidity("invalidChars",!b.folderNameInvalidCharactersRegex.test(a)),c.$setValidity("duplicate",!h(a))}},d.$watch("newFolderSettings.isAdding",function(){d.newFolderSettings&&d.newFolderSettings.isAdding&&c(function(){d.$broadcast("onAddingFolder")})}),d.createFolder=function(){d.canCreateFolder()&&(d.newFolderSettings.isCreating=!0,d.newFolderSettings.newFolder.parentID=d.currentFolder.id,d.newFolderSettings.newFolder.name=d.newFolderSettings.newFolder.name.trim(),a.createOrgFolder(d.currentOrg.id,d.newFolderSettings.newFolder).then()["finally"](function(){d.newFolderSettings.isCreating=!1}))},d.cancelCreateFolder=function(){d.newFolderSettings.isCreating||g()},d.removeFolder=function(){d.canRemoveFolder()&&e.confirm({text:"Are you sure you wish to remove this folder?",confirmButtonText:"Remove Folder",isLoadingButtonText:"Removing Folder"},function(){return a.removeOrgFolder(d.currentOrg.id,d.currentFolder)})},d.gotoFolder=function(b){b&&b.id!==d.currentFolder.id&&a.gotoFolderByID(d.currentOrg.id,b.id)}}}}angular.module("Crops").directive("orgFolders",a),a.$inject=["orgService","config","$timeout","fvAlertsService","confirmService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{currentOrg:"="},replace:!0,templateUrl:"{0}/setup/orgs/org.change.info.html".format(b.viewRoot),link:function(c){function e(){c.currentOrg.emails=c.currentOrg.emails||[],c.currentOrg.phones=c.currentOrg.phones||[],c.currentOrg.addresses=c.currentOrg.addresses||[],c.currentOrg.addresses.length||c.currentOrg.addresses.push({name:"",line1:"",line2:"",city:"",state:"",zip:""}),c.currentOrg.phones.length||c.currentOrg.phones.push({label:"",number:""}),c.currentOrg.emails.length||c.currentOrg.emails.push({address:""})}function f(a){c.currentOrg.emails=_(a.emails).reject(function(a){return!a.address}),c.currentOrg.addresses=_(a.addresses).reject(function(a){return!(a.name||a.line1||a.line2||a.city||a.state||a.zip)}),c.currentOrg.phones=_(a.phones).reject(function(a){return!a.number})}function g(a){angular.copy(c.currentOrg,i),j=!1,c.orgInfoForm.$setPristine(),c.orgInfoForm.$setUntouched(),c.isSavingOrgInfo=!1,d.alertSuccess("Org Contact Info Saved")}function h(a){c.isSavingOrgInfo=!1,c.isOrgInfoSaveFailed=!0,d.alertFail(a)}c.isSavingOrgInfo=!1,c.isOrgInfoSaved=!1,c.isOrgInfoSaveFail=!1;var i={},j=!1;c.$watch("currentOrg",function(){c.currentOrg&&(angular.copy(c.currentOrg,i),e())}),c.canAddPhone=function(){if(!c.currentOrg||!c.currentOrg.phones)return!1;if(!c.currentOrg.phones.length)return!0;var a=c.currentOrg.phones[c.currentOrg.phones.length-1];return a.number&&""!==a.number.trim()},c.canAddAddress=function(){if(!c.currentOrg||!c.currentOrg.addresses)return!1;if(!c.currentOrg.addresses.length)return!0;var a=c.currentOrg.addresses[c.currentOrg.addresses.length-1];return a.name&&""!==a.name.trim()||a.line1&&""!==a.line1.trim()||a.line2&&""!==a.line2.trim()||a.city&&""!==a.city.trim()||a.state&&""!==a.state.trim()||a.zip&&""!==a.zip.trim()},c.canAddEmail=function(){if(!c.currentOrg||!c.currentOrg.emails)return!1;if(!c.currentOrg.emails.length)return!0;var a=c.currentOrg.emails[c.currentOrg.emails.length-1];return a.address&&""!==a.address.trim()},c.addPhone=function(){c.canAddPhone()&&c.currentOrg.phones.push({label:"",number:""})},c.addAddress=function(){c.canAddAddress()&&c.currentOrg.addresses.push({name:"",line1:"",line2:"",city:"",state:"",zip:""})},c.addEmail=function(){c.canAddEmail()&&c.currentOrg.emails.push({address:""})},c.rmPhone=function(a){j=!0,c.currentOrg.phones.splice(a,1),c.currentOrg.phones.length||c.currentOrg.phones.push({label:"",number:""})},c.rmAddress=function(a){j=!0,c.currentOrg.addresses.splice(a,1),c.currentOrg.addresses.length||c.currentOrg.addresses.push({name:"",line1:"",line2:"",city:"",state:"",zip:""})},c.rmEmail=function(a){j=!0,c.currentOrg.emails.splice(a,1),c.currentOrg.emails.length||c.currentOrg.emails.push({address:""})},c.pattern={email:new RegExp(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/i)},c.validateEmail=function(a,b){a&&""!==a&&!c.pattern.email.test(a)?(c.orgInfoForm["emailAddress_"+b].$setValidity("email",!1),c.isVisibleEmailErrorMessage=!0):(c.orgInfoForm["emailAddress_"+b].$setValidity("email",!0),c.isVisibleEmailErrorMessage=!1)},c.resetEmailError=function(a){c.orgInfoForm["emailAddress_"+a].$setValidity("email",!0),c.isVisibleEmailErrorMessage=!1},c.$on("onOrgLabelChanged",function(){j=!0}),c.$on(b.globalSaveHotkeyPressed,function(a,b,d){c.orgInfoForm&&c.canSave(c.orgInfoForm)&&c.saveCurrentOrg(c.orgInfoForm)}),c.isAdmin=function(){return c.$parent.isAdmin()},c.canSave=function(){return c.orgInfoForm&&!c.isSavingOrgInfo&&(j||c.orgInfoForm.$dirty)&&!c.orgInfoForm.$invalid},c.canUndo=function(){return c.orgInfoForm&&!c.isSavingOrgInfo&&(j||c.orgInfoForm.$dirty)},c.saveCurrentOrg=function(){if(c.canSave()){c.isSavingOrgInfo=!0;var b=angular.copy(c.currentOrg);f(b),a.updateOrgInfo(b,g,h),e()}},c.cancelEditing=function(){angular.copy(i,c.currentOrg),e(),j=!1,c.orgInfoForm.$setPristine(),c.orgInfoForm.$setUntouched()}}}}angular.module("Crops").directive("orgChangeInfo",a),a.$inject=["orgService","config","$timeout","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{currentOrg:"="},replace:!0,templateUrl:"{0}/setup/orgs/org.change.name.html".format(b.viewRoot),link:function(b){b.isSavingOrgName=!1,b.isJustSaved=!1,b.isSaveFail=!1,b.errorMessage="",b.orgName=angular.copy(b.currentOrg.name),b.$on(a.onCurrentOrgChanged,function(){b.currentOrg=a.currentOrg(),b.currentOrg?b.orgName=b.currentOrg.name:b.orgName="";
}),b.canCancel=function(){return!b.isSavingOrgName&&b.currentOrg&&b.currentOrg.id&&b.orgName!==b.currentOrg.name},b.canSave=function(){return b.orgNameUpdateForm.orgName.$valid&&b.orgName&&b.canCancel()},b.save=function(){b.canSave()&&a.changeOrgName(b.currentOrg.id,b.orgName)},b.cancel=function(){b.canCancel()&&(b.orgName=b.currentOrg.name,b.isSaveFail=!1,b.orgNameUpdateForm.$setPristine(),b.orgNameUpdateForm.$setUntouched())},b.$on(a.onLoadingChanged,function(){b.isSavingOrgName=a.isLoading().isSavingName}),b.$on(a.onSuccess.saveName,function(){d.alertSuccess("The Org has been renamed"),b.orgNameUpdateForm.$setPristine(),b.orgNameUpdateForm.$setUntouched()}),b.$on(a.onFail.saveName,function(){d.alertFail("The Org name could not be saved. Please refresh the page and try again.")})}}}angular.module("Crops").directive("orgChangeName",a),a.$inject=["orgService","config","$timeout","fvAlertsService"]}(),function(){"use strict";function a(a){return{restrict:"E",scope:{orgContact:"=",isOrgAddress:"=",isOrgPhone:"=",isOrgEmail:"="},replace:!0,templateUrl:"{0}/setup/orgs/org.contact.label.html".format(a.viewRoot),link:function(a){a.orgContactType=a.isOrgAddress?"Address":a.isOrgPhone?"Phone":a.isOrgEmail?"Email":"",a.orgContactLabels={Address:["Home","Work","Other","None"],Phone:["Office","Fax","Other","None"],Email:["Personal","Work","Other","None"]},a.addOrgLabel=function(b){"None"===b&&(b=""),a.orgContact.label=b,a.$emit("onOrgLabelChanged")}}}}angular.module("Crops").directive("orgContactLabel",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m){a.orgList=[],a.currentOrg=null,a.isLoadingOrgList=!0,a.isCreatingOrg=!1,a.isLoadingCurrentOrg=!1,a.selectOrg=function(a){a&&d.setCurrentOrg(a)},a.$on(d.onCurrentOrgChanged,function(){a.currentOrg=d.currentOrg(),a.gotoTab("basic")}),a.$on(d.onLoadingChanged,function(){a.isLoadingOrgList=d.isLoading().isLoadingOrgList,a.isCreatingOrg=d.isLoading().isCreatingOrg,a.isLoadingCurrentOrg=d.isLoading().isLoadingCurrentOrg}),a.isAdmin=function(){return a.currentOrg&&3===a.currentOrg.accessLevel},a.$on(m.onRoleListChanged,function(){a.rolesList=m.roleList()}),m.loadRoles(),a.$on(d.onOrgListChanged,function(){if(a.orgList=d.orgList(),a.orgList&&a.orgList.length){var b=a.currentOrg&&_(a.orgList).findWhere({id:a.currentOrg.id});b||1!==a.orgList.length?a.selectOrg(null):a.selectOrg(a.orgList[0])}}),d.loadOrgs(!1,!1,!1),a.toggleSidenav=function(a){h.toggleSidenav(a)},a.openAddOrg=function(){a.newOrg={},$("#addOrgModal").modal("show"),a.$broadcast("reFocusNewOrg")},a.addOrg=function(){a.addOrgForm.$valid&&!a.isAdding&&(a.newOrg.id=0,a.isAdding=!0,d.createOrg(a.newOrg))},a.$on(d.onSuccess.createOrg,function(b,d){$("#addOrgModal").modal("hide"),a.isAdding=!1,a.newOrg={},c.alertSuccess("New org added"),a.selectOrg(d)}),a.$on(d.onFail.createOrg,function(a,b){c.alertFail("We were unable to add this org. Please refresh the page and try again.")}),$("#addOrgModal").on("hidden.bs.modal",function(){a.newOrg={},a.addOrgForm.$setPristine()}),a.inviteOrgID=null,a.showInvitePanel=function(){a.inviteOrgID=a.currentOrg.id,i.showInvitePanel(a.currentOrg.id,0)},a.$on(d.onSuccess.inviteMember,function(b,d){a.inviteOrgID&&a.currentOrg.id===a.inviteOrgID&&(_(a.currentOrg.members).findWhere({memberID:d.memberID})?c.alertFail(d.user.fullname+" is already a member of the org."):(a.currentOrg.members.push(d),c.alertSuccess(d.user.fullname+" invited"))),a.inviteOrgID=null}),a.$on(d.onFail.inviteMember,function(b,d){d&&d.errorMessage?a.currentOrg.inviteErrorMessage=d.errorMessage:c.alertFail("We were unable to invite "+(d&&d.member&&d.member.fullname?d.member.fullname:"this new member")+". Please refresh the page and try again"),a.inviteOrgID=null}),a.openOrgPermissions=function(b){var c=k.open({animation:!0,templateUrl:"{0}/setup/orgs/org.permissions.modal.html".format(e.viewRoot),controller:"orgPermissionsModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"org-permissions-modal",resolve:{org:function(){return a.currentOrg},currentMember:function(){return b}}});c.result.then(function(b){for(var c=0;c<a.currentOrg.members.length;c++)if(a.currentOrg.members[c].memberID===b.memberID){a.currentOrg.members[c]=b;break}})},a.memberRoles=function(a){var b=[];return a&&(3===a.accessLevel?b.push("Org Admin"):a.accessOrgInbox&&b.push("Mailroom"),a.autoAddToNewProject&&(3===a.autoAccessLevelOnNewProject&&b.push("Project Admin"),a.autoFollowNewProject?b.push("Project Follower"):b.push("Project Collab"))),b},a.isLegacyDocIntegration=function(){return a.currentOrg&&a.currentOrg.docIntegration&&a.currentOrg.docIntegration.integrationTypeID<10},a.getSyncStatusDetails=function(){if(a.currentOrg&&a.currentOrg.docIntegration&&a.currentOrg.docIntegration.lastSyncStatus){var b,c=a.currentOrg.docIntegration.lastSyncStatus,d=a.currentOrg.docIntegration.name;switch(c){case"Success":b="Your "+d+" integration is set up and everything is working.";break;case"InitialSync":b="Your "+d+" integration is set up and we are syncing the org's files.";break;case"Failed":b="Something went wrong while trying to sync docs. We'll attempt to connect to your "+d+" account for about an hour, and if it's still not working, an Advanced user can repair the integration.";break;case"LostAuthorization":b="We were unable to sync with your "+d+" account.";break;case"Not Available":b="The setup may not have been completed or we may not have synced any docs yet. Refresh the page or come back later for an updated status.";break;default:b=""}return b}},a.showSmsSetupModal=function(){var b={name:a.currentOrg.name,type:"org",id:a.currentOrg.id,number:a.currentOrg.smsNumber};g.showSmsSetupModal(b)},a.$on(g.onDetailChanged,function(b,c,d){"success"===c&&(a.currentOrg.smsNumber=d)}),a.tab={basic:{title:"Basic Info",active:!0},contact:{title:"Contact Info",active:!1},members:{title:"Members",active:!1},folders:{title:"Folders",onSelect:function(){a.$broadcast("onOrgFoldersTabSelected")},active:!1}},a.gotoTab=function(b){_(a.tab).each(function(c){c.active=c===a.tab[b]})}}angular.module("Crops").controller("OrgController",a),a.$inject=["$scope","$rootScope","fvAlertsService","orgService","config","$location","smsService","sidenavService","userService","$window","$uibModal","confirmService","roleService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(b){if(b&&b.autoAddToNewProject){var c=_(a.autoAddSettingsList).findWhere({accessLevel:b.autoAccessLevelOnNewProject,follower:b.autoFollowNewProject});if(c)return c.name}return null}function l(b){a.memberReference=b,a.memberReference.isAdmin=3===a.memberReference.accessLevel,a.memberReference.isOrgOwner=a.memberReference.user.id===a.org.ownerID,a.memberReference.isCurrentUser=a.memberReference.user&&a.memberReference.user.id&&a.memberReference.user.id===f.currentUser().id,a.memberReference.autoAddSettingsName=k(b),a.member=angular.copy(a.memberReference),a.rolesList?a.settings.autoRoles=_(a.rolesList).filter(function(b){return a.member.autoRoleIDs.indexOf(b.id)>-1}):a.settings.autoRoles=[]}function m(b){var c=_(a.existingProjectAccessLevels).findWhere({name:b});return c?c.toHuman:""}function n(){var b=_(a.autoAddSettingsList).findWhere({name:a.member.autoAddSettingsName}),c=a.member.autoAddToNewProject;return{autoAddToNewProject:c,autoAccessLevelOnNewProject:c&&b?b.accessLevel:0,autoFollowNewProject:!(!c||!b)&&b.follower,autoRoleIDs:c?a.member.autoRoleIDs:[]}}function o(c,d){l(c),e.alertSuccess((a.member.isCurrentUser?"Your ":a.member.user.fullname+"'s ")+d+" settings have been updated."),a.status.closeAfterUpdate&&b.close(a.memberReference)}function p(b){e.alertFail("There was a problem saving "+(a.member.isCurrentUser?"your ":a.member.user.fullname+"'s ")+b+" settings. Please refresh and try again.")}a.status={isRemovingFromOrg:!1,isUpdatingMember:!1,isUpdatingExistingProjectPermissions:!1,isAddingRoleToExistingProjects:!1,isRemovingRoleFromExistingProjects:!1,closeAfterUpdate:!1},a.forms={},a.settings={tabTooltipText:"You have unsaved changes. You must update or reset before going to another tab."},a.$on(c.onLoadingChanged,function(){a.status.isRemovingFromOrg=c.isLoading().isRemovingFromOrg,a.status.isUpdatingMember=c.isLoading().isUpdatingMember}),a.$on(g.onRoleListChanged,function(){a.rolesList=g.roleList(),a.rolesList&&a.rolesList.length&&a.member&&a.member.autoRoleIDs?a.settings.autoRoles=_(a.rolesList).filter(function(b){return a.member.autoRoleIDs.indexOf(b.id)>-1}):a.settings.autoRoles=[]}),g.loadRoles(),a.initOrgTab=function(){a.currentActiveTabTitle="Org Admin Permissions"},a.initExistingProjectsTab=function(){a.currentActiveTabTitle="Existing Project Permissions",a.settings.projectCriteria=a.existingProjectCriteria[0],a.settings.roleToAdd=null,a.settings.roleToRemove=null},a.initNewProjectsTab=function(){a.currentActiveTabTitle="New Project Permissions (Auto-add)",a.settings.autoRoles||(a.rolesList&&a.rolesList.length&&a.member&&a.member.autoRoleIDs?a.settings.autoRoles=_(a.rolesList).filter(function(b){return a.member.autoRoleIDs.indexOf(b.id)>-1}):a.settings.autoRoles=[])},a.isOpen={existingProjectsTab:!0,newProjectsTab:!1,orgTab:!1},a.autoAddSettingsList=[{name:"Admin-Follower",accessLevel:3,follower:!0},{name:"Admin-Collaborator",accessLevel:3,follower:!1},{name:"Follower",accessLevel:2,follower:!0},{name:"Collaborator",accessLevel:2,follower:!1},{name:"Guest",accessLevel:1,follower:!0}],i&&(a.org=i),j&&l(j),a.existingProjectCriteria=[{name:"allorg",description:"in the entire org"},{name:"member",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" already a team member"},{name:"admin",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" an Admin"},{name:"nonadminmember",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" a non-Admin"},{name:"follower",description:"that "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" following"},{name:"nonfollower",description:"that "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" not following"},{name:"collaborator",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" a Collaborator (non-admin, non-follower)"},{name:"nonguestmember",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" a non-Guest team member"},{name:"guest",description:"where "+(a.member.isCurrentUser?"you are":a.member.user.firstName+" is")+" a Guest"}],a.existingProjectAccessLevels=[{name:"adminfollower",toHuman:"Admin-Follower"},{name:"admincollaborator",toHuman:"Admin-Collaborator"},{name:"follower",toHuman:"Follower"},{name:"collaborator",toHuman:"Collaborator"},{name:"guest",toHuman:"Guest"},{name:"admin",toHuman:"Admin"},{name:"full",toHuman:"non-Admin"},{name:"follow",toHuman:"follow"},{name:"unfollow",toHuman:"unfollow"}],a.hideProjectAccessActions=function(){return!a.settings||!a.settings.projectCriteria||"allorg"===a.settings.projectCriteria.name||"guest"===a.settings.projectCriteria.name||"follower"===a.settings.projectCriteria.name||"nonfollower"===a.settings.projectCriteria.name},a.hideProjectNotificationActions=function(){return!a.settings||!a.settings.projectCriteria||"allorg"===a.settings.projectCriteria.name||"guest"===a.settings.projectCriteria.name},a.canAddRoleToExisting=function(){return a.member&&a.member.user&&a.member.user.id&&a.settings.roleToAdd&&a.settings.roleToAdd.id},a.canRemoveRoleFromExisting=function(){return a.member&&a.member.user&&a.member.user.id&&a.settings.roleToRemove&&a.settings.roleToRemove.id},a.addRoleToExistingProjects=function(){a.canAddRoleToExisting&&h.confirm({text:"Are you sure you wish to give "+(a.member.isCurrentUser?"yourself":a.member.user.fullname)+" the role of '"+a.settings.roleToAdd.name+"' on all existing projects of which "+(a.member.isCurrentUser?"you're":"he/she is")+" already a member?",confirmButtonText:"Add Role",isLoadingText:"Adding Role"},function(){return a.status.isAddingRoleToExistingProjects=!0,c.addRoleToExistingProjects(a.member.user.id,a.settings.roleToAdd.id).then(function(b){var c=0===b?"No projects were affected.":(a.member.isCurrentUser?"Your ":a.member.user.fullname+"'s ")+"role has been added in "+b+" project"+(1===b?".":"s.");e.alertSuccess(c),a.settings.roleToAdd=null},function(){e.alertFail("There was a problem adding "+(a.member.isCurrentUser?"your ":a.member.user.fullname+"'s ")+"project role. Please refresh and try again.")})["finally"](function(){a.status.isAddingRoleToExistingProjects=!1})})},a.removeRoleFromExistingProjects=function(){a.canRemoveRoleFromExisting&&h.confirm({text:"Are you sure you wish to remove "+(a.member.isCurrentUser?"your":a.member.user.fullname+"'s")+" role of '"+a.settings.roleToRemove.name+"' from all existing projects of which "+(a.member.isCurrentUser?"you're":"he/she is")+" already a member?",confirmButtonText:"Remove Role",isLoadingText:"Removing Role"},function(){return a.status.isRemovingRoleFromExistingProjects=!0,c.removeRoleFromExistingProjects(a.member.user.id,a.settings.roleToRemove.id).then(function(b){var c=0===b?"No projects were affected.":(a.member.isCurrentUser?"Your ":a.member.user.fullname+"'s ")+"role has been removed from "+b+" project"+(1===b?".":"s.");e.alertSuccess(c),a.settings.roleToRemove=null},function(){e.alertFail("There was a problem removing "+(a.member.isCurrentUser?"your ":a.member.user.fullname+"'s ")+"project role. Please refresh and try again.")})["finally"](function(){a.status.isRemovingRoleFromExistingProjects=!1})})},a.updateExistingProjectPermissions=function(b){if(a.member&&a.member.user&&a.member.user.id){var d,f=m(b);switch(b){case"adminfollower":case"admincollaborator":case"follower":case"collaborator":case"guest":d="Are you sure you wish to make "+(a.member.isCurrentUser?"yourself":a.member.user.fullname)+" a(n) '"+f+"' on all existing projects "+a.settings.projectCriteria.description+"?";break;case"admin":case"full":d="Are you sure you wish to change "+(a.member.isCurrentUser?"your":a.member.user.fullname+"'s")+" project access level to '"+f+"' on all existing projects "+a.settings.projectCriteria.description+"?";break;case"follow":case"unfollow":d="Are you sure you wish to set "+(a.member.isCurrentUser?"yourself":a.member.user.fullname)+" to "+f+" all existing projects "+a.settings.projectCriteria.description+"?"}h.confirm({text:d,confirmButtonText:"Yes, Update",isLoadingButtonText:"Updating"},function(){return a.status.isUpdatingExistingProjectPermissions=!0,c.updateExistingProjectPermissions(a.member.user.id,b,a.settings.projectCriteria.name).then(function(b){var c=0===b?"No projects were affected.":(a.member.isCurrentUser?"Your ":a.member.user.fullname+"'s ")+"permissions have been updated on "+b+" project"+(1===b?".":"s.");e.alertSuccess(c),a.settings.projectCriteria=a.existingProjectCriteria[0]},function(b){console.log(b),e.alertFail("There was a problem updating "+(a.member.isCurrentUser?"your ":a.member.user.fullname+"'s ")+"existing project permissions. Please refresh and try again.")})["finally"](function(){a.status.isUpdatingExistingProjectPermissions=!1})})}},a.$watch("member.autoAddToNewProject",function(b,c){c&&!b&&(a.member.autoAddSettingsName=null,a.member.autoRoleIDs=[],a.settings.autoRoles=[])}),a.onAutoRolesChanged=function(){a.member.autoRoleIDs=_(a.settings.autoRoles).map(function(a){return a.id})},a.selectedRolesToList=function(){var b=a.settings.autoRoles;if(b&&b.length){var c=b.map(function(a){return a.name});return 1===c.length?c[0]:[c.slice(0,-1).join(", "),c.slice(-1)[0]].join(c.length>2?", and ":" and ")}},a.hasAutoAddSettingsChanges=function(){return a.member&&a.member.user&&a.member.user.id&&a.memberReference&&(a.member.autoAddToNewProject!==a.memberReference.autoAddToNewProject||!angular.equals(a.member.autoAddSettingsName,a.memberReference.autoAddSettingsName)||!angular.equals(a.member.autoRoleIDs,a.memberReference.autoRoleIDs))},a.canUpdateAutoAddSettings=function(){return!a.status.isUpdatingMember&&!a.status.isRemovingFromOrg&&a.hasAutoAddSettingsChanges()&&(!a.member.autoAddToNewProject||a.member.autoAddSettingsName)},a.updateOrgProjectAutoAddSettings=function(){if(a.canUpdateAutoAddSettings()){var b=a.member.autoAddToNewProject?"Are you sure you wish to auto-add "+(a.member.isCurrentUser?"yourself":a.member.user.fullname)+" as a "+a.member.autoAddSettingsName+" on new projects"+(a.member.autoRoleIDs&&a.member.autoRoleIDs.length?" with the role(s) of "+a.selectedRolesToList():"")+"?":"Are you sure you wish to stop auto-adding "+(a.member.isCurrentUser?"yourself":a.member.user.fullname)+" to new projects?";h.confirm({text:b,confirmButtonText:"Yes, Update",isLoadingButtonText:"Updating"},function(){a.status.isUpdatingMember=!0;var b=n();return c.updateOrgProjectAutoAddSettings(a.member.user.id,b).then(function(a){o(a,"new projects")},function(a){p("new projects")})["finally"](function(){a.status.isUpdatingMember=!1})})}},a.resetAutoAddSettings=function(){a.member.autoAddToNewProject=a.memberReference.autoAddToNewProject,a.member.autoAddSettingsName=a.memberReference.autoAddSettingsName,a.member.autoRoleIDs=angular.copy(a.memberReference.autoRoleIDs),a.settings.autoRoles=_(a.rolesList).filter(function(b){return a.member.autoRoleIDs.indexOf(b.id)>-1}),a.forms.autoAddForm.$setPristine(),a.forms.autoAddForm.$setUntouched()},a.setAsAdmin=function(){a.member.isAdmin?(a.member.accessLevel=3,a.member.accessOrgInbox=!0):a.member.accessLevel=2},a.canUpdateOrgPermissions=function(){return!a.status.isUpdatingMember&&!a.status.isRemovingFromOrg&&a.member&&a.member.user&&a.member.user.id&&a.memberReference&&(a.member.isAdmin!==a.memberReference.isAdmin||a.member.accessOrgInbox!==a.memberReference.accessOrgInbox)},a.updateOrgPermissions=function(){if(a.canUpdateOrgPermissions()){var b="Are you sure you wish to "+(a.member.accessLevel!==a.memberReference.accessLevel?3===a.member.accessLevel?"make "+a.member.user.fullname+" an Org Admin?":"remove "+a.member.user.fullname+"'s Org Admin "+(a.member.accessOrgInbox?"access, but still allow him/her to access the Org's Mailroom?":"and Mailroom access?"):(a.member.accessOrgInbox?"grant "+a.member.user.fullname:"remove "+a.member.user.fullname+"'s")+" access to the Org's Mailroom?");h.confirm({text:b,confirmButtonText:"Yes, Update",isLoadingButtonText:"Updating"},function(){a.status.isUpdatingMember=!0;var b={accessLevel:a.member.accessLevel,accessOrgInbox:a.member.accessOrgInbox};return c.updateOrgPermissions(a.member.user.id,b).then(function(a){o(a,"org")},function(){p("org")})["finally"](function(){a.status.isUpdatingMember=!1})})}},a.resetOrgPermissions=function(){a.member.accessLevel=angular.copy(a.memberReference.accessLevel),a.member.accessOrgInbox=angular.copy(a.memberReference.accessOrgInbox),a.member.isAdmin=3===a.member.accessLevel},a.canRemoveFromOrg=function(){return!a.status.isUpdatingMember&&!a.status.isRemovingFromOrg&&a.member&&a.member.user&&a.member.user.id},a.removeFromProjectsAndOrg=function(){a.canRemoveFromOrg()&&h.confirm({text:"Are you sure you wish to remove "+(a.member.isCurrentUser?"yourself":a.member.user.firstName)+" from the Org and all its projects?",confirmButtonText:"Remove from Org",isLoadingText:"Removing from Org"},function(){return c.removeFromProjectsAndOrg(a.member)})},a.$on(c.onSuccess.removeFromOrg,function(){e.alertSuccess((a.member.isCurrentUser?"You have ":a.member.user.fullname+" has ")+"been removed from the org and all projects.",5e3),a.dismiss("Member removed from Org")}),a.$on(c.onFail.removeFromOrg,function(b,c){e.alertFail("There was a problem removing "+(a.member.isCurrentUser?"you":a.member.user.fullname)+" from the org: "+c)}),a.dismiss=function(a){b.dismiss(a)},a.close=function(){var c=a.canUpdateAutoAddSettings()?"New Projects":a.canUpdateOrgPermissions()?"Org Admin":null;c?h.confirm({type:"warning",text:"You have unsaved changes in the "+c+" tab. Are you sure you wish to close?",confirmButtonText:"Save then Close",cancelButtonText:"Close"}).then(function(){a.status.closeAfterUpdate=!0;var b="New Projects"===c?a.updateOrgProjectAutoAddSettings:a.updateOrgPermissions;b()},function(){b.close(a.memberReference)}):b.close(a.memberReference)}}angular.module("Crops").controller("orgPermissionsModalController",a),a.$inject=["$scope","$uibModalInstance","orgService","config","fvAlertsService","currentUserService","roleService","confirmService","org","currentMember"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){return{isLoadingOrgList:V.isLoadingOrgList,isLoadingCurrentOrg:V.isLoadingCurrentOrg,isCreatingOrg:V.isCreatingOrg,isSavingName:V.isSavingName,isUpdatingMember:V.isUpdatingMember,isRemovingFromOrg:V.isRemovingFromOrg,currentOrgFolder:V.currentOrgFolder}}function g(c,d,e){return W=[],M("isLoadingOrgList",!0),a.get(O.getList,[c?1:0,d?1:0,e?1:0]).then(function(a){W=a},function(){b.$broadcast(U.loadOrgs)})["finally"](function(){M("isLoadingOrgList",!1),b.$broadcast(P)})}function h(){return W}function i(c){c!==X&&(c?(M("isLoadingCurrentOrg",!0),X=null,b.$broadcast(Q),a.get(O.getOrg,[c.id,1,0,1]).then(function(a){angular.copy(a,c),X=c,b.$broadcast(Q)})["finally"](function(){M("isLoadingCurrentOrg",!1)})):(X=c,b.$broadcast(Q)))}function j(b,c){return a.get(O.getOrgMember,[b,c])}function k(){return a.get(O.getDocIntegrationTypes)}function l(b,d){return a.post(O.removeDocIntegration,[b,d]).then(function(){for(var a=0;a<W;a++)if(W[a].id===b){W[a].docIntegrations=null,c.alertSuccess();break}})}function m(b,c){return a.get(c,[b])}function n(){return X}function o(b,c,d){return a.get(O.getAdminList,[b?1:0,c?1:0,d?1:0])}function p(c){M("isCreatingOrg",!0),a.post(O.createOrg,[],c).then(function(a){M("isCreatingOrg",!1),g(!0,!1,!0).then(function(){X=a,b.$broadcast(Q),b.$broadcast(T.createOrg,a)})},function(a){M("isCreatingOrg",!1),b.$broadcast(U.createOrg,a)})}function q(c,d){M("isSavingName",!0),a.post(O.updateOrgName,[c],{name:d}).then(function(a){X=a,M("isSavingName",!1),g(!0,!1,!0),b.$broadcast(Q),b.$broadcast(T.saveName)},function(){M("isSavingName",!1),b.$broadcast(U.validName)})}function r(b,c,d){var e=angular.isFunction(c)?c:function(){},f=angular.isFunction(d)?d:function(){};b.id&&a.post(O.updateOrgInfo,[b.id],b).then(function(a){e(a)},function(a){f("Could not save org info. Please refresh and try again")})}function s(b){return b?b.userID<0?a.post(O.inviteNewUser,[X.id],{FindBy:b.userName}).then(function(a){t(a)},function(a){u(a)}):a.post(O.inviteKnownUser,[X.id],b).then(function(a){t(a)},function(a){u(a,b)}):null}function t(a){b.$broadcast(T.inviteMember,a)}function u(a,c){a=N(a),b.$broadcast(U.inviteMember,{errorMessage:a,member:c})}function v(b,c,d){return a.post(O.updateExistingProjectPermissions,[X.id,b,c,d])}function w(b,c){return a.post(O.addRoleToExistingProjects,[X.id,b,c])}function x(b,c){return a.post(O.removeRoleFromExistingProjects,[X.id,b,c])}function y(b,c){return a.post(O.updateOrgPermissions,[X.id,b],c)}function z(b,c){return a.post(O.updateOrgProjectAutoAddSettings,[X.id,b],c)}function A(c){M("isRemovingFromOrg",!0);var e=c.user.id===d.currentUser().id;return a.post(O.removeFromProjectsAndOrg,[X.id,c.user.id]).then(function(){if(e)W=null,X=null,b.$broadcast(Q),b.$broadcast(P),g(!1,!1,!1);else for(var a=0,d=X.members.length;a<d;a++)if(X.members[a].user.id===c.user.id){X.members.splice(a,1),b.$broadcast(Q);break}b.$broadcast(T.removeFromOrg)},function(a){b.$broadcast(U.removeFromOrg,a)})["finally"](function(){M("isRemovingFromOrg",!1)})}function B(a){a&&(Y=a,b.$broadcast(Z))}function C(a,b){return M("currentOrgFolder",!0),J(a,b).then(function(a){B(a)},function(a){c.alertFail("There was a problem retrieving this folder. "+a)})["finally"](function(){M("currentOrgFolder",!1)})}function D(a){M("currentOrgFolder",!0),G(a).then(function(a){B(a)},function(a){c.alertFail("There was a problem retrieving the Org's root folder. "+a)})["finally"](function(){M("currentOrgFolder",!1)})}function E(){return Y}function F(d,e){return a.post(O.createOrgFolder,[d],e).then(function(a){Y.children.unshift(a),b.$broadcast(Z)},function(a){c.alertFail("There was a problem creating this folder. "+a)})}function G(b){return a.get(O.getOrgRootFolder,[b])}function H(b,d){return a.post(O.moveOrgFolder,[b,d.id],d).then(function(a){c.alertSuccess("Folder moved"),a.isProjectRootFolder?e.setProjectRootFolderAsCurrent():B(a)},function(a){c.alertFail("There was a problem moving this folder. "+a)})}function I(d,e){return a.put(O.renameOrgFolder,[d,e.id],e).then(function(a){Y=a,b.$broadcast(Z)},function(a){c.alertFail("There was a problem renaming this folder. "+a)})}function J(b,c){return a.get(O.getOrgFolder,[b,c])}function K(b,c){return a.get(O.getOrgFolderChildren,[b,c])}function L(b,d){return a.del(O.removeOrgFolder,[b,d.id]).then(function(){c.alertSuccess("Folder removed"),C(b,d.parentID)},function(a){c.alertFail("There was a problem removing this folder. "+a)})}function M(a,c){a in V&&(V[a]=c,b.$broadcast(R))}function N(a){return a?a.indexOf(":")?a.substring(a.indexOf(":")+1):a:""}var O={getOrg:"/api/org/{0}?includeMembers={1}&includeProjectTypes={2}&includeExtendedInfo={3}",getList:"/api/orgs?includeMembers={0}&includeProjectTypes={1}&includeExtendedInfo={2}",getOrgMember:"api/orgs/{0}/users/{1}",getAdminList:"api/orgs/adminonly?includeMembers={0}&includeProjectTypes={1}&includeExtendedInfo={2}",getDocIntegrationTypes:"/api/docintegrations",removeDocIntegration:"/api/orgs/{0}/removeintegration/{1}",createOrg:"/api/orgs/create",updateOrgName:"/api/orgs/{0}/updateName",updateOrgInfo:"/api/orgs/{0}/updateInfo",inviteKnownUser:"/api/orgs/{0}/inviteKnownUser",inviteNewUser:"/api/orgs/{0}/invite",updateExistingProjectPermissions:"/api/orgs/{0}/users/{1}/updateExistingProjectPermissions/{2}/{3}",addRoleToExistingProjects:"/api/orgs/{0}/users/{1}/addRoleToExistingProjects/{2}",removeRoleFromExistingProjects:"/api/orgs/{0}/users/{1}/removeRoleFromExistingProjects/{2}",updateOrgPermissions:"/api/orgs/{0}/users/{1}/updateOrgPermissions",updateOrgProjectAutoAddSettings:"/api/orgs/{0}/users/{1}/updateOrgProjectAutoAddSettings",removeFromProjectsAndOrg:"/api/orgs/{0}/users/{1}/remove",createOrgFolder:"/api/orgs/{0}/folders",getOrgRootFolder:"api/orgs/{0}/rootfolder",moveOrgFolder:"/api/orgs/{0}/folders/{1}",renameOrgFolder:"/api/orgs/{0}/folders/{1}",getOrgFolder:"/api/orgs/{0}/folders/{1}",getOrgFolderChildren:"/api/orgs/{0}/folders/{1}/children",removeOrgFolder:"/api/orgs/{0}/folders/{1}"},P="orgService.onOrgListChanged",Q="orgService.onCurrentOrgChanged",R="orgService.onLoadingChanged",S="orgService.onOrgPermissionsOpened",T={saveName:"orgService.onSuccess.Savename",createOrg:"orgService.onSuccess.createOrg",updateMember:"orgService.onSuccess.updateMember",inviteMember:"orgService.onSuccess.inviteMember",removeFromOrg:"orgService.onSuccess.removeFromOrg"},U={saveName:"orgService.onFail.Savename",createOrg:"orgService.onFail.createOrg",loadOrgs:"orgService.onFail.loadOrgs",inviteMember:"orgService.onFail.inviteMember",updateMember:"orgService.onFail.updateMember",removeFromOrg:"orgService.onFail.removeFromOrg"},V={isLoadingOrgList:!1,isCreatingOrg:!1,isSavingName:!1,isUpdatingMember:!1,isLoadingCurrentOrg:!1,isRemovingFromOrg:!1,currentOrgFolder:!1},W=null,X=null,Y=null,Z="orgService.onCurrentOrgFolderChanged",$={loadOrgs:g,orgList:h,getOrgMember:j,isLoading:f,onOrgListChanged:P,onCurrentOrgChanged:Q,setCurrentOrg:i,currentOrg:n,getDocIntegrationTypes:k,removeDocIntegration:l,repairLegacyDocIntegration:m,onLoadingChanged:R,onOrgPermissionsOpened:S,onSuccess:{saveName:T.saveName,createOrg:T.createOrg,inviteMember:T.inviteMember,updateMember:T.updateMember,removeFromOrg:T.removeFromOrg},onFail:{saveName:U.saveName,createOrg:U.createOrg,loadOrgs:U.loadOrgs,inviteMember:U.inviteMember,updateMember:U.updateMember,removeFromOrg:U.removeFromOrg},getAdminList:o,createOrg:p,changeOrgName:q,updateOrgInfo:r,invite:s,updateExistingProjectPermissions:v,addRoleToExistingProjects:w,removeRoleFromExistingProjects:x,updateOrgPermissions:y,updateOrgProjectAutoAddSettings:z,removeFromProjectsAndOrg:A,currentOrgFolder:E,gotoFolderByID:C,gotoOrgRootFolder:D,createOrgFolder:F,getOrgRootFolder:G,moveOrgFolder:H,renameOrgFolder:I,getOrgFolder:J,getOrgFolderChildren:K,removeOrgFolder:L,onCurrentOrgFolderChanged:Z};return $}angular.module("Crops").service("orgService",a),a.$inject=["fvApi","$rootScope","fvAlertsService","currentUserService","docService"]}(),function(){"use strict";function a(a,b,c,d,e){a.paymentLoading=!1,a.cardAction="Add",a.currentCard={},a.currentCardMask=function(){return a.currentCard.lastFour?["************",a.currentCard.lastFour," Exp: ",a.currentCard.expMonth,"/",a.currentCard.expYear].join(""):""},d.get().then(function(b){b.length&&(a.currentCard=b[0],a.cardAction="Update")},function(a){console.log("Unable to get credit card")}),a.expDateInvalid=function(){return a.card&&a.card.expMonth&&a.card.expYear&&moment().diff(moment([+a.card.expYear,+a.card.expMonth-1,1]).endOf("month"))>0},a.addUpdateCard=function(b){a.paymentLoading=!0,a.errorMessage="";var f=$('form[name="cardForm"]');e.Stripe.card.createToken(f,function(b,e){if(200===b){var f={token:e.id,type:e.card.brand,expMonth:e.card.exp_month,expYear:e.card.exp_year,lastFour:e.card.last4};d.createUpdate(f).then(function(b){a.successMessage="Your card was added successfully",a.currentCard=f,a.card={},c(function(){a.successMessage=""},3e3)},function(b){a.errorMessage="An error occurred saving your credit card.",console.log(b)})["finally"](function(){a.paymentLoading=!1})}else a.errorMessage=e.error.message,a.paymentLoading=!1})},b.$on("$viewContentLoaded",function(){$.getScript(e.Crops.StripeUri,function(){e.Stripe.setPublishableKey(e.Crops.StripePublic)})})}angular.module("Crops").controller("PaymentController",a),a.$inject=["$scope","$rootScope","$timeout","paymentService","$window"]}(),function(){"use strict";function a(a){function b(){return a.get(e.creditCards)}function c(){return a.get(e.creditCardPaymentHistory)}function d(b){return a.post(e.creditCardCreate,[],b)}var e={creditCards:"/api/creditcards",creditCardPaymentHistory:"/api/users/paymenthistory",creditCardCreate:"/api/creditcards/create"},f={get:b,paymentHistory:c,createUpdate:d};return f}angular.module("Crops").service("paymentService",a),a.$inject=["fvApi"]}(),function(){"use strict";function a(a,b){b.toggleSidenav("close"),a.$on(b.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(){b.toggleSidenav()}}angular.module("Crops").controller("SetupController",a),a.$inject=["$scope","sidenavService"]}(),function(){"use strict";function a(a,b,c){a.sections=[{name:"My Profile",sectionIcon:"fa fa-fw fa-user",currentSectionIcon:"fa fa-user",url:"setupLayout.setup.profile"},{name:"Account Settings",sectionIcon:"fa fa-fw fa-key",currentSectionIcon:"fa fa-key",url:"setupLayout.setup.account"},{name:"Notifications",sectionIcon:"fa fa-fw fa-envelope-o",currentSectionIcon:"fa fa-envelope-o",url:"setupLayout.setup.notifications"},{name:"Orgs",sectionIcon:"fa fa-fw fa-users",currentSectionIcon:"fa fa-users",url:"setupLayout.setup.orgs"},{name:"Plugins",sectionIcon:"fa fa-fw fa-plug",currentSectionIcon:"fa fa-plug",url:"setupLayout.setup.plugins"}],a.$on("$stateChangeSuccess",function(){for(var b=0;b<a.sections.length;b++)if(a.sections[b].url===c.current.name){a.currentSection=a.sections[b],a.toggleSidenav("close");break}}),a.onSectionSelected=function(b){b.name===a.currentSection.name&&c.reload(),a.toggleSidenav("close")},a.isSidenavOpen=!1,a.$on(b.onSidenavChanged,function(b,c){a.isSidenavOpen=c.isSidenavOpen}),a.toggleSidenav=function(a){b.toggleSidenav(a)}}angular.module("Crops").controller("SetupSidenavController",a),a.$inject=["$scope","sidenavService","$state"]}(),function(){"use strict";function a(a,b,c){return{restrict:"A",replace:!0,templateUrl:"{0}/share/share.view.html".format(b.viewRoot),scope:{
shareList:"=",activated:"=",shareXpos:"@"},link:function(a,b,d){var e=d.shareType;a.isTogglingShare={},a.shareXpos="right"===a.shareXpos?"right":"left",a.shareToggle=function(b){var f=b.isShared?c.shareRemove:c.shareAdd;a.isTogglingShare[b.id]=!0,f(e,d.assetId,b.id).then(function(){b.isShared=!b.isShared},function(){})["finally"](function(){a.isTogglingShare[b.id]=!1,a.$emit("onSharedUsersChanged")})},b.find(".popover-content").on("mouseleave",function(){a.$apply(function(){a.activated=!1})})}}}angular.module("Crops").directive("fvShare",a),a.$inject=["$rootScope","config","shareService"]}(),function(){"use strict";function a(a,b){function c(a,b,c){return"notes"===a?e(b,c):"docs"===a?g(b,c):"section"===a?i(b,c,!1):void 0}function d(a,b,c){return"notes"===a?f(b,c):"docs"===a?h(b,c):"section"===a?j(b,c):void 0}function e(b,c){return a.post(k.addNoteShare,[b,c])}function f(b,c){return a.post(k.removeNoteShare,[b,c])}function g(b,c){return a.post(k.addDocShare,[b,c])}function h(b,c){return a.post(k.removeDocShare,[b,c])}function i(c,d,e){return a.post(k.addOrEditSectionShare,[b.projectID,c,d,e?1:0])}function j(c,d){return a.post(k.removeSectionShare,[b.projectID,c,d])}var k={addNoteShare:"/api/notes/{0}/share/{1}",removeNoteShare:"/api/notes/{0}/unshare/{1}",addDocShare:"/api/docs/{0}/share/{1}",removeDocShare:"/api/docs/{0}/unshare/{1}",addOrEditSectionShare:"/api/projects/{0}/section/{1}/share/{2}/{3}",removeSectionShare:"/api/projects/{0}/section/{1}/unshare/{2}"},l={shareAdd:c,shareRemove:d,addOrEditSectionShare:i};return l}angular.module("Crops").service("shareService",a),a.$inject=["fvApi","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e,f){e&&(a.org=e,a.orgID=e.orgID||e.id,a.orgName=e.orgName||e.name),a.status={isSendingSms:!1},a.settings={targetNumber:null,message:null,errorMessage:null},a.validateTargetNumber=function(b){if(b){var c=a.settings.targetNumber&&10===a.settings.targetNumber.replace(/\D/g,"").length;a.sendSmsForm.targetNumber.$setValidity("required",!0),a.sendSmsForm.targetNumber.$setValidity("tenDigitNumber",c)}else a.sendSmsForm.targetNumber.$setValidity("required",!1)},a.canSendSms=function(){return!a.status.isSendingSms&&a.orgID&&a.org.smsNumber&&a.settings.targetNumber&&a.settings.message&&a.sendSmsForm.$valid},a.sendSms=function(){a.canSendSms()&&(a.status.isSendingSms=!0,d.sendOrgSms(a.orgID,a.settings.targetNumber,a.settings.message).then(function(){a.status.isSendingSms=!1,f.alertSuccess("Text message sent."),a.close()},function(){a.status.isSendingSms=!1,f.alertFail("There was a problem sending this text message. Please refresh and try again.")}))},a.close=function(){b.close()}}angular.module("Crops").controller("sendOrgSmsModalController",a),a.$inject=["$scope","$uibModalInstance","$rootScope","mailroomService","org","fvAlertsService"]}(),function(){"use strict";function a(a,b,c,d){function e(a){d.open({animation:!0,templateUrl:"{0}/sms/sms.setup.modal.html".format(b.viewRoot),controller:"smsSetupModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"sms-modal sms-setup-modal",resolve:{smsInfo:function(){return a}}})}function f(a){a&&a.orgID&&a.smsNumber&&d.open({animation:!0,templateUrl:"{0}/sms/send.org.sms.modal.html".format(b.viewRoot),controller:"sendOrgSmsModalController",size:"md",backdrop:"static",keyboard:!1,windowClass:"sms-modal send-org-sms-modal",resolve:{org:function(){return a}}})}function g(b,d){a.post(k.smsAssignToProject,[b,d]).then(function(a){c.$broadcast(l,"success",a)})["catch"](function(a){c.$broadcast(l,"failure",a)})}function h(b){a.post(k.smsDropFromProject,[b]).then(function(){c.$broadcast(l,"success")})}function i(b,d){a.post(k.smsAssignToOrg,[b,d]).then(function(a){c.$broadcast(l,"success",a)})["catch"](function(a){c.$broadcast(l,"failure",a)})}function j(b){return a.post(k.smsDropFromOrg,[b]).then(function(){c.$broadcast(l,"success")})}var k={smsAssignToProject:"/api/projects/{0}/assignsms/{1}",smsDropFromProject:"/api/projects/{0}/dropsms",smsAssignToOrg:"/api/orgs/{0}/assignsms/{1}",smsDropFromOrg:"/api/orgs/{0}/dropsms"},l="smsService.onDetailChanged",m={showSmsSetupModal:e,showSendOrgSmsModal:f,onDetailChanged:l,assignToProject:g,dropFromProject:h,assignToOrg:i,dropFromOrg:j};return m}angular.module("Crops").service("smsService",a),a.$inject=["fvApi","config","$rootScope","$uibModal"]}(),function(){"use strict";function a(a,b,c,d,e,f){a.status={isChangingNumber:!1},a.settings={newAreaCode:null,dropConfirmation:null,assignNumberFailed:!1,errorMessage:null},e&&(a.smsInfo=e,a.settings.isDropping=!!e.number),a.$on(d.onDetailChanged,function(b,c){if(a.status.isChangingNumber=!1,"success"===c){var d=a.settings.isDropping?("project"===a.smsInfo.type?"Project":"Org")+" SMS number removed.":("project"===a.smsInfo.type?"Project":"Org")+" SMS number added.";f.alertSuccess(d),a.close()}else f.alertFail("There are no numbers currently available for that area code. Please pick another code or try again in a few minutes."),a.errorMessage="There are no numbers currently available for that area code. Please pick another code or try again in a few minutes.",a.assignNumberFailed=!0}),a.reset=function(){a.settings.errorMessage=null,a.settings.newAreaCode=null,a.settings.dropConfirmation=null,a.settings.assignNumberFailed=!1},a.canStartSms=function(){return!a.status.isChangingNumber&&a.smsInfo&&a.smsInfo.id&&a.settings.isDropping===!1&&a.settings.newAreaCode&&a.smsSetupForm.$valid},a.startSms=function(){a.canStartSms()&&("project"===a.smsInfo.type?(a.status.isChangingNumber=!0,d.assignToProject(a.smsInfo.id,a.settings.newAreaCode)):"org"===a.smsInfo.type&&(a.status.isChangingNumber=!0,d.assignToOrg(a.smsInfo.id,a.settings.newAreaCode)))},a.canDropSms=function(){return!a.status.isChangingNumber&&a.smsInfo&&a.settings.isDropping&&a.settings.dropConfirmation&&a.smsSetupForm.$valid},a.dropSms=function(){a.canDropSms()&&("project"===a.smsInfo.type?(a.status.isChangingNumber=!0,d.dropFromProject(a.smsInfo.id)):"org"===a.smsInfo.type&&(a.status.isChangingNumber=!0,d.dropFromOrg(a.smsInfo.id)))},a.close=function(){b.close()}}angular.module("Crops").controller("smsSetupModalController",a),a.$inject=["$scope","$uibModalInstance","$rootScope","smsService","smsInfo","fvAlertsService"]}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{sectionId:"@",itemId:"=",needsSave:"&",canSave:"&",saveItem:"&",isreadonly:"=",isCollection:"="},templateUrl:"{0}/snagrecords/snag.records.action.button.html".format(a.viewRoot),link:function(a){function d(){var b=a.isCollection?a.itemId:a.nonCollectionItemID;b?c.getStatus(a.sectionId,b).then(function(b){a.sendButtonEnabled=b.isEnabled,a.displayText=b.displayText}):a.sendButtonEnabled=!0}function e(){var b=a.isCollection?a.itemId:a.nonCollectionItemID;b&&c.createRequest(a.sectionId,b).then(function(b){a.sendButtonEnabled=b.isEnabled,a.displayText=b.displayText})}a.activityLines=[],a.displayText="",a.createButtonEnabled=!1,a.nonCollectionItemID=b.nonCollectionItemID();var f=$("#snagModal");d(),a.createRequest=function(){var b=a.isCollection?a.itemId:a.nonCollectionItemID;a.needsSave()&&a.canSave()?a.saveItem({keepEditing:!0}).then(function(b){a.itemId=b,e()}):!a.needsSave()&&b&&e()},a.openModal=function(){a.activityLines=[],f.modal("show");var b=a.isCollection?a.itemId:a.nonCollectionItemID;b&&c.getActivity(a.sectionId,b).then(function(b){a.activityLines=b})}}}}angular.module("Crops").directive("snagRecordsActionButton",a),a.$inject=["config","customService","snagRecordsActionButtonService"]}(),function(){"use strict";function a(a,b,c){function d(b,d){return a.post(g.createRequest,[c.projectID],{sectionID:b,itemID:d})}function e(b,d){return a.get(g.getStatus,[c.projectID,b,d])}function f(b,d){return a.get(g.getActivity,[c.projectID,b,d])}var g={createRequest:"/api/snagrecords/{0}/createrequest",getStatus:"/api/snagrecords/{0}/getstatus/{1}/{2}",getActivity:"/api/snagrecords/{0}/getactivity/{1}/{2}"},h={createRequest:d,getStatus:e,getActivity:f};return h}angular.module("Crops").service("snagRecordsActionButtonService",a),a.$inject=["fvApi","$rootScope","$stateParams"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l){function m(){if(e.path().match(/tasks$/gi))if(e.search().hashtag){var b=angular.copy(a.defaultFilter);b.filterHashtagsList.push(e.search().hashtag),angular.equals(b,a.activeFilter)||(a.activeFilter=b,e.search("hashtag",null),o=!0)}else if(o)o=!1;else{var c=a.activeFilter.filterRawTaskTargetDateRangeStart,d=a.activeFilter.filterRawTaskTargetDateRangeEnd||moment(moment().format("YYYY-MM-DD"));if(e.search().due){var f=e.search().due;"today"===f?(c=null,d=moment(moment().format("YYYY-MM-DD"))):"week"===f?(c=null,d=moment(moment().format("YYYY-MM-DD")).add(1,"weeks")):"month"===f?(c=null,d=moment(moment().format("YYYY-MM-DD")).add(1,"months")):moment(f,"YYYY-MM-DD").isValid()&&(c=moment(moment(f).format("YYYY-MM-DD")).unix()<moment().unix()?null:moment(f),d=moment(f)),e.search({})}a.activeFilter.filterRawTaskTargetDateRangeStart=c,a.activeFilter.filterRawTaskTargetDateRangeEnd=d.format("MM/DD/YYYY")}}function n(){if(!a.noteBeingParsed){a.noteBeingParsed=!0,a.newNote.body=$("#new-note-input").text();var c="/api/projects/{0}/notes/parse".format($stateParams.projectID);return b.post(c,[],a.newNote).then(function(b){a.newNote.message=f.trustAsHtml(b.noteMessage)})["finally"](function(){a.noteBeingParsed=!1})}}j.init(),a.taskList=[],a.isLoading=!0,a.noteListEmpty=!1,a.flashPrevent=!1,a.noteUiSettings={bottomMenuExpanded:l.getNoteBottomMenuState()},a.$on(l.onUiSettingsChanged,function(){a.noteUiSettings.bottomMenuExpanded=l.getNoteBottomMenuState()}),a.noteBeingParsed=!1,a.$on(d.onNoteListChanged,function(b,c){c&&0===c.listState.indexOf("tasks")&&(a.taskList=d.noteList(),a.isLoading=d.isLoading(),a.noteListEmpty=d.noteListEmpty(),a.flashPrevent=d.isBetweenTimeout()),c.noteID&&h(function(){a.$broadcast("onNotePushed",{noteID:c.noteID,pushType:c.pushType})})}),a.$on(d.onNotePinnedToFeed,function(a,b){b.isExpanded=!0,d.mergeNote(b)}),a.$on(d.onNoteUnpinnedFromFeed,function(a,b){b.isExpanded=b.wasExpanded,d.mergeNote(b)}),a.activeFilter=a.activeFilter||d.defaultFilter(),a.defaultFilter=d.defaultFilter(),a.$on("$locationChangeSuccess",function(){m()},!0),m();var o=!1;d.loadTasks(a.activeFilter),a.$watch("activeFilter",function(b,c){angular.equals(b,c)||d.loadTasks(a.activeFilter)},!0),a.busy=!1,a.getMoreNotes=function(){d.getMore()},a.isShared=function(a){return!(!a||!a.length)&&a.some(function(a){return a.isShared})},a.uploadDoc=function(b){b.length>0&&a.$apply(function(){var c={file:b[0],percent:0,id:-1,projectID:a.newNote.projectID};a.newNote.uploads.push(c);var d=i.find("#fileinput");angular.element(d).val(null)})},a.removeUpload=function(b){var c=a.newNote.uploads.indexOf(b);c>=0&&a.newNote.uploads.splice(c,1)},a.parseNewNote=_.debounce(n,750),a.noteLength=function(a){return a=_.str.stripTags(a),a=a.replace("&nbsp;",""),a=a.replace(/\s+/," "),a=_.str.trim(a),a.length},a.$on("add-task-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){d.mergeNote(c,"tasks",!0)})}),a.$on("update-task-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){d.mergeNote(c,"tasks",!0)})}),a.$on("remove-task-vine",function(b,c){c.filterMismatch||a.$applyAsync(function(){d.removeNote(c)})}),a.$on(d.isPrintingVine,function(){h(function(){k.print(),a.$broadcast("onPrintFinished")})})}angular.module("Crops").controller("TasksController",a),a.$inject=["$scope","fvApi","$rootScope","noteService","$location","$sce","config","$timeout","$document","pushService","$window","uiSettingsService"]}(),function(){"use strict";function a(a,b,c,d){a.noteCount=0,a.$on(d.onNoteCountChanged,function(){a.noteCount=d.noteCount()}),a.todayView=function(){c.search({due:"today"})},a.weekView=function(){c.search({due:"week"})},a.monthView=function(){c.search({due:"month"})}}angular.module("Crops").controller("TasksPageHeaderController",a),a.$inject=["$scope","$stateParams","$location","noteService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,c,d){var e=_(b.selectedUser.sectionShares).findWhere({sectionID:a});e&&(e.isShared=c,e.isSelected=!1,e.isReadonly=d)}function o(){b.selectedUser&&b.selectedUser.sectionShares?(b.sharedSectionsList=_(b.selectedUser.sectionShares).where({isShared:!0}),b.unsharedSectionsList=_(b.selectedUser.sectionShares).where({isShared:!1})):(b.sharedSectionsList=[],b.unsharedSectionsList=[])}function p(){if(b.team)for(var a=0;a<b.team.length;a++){var c=[],d=b.team[a];d.isFirstPrimary?c.push("*Primary"):d.isPrimary&&c.push("Primary"),d.isAdmin&&c.push("Project Admin"),q(d)&&c.push("Follower"),r(d)&&c.push("Collaborator"),s(d)&&c.push("Guest"),d.roles=c}}function q(a){return"Main"===a.team}function r(a){return"Support"===a.team}function s(a){return"Guest"===a.team}b.team=[],b.tagRoleList=[],b.userModalSettings={isOtherRoles:!1,isShareSections:!1},b.teamLoading=!0,b.currentUserIsAdmin=!1,b.mainUserCount=0,b.supportUserCount=0,b.guestUserCount=0,b.inviteeMemberCardIsloading=!1;var t=$("#userRoleModal");b.selectedUser={},b.sharedSections=[],b.unsharedSections=[],b.selectedSectionsToShare=[],b.selectedSectionsToUnshare=[],b.$on(c.onDataChanged,function(){b.team=c.team(),b.teamLoading=c.isLoading(),b.currentUserIsAdmin=c.currentUserIsAdmin(),b.mainUserCount=b.team.filter(q).length,b.supportUserCount=b.team.filter(r).length,b.guestUserCount=b.team.filter(s).length,p(),b.selectedUser&&b.selectedUser.id&&(b.gotoTeamTab(b.selectedUser),b.isGuest(b.selectedUser)&&o())}),b.$on(c.onNewInvite,function(a,c){var d=null;c.userID?d=_(b.team).findWhere({id:c.userID}):c.userEmail&&(d=_(b.team).findWhere({email:c.userEmail})),d&&b.gotoTeamTab(d)}),b.$on(d.onRoleListChanged,function(){b.tagRoleList=d.roleList()}),c.loadTeam(!0),d.loadRoles(),b.showInvitePanel=function(){if(k.project()){var a=k.project().orgID,b=k.project().id;a&&(b||0===b)&&e.showInvitePanel(a,b)}},b.isMain=q,b.isSupport=r,b.isGuest=s,b.openUserPermissions=function(a){b.selectedUser=a,b.isGuest(a)&&o(),b.selectedTagRoles=angular.copy(b.selectedUser.tagRoles),t.modal("show")},t.on("hidden.bs.modal",function(){b.selectedUser={},b.sharedSectionsList=[],b.unsharedSectionsList=[],b.selectedSectionsToShare=[],b.selectedSectionsToUnshare=[],b.selectedTagRoles=[],b.userModalSettings={isOtherRoles:!1,isShareSections:!1}}),b.gotoTeamTab=function(a){switch($("#inviteModal").modal("hide"),a.team){case"Main":$('[href="#mainUsers"]').trigger("click");break;case"Support":$('[href="#supportUsers"]').trigger("click");break;case"Guest":$('[href="#limitedUsers"]').trigger("click")}},b.makePrimary=function(a){c.makePrimary(a)},b.removePrimary=function(a){c.removePrimary(a)},b.removeUserFromProject=function(a){c.removeUserFromProject(a)},b.moveToMain=function(a){c.moveToMain(a)},b.moveToSupport=function(a){c.moveToSupport(a)},b.moveToGuest=function(a){c.moveToGuest(a)},b.makeAdmin=function(a){c.makeAdmin(a)},b.removeAdmin=function(a){c.removeAdmin(a)},b.saveTagRoles=function(){d.changeRoles(b.selectedUser.id,_.pluck(b.selectedTagRoles,"id")).then(function(){b.tagRoleForm.$setPristine(),b.selectedUser.tagRoles=b.selectedTagRoles,j.alertSuccess(b.selectedUser.fullname+"'s roles have been saved.")})},b.toggleSectionSelection=function(a){a.isSelected=!a.isSelected},b.shareSections=function(a){var c=b.selectedUser.id,d=a?[{sectionID:a}]:_(b.unsharedSectionsList).where({isSelected:!0});if(d.length){for(var e=0;e<d.length;e++)h.addOrEditSectionShare(d[e].sectionID,c),n(d[e].sectionID,!0,!1);o()}},b.unshareSections=function(a){var c=b.selectedUser.id,d=a?[{sectionID:a}]:_(b.sharedSectionsList).where({isSelected:!0});if(d.length){for(var e=0;e<d.length;e++)h.shareRemove("section",d[e].sectionID,c),n(d[e].sectionID,!1,!1);o()}},b.toggleReadonly=function(a){h.addOrEditSectionShare(a.sectionID,b.selectedUser.id,a.isReadonly)},b.$on(c.onUserPermissionsChanged,function(a,c){c&&c.closeModal&&$("#userRoleModal").modal("hide"),c&&c.msg&&j.alertSuccess(b.selectedUser.fullname+" "+c.msg)})}angular.module("Crops").controller("TeamController",a),a.$inject=["$rootScope","$scope","teamService","roleService","userService","$state","config","shareService","$filter","fvAlertsService","projectService","$location","$anchorScroll"]}(),function(){"use strict";function a(a,b,c,d){function e(){b.$broadcast(w)}function f(b){b||c.projectID&&c.projectID!==A?(z=!0,y=[],A=c.projectID,e(),a.get(t.getTeam,[c.projectID]).then(function(a){y=a,z=!1,console.debug(a)})["finally"](e)):e()}function g(b,c){return a.get(t.getTeamMember,[b,c])}function h(){return c.projectID!==A&&f(),y}function i(){return z}function j(){if(y.length)for(var a=0;a<y.length;a++)if(y[a].id===d.currentUser().id)return y[a].isAdmin;return!1}function k(d){a.put(t.makePrimary,[c.projectID,d.id]).then(function(){d.isPrimary=!0,d.isFirstPrimary=!0,d.isOnlyPrimary=!1,d.position=0,_.each(y,function(a){a.isPrimary&&a.id!==d.id&&(a.position=a.position+1,a.isOnlyPrimary=!1,a.isFirstPrimary=!1)}),b.$broadcast(u,{msg:"is now a Primary on this project."})})["finally"](e)}function l(d){a.put(t.removePrimary,[c.projectID,d.id]).then(function(){d.isPrimary=!1,d.isFirstPrimary=!1,d.isOnlyPrimary=!1,d.position=null;var a=y.filter(function(a){return a.isPrimary});1===a.length?(a[0].isOnlyPrimary=!0,a[0].isFirstPrimary=!0):(a=_.sortBy(a,function(a){return+a.position}),a[0].isFirstPrimary=!0),b.$broadcast(u,{msg:"is no longer a Primary on this project."})})["finally"](e)}function m(d){a.put(t.makeAdmin,[c.projectID,d.id]).then(function(){d.isAdmin=!0,b.$broadcast(u,{msg:"is now an Admin of this project."})})["finally"](e)}function n(d){a.put(t.removeAdmin,[c.projectID,d.id]).then(function(){d.isAdmin=!1,b.$broadcast(u,{msg:"is no longer an Admin of this project."})})["finally"](e)}function o(d){a.put(t.moveToMain,[c.projectID,d.id]).then(function(){d.team="Main",b.$broadcast(u,{msg:"is now a Follower on this project."})})["finally"](e)}function p(d){a.put(t.moveToSupport,[c.projectID,d.id]).then(function(){d.team="Support",b.$broadcast(u,{msg:"is now a Collaborator on this project."})})["finally"](e)}function q(d){a.put(t.moveToGuest,[c.projectID,d.id]).then(function(a){d.team="Guest",d.isAdmin=!1,d.sectionShares=a,b.$broadcast(u,{msg:"is now a Guest on this Project."})})["finally"](e)}function r(d){a.del(t.removeUserFromProject,[c.projectID,d.id]).then(function(){var a;y.forEach(function(b,c){b.id===d.id&&(a=c)}),"undefined"!=typeof a&&y.splice(a,1),b.$broadcast(u,{msg:"has been removed from this Project.",closeModal:!0})})["finally"](e)}function s(d){return d?d.userID<0?a.post(t.inviteNewUser,[c.projectID],{FindBy:d.userName}).then(function(a){y=a,e(),b.$broadcast(v,{userEmail:d.userName})}):a.post(t.inviteKnownUser,[c.projectID],d).then(function(a){y=a,e(),b.$broadcast(v,{userID:d.userID})}):null}var t={getTeam:"/api/projects/{0}/team",getTeamMember:"api/projects/{0}/team/{1}",moveToMain:"/api/projects/{0}/team/movetomain/{1}",moveToSupport:"/api/projects/{0}/team/movetosupport/{1}",moveToGuest:"/api/projects/{0}/team/movetoguest/{1}",inviteNewUser:"/api/projects/{0}/team/invite",inviteKnownUser:"/api/projects/{0}/team/inviteKnownUser",removeUserFromProject:"/api/projects/{0}/team/removeuserfromproject/{1}",makePrimary:"/api/projects/{0}/makeprimary/{1}",removePrimary:"/api/projects/{0}/removeprimary/{1}",makeAdmin:"/api/projects/{0}/team/makeadmin/{1}",removeAdmin:"/api/projects/{0}/team/removeadmin/{1}"},u="teamService.onUserPermissionsChanged",v="teamService.onNewInvite",w="teamService.onDataChanged",x={loadTeam:f,team:h,getTeamMember:g,isLoading:i,onDataChanged:w,onUserPermissionsChanged:u,onNewInvite:v,currentUserIsAdmin:j,makePrimary:k,removePrimary:l,makeAdmin:m,removeAdmin:n,moveToMain:o,moveToSupport:p,moveToGuest:q,removeUserFromProject:r,invite:s},y=[],z=!1,A=-1;return x}angular.module("Crops").service("teamService",a),a.$inject=["fvApi","$rootScope","$stateParams","currentUserService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",scope:{members:"=",isOrg:"="},templateUrl:"{0}/user/invite.user.panel.html".format(a.viewRoot),link:function(a){function e(){a.invitee=angular.copy(a.inviteeDefault)}function f(){e(),k.modal("show"),a.$broadcast("reFocusInvite")}function g(a){return a?a.indexOf(":")?a.substring(a.indexOf(":")+1):a:""}function h(a){return"Main"===a.team}function i(a){return"Support"===a.team}function j(a){return"Guest"===a.team}var k=$("#inviteModal");a.inviteeDefault={input:"",current:null,error:"",isAlreadyMember:!1,team:null,teamName:null},a.resetError=function(){a.invitee.error=""},e(),a.$on(b.onShowInvitePanel,function(b,c){c&&(a.orgID=c.orgID,a.projectID=c.projectID,a.orgID&&(a.projectID||0===a.projectID)&&f())}),a.getInviteeList=function(c){return"@"===c[0]&&(c=c.slice(1)),c?b.getInviteeList(a.orgID,a.projectID,c).then(function(a){return a}):null},a.onInviteeSelected=function(b,c,d){if(e(),a.invitee.current=b,!a.isOrg){var f=_(a.members).findWhere({id:b.userID});f&&(a.invitee.team=f.team,a.invitee.teamName=h(f)?"Follower":i(f)?"Collaborator":j(f)?"Guest":null)}},a.gotoTeamTab=function(a){switch(k.modal("hide"),a.team){case"Main":$('[href="#mainUsers"]').trigger("click");break;case"Support":$('[href="#supportUsers"]').trigger("click");break;case"Guest":$('[href="#limitedUsers"]').trigger("click")}},a.removeCurrentInvitee=function(){a.invitee.current=null},a.canInvite=function(){return a.invitee&&a.invitee.current&&(!a.isOrg&&!a.invitee.team||a.isOrg&&!a.invitee.current.isInOrg)},a.invite=function(){if(a.canInvite){a.isInviting=!0;var b=a.invitee.current;a.resetError(),a.isOrg?d.invite(b).then(function(){a.isInviting=!1,k.modal("hide")},function(b){a.isInviting=!1,a.invitee.error=g(b)}):c.invite(b).then(function(){a.isInviting=!1,k.modal("hide")},function(b){a.isInviting=!1,a.invitee.error=b.replace("Exception: ","")})}},k.on("hidden.bs.modal",function(){e(),a.isInviting=!1})}}}angular.module("Crops").directive("inviteUserPanel",a),a.$inject=["config","userService","teamService","orgService"]}(),function(){"use strict";function a(a){return{restrict:"E",scope:{user:"=",member:"=",isOrgMemberCard:"=",rolesList:"=?"},replace:!0,templateUrl:"{0}/user/user.block.view.html".format(a.viewRoot),link:function(a){function b(){if(a.isOrgMemberCard&&a.member&&(a.settings.accessLevelTags=[],a.settings.autoRoles=[],a.settings.autoRolesDisplay="",3===a.member.accessLevel?a.settings.accessLevelTags.push({type:"orgaccess",cssClass:"label-primary",text:"Org Admin"}):a.member.accessOrgInbox&&a.settings.accessLevelTags.push({type:"mailroom",cssClass:"label-gold",text:"Mailroom"}),a.member.autoAddToNewProject)){var b={type:"autoadd",cssClass:"",accessIcon:"",notificationIcon:"",text:""};1===a.member.autoAccessLevelOnNewProject?b.text="Guest":2===a.member.autoAccessLevelOnNewProject?(b.text=a.member.autoFollowNewProject?"Follower":"Collaborator",b.accessIcon="fa-shield text-muted",b.notificationIcon="fa-feed"+(a.member.autoFollowNewProject?"":" text-muted")):3===a.member.autoAccessLevelOnNewProject&&(b.text=3===a.member.autoAccessLevelOnNewProject?"Admin-"+(a.member.autoFollowNewProject?"Follower":"Collab"):"",b.cssClass="label-aqua",b.accessIcon="fa-shield",b.notificationIcon="fa-feed"+(a.member.autoFollowNewProject?"":" text-muted")),b.text&&a.settings.accessLevelTags.push(b),a.member&&a.member.autoRoleIDs&&a.member.autoRoleIDs.length&&a.rolesList&&a.rolesList.length&&(a.settings.autoRoles=_(a.rolesList).filter(function(b){return a.member.autoRoleIDs.indexOf(b.id)>-1}),a.settings.autoRolesDisplay=_(a.settings.autoRoles.slice(0,3)).map(function(a){return a.name}).join(",  "))}}function c(){a.isOrgMemberCard||(a.settings.accessLevelTags=[],a.settings.accessLevelTags=_(a.user.roles).map(function(a){return{type:"projectaccess",cssClass:["Primary","*Primary"].indexOf(a)>-1?"label-primary":"Project Admin"==a?"label-aqua":"",text:a}}))}a.showEmails=!!Crops.AdminPath,a.settings={accessLevelTags:[],autoRoles:null},a.$watch("member",b,!0),a.$watch("user.roles",c,!0),a.autoAddRolesToHumanList=function(){var b=a.settings.autoRoles;if(b&&b.length){var c=b.map(function(a){return a.name});return 1===c.length?c[0]:[c.slice(0,-1).join(", "),c.slice(-1)[0]].join(c.length>2?", and ":" and ")}}}}}angular.module("Crops").directive("userBlock",a),a.$inject=["config"]}(),function(){"use strict";function a(a,b,c){var d=0;return{restrict:"EA",replace:!0,scope:{usersList:"=",selectedUsersList:"=?",getUserData:"&?",placeholder:"@",disabled:"=?",formControlName:"@?",onSelect:"&?",includeSelected:"=?"},templateUrl:"{0}/user/user.selector.html".format(b.viewRoot),link:function(a,b,c){function e(){if(a.usersList&&a.usersList.length&&(a.availableUsers=_.chain(a.usersList).map(function(b){return a.getUserData({user:b})}).filter(function(a){return a.id}).value(),!a.includeSelected)){var b=_.chain(a.selectedUsersList).map(function(b){return a.getUserData({user:b})}).filter(function(a){return a.id}).pluck("id").value();b&&b.length&&(a.availableUsers=_(a.availableUsers).reject(function(a){return b.indexOf(a.id)>-1}))}}a.selectorID=d,a.userInputID=a.formControlName?a.formControlName:"userInput"+d,a.userResultsID="user-results-"+d,d++,a.selectedUsersList=a.selectedUsersList||[],a.getUserData=a.getUserData&&angular.isFunction(a.getUserData)?a.getUserData:function(a){return a},a.placeholder=a.placeholder||"Enter name or @username",a.$watch("usersList",e,!0),a.$watch("selectedUsersList",e,!0),a.getUsersForTypeahead=function(b){if(!a.availableUsers||!a.availableUsers.length)return[];var c=[],d=[],e=!1;return b=b.toLowerCase(),0===b.indexOf("@")&&(e=!0,b=b.substring(1)),e?_(a.availableUsers).each(function(a){if(a.username){var e=a.username.toLowerCase();0===e.indexOf(b)?c.push(a):e.indexOf(b)>0&&d.push(a)}}):_(a.availableUsers).each(function(a){if(a.fullname){var e=a.fullname.toLowerCase();0===e.indexOf(b)?c.push(a):e.indexOf(b)>0&&d.push(a)}}),c.concat(d)},a.onUserSelected=function(b,c,d){if(!a.disabled&&b){var e=_(a.usersList).find(function(c){return a.getUserData({user:c})&&a.getUserData({user:c}).id===b.id});if(!e)return;a.selectedUsersList.push(e),a.onSelect&&angular.isFunction(a.onSelect)&&a.onSelect({user:e}),a.user=null}}}}}angular.module("Crops").directive("userSelector",a),a.$inject=["fvApi","config","currentUserService"]}(),function(){"use strict";function a(a,b,c,d){function e(a,c){b.$broadcast(j,{orgID:a,projectID:c})}function f(){b.$broadcast(k)}function g(b,c,d){return a.get(i.getInviteeList,[b,c,d])}function h(b){return a.get(i.getRelatedUsers,[b])}var i={getInviteeList:"/api/users/invitelist/{0}/{1}?q={2}",getRelatedUsers:"api/users/relatedUsers?q={0}"},j="userService.onShowInvitePanel",k="userService.onHideInvitePanel",l={onShowInvitePanel:j,onHideInvitePanel:k,showInvitePanel:e,hideInvitePanel:f,getInviteeList:g,getRelatedUsers:h};return l}angular.module("Crops").service("userService",a),a.$inject=["fvApi","$rootScope","teamService","orgService"]}(),function(){"use strict";function a(a,b,c,d){return{restrict:"E",replace:!0,scope:{},templateUrl:"{0}/user/usercard/user.card.popup.html".format(a.viewRoot),link:function(a,c,e){var f=function(a){a.stopPropagation(),a.preventDefault(),b.userCardData=null,b.$broadcast(d.onShow,null)};b.$on(d.onShow,function(a,b){b?angular.element(document).bind("click",f):angular.element(document).unbind("click",f)})}}}angular.module("Crops").directive("userCard",a),a.$inject=["config","$rootScope","$timeout","userCardService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(c,f,i,j){a.$broadcast(h,null),a.userCardData=null;var k=!f&&c&&(!j&&c.author&&"User"===c.author.type&&c.author.id&&1!==c.author.id||j&&c.assignee&&c.assignee.id);if(k){var l=j?c.assignee.id:c.author.id,m=b.projectID||c.projectID||(i?i.projectID:null);m?d.getTeamMember(m,l).then(function(b){a.userCardData={isOrgMemberCard:!1,user:b,member:null},g(a.userCardData),a.$broadcast(h,{note:c,isAssignee:j})}):b.orgID&&e.getOrgMember(b.orgID,l).then(function(b){a.userCardData={isOrgMemberCard:!0,member:b,user:b?b.user:null},g(a.userCardData),a.$broadcast(h,{note:c,isAssignee:j})})}}function g(a){var b=[];if(a.isOrgMemberCard&&a.member){var c=a.member;c&&(3===c.accessLevel?b.push("Org Admin"):c.accessOrgInbox&&b.push("Mailroom"),c.autoAddToNewProject&&(3===c.autoAccessLevelOnNewProject&&b.push("Project Admin"),c.autoFollowNewProject?b.push("Project Follower"):b.push("Project Collab")),c.roles=b)}else if(!a.isOrgMemberCard){var d=a.user;d&&(d.isFirstPrimary?b.push("*Primary"):d.isPrimary&&b.push("Primary"),d.isAdmin&&b.push("Project Admin"),"Main"===d.team&&b.push("Follower"),"Support"===d.team&&b.push("Collaborator"),"Guest"===d.team&&b.push("Guest"),d.roles=b)}}var h="userCardService.onShowPopup",i={loadUserCardData:f,onShow:h};return i}angular.module("Crops").service("userCardService",a),a.$inject=["$rootScope","$stateParams","$q","teamService","orgService"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,templateUrl:"{0}/yield/yield.adjustment.html".format(b.viewRoot),link:function(b,c){function d(){return b.line?parseFloat((b.line.amount*b.line.reductionPercentage/100).toFixed(2)):0}function e(){return b.line?parseFloat((b.line.adjustmentAmount/b.line.amount*100).toFixed(5)):0}var f=$(c);f.modal("hide"),b.isPopupOpen=!1,b.line=null,b.$on(a.onShowLineAdjustment,function(a,c){c.line&&(b.line=c.line,b.table=c.table,b.isPopupOpen=!0,f.modal("show"))}),b.close=function(){b.canClose()&&(b.isPopupOpen=!1,f.modal("hide"))},b.canClose=function(){return!b.line||(b.line.reductionPercentage||0===b.line.reductionPercentage)&&b.line.reductionPercentage<=100&&b.line.reductionPercentage>=0},b.calculate=function(a){"adjPercentage"===a?(b.line.isReductionPercentageLocked=!1,b.line.reductionPercentage=e()):"adjAmount"===a&&(b.line.isReductionPercentageLocked=!0,b.line.adjustmentAmount=d())},b.netAmount=function(){return b.line&&b.line.reductionPercentage<=100?b.line.isReductionPercentageLocked?parseFloat((b.line.amount*(1-b.line.reductionPercentage/100)).toFixed(2)):parseFloat((b.line.amount-b.line.adjustmentAmount).toFixed(2)):0}}}}angular.module("Crops").directive("yieldAdjustment",a),a.$inject=["yieldService","config"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{},templateUrl:"{0}/yield/yield.calc.html".format(b.viewRoot),link:function(b){b.currentYield=null,b.editing={offer:!1,attorneyPercentage:!1,attorneyAmount:!1,medicalBillAmount:!1,expenseAmount:!1,netToClient:!1},b.$on(a.onCurrentYieldChanged,function(){b.currentYield=a.currentYield()}),b.updateYield=function(){a.updateYield(b.currentYield)},b.updateAttorneyAmount=function(){b.currentYield.attorneyPercentage=parseFloat((b.currentYield.attorneyAmount/b.currentYield.offer*100).toFixed(5)),b.updateYield()},b.updateAttorneyPercentage=function(){b.currentYield.attorneyAmount=parseFloat((b.currentYield.offer*b.currentYield.attorneyPercentage/100).toFixed(2)),b.updateYield()}}}}angular.module("Crops").directive("yieldCalc",a),a.$inject=["yieldService","config"]}(),function(){"use strict";function a(a,b,c,d){b.isLoading=!0,b.yieldList=[],b.currentYield=null,b.$on(c.onYieldListChanged,function(){b.isLoading=c.isLoading(),b.yieldList=c.yieldList()}),b.$on(c.onCurrentYieldChanged,function(){b.currentYield=c.currentYield()}),c.loadList(),b.createYield=function(){c.createYield()},b.updateYield=function(){c.updateYield(b.currentYield)},b.removeYield=function(){c.removeYield(b.currentYield)},b.removeLine=function(a){c.removeLine(a)},b.replaceLines=function(a,b){var e="";1===b&&(e="Meds"),2===b&&(e="Expenses"),d.confirm({text:"Are you sure you wish to permanently remove all existing entries and adjustments and replace them with the latest "+e+" section entries?",confirmButtonText:"Replace "+e+" List",isLoadingButtonText:"Replacing "+e+" List"},function(){return c.replaceLines(a,b)})}}angular.module("Crops").controller("YieldController",a),a.$inject=["$rootScope","$scope","yieldService","confirmService"]}(),function(){
"use strict";function a(a,b,c,d){return{restrict:"E",scope:!1,replace:!0,templateUrl:"{0}/yield/yield.Header.html".format(c.viewRoot),link:function(b,c){b.currentYield=null,b.exportedDoc=void 0,b.$on(a.onDocGenerated,function(a,c){b.isGenerating=!1,b.exportedDoc=c}),b.generateDoc=function(){b.isGenerating=!0,b.exportedDoc=void 0,a.generateDoc(b.currentYield),$("#exportModal").modal("show")},b.isEditingYieldName=!1,b.beginEditYieldName=function(){b.isEditingYieldName=!0,console.log($(c).find("#yieldName")),d(function(){$(c).find("#yieldName").focus()})},b.saveYieldName=function(){if(""===b.currentYield.name){for(var a=1,c=0;c<b.yieldList.length;c++)b.yieldList[c].id===b.currentYield.id&&(a=c+1);b.currentYield.name="Scenario "+a}b.isEditingYieldName=!1,b.updateYield()},b.isEditingYieldNotes=!1,b.beginEditYieldNotes=function(){b.isEditingYieldNotes=!0,console.log($(c).find("#yieldNotes")),$(c).find("#yieldNotes").focus()},b.saveYieldNotes=function(){b.isEditingYieldNotes=!1,b.updateYield()}}}}angular.module("Crops").directive("yieldHeader",a),a.$inject=["yieldService","docService","config","$timeout"]}(),function(){"use strict";function a(a,b){return{restrict:"E",replace:!0,scope:{line:"=",table:"@"},templateUrl:"{0}/yield/yield.line.html".format(b.viewRoot),link:function(c,d){function e(){return c.line&&c.line.reductionPercentage<=100?parseFloat((c.line.amount*c.line.reductionPercentage/100).toFixed(2)):0}function f(){return c.line?parseFloat((+c.line.adjustmentAmount/+c.line.amount*100).toFixed(5)):0}c.line.isIncluded=!c.line.isExcluded,c.line.editingLine=!1,c.hasAdjDetails=function(){return 0!==c.line.adjustmentAmount||""!==c.line.notes||c.line.reductionPercentage>0},c.lineCanSave=function(){return!c.line.newLine||c.line.newLine&&(c.line.name||c.line.amount||c.line.adjustmentAmount||c.line.reductionPercentage||c.line.notes)},c.beginEdit=function(a){c.line.editingLine||(c.line.editingLine=!0,c.line.originalLine=angular.copy(c.line))},c.line.newLine&&c.beginEdit(),c.save=function(b){c.lineCanSave()&&(a.saveLine(c.line),c.line.editingLine=!1,delete c.line.originalLine),b.stopPropagation()},c.$on(b.globalSaveHotkeyPressed,function(a,b,d){c.save(d)}),c.remove=function(){console.log("hello"),a.removeLine(c.line)},c.cancel=function(a){var b=angular.copy(c.line.originalLine);delete c.line.originalLine,angular.copy(b,c.line),c.line.newLine||(c.line.editingLine=!1),c.line.newLine&&(c.line.originalLine=angular.copy(c.line)),a.stopPropagation()},c.includeLine=function(b){c.line.isExcluded=!c.line.isIncluded,c.line.newLine||c.line.editingLine||a.saveLine(c.line),b.stopPropagation()},c.calculate=function(a){a?"adjAmount"===a&&(c.line.isReductionPercentageLocked=!0,c.line.adjustmentAmount=e()):c.line.isReductionPercentageLocked?c.line.adjustmentAmount=e():c.line.reductionPercentage=f()},c.netAmount=function(){return c.line&&c.line.reductionPercentage<=100?c.line.isReductionPercentageLocked?parseFloat((+c.line.amount*(1-+c.line.reductionPercentage/100)).toFixed(2)):parseFloat((+c.line.amount-+c.line.adjustmentAmount).toFixed(2)):0},c.openPopup=function(){a.showLineAdjustment(c.line,c.table)}}}}angular.module("Crops").directive("yieldLine",a),a.$inject=["yieldService","config"]}(),function(){"use strict";function a(a,b,c,d){function e(){return c.projectID===D&&C?(b.$broadcast(F),void b.$broadcast(G)):(B=!0,C=[],D=c.projectID,b.$broadcast(F),void a.get(A.getYieldList,[c.projectID]).then(function(a){B=!1,C=a,b.$broadcast(F),C.length>0?h(C[0]):E=i(),b.$broadcast(G)}))}function f(){return C||[]}function g(){return E}function h(a){E&&u(E),E=a,t(E),v(E),b.$broadcast(G)}function i(){a.post(A.createYield,[c.projectID],r()).then(function(a){C.push(a),h(a),b.$broadcast(F)})}function j(c){a.post(A.updateYield,[c.id],c).then(function(a){d.replaceInList(C,a),v(c),b.$broadcast(F)})}function k(c){var e=0;a.post(A.removeYield,[c.id]).then(function(){for(var a=0;a<C.length;a++)C[a].id===c.id&&(e=0===a?0:a-1);d.removeFromList(C,c.id),C.length?(h(C[e]),b.$broadcast(F)):i()})}function l(c){c.id?a.post(A.updateLine,[E.id,c.id],c).then(function(a){C=a,b.$broadcast(F),E=_(C).findWhere({id:E.id}),t(E),v(E),b.$broadcast(G)}):a.post(A.createLine,[E.id],c).then(function(a){C=a,b.$broadcast(F),E=_(C).findWhere({id:E.id}),t(E),v(E),b.$broadcast(G)})}function m(c){a.post(A.removeLine,[E.id,c.id]).then(function(a){C=a,b.$broadcast(F),E=_(C).findWhere({id:E.id});for(var e=0;e<C.length;e++)d.removeFromList(C[e].lines,c.id),v(C[e]);t(E),b.$broadcast(G)})}function n(c,d){var e=_.chain(c).where({itemType:d}).pluck("id").compact().value(),f={yieldLineIDs:e,itemType:d};return a.post(A.replaceLines,[E.id],f).then(function(a){C=a,b.$broadcast(F),E=_(C).findWhere({id:E.id}),t(E),b.$broadcast(G)})}function o(a,c){b.$broadcast(H,{line:a,table:c})}function p(){return B}function q(c){a.post(A.generateDoc,[c.id]).then(function(a){b.$broadcast(I,a)})}function r(){return{offer:0,attorneyPercentage:33.33333,isAttorneyAmountLocked:!1,lines:[],name:"New Scenario",notes:""}}function s(a){return{name:"",amount:0,itemType:a,adjustmentAmount:0,reductionPercentage:0,notes:"",newLine:!0}}function t(a){var b=!1,c=!1;if(a.lines)for(var d=0;d<a.lines.length;d++)a.lines[d].newLine&&a.lines[d].itemType===J&&(b=!0),a.lines[d].newLine&&a.lines[d].itemType===K&&(c=!0);b||a.lines.push(s(J)),c||a.lines.push(s(K))}function u(a){if(a.lines)for(var b=a.lines.length-1;b>=0;b--)a.lines[b].newLine&&a.lines.splice(b,1)}function v(a){a.medicalBillAmount=w(a),a.expenseAmount=x(a),a.netToClient=z(a)}function w(a){var b=0;return a&&a.lines&&angular.forEach(a.lines,function(a){1!==a.itemType||a.isExcluded||(b+=y(a))}),b}function x(a){var b=0;return a&&a.lines&&angular.forEach(a.lines,function(a){2!==a.itemType||a.isExcluded||(b+=y(a))}),b}function y(a){return a.isReductionPercentageLocked?a.amount*(1-a.reductionPercentage/100):a.amount-a.adjustmentAmount}function z(a){return a?a.offer-(a.attorneyAmount+a.medicalBillAmount+a.expenseAmount):0}var A={getYieldList:"/api/yield/list/{0}",createYield:"/api/yield/create/{0}",updateYield:"/api/yield/{0}/update",removeYield:"/api/yield/{0}/remove",createLine:"/api/yield/{0}/createline",updateLine:"/api/yield/{0}/updateline/{1}",removeLine:"/api/yield/{0}/removeline/{1}",replaceLines:"/api/yield/{0}/replacelines/{1}",generateDoc:"/api/yield/{0}/generateworddoc"},B=!1,C=null,D=0,E=null,F="yieldService.onYieldListChanged",G="yieldService.onCurrentYieldChanged",H="yieldService.onShowLineAdjustment",I="yieldService.onDocGenerated",J=1,K=2,L={loadList:e,yieldList:f,currentYield:g,isLoading:p,onYieldListChanged:F,onCurrentYieldChanged:G,onShowLineAdjustment:H,onDocGenerated:I,selectCurrent:h,createYield:i,updateYield:j,removeYield:k,saveLine:l,removeLine:m,replaceLines:n,showLineAdjustment:o,generateDoc:q};return L}angular.module("Crops").service("yieldService",a),a.$inject=["fvApi","$rootScope","$stateParams","fvUtils"]}(),function(){"use strict";function a(a,b){return{restrict:"E",scope:{summary:"="},templateUrl:"{0}/yield/yield.summary.html".format(b.viewRoot),link:function(b){b.isCurrent=!1,b.$on(a.onCurrentYieldChanged,function(){b.isCurrent=b.summary.id===a.currentYield().id}),b.selectCurrent=function(){a.selectCurrent(b.summary)},a.loadList()}}}angular.module("Crops").directive("yieldSummary",a),a.$inject=["yieldService","config"]}();
